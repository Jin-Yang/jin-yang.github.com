---
Date: October 19, 2013
title: Linux 网络负载均衡
layout: post
comments: true
language: chinese
category: [linux, network]
---

对于一个每秒处理百万请求的网站来说，通常是有整个集群提供服务的，而如何做到负载均衡呢？

<!-- more -->

# 简介

在 GRE 中，对负载均衡是如下定义的：Traffic load balancing is how we decide which of the many, many machines in our datacenters will serve a particular request.

如何选择一个最优的解决方案实际上有多种考虑因素：从全局来看还是局部，使用硬件还是软件，所处理场景的特性等。例如，对于搜索以及视频服务来说，前者希望有较小的 RTT，而后者则希望有较大的带宽。

接下来我们看看从一个请求的处理流程来说，有哪些节点可以或者需要做负载均衡。

下图是 Amazon 的一套组网方案，首先是 DNS 系统，然后是 CDN 网络，前端的负载均衡，web 服务器，数据中心的负载均衡，应用服务器，数据库，存储等。

![network]({{ site.url }}/images/network/lb-overview.png){: .pull-center}

其中前端负载均衡之后还包括了两个可用区，用来保证高可用。

# DNS

在客户端发送请求前，首先需要通过 DNS 查询域名对应的 IP 地址，这也就意味着可以首先通过 DNS 做负载均衡，而在这阶段所作的就是，尽可能返回一个最优的 IP 。

首先，最简单的方式是返回多个 A 或者 AAAA 地址，而客户端随意选择其中的一个，从而可以做到打散。

上述的方法实现非常简单，同样也带有很多问题。首先，我们很难控制客户端应该选择那个 IP 地址，当然，可以通过 SRV 设置权重以及优先级，但目前对 HTTP 请求是无效的。

另外，为了选择最近的服务器，减小 RTT，可以通过 anycast+BGP 解决，后面我们详细讨论其实现的方式。

但是还有个问题，通常的 DNS 请求并不是直接请求权威服务器的，而是直接请求的 ISP 的代理。这也就意味着，权威服务器收到的将是代理的 IP 地址，而非客户端的 IP，从而可能会导致出错。目前的解决方案是使用 EDNS 协议，它将会携带客户端的子网信息，目前 OpenDNS 是支持该功能的。

DNS 存在着一些功能限制，最明显的就是缓存、512Bytes，我们所能做的就是在做方案时铭记。



# 软件负载均衡

网络中常见的的负载均衡主要分为两种：一种是通过硬件来进行进行，常见的硬件有比较昂贵的 NetScaler、F5、Radware 和 Array 等商用的负载均衡器；也有类似于 LVS、Nginx、HAproxy 的基于 Linux 的开源的负载均衡策略。

商用负载均衡可以建立在四~七层协议之上，因此适用面也就更广所以有其不可替代性，而且有专业的维护团队来对这些服务进行维护，不过缺点就是花销太大，所以对于规模较小的网络服务来说暂时还没有必要使用。

对于软件实现的负载均衡，其中 LVS 是建立在四层协议上面的，而另外 Nginx 和 HAproxy 是建立在七层协议之上的。


## LVS

从性能和稳定上来说 LVS 基本达到了 F5 硬件设备的 60% 性能，不过配置也最麻烦，而且健康检测需要另外配置 Ldirector 。在此简单介绍下 LVS，它配置非常简单，在内核中实现，仅做请求分发之用，可以支持几乎所有应用的负载均衡，包括 http、数据库、聊天室等。


## Nginx

Nginx 工作在网络的第 7 层，所以它可以针对 http 应用本身来做分流策略，比如针对域名、目录结构等，相比之下 LVS 并不具备这样的功能。

可以负载超过 1 万的并发，除了负载均衡，还能作 Web 服务器，而且可以通过 Geo 模块来实现流量分配，不过不支持 session 保持，而且对后端 real server 的健康检查功能效果不好，而且只支持通过端口来检测，不支持通过 url 来检测。

## HAproxy

其优点正好可以补充 nginx 的缺点，支持 session 保持，同时支持通过获取指定的 url 来检测后端服务器的状态。支持 TCP 模式的负载均衡，比如可以给 MySQL 的从服务器集群和邮件服务器做负载均衡。








<!--
LVS的特点是：

1、抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生；

2、配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率；

3、工作稳定，自身有完整的双机热备方案；

4、无流量，保证了均衡器IO的性能不会收到大流量的影响；

5、应用范围比较广，可以对所有应用做负载均衡；

6、LVS需要向IDC多申请一个IP来做Visual IP，因此需要一定的网络知识，所以对操作人的要求比较高。

Nginx的特点是：

1、工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构；

2、Nginx对网络的依赖比较小；

3、Nginx安装和配置比较简单，测试起来比较方便；

4、也可以承担高的负载压力且稳定，一般能支撑超过1万次的并发；

5、Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测；

6、Nginx对请求的异步处理可以帮助节点服务器减轻负载；

7、Nginx能支持http和Email，这样就在适用范围上面小很多；

8、不支持Session的保持、对Big request header的支持不是很好，另外默认的只有Round-robin和IP-hash两种负载均衡算法。

HAProxy的特点是：

1、HAProxy是工作在网络7层之上。

2、能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作

3、支持url检测后端的服务器出问题的检测会有很好的帮助。

4、更多的负载均衡策略比如：动态加权轮循(Dynamic Round Robin)，加权源地址哈希(Weighted Source Hash)，加权URL哈希和加权参数哈希(Weighted Parameter Hash)已经实现

5、单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度。

6、HAProxy可以对Mysql进行负载均衡，对后端的DB节点进行检测和负载均衡。

最终形成比较理想的状态为：F5/LVS<—>Haproxy<—>Squid/Varnish<—>AppServer。
-->





# Virtual IP Address

简单来说，用户的请求会直接发送给 VIP，而拥有该 VIP 的是一个负载均衡器，而真正处理该请求的服务器，接收的是负载均衡器发送的转发请求。

通常来说，我们希望请求发送给压力最小的服务器，不过这种方法只适用于无状态的请求。对于有状态的请求，可以将报文中的某个字段做 hash，从而一个请求只会发送到相同的服务器。

不过这样仍然存在问题，假设之前的 hash 算法是 id mod N，那么如果一台机器宕机则成为 id mod (N-1) 从而导致当前处理的连接被重置，为此就需要一种 consistent hashing 算法。












<!--
IP负载均衡技术
http://zh.linuxvirtualserver.org/node/25
-->
