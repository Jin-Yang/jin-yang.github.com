<html><head>
<meta http-equiv="Content-Type" Content="text/html; charset=UTF-8"/>
<title>61641</title>
<link rel="stylesheet" type="text/css" charset="utf-8" media="screen" href="src/screen.css">
</head>
<body dir="ltr" lang="en">
<div id="round"><img src="src/cap-top.png">
<div id="page" dir="ltr" lang="en">
<br><br><br><h1>61641</h1><p></p>

    <h1 id="toc_0" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 28px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=61641" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库开发自助手册(面向研发)</a></h1><h2 id="toc_1" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">前言</h2><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">本文是为了方便研发同学快速找到跟数据库有关问题的答案，以免DBA繁忙时不能及时答复研发的问题降低彼此工作效率。<br style="-webkit-print-color-adjust: exact;"/>不过本文作用并不仅限于此。有兴趣的研发可以深入阅读。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">随着技术的进步，在不久的未来，跟业务有关的数据库的表设计、索引、SQL性能等都完全有可能由研发同学保障。实现这个目标需要DBA和研发共建，要很长时间，本文正是为此铺路。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:blue;-webkit-print-color-adjust: exact;">本文可能存在描述不清晰、不准确的地方，欢迎指出，一定改正。 谢谢！</span></p><h3 id="toc_2" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">索引</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="#idb" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">日常工作iDB相关</a>&nbsp;：解答跟idb有关的日常工作。包括：数据库升级、拆分、升级；数据库帐号授权变更、数据订正；数据库表结构变更发布；SQL Review细节； 数据查询；OB1.0相关咨询等。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="#other" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">日常其他</a>&nbsp;： 解答日常工作非idb相关的。包括：云梯回流、opensearch所需的帐号权限、以及业务帐号密码等；TDDL配置查询相关；单元化数据同步和数据质量相关的问题。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="#asset" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库资源评估</a>&nbsp;：解答申请新数据库时如何评估数据库资源；以及描述现有数据库资源信息查看参考。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="#diagnose" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库性能诊断</a>&nbsp;： 描述研发如何利用DBA工具（dbfree）观察、分析数据库性能。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="#sqltuning" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">SQL优化建议</a>&nbsp;： 描述SQL优化准备工作、思考方法和经验总结。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="#risk" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库风险评估</a>&nbsp;： 描述研发做跟数据库有关的事情（如表结构发布、云梯回流数据或者数据订正、opensearch拉数据等）时，如果评估其对数据库带来的风险。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a href="#troubleshooting" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">线上数据库问题分析</a>&nbsp;： 描述研发如何汇报、分析和处理线上数据库相关问题（如连接异常、死锁、sql性能异常等）。</p><h3 id="toc_3" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">结构图</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><img src="pictures/getTfsFile.dofilePath=TB18JeeJFXXXXblXVXXXXXXXXXX.png" alt="数据库开发自助" title="数据库开发自助" style="-webkit-print-color-adjust: exact; max-width: 100%;"/></p><h2 id="toc_4" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="idb"></a>日常工作iDB相关</h2><h3 id="toc_5" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库申请</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节解释的是研发同学新发应用，想申请新的数据库资源时，技术上需要做的一些事情。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">DBA推荐独立的应用使用独立的数据库，并且每个实例只有一个数据库（有多个分库不受此限制）。这是方便后期的运维。</p><h4 id="toc_6" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">首先，研发对自己的业务要有具体的了解。</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">研发对自己的应用的一些指标要能给出具体的描述。要关注的指标参见&nbsp;<a href="#appinfo" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">业务指标</a>&nbsp;。</p><h4 id="toc_7" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">第二，研发对dbfree提供的数据库资源规格有个了解。</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">dbfree是DBA的数据库管理平台，可以自动化分配出指定规格的mysql实例。<br style="-webkit-print-color-adjust: exact;"/>每个mysql实例可以根据业务重要性和访问压力综合决定是否独占主机资源。如库存应用、交易买家/卖家应用的实例都是独占一台主机，不支持混布（严格说是存在同一应用多个实例在一台主机上，这个不算混布）。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">由于电商的数据库主机环境并不实施资源隔离，所以物理机的cpu和io资源对各个实例都是共享式的，抢占式的。所以，决定不同规格mysql实例性能差异的关键因素就是内存大小。<br style="-webkit-print-color-adjust: exact;"/>电商实例混布时，线上mysql实例规格有三种：1G，10G和35G. 通常来说，DBA会选择10G的规格。如果研发感觉数据库访问压力会非常大，可以提出，选35G内存。如果研发感觉mysql只是个数据存储，应用访问压力很小，可以提出，选1G的规格。目的是在满足应用需求的情况下，充分利用主机的资源。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">至于为何规格是10G而不是20G，是35G而不是45G，只是资源管理上的方便。初期不需要深究。对于数据库资源是否满足应用需求，是需要运行一段时间后观察数据库指标才知道。然后，再针对性的调整数据库资源规格（升级或者降级）。要关注的数据库指标参见&nbsp;<a href="#dbinfo" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库指标</a>&nbsp;。</p><h4 id="toc_8" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">第三，字符集的评估。</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库和表的字符集一旦定了，应用上线后，再调整字符集就很麻烦，所以永远不考虑后期调整字符集这个选项。<br style="-webkit-print-color-adjust: exact;"/>现在默认都推荐用utf8。早期的数据库还有很多是gbk字符集，不利于国际化。如果业务很多表要存储表情字符，则推荐用utf8mb4。这个影响的数据库的默认字符集。<br style="-webkit-print-color-adjust: exact;"/>如果只是某个表需要用utf8mb4,则还是推荐默认用utf8，只是该表的字符集改为utf8mb4（iDB如果不支持，请dba操作）。之所以这样，是因为字符集会影响前缀索引的长度。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">在mysql里，前缀索引的长度在不同字符集下是不一样的。gbk下是383，utf8下是255，utf8mb4下是191. 顺带提一下，ob兼容mysql，ob默认字符集是utf8，除了utf8和utf8mb4，ob不允许使用其他字符集。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">有关数据库字符集更多有趣的知识参见&nbsp;<a href="http://www.atatech.org/articles/48619" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库字符乱码问题分析</a>&nbsp;。</p><h4 id="toc_9" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">第四，分表和分库的选择。</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">影响分表选择的因素是表的业务是否支持水平拆分、表的大小、表的访问量（QPS+TPS）。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">拆分的前提是表的业务有一个好的水平拆分维度。如买家id、商家id、订单id，都可以作为拆分的维度。业务SQL（尤其是OLTP型的sql），必须避免跨分表。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">表大小上一定规模后，无论是根据pk查询还是根据二级索引查询，sql的rt都会随着表的大小增长而增长，最终超出应用对数据库响应时间的需求。所以，表大了要分表。<br style="-webkit-print-color-adjust: exact;"/>表的访问量上一定规模后，对于根据二级索引查询，sql的rt会随着page读写冲突概率的增加而增长，最终超出应用对数据库响应时间的需求。所以，表的访问量高了也要分表。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">影响分库选择的因素也是表的大小、分表的数量、表的总访问量（QPS+TPS）<br style="-webkit-print-color-adjust: exact;"/>如果分表后所有分表的总大小占实例主机的可用存储规格的比例很高，则要分库，以免单库遭遇空间瓶颈。<br style="-webkit-print-color-adjust: exact;"/>如果分表的数量超出单个实例对分表数目的限制（idb限制的，一个经验值），则也要分库。其限制的原理也是担心大量的访问集中到同一个实例上，引起mysql内存级别的lock冲突概率增加，以及mysql实例的cpu和io利用率太高，导致sql的rt还是超出应用对数据库的需求。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;">分表分库也有负面影响，就是表结构变更相比单表麻烦，有一定风险。</span><br style="-webkit-print-color-adjust: exact;"/>iDB已经将分表的变更的技术复杂度大大降低，节省了研发和DBA的很多精力。但分表过多，表结构变更还是存在一些风险：如个别表变更失败导致分表结构不完全一致；表结构变更时间很长等等。所以研发对于分表结构的变更任务执行结果要特别注意，并采取适当的double check。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">分多少个表，分多少个库，研发自己跟其他应用参考对比一下决定。只要数量不是特别离谱，DBA不会干预。</p><h3 id="toc_10" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库拆分</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指的是针对早期的有多个数据库混布的实例（分库不在此列）</span><br style="-webkit-print-color-adjust: exact;"/>为了解决某些应用问题性能时，DBA可以将多个数据库从一个实例里分拆出去。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">dbfree支持数据库拆分自动化，对应用的影响就是某一时刻TDDL配置的变更。</p><h3 id="toc_11" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库升级</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指的是数据库从低版本升级到高版本的场景。</span><br style="-webkit-print-color-adjust: exact;"/>数据库升级的原因有：数据库版本相对最新稳定版本太低，不利于运维；数据库当前版本不满足业务需求而最新稳定版本满足。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">dbfree支持数据库升级自动化，对应用的影响也是某一时刻TDDL配置的变更。<br style="-webkit-print-color-adjust: exact;"/>升级流程参见&nbsp;<a href="http://beidou.corp.taobao.com/dbfree//Application/Dbfree/View/Public/Help/REPLACE_MS_TDDL.jpg" title="升级替换现有主备实例流程图" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">升级替换现有主备实例流程图</a>&nbsp;（了解即可）。</p><h4 id="toc_12" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">风险评估</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">从5.5升级到5.6的风险详情请参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=59282" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">升级5.6风险整理</a>&nbsp;。<br style="-webkit-print-color-adjust: exact;"/>需要应用升级相应的TDDL和jdbc的版本，以及排查分页排序SQL的写法。</p><h3 id="toc_13" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库帐号赋权</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指通过idb流程实现一些数据库帐号的赋权操作。</span><br style="-webkit-print-color-adjust: exact;"/>涉及到需要做帐号赋权操作的场景有：云梯回流，opensearch抽取数据。<br style="-webkit-print-color-adjust: exact;"/>由于iDB不直接支持帐号赋权操作，dba也不方便直接登录数据库操作，所以，可以通过iDB的数据订正流程实现账户的赋权。具体方法就是将赋权sql作为数据订正sql，提交给DBA执行。<br style="-webkit-print-color-adjust: exact;"/>赋权SQL的写法，详情参见&nbsp;<a href="#dbaccount" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库帐号相关</a>&nbsp;。</p><h3 id="toc_14" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="sqlreview"></a>SQL Review</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指的是为sql review需要做的技术工作。</span><br style="-webkit-print-color-adjust: exact;"/><span style="color:red;-webkit-print-color-adjust: exact;">这是关系到线上数据库性能的关键环节，也是数据库风险链条里比较脆弱的一环。</span></p><h4 id="toc_15" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">iDB sqlreview的优缺点</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">iDB解决了sqlmap文件的读取解析和管理，大大降低了sql review操作的便捷性。但是开发在绑定sqlmaps路径的时候需要尽可能的具体；否则，sqlreview的时候还是会引入很多无关的sqlmaps文件，从而让DBA无法快速识别变更的sql。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">iDB在sqlreview的时候引入了一些规则，但目前看离alphago的水平还有很大距离。所以，sqlreview质量的关键仍然是由审核人的水平决定。这个智能水平对研发人员并不算高，对程序是为难了点。<br style="-webkit-print-color-adjust: exact;"/>具体如下：</p><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>iDB并不能评估SQL访问表的一些跟性能有关的指标（如表的数据量、请求量）</p></li><li><p>iDB并不能识别SQL的查询场景组合（即连接条件和filter条件）。sqlmaps的动态条件组合换dba，也无法正确判断查询场景，只有研发人员最清楚（如果不清楚，说明PD的产品需求没有正确传递到研发的设计文档里）。</p></li><li><p>iDB并不能判断某些查询场景组合已经没有在线上使用了（即下线或者发生需求变更）。这点也只有研发人员最有可能清楚。</p></li><li><p>iDB并不能识别SQL对业务的重要程度。</p></li></ol><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">所以，sql review里通过sql审核，并不一定保证sql就一定没有问题。尤其是没有经过充分的分析就强制通过的sql，只不过是把问题的爆发留到上线后的环节里，转移了风险而已。</p><h4 id="toc_16" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">sql review需要的信息</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">sql review是一项智力活，并不是研发人员在iDB里提交sqlreview给DBA，DBA就可以准确review的。如上所知，iDB里传递的信息量很少。<br style="-webkit-print-color-adjust: exact;"/>正确的sql review需要以下信息：</p><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>表的访问类型分布（OLTP还是OLAP）、访问量分布（QPS\TPS）。分布通常指的24小时内的分布。个别sql如果在特定时间才会执行，也需要告知。</p></li><li><p>表的数据量、数据增量、读写比。表的数据量以及增量，都有可能改变sql的执行计划、执行时间。表的读写比也会影响实例的sql的rt的平均水平。</p></li><li><p>查询场景组合，各种组合的优先级。SQL的查询场景组合越多，情况越复杂，越难以保证每个场景的性能。这时候就需要对查询场景组合分个优先级出来。即当无法保证全部查询场景的性能的时候，则优先保证某些场景的性能。</p></li></ol><h4 id="toc_17" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">sql review的步骤</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">由于日常环境的数据量少，访问压力极低，在日常环境验证sql rt意义不大。所以重点放在执行计划的验证上。</p><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>根据上面信息，建合适的索引，变更到日常数据库环境。详情参见&nbsp;<a href="#index" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196); margin-top: 0px;">索引建议</a></p></li><li><p>编写可以运行的sql，查看其在日常数据库下的执行计划。详情参见&nbsp;<a href="#sqlplan" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196); margin-top: 0px;">执行计划</a></p></li><li><p>如果执行计划不是最优，则回滚（即删除）刚才的索引变更。重新尝试新的索引；如果执行计划很好，则该索引被采纳。</p></li><li><p>如此反复执行1-3，review完所有sql。</p></li><li><p>当表上的索引非常多的时候（如5个以上），根据查询场景组合的优先级，拿掉为优先级最低场景设计的索引。因为，索引太多，影响DML性能，且容易导致死锁。</p></li></ol><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">由此可见，sql review的成本其实很高，有两点：一是信息的沟通成本（研发&lt;-&gt;DBA）;二是执行计划的测试成本。</span>&nbsp;<br style="-webkit-print-color-adjust: exact;"/>所以，如果说研发效能还一定要继续提升的话，优化SQL Review的成本是一个很好的点。这也是我相信未来sql review 成为研发人员必备基本技能的重要原因。</p><h3 id="toc_18" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库DDL发布</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指通过iDB发布表结构的变更。</span></p><h4 id="toc_19" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">自助发布（dailyddl）和DBA发布</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">感谢iDB，普通实例的表结构变更，研发人员大部分可以通过iDB自助发布。普通实例个别表的数据量超出一定规模以及核心实例的表的变更，其变更仍由DBA执行发布。<br style="-webkit-print-color-adjust: exact;"/>是“普通”还是”核心”，在线上数据库申请的那一刻确定的，可能有些实例的定性不是很准。这个后期DBA可以修改，研发人员可以根据业务情况跟DBA商量调整。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">有关dailyddl的发布方法，请咨询研发同事，或者参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=13855" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">dailyDDL自助发布指南-for集团</a>。（最新以iDB PD倩薇解释为准）。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">长远的趋势，会进一步扩大研发人员自助发布范围，究竟放多大范围，这取决于“风险评估”的结果。</p><h4 id="toc_20" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">主键和唯一键</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">一般的业务表，都建议以id为主键，并设置为自增值。<br style="-webkit-print-color-adjust: exact;"/>对于分表，也是id为主键，但不使用自增值，而改为从TDDL Sequence取值，能够做到分表之间的全局唯一。其原理详情有兴趣的请参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=12593" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">单元化中的sequence设计</a>&nbsp;，&nbsp;<a href="http://baike.corp.taobao.com/index.php/TDDL_sequence" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">TDDL Sequence使用说明</a>&nbsp;。这是一个很不错的设计。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">个别表如果业务需要以其他字段为主键，只要设计上的理由充分就可以允许。先在idb里编辑一下表结构生成一个工单，然后把工单号发给DBA修改主键列即可。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">对于只是用于云梯回流业务的表，为了某些唯一性的需求，也可以允许以非id列作为主键，以及增加唯一约束列都可以。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">关于唯一键</strong><br style="-webkit-print-color-adjust: exact;"/>如果一个表既有id主键，又有其他列作为唯一键，这个要充分考虑到其影响。加唯一键之前要确保不存在数据冲突。<br style="-webkit-print-color-adjust: exact;"/>此外，在单元化的业务中，当发生中心和单元数据不一致的时候，DBA自助化的数据校验和订正系统是以主键为标准来比对数据的，暂时不支持以唯一键（代表了业务上的数据重复判断标准）去识别同一笔数据，同时数据订正暂时也不支持以唯一键去订正。<br style="-webkit-print-color-adjust: exact;"/>这是唯一键对单元化的影响。从设计上说，单元化业务表如果需要这样的唯一性（中心和单元间的唯一），那唯一键是很有必要的。</p><h4 id="toc_21" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">锁表和不锁表</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">在mysql 5.5及其以前的版本中，表结构的DDL变更期间，会全程对表加写锁，导致DML SQL（来自业务）会被阻塞。阻塞的时间取决于DDL变更的时间长度（这也是分表的一个益处。）。<br style="-webkit-print-color-adjust: exact;"/>在早期，DBA通过先在备库做DDL变更（屏蔽同步），然后主备切换，然后在新的备库做DDL变更，将对业务的影响（锁表）消除了。但是这种由于需要DBA人工操作，且分表很多的时候，效率极低，最终被放弃。<br style="-webkit-print-color-adjust: exact;"/>后来有一种方法是通过MyDDL。有关MyDDL的信息参见&nbsp;<a href="https://askdba.alibaba-inc.com/courser/control/getQueryResult.do?q=myddl&page=1" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">MyDDL相关总结</a>。有些场景是MyDDL解决不了的。最关键的是，单元化Unit类型的实例的表结构变更用MyDDL，会导致单元的数据丢失。所以，在有了onlineddl后，MyDDL也被放弃。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">自MySQL 5.6开始支持Online DDL，即变更时不锁表。Online DDL的诞生大大提升了表结构变更的效率，提升了DBA规模化运维的效率和研发项目发布的效率。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;"><strong style="-webkit-print-color-adjust: exact;">注意：</strong><br style="-webkit-print-color-adjust: exact;"/>1. 这里说的不锁表是指变更全程内绝大部分时间不会锁表。但是严格的说，由于涉及到元数据的变更，在onlineddl的某个环节还是会对表加写锁，只不过持有时间非常短,跟应用DML的相互影响极小。<br style="-webkit-print-color-adjust: exact;"/>在尝试加锁期间，如果表上有事务或者其他会话对表的某些记录加锁不释放的话，OnlineDDL也是会被阻塞等待（具体State信息是：<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">Waiting for table metadata lock</code>）。<br style="-webkit-print-color-adjust: exact;"/>2. Online DDL并不适合所有的场景。即使在5.6的版本里，有些DDL变更也不适用Online DDL。具体是否适用iDB会在你提交变更的那一刻给出提醒（这里有个坑，见后面描述！）。OnlineDDL的变更适用规则详情参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=30021" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">Online DDL适用的DDL类型规则 —— 截至5.6.16.7信息</a>。研发人员必须详细了解该细则，尽量避免陷入Online DDL的盲区，尤其是核心实例、分表很多或者有单元化业务的表的变更。<br style="-webkit-print-color-adjust: exact;"/>3. OnlineDDL 在变更有唯一键的表的时候，即使变更内容跟唯一约束没有关系，也可能会报数据重复导致变更失败。这是一个bug，目前没有办法解决，只能取消onlineddl选项，改为以锁表的方式进行变更。对于分表很多的带有唯一键的表。碰到这个bug的概率还是很高的。详情请参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=34721" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">Online DDL中加列出现duplicate entry报错问题</a>&nbsp;。<br style="-webkit-print-color-adjust: exact;"/></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">iDB判断OnlineDDL的坑：</strong><br style="-webkit-print-color-adjust: exact;"/>1. 当日常mysql实例是5.6而线上版本还是5.5的时候，研发容易误判。所以，DBA会力主升级线上实例到5.6 。同时，研发对所负责应用线上实例的版本也要了解。<br style="-webkit-print-color-adjust: exact;"/>2. 当线上主备实例的版本不一致（其中一个低于5.6）或者单元化实例的中心和单元的版本不一致，也会导致“复制”传递到其中一个5.5的实例时发生锁表，会导致备库或者单元数据有延时。这是DBA运维的风险，所以，DBA也力主升级线上实例到5.6 。该情况存在于一些历史悠久的实例里。其应用也存在类似麻烦（TDDL或者jdbc版本过低）。</p><h4 id="toc_22" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">风险评估</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">DDL变更的风险除了上面说的可能存在锁表外，还有其他的风险，详情请参见&nbsp;<a href="#risk" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库风险评估</a>&nbsp;。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;">研发人员发起的变更可能需对此风险的发生承担全部或者部分责任。所以，请务必详细了解，不确定的地方请跟业务DBA确认。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;">#### 变更时间</span></p><p><span style="color:red;-webkit-print-color-adjust: exact; font-family: Helvetica, arial, sans-serif; font-size: 14px; widows: auto; background-color: rgb(255, 255, 255);"></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px;">数据库团队合法的变更时间是： 16:00-19:00， 00:00-06:00. 所有变更（包括自助发布的变更）请严格限制在这个时间段。<br style="-webkit-print-color-adjust: exact;"/>其他时间段如果非要发布，请点&nbsp;<a href="http://psp.alibaba-inc.com/paas/emergency/emergencyIndex.htm" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">此链接</a>&nbsp;申请封网期间紧急变更。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px;">对流程有异议的，请参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=54301" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">技术保障 运维红线3.0</a>&nbsp;。 一言蔽之，DBA不遵守流程，后果很严重。<br style="-webkit-print-color-adjust: exact;"/>所以，请尽量提前一天发布变更，以免耽误应用发布。请不要让DBA为难。</p><p><br/></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;"></span></p><h3 id="toc_23" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库DML订正</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指研发发起的针对业务表的数据订正。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据订正有三个问题需要注意。</p><h4 id="toc_24" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">安全问题</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">业务表在安全上是分级的，针对敏感表以及敏感字段的订正可能需要特别的权限，具体按iDB提示执行。<br style="-webkit-print-color-adjust: exact;"/>研发人员需要依此掌握订正的风险。</p><h4 id="toc_25" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">性能问题</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">订正sql不仅要功能正确，还要考虑性能问题。<br style="-webkit-print-color-adjust: exact;"/>如果没有走上合适的索引，sql性能就会不好，执行时间长，对相关记录加锁的时间就长，可能会阻塞业务的DML SQL，甚至触发死锁事件。<br style="-webkit-print-color-adjust: exact;"/>性能问题应对方法参见后面&nbsp;<a href="#sqltuning" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">SQL优化</a></p><h4 id="toc_26" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">回滚SQL</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">变更流程要求，任何变更都要有回滚方案；除非明确说明不需要回滚。<br style="-webkit-print-color-adjust: exact;"/>对于DML SQL，回滚SQL也很有必要，以防止订正产生故障以及快速从故障里恢复。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">研发人员常犯的错误就是回滚SQL跟订正SQL一样，即偷懒。这表示方案不成熟、不完善。审批的主管需要杜绝这一现象。（如果不需要回滚，需要明确写明理由）。</p><h4 id="toc_27" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">风险评估</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">DML SQL除了上面说的性能问题导致lock冲突概率增加的风险外，还有一类风险就是事务过大。详情请参见&nbsp;<a href="#risk" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库风险评估</a>&nbsp;。<br style="-webkit-print-color-adjust: exact;"/>研发人员可能要对数据库订正DML SQL带来的风险承担全部或者部分责任。</p><h3 id="toc_28" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库查询</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指的是通过iDB发起的数据库查询。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">为避免影响线上mysql主库，iDB里的mysql数据源的查询都是针对备库的。iDB里开发看到的数据源的IP也是备库的IP。（变更任务里的ip是主库的IP）。<br style="-webkit-print-color-adjust: exact;"/>通常情况下，备库跟主库间的延时很短（1s内），研发人员通过iDB查询的数据基本是跟主库数据是一样的，是可靠的。<br style="-webkit-print-color-adjust: exact;"/>但是，不排除在特殊的场景下，备库出现大量延时，导致iDB里查询的数据不是最新的。 研发人员通过iDB查询数据诊断分析业务问题的时候，需要考虑到延时的可能性。<br style="-webkit-print-color-adjust: exact;"/>研发人员可以联系DBA确认当前备库的延时。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">备注：</strong>&nbsp;备库的延时问题首先是DBA运维的责任，但是DBA只能从主机和实例层面去保证备库的性能，进而控制备库的延时，但是不能应对主库短时间内发生大量的数据变更（如云梯回流、表结构加字段带默认值变更导致）。这是一种源头不在自己手里无法控制但责任要自己承担的例子。研发同学需要了解这个原理，并给予一定的理解支持。详情请参见&nbsp;<a href="#risk" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库风险评估</a>&nbsp;。</p><hr style="-webkit-print-color-adjust: exact; border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC); background-color: rgb(255, 255, 255); background-position: 0px 0px; background-repeat: repeat-x;"/><h2 id="toc_29" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="other"></a>日常其他</h2><h3 id="toc_30" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="dbaccount"></a>数据库帐号相关</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库在初次创建的时候，会自动创建一个业务帐号（跟&nbsp;<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">db_name</code>&nbsp;相同）,密码随机并传递给 TDDL 配置里。DBA对这个帐号的密码是什么一无所知，也不需要知道。<br style="-webkit-print-color-adjust: exact;"/>应用连接数据库必须通过TDDL配置，这样研发人员也不需要知道密码。如果没有非常特别的理由，应用都应遵循这一规则。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">日常环境的数据库开发，研发同学可以使用帐号直连数据库，获取日常数据库用户名密码参考&nbsp;<a href="http://www.atatech.org/articles/47596" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">如何获取日常数据库用户名密码</a><br style="-webkit-print-color-adjust: exact;"/>获取线上数据库用户名密码请戳&nbsp;<a href="https://changefree.alibaba-inc.com/changefree/index.html" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">这个链接</a>&nbsp;提工单。<br style="-webkit-print-color-adjust: exact;"/>接口人：梦实。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">云梯回流业务，需要使用tbdw帐号对相关表有增删改查权限，如果要通过truncate table清理数据的话，还需要create table和drop table权限。相关细节请参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=36122" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">云梯和ODPS通过tbdw帐号回流数据库没权限的问题</a></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">opensearch 使用的是tbdump帐号，需要对要访问表有只读权限。opensearch使用两种帐号体系，一个是自带的，密码都是统一的。研发不需要指定。dba保障数据库上有该密码。密码是什么DBA并不知道。但是开发可以通过在iDB里提数据订正，写入grant 语句（sql由dba提供，里面会有密码的密文），选择dba执行实现。 opensearch详情参见&nbsp;<a href="http://www.atatech.org/articles/41200?commentId=90432&msgid=807984" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">TDDL用户接入OpenSearch流程</a>&nbsp;。</p><h3 id="toc_31" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">TDDL配置</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">TDDL 是中间件团队的产品，有效的解决了mysql分库分表给应用读写表带来的难题。详情参见&nbsp;<a href="http://gitlab.alibaba-inc.com/middleware/tddl5-wiki/wikis/QuickStart" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">TDDL新生入门指南</a>&nbsp;，&nbsp;<a href="http://gitlab.alibaba-inc.com/middleware/tddl5-wiki/wikis/TDDL-Validator" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">TDDL问题排查</a>&nbsp;。<br style="-webkit-print-color-adjust: exact;"/>研发人员需对TDDL有初步了解，有疑难问题请联系 TDDL接口人：梦实 。 DBA对TDDL的解释仅供参考。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">TDDL配置的推送跟diamond密切相关。diamond如果异常了，应用端的TDDL配置的正确性就需要重新评估。详情咨询 TDDL接口人：梦实 。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">研发人员可以跟DBA确认是否使用了正确的TDDL配置，是否连接了正确的数据库。 如果DBA确认TDDL配置正确，但是应用不能获取正确的配置，则请咨询 TDDL接口人：梦实 。</p><h3 id="toc_32" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">单元化相关</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节解释单元化的架构、数据同步、对变更的影响、风险评估相关</span></p><h4 id="toc_33" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">单元化分类</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">真正单元化的业务在中心（上海）有一个数据库，在单元（深圳、杭州（即将裁撤）、张北（即将启用））也分别有一个数据库。这就涉及到数据同步问题（包括表结构和数据的同步）。<br style="-webkit-print-color-adjust: exact;"/>其中Unit类型的，单元是封闭的（即无论中心还是单元，都可以独立读写），如交易的买家应用。虽然是封闭的，目前中心和单元都有全部的数据。在未来，某些单元可能只保留部分数据。<br style="-webkit-print-color-adjust: exact;"/>Copy类型的，单元是非封闭的。写在中心，读在单元。读有可能有延时，取决于单元间的数据同步性能。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">有关单元化的详情介绍请参见&nbsp;<a href="http://www.atatech.org/articles/45293" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">数据库同城与异地多活架构概述</a>&nbsp;。</p><h4 id="toc_34" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">单元化环境和TDDL配置问题</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">全部环境共有： 正式（指上海）、预发（指上海）、杭州APP单元、杭州预发单元、深圳APP单元、深圳预发单元、深圳冷备单元； 还有 杭州DB单元、深圳DB单元</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">一个完全的单元化业务（UNIT和COPY）类型，在上海、杭州和深圳都有 正式环境（也叫APP单元），上海会有一个预发环境。杭州的预发和深圳的预发由应用自己选择是否需要。&nbsp;<br style="-webkit-print-color-adjust: exact;"/>TDDL配置可以从一个环境推送到另外一个环境。从非正式环境推送到正式环境需要谨慎。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">有些应用，在杭州和深圳部署了应用，但是数据库并没有做单元化部署，依然在上海。为了应用能够运行，在杭州和深圳的APP单元会为这些应用推送TDDL配置。<br style="-webkit-print-color-adjust: exact;"/><strong style="-webkit-print-color-adjust: exact;">缺点</strong>就是，上海的数据库如果发生主备切换，杭州APP和深圳APP单元的TDDL配置并会联动，所以杭州的应用和深圳的应用如果写数据库（严格说不能有写请求），会报数据库只读错误。<br style="-webkit-print-color-adjust: exact;"/>这时候需要联系DBA更新杭州和深圳APP环境的TDDL配置。</p><h4 id="toc_34" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">单元间的同步</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">电商单元化业务的中心和单元之间的数据同步是通过DRC实现。有关DRC的详情介绍请参见&nbsp;<a href="http://www.atatech.org/articles/46181" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">DRC前世今生</a>&nbsp;。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;"><strong style="-webkit-print-color-adjust: exact;">这里要注意的是：</strong><br style="-webkit-print-color-adjust: exact;"/>1. 单元和单元之间不能直接同步，单元只能跟中心做同步。<br style="-webkit-print-color-adjust: exact;"/>2. 单元间同步的能力是有个限度（好像是TPS 4K/秒左右）。任何一个大表的全量数据更新必然会导致该单元的实例产生数据延时。所以，务必杜绝这种场景的发生。<br style="-webkit-print-color-adjust: exact;"/>3. 不要更新表的主键，这个会导致DRC的同步任务挂掉。</span></p><p><span style="color:red;-webkit-print-color-adjust: exact; font-family: Helvetica, arial, sans-serif; font-size: 14px; widows: auto; background-color: rgb(255, 255, 255);"></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;"></span></p><h4 id="toc_35" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据质量</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">Unit类型的单元化业务的多点写入的功能，在<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">切流</code>的时候很容易导致中心和单元的数据不一致问题，还不一定好修复。做单元化业务的研发，有必要了解这个细节，以控制风险。详情请参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=53221" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">单元化业务数据质量问题总结</a>&nbsp;。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">DBA为数据交易提供了 全量校验平台（TCP）和增量校验平台（AMG）。其中增量校验使用经验详情参见&nbsp;<a href="http://www.atatech.org/articles/44409" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">AMG库存交易对账系统</a>&nbsp;，各个业务可以和AMG对接以实现业务数据的校验和订正。</p><h3 id="toc_36" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">OB1.0相关</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">OB1.0是分布式数据库，非常适合云业务。其优势更多的体现在运维层面。对业务研发而言，OB1.0的分区表（不需要分库分表）功能、扩展功能是最值得期望的功能。最适合应用场景：历史库。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">相比MySQL 5.7，Oracle 12c， SQL Server 2014而言，OB 1.0 还只是发育中的小孩。对运维而言，其大规模集群的稳定性、分区表的维护性还有待考验。对应用而言，支持的mysql 类型和语法还有限，sql的rt 相对于alisql还是高出很多。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">OB1.0目前在集团上线的应用是行业互动的5个应用：母婴、数码、digitalwatcher、qs和 TBQUALITY。都是访问量不大，对sql rt要求不高的应用。另外准备上线中的有交易历史库的买家和卖家集群。OB1.0在蚂蚁将大面积使用，已经上线和正在上线的应用有 userview，acclog，花呗等等。这是OB研发团队重点保障的项目。<br style="-webkit-print-color-adjust: exact;"/>所以，2016年双11之前，OB研发团队会重点保障蚂蚁项目，对于集团的OB1.0业务不会做功能方面的研发支持。DBA暂时也不会受理新的上线OB1.0需求。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">不过研发可以提前针对OB1.0做一些技术了解和储备。 概况参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=51101" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">OB学习手册</a>&nbsp;。OB的运维特性参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=54781" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">OB1.0资源动态调整技术原理和运维总结</a></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">交易在线应用针对OB1.0.4做过一次压测，详情参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=59621" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">交易在线应用压测OB 20160407报告</a>&nbsp;。</p><hr style="-webkit-print-color-adjust: exact; border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC); background-color: rgb(255, 255, 255); background-position: 0px 0px; background-repeat: repeat-x;"/><h2 id="toc_37" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="asset"></a>数据库资源评估</h2><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指的是如何评估申请的数据库资源规格，以及如何观察分析现有的数据库资源跟应用的关系。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">首先，要了解业务对数据库的需求，需要一些指标的数据。<br style="-webkit-print-color-adjust: exact;"/>然后，是了解数据库的能力，也需要一些指标。<br style="-webkit-print-color-adjust: exact;"/>前后两个指标并无确定的关系，主要靠经验总结和实际分析。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;"><code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">度量</code>是<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">分析</code>的前提。</strong></p><h3 id="toc_38" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="appinfo"></a>业务指标</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指的是描述业务压力特征的一些指标。能说清楚业务的下面指标，是研发同学对自己业务系统掌控程度的表现，是“知己”的标准。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">业务包括：</p><ul style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>访问类型分布</p></li></ul><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">指应用访问数据库的请求类型是OLTP型（请求数由应用页面的PV决定，每个请求处理的是小范围的数据，执行时间要求很短（1s以内），读写比固定）、OLAP型（请求数由要分析的数据量决定，每个请求处理的数据量很大，执行时间很长（大于1s）），以及二者的混合。<br style="-webkit-print-color-adjust: exact;"/>如果该访问类型分布还跟时间段有关，则还包括24小时内不同时间段的访问类型分布。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">知道访问类型，就可以对数据库要面临的压力有个大概的了解。</p><ul style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>访问量</p></li></ul><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">指应用访问数据库的QPS（读）、TPS（写，精确到insert、update、delete更好）、读写比等。<br style="-webkit-print-color-adjust: exact;"/>如果该访问量特征还跟时间段有关，则还包括24小时内不同时间段的访问量分布。</p><ul style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>应用容量</p></li></ul><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">指会部署多少个应用会话（具体指java实例数），每个tddl配置的最小和最大连接数，超时时间等。</p><ul style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>RT要求</p></li></ul><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">指业务对SQL的响应时间的要求，具体为多少毫秒以内。应用的数据库调用链中一般都存在多个接口的调用，都有一定的超时机制。SQL的RT如果超过其中任一个超时时间，就变得没有意义。</p><ul style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>故障影响</p></li></ul><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">指如果这个应用出现数据库访问故障，其影响是什么级别。P1?P2?P3?P4? 不同的故障级别，处理问题的策略不同。<br style="-webkit-print-color-adjust: exact;"/>如果应用的故障级别跟具体模块有关，则具体到模块。</p><h3 id="toc_39" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="dbinfo"></a>数据库指标</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指的是研发通过iDB可以了解的数据库指标。读懂数据库的性能指标，是研发掌握数据库优化技能的其中一个关键点，是“知彼”的标准。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">在iDB里查询一个数据库，在结果集的<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">操作</code>一列里，点<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">主库性能</code>，可以查看主库的数据库性能指标。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">实例性能监测示例（同一个实例尽量避免多个会话同时运行）：<br style="-webkit-print-color-adjust: exact;"/><img src="pictures/getTfsFile.dofilePath=TB1Q9ODJFXXXXXOXXXXXXXXXXXX.png" alt="实例性能监测" title="实例性能监测" style="-webkit-print-color-adjust: exact; max-width: 100%;"/></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">指标包含：</p><h4 id="toc_40" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">主机load信息</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">有些核心实例是独占主机的，大部分实例是混布的。主机load表示实例所在的主机压力情况。其load高可能跟该实例的性能有关系或者没有关系，但其load高很可能会影响该实例的性能（需要实例性能数据佐证）。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">load高的源头有两类，一是cpu的user利用率冲高，表示cpu确实很忙；一是cpu的iowait利用率冲高，表示io很忙，cpu在等待io导致load的队列积压。 不过暂时还无法从iDB的性能数据里看到这点。这是iDB需要改进的地方。</p><h4 id="toc_41" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">sql访问量信息</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">值sql的select/insert/update/delete在单位时间内的数据及趋势。<br style="-webkit-print-color-adjust: exact;"/>由此可以看出读写比。对于读比写多或者写比读多，或者二者差不多，都跟业务有关系。长时间的观察后，研发结合该数据库上的业务有能力看出其背后的原因。而当这个读写比发生变化甚至具体的某一项发生变化的时候，即为“异常”，即表示业务有变化，就需要确认是正常现象还是异常现象。</p><h4 id="toc_42" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">实例的平均RT（response time）信息</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">这里指的是该实例每个采集时刻的SQL的平均RT水平，不同时间段会有些许变化。<br style="-webkit-print-color-adjust: exact;"/>注意，它是一个平均值。平均值的统计意义是在一段范围或者全局范围内观察一个系统的性能状况。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">平均值也有”统计陷阱”。一个或一小部分sql很高的rt，可能会拉高平均rt水平。sql读写比的变化也会改变平均rt的水平（因为通常写sql的rt是高出读sql的rt的一倍。）所以，反过来结合sql的访问信息的变化和rt的变化，也可以推测其背后的原因。<br style="-webkit-print-color-adjust: exact;"/>为了避免这个陷阱，DBA的orzdba工具是在统计的时候还支持显示去除两端1%的数据，显示99%的数据的平均rt，以及去除两端5%的数据，显示95%的数据的平均rt。这样比较三个rt值可以看出是否有个别慢SQL拉高了平均rt水平。</p><h4 id="toc_43" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">innodb rows 信息</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">这里指的是 read/insert/update/delete的行数。结合select/insert/update/delete sql的个数一起分析。当二者比例失调的时候，很容易发现某些查询sql单次查询或者更新了大批量数据。很有可能就是open search在拉数据或者是一个sql更新了大批量数据。</p><h4 id="toc_44" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">连接会话信息</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">这里指的是数据库上活动连接和已连接（非活跃）的个数。活动与否取决于采集那一刻的状态。SQL的rt都非常低的时候，活动的连接会很少。一旦这个数据发生大范围的抖动，可能是业务访问流量突增或者有慢sql。</p><hr style="-webkit-print-color-adjust: exact; border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC); background-color: rgb(255, 255, 255); background-position: 0px 0px; background-repeat: repeat-x;"/><h2 id="toc_45" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="diagnose"></a>数据库性能诊断</h2><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">这里指的研发角度诊断数据库性能的方法。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">研发只能从DBA平台提供给研发的信息里去诊断数据库，虽然相比DBA角度看到的信息而言是少了点，但还是能够独立于DBA提前发现一些性能问题及其原因。<br style="-webkit-print-color-adjust: exact;"/>性能诊断需要长期实际，总结经验。这里只是简述经验。</p><h3 id="toc_46" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">慢SQL诊断</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">iDB里查询数据库后，在结果集的<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">操作</code>一列里，点<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">慢日志诊断</code>，可以看到一些慢SQL的信息。<br style="-webkit-print-color-adjust: exact;"/>当前这一块功能还不是很完善，实时性不高，展现形式也不是很好。研发同学可以从这里先发现一些明确看出有问题的SQL进行优化。然后可以问DBA要一个展现形式好的某个时间段的慢SQL报告。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">从慢SQL报告里，重点关注SQL的执行次数、执行时间和消耗时间、扫描的行数和返回的行数及二者比例等。这些可以判断这个慢SQL的严重程度和影响。</p><h3 id="toc_47" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">QPS/TPS诊断</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">实例运行一段时间后，只要业务在一段时间内是稳定的，实例的QPS和TPS水平就了解了。一旦在某个时间点QPS和TPS值不同于寻常，就意味着背后有什么“异常”发生。就需要及时分析和应对。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">常见场景有：</strong></p><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>慢SQL或者高并发的SQL（性能不好）导致实例所在主机IO利用率高，引起实例其他SQL的rt增加，从而正常SQL的QPS和TPS出现下跌。当然，业务的异常也可能引起QPS和TPS的下跌。需要综合分析。解决办法：优化SQL。</p></li><li><p>前端tair故障或者有刷单没有被拦截导致数据库的QPS和TPS暴增，引起数据库的CPU或者IO利用率飙高，性能下降。解决办法：DB临时针对SQL限流，研发查明原因并修复，DBA解除SQL限流。</p></li></ol><h3 id="toc_48" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">RT诊断</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">RT就类似数据库实例的<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">体温</code>。RT增高，原因有多种可能，前面有描述“统计的陷阱”。<br style="-webkit-print-color-adjust: exact;"/>所以平均RT增高，需要尽快定位到慢SQL，以及流量异常的SQL。查明原因，修复问题，RT就会恢复到正常水平。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">至于多少ms才是一个正常的RT水平，每个应用对数据库的RT要求不一样，每个数据库实例的RT水平也不一样。需要长期观察才能了解。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">每一个应用发布时，建议研发先预测一下这个应用发布后会引起RT多大范围的变化，然后观察一周验证一下自己的判断。如此反复积累，假以时日，研发必可以从RT的细微抖动上做到“见微知著”。</p><h3 id="toc_49" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">连接诊断</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">这里指的是在应用没有爆发连接问题之前，提前从一些性能数据里去分析预判是否有这个问题。</p><h4 id="toc_50" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">TDDL连接</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">alisql 的实例可以支持上万个数据库连接。当应用服务器数量非常多并且单个实例上有很多分库的时候，平均分摊到每个java实例的tddl连接池中的最大连接数并不高。普通实例默认都是10个左右，核心实例（应用访问量非常高的应用），每个tddl配置可能只分摊到3-5个连接。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">TDDL连接示例：</strong><br style="-webkit-print-color-adjust: exact;"/><img src="pictures/getTfsFile.dofilePath=TB1NnyAJFXXXXaPXXXXXXXXXXXX.png" alt="tcbuyer_app tddl连接配置示例" title="tcbuyer_app tddl连接配置示例" style="-webkit-print-color-adjust: exact; max-width: 100%;"/></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">TDDL连接池跟jboss连接池原理差不多，参数名也很类似。对于上图所列的参数，研发同学有必要了解其意义和影响。尤其是各种timeout参数的生效范围。</strong>&nbsp;有兴趣的参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=59221" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">MySQL Communications link failure 问题记录分析</a>&nbsp;。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">各个应用都应该在Alimonitor 针对TDDL连接池配置监控，以监控tddl连接池的activeconnection。如果频繁的达到max值，这说明可能有慢sql导致连接不够。应对方法：优化sql 或者提升max值。</p><h4 id="toc_51" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">mysql 会话状态</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">在mysql里运行：<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">show processlist</code>&nbsp;。可以查看所有连接的状态，重点关注那些活跃连接的状态，分析其状态。不过目前iDB还不支持展示这个功能。这部分暂时先联系DBA分析。</p><hr style="-webkit-print-color-adjust: exact; border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC); background-color: rgb(255, 255, 255); background-position: 0px 0px; background-repeat: repeat-x;"/><h2 id="toc_52" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="sqltuning"></a>SQL优化建议</h2><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">这里指的是sql的执行计划优化和索引调整。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">之所以要优化sql，有两个原因：<br style="-webkit-print-color-adjust: exact;"/>1. 业务对该sql的响应时间有要求（在某个值以内，单位毫秒）。更低的rt才可能支撑更高的并发。<br style="-webkit-print-color-adjust: exact;"/>2. 该sql的rt高可能导致其他sql的rt也会变高，引起恶性循环。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">优化sql的步骤也就两步：一、分析现有业务指标和sql执行计划；二、改写sql写法或者调整索引。反复执行这两步。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">SQL优化的经验很多，后面会专门给研发同学培训。这里只是简介。</span></p><h3 id="toc_53" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">业务信息</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">优化一个SQL，首先必须了解该SQL的业务信息。代表什么业务，多久执行一次，QPS多少，RT要求多少。RT变慢直接影响是什么。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">实际工作中，最麻烦的就是查询页面的优化。查询页面的查询条件很多，可以任意选择，排列组合很多。这里有一些经验：<br style="-webkit-print-color-adjust: exact;"/>1. 这需要PD在整理需求的时候，尽可能的减少组合的场景或者尽可能多的增加必选字段。<br style="-webkit-print-color-adjust: exact;"/>2. 对于有时间范围的查询，尽可能的给出一个默认值，并尽可能的在满足业务需求的前提下缩小时间的跨度。要知道返回几千几万笔记录分了20-200页给用户这样的结果意义并不大。<br style="-webkit-print-color-adjust: exact;"/>3. 页面加载时，尽量避免load数据。因为此时用户还没有输入查询条件，这种查询性能不大可能好，不一定有意义。<br style="-webkit-print-color-adjust: exact;"/>4. 分页查询的时候务必指定排序字段，排序字段的组合要能保证唯一性。比如按照时间排序的时候，就在排序字段后面加上主键。这是为了规避分页排序的一个问题。</p><h3 id="toc_54" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">SQL写法</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">SQL的写法主要是指sql join的写法、子查询的写法、分页排序的写法、以及where查询条件的写法。</p><h4 id="toc_55" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">sql join</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">mysql join的算法通常都是 nest loop join。 本质就是2层嵌套循环，外层循环次数要尽可能的少，内存循环的rt要尽可能的小，这样nest loop join效率才最高。<br style="-webkit-print-color-adjust: exact;"/>所以，join的条件，where里的filter的条件就至关重要。</p><h4 id="toc_56" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">子查询</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">尽量少用 in（子查询）或 not in（子查询），改用跟子查询做 join。</p><h4 id="toc_57" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">分页排序</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">前端页面的分页大小一般是固定的50个，那就尽可能的让where里的filter条件尽可能的多，以方便建对应的索引，缩小查询扫描的行数。<br style="-webkit-print-color-adjust: exact;"/>另外，排序的字段组合要保证唯一，以规避分页排序的漏数据或者数据重复的问题。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">后端定时任务，分页大小取大一点，1K行，1W行，5W行都可以，尽量减少循环的次数。并且定时任务尽量放在低峰期。</p><h4 id="toc_58" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">filter条件</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">where里的条件要尽可能的过滤性大点。status列作为条件意义不是很大（除非是定位占比很小的status数据）。尽可能结合业务和数据库性能两方面去考虑查询条件的限制。只考虑业务，不考虑数据库性能，查询很慢甚至超时最终也是白费功夫。</p><h3 id="toc_59" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">索引建议</h3><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>索引优先为重要的，或者QPS(含TPS）占比很大的SQL服务。</p></li><li><p>索引太多对查询很有好，对DML性能不友好。</p></li><li><p>status列不适合单独做索引，多个status组合也不一定适合做索引，因为扫描的行数很多。</p></li><li><p>多个单列索引跟组合索引的功效并不对等。滥用单列索引会适得其反。尽量多用组合索引。组合索引（a,b）能覆盖只针对a列的查询，但不能覆盖只针对b列的查询。</p></li></ol><hr style="-webkit-print-color-adjust: exact; border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC); background-color: rgb(255, 255, 255); background-position: 0px 0px; background-repeat: repeat-x;"/><h2 id="toc_60" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="risk"></a>数据库风险评估</h2><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">这里指的是研发对数据库做变更、相关任何任务时需要评估的数据库风险。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;">风险无处不在。</span></p><h3 id="toc_61" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">DDL变更风险</h3><h4 id="toc_62" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">create table</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">单个create table风险很低，列类型尽可能的适用，不过度（比如说字符串长度都一律定义为512，就是过度），少用text类型。<br style="-webkit-print-color-adjust: exact;"/>分表的create table 风险还在于分表的数量，也很低。单个实例如果短时间内创建上千个分表，避开业务高峰期即可。</p><h4 id="toc_63" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">alter table</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">alter table 首先要判断是否锁表。如果业务对该表访问很高，锁表阻塞业务dml sql的概率就很大，可能引起故障，需要充分评估。因此锁表的变更一律放到业务低峰期操作。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">通常在mysql 5.6的版本里，可以使用onlineddl变更（iDB会自动判断是否锁表），不锁表。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:red;-webkit-print-color-adjust: exact;"><strong style="-webkit-print-color-adjust: exact;">注意：</strong><br style="-webkit-print-color-adjust: exact;"/>1. 这里说的不锁表是指变更全程内绝大部分时间不会锁表。但是严格的说，由于涉及到元数据的变更，在onlineddl的某个环节还是会对表加写锁，只不过持有时间非常短,跟应用DML的相互影响极小。<br style="-webkit-print-color-adjust: exact;"/>在尝试加锁期间，如果表上有事务或者其他会话对表的某些记录加锁不释放的话，OnlineDDL也是会被阻塞等待（具体State信息是：<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">Waiting for table metadata lock</code>）。<br style="-webkit-print-color-adjust: exact;"/>2. Online DDL并不适合所有的场景。即使在5.6的版本里，有些DDL变更也不适用Online DDL。具体是否适用iDB会在你提交变更的那一刻给出提醒（这里有个坑，见后面描述！）。OnlineDDL的变更适用规则详情参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=30021" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">Online DDL适用的DDL类型规则 —— 截至5.6.16.7信息</a>。研发人员必须详细了解该细则，尽量避免陷入Online DDL的盲区，尤其是核心实例、分表很多或者有单元化业务的表的变更。<br style="-webkit-print-color-adjust: exact;"/>3. OnlineDDL 在变更有唯一键的表的时候，即使变更内容跟唯一约束没有关系，也可能会报数据重复导致变更失败。这是一个bug，目前没有办法解决，只能取消onlineddl选项，改为以锁表的方式进行变更。对于分表很多的带有唯一键的表。碰到这个bug的概率还是很高的。详情请参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=34721" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">Online DDL中加列出现duplicate entry报错问题</a>&nbsp;。<br style="-webkit-print-color-adjust: exact;"/></span></p><h4 id="toc_64" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">drop/truncate table</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">iDB是不支持drop table的。通常也不会删除表。但某些大表由于占用了很大的空间而这个表在业务里已经确认没有使用的时候，DBA和研发可能会考虑drop table或者truncate table 以释放空间。优选truncate table。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">truncate table的风险（drop table同理）在于短时间内删除大量数据，会在mysql里持续很长时间，很可能引起mysql的buffer pool内存的抖动。以及会引起文件系统的page cache的抖动导致主机io rt不稳定。<br style="-webkit-print-color-adjust: exact;"/>有时候会用drop table 代替，因为dba有特殊的方法可以让drop table在mysql里瞬间完成，然后在主机层面去删文件内容数据，释放pagecache里的数据（持续很长时间）。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">总之，drop table和truncate table 不是像表面想的那么简单。避免出现这样的大表是研发首先应该考虑的。</p><h3 id="toc_65" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">空间容量风险</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">线上实例由于多是混布，因此对实例空间增长预测很复杂，准确度不高。<br style="-webkit-print-color-adjust: exact;"/>研发要尽量保证业务实例的数据增长处于可控、合理的范围内。<br style="-webkit-print-color-adjust: exact;"/>但有一个业务是例外，不在DBA的控制中。那就是云梯回流数据。如果云梯回流数据的计算逻辑出现bug（比如说笛卡尔积），则很可能导致短时间回流的数据达上千万或者上亿，实例空间会暴增几百G，很有可能把主机分区空间耗尽，而DBA短时间内并无快速应对方法。这个场景实际发生过一次，风险很高。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">在表上线的时候，研发对该表将来的数据量要有个清晰的认识，并反馈给DBA。对可能一直增长的表，要考虑是否使用分表。是否可以定时清理或者迁移数据到其他平台（如odps等）。<br style="-webkit-print-color-adjust: exact;"/>要充分评估表发展成大表后，对sql rt的影响。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">另外一个可能引起空间暴增的场景就是临时表。<br style="-webkit-print-color-adjust: exact;"/>如对大表的DDL变更会产生一个临时表。以及SQL排序过程中会生成ondisk临时表，虽然不大，但是如果sql的并发很高，这个增长也是相对很大的。当然，此时实例的性能问题也是很严重。</p><h4 id="toc_66" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">应对方法</h4><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>删除或者清理大表数据</p></li><li><p>实例跨机迁移</p></li><li><p>拆库或者拆表</p></li></ol><h3 id="toc_67" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">性能容量风险</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">性能容量风险指系统的吞吐量或者响应时间不能满足上层请求方的需求，导致请求方的请求数（QPS）上不去。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">应用集群、tair集群、中间件集群、数据库集群，都有一个共同的特征：都是请求-响应形式，都可以借用<code style="-webkit-print-color-adjust: exact; margin: 0px 2px; padding: 0px 5px; white-space: nowrap; border: 1px solid rgb(234, 234, 234); background-color: rgb(248, 248, 248); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px;">排队理论</code>解释。</p><h4 id="toc_68" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">排队理论</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><img src="pictures/getTfsFile.dofilePath=TB1OTSpJFXXXXadXFXXXXXXXXXX.png" alt="M/G/1队列" title="M/G/1队列" style="-webkit-print-color-adjust: exact; max-width: 100%;"/></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">备注：</strong>&nbsp;<br style="-webkit-print-color-adjust: exact;"/>这个描述的是排队理论的模型。抽象为系统只有一个并发。实际系统都是有多个并发，道理基本相通。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><img src="pictures/getTfsFile.dofilePath=TB1YhakJFXXXXb_XFXXXXXXXXXX.png" alt="M/G/1队列" title="M/G/1队列" style="-webkit-print-color-adjust: exact; max-width: 100%;"/></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">备注：</strong>&nbsp;<br style="-webkit-print-color-adjust: exact;"/>这个描述的一个并发的情况下，影响系统内队列的长度、系统的利用率和系统的响应时间的因素。<br style="-webkit-print-color-adjust: exact;"/>这个系统可以扩展到集群级别，可以是应用集群，也可以是db集群。<br style="-webkit-print-color-adjust: exact;"/>有这个公式可以得出几个结论：<br style="-webkit-print-color-adjust: exact;"/>1. 在DB内部处理队列(抽象的)长度固定的情况下, sql在DB内部处理的rt只有尽可能的低（W↓），才能支持更高的QPS（λ↑）。所以要优化sql，降低rt。<br style="-webkit-print-color-adjust: exact;"/>2. 为了维持DB的响应时间（R）尽可能的低，DB的利用率（U）不可能很高。这也说明为什么核心实例集群主机的资源利用率不高。<br style="-webkit-print-color-adjust: exact;"/>3. 系统对外输出的响应时间（Rs）跟系统内部的子系统提供的响应时间（W）的关系并不是线性关系。这个可以往外部或者往内部推演。也间接说明，DB的sql的rt抖一抖，很可能应用集群的查询就死一片（查询超时报错）。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">排队理论在应用集群的限流里，db的限流里大量运用。“限流”都是限制输入（λ），从而保障系统能够以较低的利用率运行，保障系统的响应时间（rt）足够低。<br style="-webkit-print-color-adjust: exact;"/>没有“限流”，系统利用率（U）很容易就100%，然后系统响应时间（Rs）就类似指数级上涨，很可能在系统崩溃之前，其调用方的系统已经因为过高的响应时间而提前崩溃了。实际上也是如此，应用集群会先于DB集群挂掉。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">注意：</strong>&nbsp;这些公式都是高度抽象，实际上无论是吞吐量，还是响应时间，我们看到的都是观察值，都是反映一个时间粒度内的平均水平，其内部分布理论上也是呈正态分布或者泊松分布。所以，应用查询超时的时候也不是全挂。</p><h4 id="toc_69" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">性能评估</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">性能评估就是找出系统的瓶颈，即在多大的rt水平下能提供多大的吞吐量（输出），以及此时系统的请求量（输入）。<br style="-webkit-print-color-adjust: exact;"/>当然这是理论上的。实际上很难做到全面、精确，只能尽可能的靠近。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">比如说双11订单高峰能冲到多高，其最关键的因素就在于 alisql 订单库的单key更新能做到多大（吞吐量）以及rt做到多低。如下是当前alisql压测性能。<br style="-webkit-print-color-adjust: exact;"/><img src="pictures/getTfsFile.dofilePath=TB1cMGgJFXXXXcLXXXXXXXXXXXX.png" alt="alisql hot sku 性能" title="alisql hot sku 性能" style="-webkit-print-color-adjust: exact; max-width: 100%;"/><br style="-webkit-print-color-adjust: exact;"/>所以，看alisql的单key并发更新的能力，就可以大概评估双11订单每秒峰值能做到多高。db上层的各级应用的限流值都是依据db的这个能力而去计划的。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">业务模型越单一，这种评估工作越好做。 可以参考一下库存应用的经验，详情参见&nbsp;<a href="http://www.atatech.org/articles/12192" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">库存中心DB优化–语法优化</a>&nbsp;，&nbsp;<a href="http://www.atatech.org/article/detail/12117/0" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">库存中心DB优化–MySQL patch</a>&nbsp;。<br style="-webkit-print-color-adjust: exact;"/>复杂的业务模型，评估很难准确，但是通过对系统指标的长期观察，还可以大概的知道系统性能容量，及其变化的原因。能够提前防范风险。</p><h3 id="toc_70" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">备库延时风险</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">在当前的数据库可用性架构里，备库（Slave）承担着灾备的作用，平时不对业务提供服务。个别业务由于主库访问压力大将部分查询导向了备库例外，而这正是有风险的地方。此外，idb查询是查询备库的。<br style="-webkit-print-color-adjust: exact;"/>通常DBA运维是可以保障备库的性能最优，不会让备库出现较大延迟（超过1s）。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">但是下列情形会导致备库出现大量延时：<br style="-webkit-print-color-adjust: exact;"/>1. 主库大表变更（锁表），同步到备库时（也锁表），备库出现大量延时。待备库表结构变更完毕后恢复。<br style="-webkit-print-color-adjust: exact;"/>2. 主库大表数据回流，产生大事务导致备库同步跟不上，出现很大延时。<br style="-webkit-print-color-adjust: exact;"/>3. 备库硬件故障导致实例不可用或者实例IO性能严重下降，出现很大延时。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><strong style="-webkit-print-color-adjust: exact;">备注：</strong>&nbsp;大事务还有另外一个风险，如果超出了mysql的一个binlog大小限制，会导致主库该事务报错。</p><h4 id="toc_71" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">使用备库的场景</h4><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>应用在sql里通过tddl hint方式指定了连接备库。</p></li><li><p>tddl配置里对备库提供了读权重。双11的时候核心实例会这样做，以分担主库压力。</p></li><li><p>应用错误的使用ip直连了数据库，并且该数据库后来变为备库了。当然应用很可能会报写失败（数据库RO了）。</p></li><li><p>iDB使用备库查询。</p></li></ol><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">由于导致备库延时的很多因素DBA并不能完全把控，所以&nbsp;<span style="color:red;-webkit-print-color-adjust: exact;">除了双11和iDB外，DBA不允许应用使用备库，除非研发明确承诺备库延时不会导致应用报故障。</span></p><h3 id="toc_72" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">单元化风险</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">本节指在数据库做单元化的情况下，数据库操作要额外考虑的风险点。并非反对单元化。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">单元化业务要保障数据同步顺畅，延时很小。否则，很容易发生故障。</p><h4 id="toc_73" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据同步风险</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">以下几种情形可能导致数据同步中断：<br style="-webkit-print-color-adjust: exact;"/>1. 更新了主键值导致drc同步任务中断。<br style="-webkit-print-color-adjust: exact;"/>2. 中心和单元表结构不一致。<br style="-webkit-print-color-adjust: exact;"/>3. 中心或者单元机房或网络故障或者突袭演练导致实例不可访问。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">应对方法：修复问题，做数据校验。</p><h4 id="toc_74" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据质量风险</h4><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">当流量在中心和单元之间变更的时候，可能会出现同一个用户先后在中心和单元发生数据读写，虽然有“禁写规则”和”禁止更新”规则，还是有可能会出现数据双写带来的不一致。尤其是表上面存在唯一约束的情况下。详情参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=53221" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">单元化业务数据质量问题总结</a>&nbsp;。<br style="-webkit-print-color-adjust: exact;"/>这个需要应用研发跟AMG对接，以方便数据校验和数据订正。&nbsp;</p><hr style="-webkit-print-color-adjust: exact; border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC); background-color: rgb(255, 255, 255); background-position: 0px 0px; background-repeat: repeat-x;"/><h2 id="toc_75" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><a style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);" name="troubleshooting"></a>线上数据库问题分析</h2><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">这里指的线上已经暴露的问题的应急处理方法。</span></p><h3 id="toc_76" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">连接问题分析</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">核心实例的应用服务器多，每个java实例对应配置的tddl里最大连接数很小。业务请求高峰时，个别慢sql很容易导致tddl连接池满了，进而应用无法取到连接。<br style="-webkit-print-color-adjust: exact;"/>已经连接上的sql，也可能由于等待过久而超时或者连接中断等等。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">相关连接的背景知识请先参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=59221" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">MySQL Communications link failure 问题记录分析</a>&nbsp;。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">当发生连接问题的时候，首先确定慢sql。看能否通过限流和调整索引临时解决。还不行的话，为缓解应用服务器压力，可以临时提升tddl配置的最大连接数。但上升空间不大。如果是慢sql导致的连接耗尽，即使调高连接数，还是很可能再次满了。</p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">连接问题的解决需要研发和DBA互通信息，协同解决。</p><h3 id="toc_77" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">死锁问题分析</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">死锁的原理大家都知道，不多说。<br style="-webkit-print-color-adjust: exact;"/>这里罗列一些死锁案例的分析。研发有兴趣的可以看看，看完不怕分析不了死锁问题。</p><ol style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; padding-left: 30px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);" class=" list-paddingleft-2"><li><p>unique key导致的死锁&nbsp;&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=24021" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196); margin-top: 0px;">由一个死锁引发的对InnoDB行锁的探索</a>&nbsp;。干货很多。</p></li><li><p><a href="http://hedengcheng.com/?p=771" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196); margin-top: 0px;">MySQL 加锁处理分析</a>&nbsp;。 干货非常非常多。</p></li><li><p>如何阅读死锁报告， 参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=14662" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196); margin-top: 0px;">MySQL 死锁信息解读</a>&nbsp;。&nbsp;</p></li><li><p>死锁相关的惨案，参见&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=12831" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196); margin-top: 0px;">千牛并发更新引起的惨案</a>&nbsp;。</p></li><li><p><a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=58421" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196); margin-top: 0px;">库存死锁case1</a>，&nbsp;<a href="https://askdba.alibaba-inc.com/libary/control/getArticle.do?articleId=60241" style="-webkit-print-color-adjust: exact; color: rgb(65, 131, 196);">库存死锁分析和解决方案</a>&nbsp;。</p></li></ol><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">线上一旦发现死锁报错的时候，立即联系DBA，索要死锁报告（在mysql的alert.log里）。</p><h3 id="toc_78" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 18px; font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">SQL超时问题分析</h3><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;">指sql响应时间过长超出了某个timeout时间了。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">找到sql，优化sql或者调整索引。</p><hr style="-webkit-print-color-adjust: exact; border: 0px none; color: rgb(204, 204, 204); height: 4px; padding: 0px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC); background-color: rgb(255, 255, 255); background-position: 0px 0px; background-repeat: repeat-x;"/><h2 id="toc_79" style="-webkit-print-color-adjust: exact; margin: 20px 0px 10px; padding: 0px; -webkit-font-smoothing: antialiased; cursor: text; position: relative; font-size: 24px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); font-family: Helvetica, arial, sans-serif; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">后记</h2><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);"><span style="color:green;-webkit-print-color-adjust: exact;"><br style="-webkit-print-color-adjust: exact;"/>1. 每个技术方案都不是完美的，都伴随一定的风险。不同的方案，风险不一样。了解细节，发挥优势，防范风险。<br style="-webkit-print-color-adjust: exact;"/>2. 数据库优化的要求不高。度量、分析、优化。如此反复，熟能生巧。<br style="-webkit-print-color-adjust: exact;"/></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 15px; margin-bottom: 15px; font-family: Helvetica, arial, sans-serif; font-size: 14px; white-space: normal; widows: auto; background-color: rgb(255, 255, 255);">数据库培训PPT：</p><p style="line-height: 16px;"><img style="vertical-align: middle; margin-right: 2px;" src="pictures/icon_ppt.gif"/><a style="font-size:12px; color:#0066cc;" href="https://askdba.alibaba-inc.com/services/getTfsFile.do?filePath=TB13md0JFXXXXcJXXXXXXXXXXXX.pptx" title="数据库培训2016_2.pptx">数据库培训2016_2.pptx</a>&nbsp; &nbsp;</p><p style="line-height: 16px;"><img style="vertical-align: middle; margin-right: 2px;" src="pictures/icon_ppt.gif"/><a style="font-size:12px; color:#0066cc;" href="https://askdba.alibaba-inc.com/services/getTfsFile.do?filePath=TB1saueJFXXXXbYXVXXXXXXXXXX.pptx" title="就要你懂连接池.pptx">就要你懂连接池.pptx</a></p><p><br/></p>
</div>

<br><br><img id="bottomcap" alt="" src="src/cap-bottom.png">
</div></div> <!-- page/round -->
</body></html>



