<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>Agent 通用库|JinYang's Blog</title>
  <meta name="keywords" content="">
  <meta name="description" content="">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-12 blog-main" style="min-width: 500px">
      <div class="post-container">
        <div class="blog-header">
          <h1>Agent 通用库</h1>
        </div>
        <hr>
        <h2 id="miniagent">MiniAgent</h2>

<p>这里实际上是一个通用的示例模版，可以通过如下方式进行编译测试。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ cmake .. -DCMAKE_BUILD_TYPE=Debug -DWITH_EXAMPLES=true -DWITH_UNIT_TESTS=true</code></pre></figure>

<h3 id="常用脚本">常用脚本</h3>

<p>简单列举常用的脚本，一般保存在 <code>contrib</code> 目录下。</p>

<h4 id="generate_versionsh">generate_version.sh</h4>

<p>依次从 <code>VERSION</code> 文件、<code>Git-Tag</code> 中读取，其命名格式为 <code>v1.2.3</code> ，默认是 <code>v0.1.0</code> 。</p>

<h4 id="packagesh">package.sh</h4>

<p>将源码打包成 <code>tar.bz2</code> 包，同时将源码编译并打包成 RPM 安装包。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">./contrib/package.sh MiniAgent 1.2.1-1</code></pre></figure>

<p>如上的示例中，其中 <code>1.2.1</code> 为版本号，而 <code>1</code> 表示编译号，</p>

<p>该脚本同时会调用 <code>generate_version.sh</code> 脚本判断版本号是否匹配，不匹配则直接报错，可以通过 <code>-f</code> 跳过。</p>

<h2 id="测试用例">测试用例</h2>

<p>其中单元测试使用的是 CMake 提供的机制，另外，针对。</p>

<h2 id="常用库">常用库</h2>

<p>这里的通用库采用 git 的 submodule 方式添加到各个项目中，大致的使用方式如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 以submodule方式添加库
$ git submodule add git@gogs.cargo.com:cargo/clib-liblog.git libs/liblog

----- 对于所有的submodule拉取最新的代码
$ git submodule foreach --recursive git pull

----- 可以简单查看当前各个模块的状态
$ git submodule</code></pre></figure>

<h3 id="liblog">liblog</h3>

<p>一个非常简单的日志库，支持简单的日志打印、级别设置、日志切割等功能，同时针对线程、进程编程进行了简单的优化。</p>

<p>为了尽量简单，并没有支持灵活的日志格式，但是如果需要调整为自己喜欢的格式，可以直接修改 <code>common.c</code> 文件中与日志格式化相关程序，其中 GCC 中可以使用的宏包括了 <code>__FILE__</code> <code>__FUNCTION__</code> <code>__LINE__</code> 等。</p>

<p>注意，在 CMake 中使用 <code>__FILE__</code> 时默认是文件的全路经，如果要使用相对路径可以参考 <a href="https://jin-yang.github.io/post/linux-cmake-auto-compile-introduce.html">CMake 自动编译</a> 中相关介绍。</p>

<h4 id="配置">配置</h4>

<p>大部分的配置都是以宏的方式提供，用户可以编译的时候指定。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 默认使用MAX缓存，可以当内存不足时自动扩容
#define LOG_USE_AUTOBUFF        1

----- 是否缩减缓存
#define LOG_SHRINK_TIMES        10

----- 日志文件的最大，以及保留日志文件数
#define LOG_FILE_SIZE_MAX       1024 * 1024 * 50
#define LOG_FILE_NUMS_MAX       4

----- 是否使用文件名+行号打印日志
#define LOG_USE_FILENO          0

----- 缓存的最大最小值
#define LOG_BUFFER_MIN          1024
#define LOG_BUFFER_MAX          16 * 1024</code></pre></figure>

<h4 id="api">API</h4>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 日志打印，可以将log开头替换为logh
log_fatal(...)
log_error(...)
log_warning(...)
log_notice(...)
log_info(...)
log_debug(...)
log_trace(...)

int log_level_inc(void); /* less logs */
int log_level_dec(void); /* more logs */
int log_set_level(int level);
int log_get_level(const char *level);
const char *log_get_name(const int level);</code></pre></figure>

<h4 id="日志模型">日志模型</h4>

<p>针对不同的场景对应了不同的实现，主要分为如下几类。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">liblog-process.a        单进程，在init会打开文件，切割时无需加锁
liblog-multi-process.a  多进程，每次写入时打开文件，原子写入，然后关闭，切割时无加文件锁
liblog-thread.a         多线程，在init时打开文件，每次写入时打开文件，原子写入，然后关闭，切割时需要加线程锁
liblog-stdout.a         直接写入到标准输出，注意不区分标准输出还是标准错误输出</code></pre></figure>

<p>注意，上述的方式实际上是有优先级，也就是 <code>FEATURE_LOG_MACRO</code> <code>FEATURE_LOG_STDOUT</code> <code>FEATURE_LOG_PROCESS</code> <code>FEATURE_LOG_MULTI_PROCESS</code> <code>FEATURE_LOG_THREAD</code> 。</p>

<p>一般来说，一个程序中会有主进程，为了保证所有库使用相同的日志输出格式，那么可以设置主进程，以及单个进程。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">ADD_DEFINITIONS(-DFEATURE_LOG_PROCESS)  # 所有，包括库，优先级低

TARGET_COMPILE_OPTIONS(${PROJECT_NAME}Ctl PRIVATE &quot;-DFEATURE_LOG_STDOUT&quot;)  # 单个，优先级高</code></pre></figure>

<h4 id="todo">TODO</h4>

<ul>
  <li>日志压缩。</li>
</ul>

<h3 id="libcron">libcron</h3>

<p>类似于系统中的 crontab 的周期定义方式。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"> .------------------ second       (0~59) , - * /
 |  .--------------- minute       (0~59) , - * /
 |  |  .------------ hour         (0~23) , - * /
 |  |  |  .--------- day of month (1~31) , - * / ?
 |  |  |  |  .------ month        (1~12) , - * / jan,feb,mar,apr ...
 |  |  |  |  |  .--- day of week  (0~7) (Sunday=0/7) , - * / ? sun,mon,tue,wed,thu,fri,sat
 |  |  |  |  |  |
 *  *  *  *  *  * user-name  command to be executed
 0  1  2  3  4  5</code></pre></figure>

<p>其中 crontab 默认精确到分钟，这里的精度是秒，包含了 6 个通过空格分开的字段，其表示的时间段如上所示。</p>

<ul>
  <li><code>*</code> 任意值，如果秒域为 <code>*</code> 表示任一秒都会触发；</li>
  <li><code>,</code> 列举，如果秒域为 <code>5,13,20</code> 则表示会在第 5 秒、第 13 秒、第 20 秒会触发；</li>
  <li><code>-</code> 范围，如果秒域为 <code>5-9</code> 表示从第 5 秒到第 9 秒都会触发，等价于 <code>5,6,7,8,9</code> ；</li>
  <li><code>/</code> 间隔，如果秒域为 <code>30/13</code> 表示从第 6 秒开始每隔 13 秒触发一次，也就是 <code>39 52 39 52 ...</code> ；</li>
  <li><code>?</code> 只能用于日期或者星期中，如果设置了其中的一个，另外一个需要设置为 <code>?</code> ；</li>
</ul>

<p>其中 <code>?</code> 只能用在 <code>Day of Month</code> 和 <code>Day of Week</code> 两个域，它也匹配域的任意值，但实际不会，因为两者会相互影响。假设，想每月 20 号触发，而不关心具体是星期几，则可以使用 <code>0 0 0 20 * ?</code> ，最后必须是 <code>?</code> ，否则会直接报错。</p>

<p>注意，对于 <code>Day of Week</code> 字段来说，在代码中实际使用的范围是 <code>0~6</code> 。</p>

<!--
Java提供了更复杂的功能
http://www.cnblogs.com/sawyerlsy/p/7208321.html
-->

<h4 id="示例">示例</h4>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&quot;0 0 * * * *&quot;                 the top of every hour of every day
&quot;*/10 * * * * *&quot;              every ten seconds
&quot;0 0 8-10 * * *&quot;              8, 9 and 10 o&#39;clock of every day
&quot;0 0/30 8-10 * * *&quot;           8:00, 8:30, 9:00, 9:30 and 10 o&#39;clock every day
&quot;0 0 9-17 * * MON-FRI&quot;        on the hour nine-to-five weekdays
&quot;0 0 0 25 12 ?&quot;               every Christmas Day at midnight


*/10 * * * *     echo &quot;Ten minutes ago.&quot; &gt;&gt; /tmp/foo.txt    // 每十分钟执行一次
0 6 * * *        echo &quot;Good morning.&quot; &gt;&gt; /tmp/foo.txt       // 每天早上6点
0 */2 * * *      echo &quot;Have a break now.&quot; &gt;&gt; /tmp/foo.txt   // 每两个小时
45 4 1,10,22 * * echo &quot;Restart server.&quot; &gt;&gt; /tmp/foo.txt     // 每月1、10、22日的4:45
0 23-7/2,8 * * * echo &quot;Have a good dream.&quot; &gt;&gt; /tmp/foo.txt  // 晚上11点到早上8点之间每两个小时，早上八点
0 11 4 * 1-3     echo &quot;Just kidding.&quot; &gt;&gt; /tmp/foo.txt       // 每月4号和每周的周一到周三的早上11点
45 11 * * 0,6    echo &quot;Have a good lunch.&quot; &gt;&gt; /tmp/foo.txt  // 每周六、周日的11点45分
0 9 * * 1-5      echo &quot;Work hard.&quot; &gt;&gt; /tmp/foo.txt          // 从周一到周五的9点
2 8-16/3 * * *   echo &quot;Some examples.&quot; &gt;&gt; /tmp/foo.txt      // 8:02、11:02、14:02执行

0,30 18-23 * * *    echo &quot;Same.&quot; &gt;&gt; /tmp/foo.txt            // 每天18:00到23:00之间每隔30分钟
0-59/30 18-23 * * * echo &quot;Same.&quot; &gt;&gt; /tmp/foo.txt            // 同上
*/30 18-23 * * *    echo &quot;Same.&quot; &gt;&gt; /tmp/foo.txt            // 同上</code></pre></figure>

<p>在表达式中，每位表示一个时间，例如秒、分、时等。</p>

<h4 id="tips">Tips</h4>

<p>如果要测试类似夏令时、冬令时这类的问题，可以通过设置环境变量的方式调整时区，详见 <code>man 3 timegm</code> 中的介绍。</p>

<p>需要测试的场景包括了：夏令时、冬令时、闰年。</p>

<h3 id="libprotocol">libprotocol</h3>

<p>这里包含了一些基本的协议，以及常用的 Socket 操作。</p>

<h4 id="简介">简介</h4>

<p>一般 Socket 的处理流程分为了发送和接收。</p>

<p>发送流程：</p>

<ol>
  <li>业务生成数据结构，发送到缓冲队列 (可以是队列、环、优先队列)，并通知 Socket 线程；Tips#1</li>
  <li>在 Socket 线程中，进行序列化操作，保存到统一的发送缓冲区中。Tips#3</li>
  <li>然后写入，此时可以通过异步 IO 进行处理；Tips#2</li>
</ol>

<p>接收流程：</p>

<ol>
  <li>接收到数据后保存到接收缓冲区，判断是否接收到一个完整的包；</li>
  <li>添加到接收链表中，然后通知工作线程进行处理；</li>
  <li>处理完成后，工作线程向写队列中添加响应报文。</li>
</ol>

<p>Tips</p>

<ol>
  <li>默认是在 Socket 线程中进行序列化，如果说性能不满足，那么可以将序列化在发送缓冲队列前进行处理，这时，只需要简单的发送缓冲队列的数据即可。</li>
  <li>这里可能会出现只发送了缓冲队列中一部分数据的情况，需要注意如何进行处理。</li>
  <li>这里的序列化采用的是一个相同的缓冲区，那么可以节省内存使用，而 Tips#1 中的使用方式，实际上是以内存换取效率。</li>
</ol>

<!--
IO 线程可以和工作线程绑定，也可以分开，主要看通讯的压力。

如果绑定那么对应的处理流程为：A) Read IO；B) 处理业务逻辑，获取结果；C) Write IO。

这种方式的处理流程简单，解析好请求后就能直接在同一线程中处理，省去了线程切换的开销，非常适合业务处理流程简单的请求。

但是，当单个任务的处理时间过长时，就可能会导致后面的任务被阻塞，影响请求的响应。

http://oserror.com/backend/libeasy-all/


当与服务端建立连接之后，建议只使用一个 Socket 连接，然后通过异步 IO 提高连接上的吞吐量，同时，如果需要也可以进行流量控制，这样会方便很多。

如果说吞吐量不够，一般是 Socket 的处理逻辑封装了很多业务逻辑，此时可以将业务逻辑拆出来，然后使用单独线程只做 Socket 收发。


缓存超过之后的策略：

1. 本地持久化，并周期重试。注意：本地持久化需要限制大小。
2. 业务失败，当前不可用。
-->

<h3 id="libdown">libdown</h3>

<p>默认直接覆盖。</p>

<h3 id="pidfile">PIDFile</h3>

<p>这里简单检查 PIDFile 文件，以及 <code>/proc</code> 文件系统中的值，并没有使用 flock 机制。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">int pidfile_check(const char *file);
    检查PIDFile对应的进程是否存在，会读取/proc/PID目录，同时校验/proc/PID/comm值。
返回值：
     0 不存在
     1 进程存在
    -1 检查异常，包括各类的异常，例如文件打开异常

int pidfile_update(const char *file);
    更新PIDFile文件值，也就是将当前进程的PID写入到文件中。

void pidfile_destory(const char *file);
    删除PIDFile文件。</code></pre></figure>

<p>也就是说只校验命令，而不校验参数。</p>

<h2 id="其它">其它</h2>

<h3 id="子进程处理">子进程处理</h3>

<p>在调用子进程时，需要注意如下。</p>

<ol>
  <li>通过 <code>setpgrp()</code> 设置进程组，在超时或者异常发送信号时，向进程组发送信号。</li>
  <li>使用 <code>prctl(PR_SET_PDEATHSIG, SIGKILL);</code> 确保父进程退出的时候，子进程同样可以接收到信号。</li>
  <li>如果不支持 Clous On Exec ，那么需要在子进程中将相关的文件描述符关闭，注意，为了防止继承系统需要在系统启动时通过 ulimits 进行设置。</li>
</ol>

<p>正常，如果父进程直接退出，那么子进程会变为僵尸进程，通过 <code>prctl()</code> 可以确保父进程退出时，向子进程发送指定的信号。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;errno.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;signal.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;sys/prctl.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;fork failed, %d:%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="n">errno</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* child */</span>
                <span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_PDEATHSIG</span><span class="p">,</span> <span class="n">SIGKILL</span><span class="p">);</span>
				<span class="cm">/* system(&quot;sleep 10000&quot;) */</span>
                <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;child running...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;father running...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;main exit()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>注意，这里只会涉及到子进程，对于孙子进程实际上是不生效的，例如上述的 <code>system("sleep 10000");</code> 实际上不会退出。</p>

<!--
strtod异常测试，包括NaN +-Inf
libev + SSL 使用
https://segmentfault.com/a/1190000005998141

Semantic version library written in ANSI C
https://github.com/h2non/semver.c
Socket基本库的封装
https://github.com/jb55/anet.c
这里有很多小而美的库介绍
https://github.com/clibs/clib/wiki/Packages

原子写入
https://yq.aliyun.com/articles/160854
https://liam.page/2018/04/28/debug-in-Linux-kernel-jprobe/
https://blog.csdn.net/dog250/article/details/78879600



## dump 进程

假设有这么一个场景，有个进程卡死在了某个系统调用，例如 `futex` 接口处。

gcore [-o filename] pid


例如可以按照如下步骤操作。

$ gcore -o /tmp/foobar.core 8059
$ gdb -c /tmp/foobar.core.8059
>

查找cache目录下不是html的文件
find ./cache ! -name '*.html' -type f

根据文件属性查找：
find . -type f -name "*config*" ! -path "./tmp/*" ! -path "./scripts/*" ! -path "./node_modules/*"

https://fedoraproject.org/wiki/Packaging:Debuginfo

https://xiaohui-p.iteye.com/blog/1171927

如果当进程出问题之后如何更好的打印日志信息。

键入info variables以列出“所有全局和静态变量名称”。
键入info locals以列出“当前堆栈框架的局部变量”(名称和值)，包括该函数中的静态变量。
键入info args以列出“当前堆栈框架的参数”(名称和值)。

#define BUG() do {
	log_fatal("BUG: failure at %s:%d/%s()!", __FILENAME__, __LINE__, __func__);
		panic("BUG!");
} while(0)
#define BUG_ON(cond)  do { if (unlikely(cond)) BUG(); } while(0)

https://zhuanlan.zhihu.com/p/31630417
https://blog.csdn.net/littlefang/article/details/42295803
https://www.cnblogs.com/muahao/p/7610645.html
https://www.cnblogs.com/welhzh/p/4813778.html
https://www.linuxjournal.com/article/6391
https://blog.csdn.net/astrotycoon/article/details/8142588
http://velep.com/archives/1032.html
https://spin.atomicobject.com/2013/01/13/exceptions-stack-traces-c/
https://www.quora.com/How-do-you-get-a-stack-trace-on-Linux
https://github.com/gustafsson/backtrace
https://github.com/daddinuz/panic



https://paper.seebug.org/481/
https://paper.seebug.org/

Stack Overflow 作者，里面包含了很多架构相关的内容
https://nickcraver.com/
https://riboseyim.github.io/2016/07/17/OpenSource-StackOverflow/
https://zhuanlan.zhihu.com/p/22353191

检查内存中的敏感数据
https://github.com/rek7/mXtract

http://cwndmiao.github.io/2014/03/10/percpu/
http://cwndmiao.github.io/programming%20tools/2013/11/26/Dwarf/
死锁检测
https://github.com/rouming/dla
https://cloud.tencent.com/developer/article/1176832
https://yq.aliyun.com/articles/579470
-->


        <hr>
      </div>
    </div>
  </div>
  <hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
