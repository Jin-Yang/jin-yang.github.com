<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>基础服务|JinYang's Blog</title>
  <meta name="keywords" content="">
  <meta name="description" content="">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-12 blog-main" style="min-width: 500px">
      <div class="post-container">
        <div class="blog-header">
          <h1>基础服务</h1>
        </div>
        <hr>
        <p>服务端，支持 HTTP 请求。</p>

<h2 id="文档服务器搭建">文档服务器搭建</h2>

<p>增加 HTTP/FTP 服务器，分别使用 nginx 和 vsftpd 搭建。为了方便使用，可以设置 <code>/etc/hosts</code> 增加如下的配置。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">127.0.0.1  files.cargo.com</code></pre></figure>

<h3 id="目录结构">目录结构</h3>

<p>其中主要是 Agent 的发布路径，相对于根目录，默认使用的是 <code>/files</code> 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">repos/CentOS/7/local/x86_64/RPMS            # 支持CentOS 7的RPM包
repos/CentOS/7/debuginfo/x86_64/RPMS        # 对应的debuginfo包
repos/CentOS/7/src/x86_64/RPMS              # 对应的源码包</code></pre></figure>

<h3 id="http-服务">HTTP 服务</h3>

<p>如果要增加新配置，可以直接修改 <code>/etc/nginx/nginx.conf</code> 默认配置文件，这里会在 <code>/etc/nginx/conf.d</code> 目录下包含了各种配置文件。</p>

<p>然后通过 <code>nginx -t</code> 检查语法是否正确，通过 <code>systemctl start nginx</code> 启动服务，如果已经启动可以直接通过 <code>nginx -s reload</code> 命令重新加载配置。</p>

<h4 id="安装包">安装包</h4>

<p>在 <code>/etc/nginx/conf.d</code> 目录下新增配置文件 <code>fileserver.conf</code> ，然后通过 <a href="http://files.cargo.com">http://files.cargo.com</a> 访问。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">server {
	listen 80;                       # 监听端口
	server_name files.cargo.com;     # 如果没有DNS解析，可以设置IP地址
	client_max_body_size 4G;         # 设置最大文件大小
	charset utf-8;                   # 防止出现中文乱码
	root /files;            # 指定相对路径的根目录，如下的location会相对该路径
	location / {                     # 实际存放文件的目录为/files/packages/
		#auth_basic &quot;Restricted&quot;; # 输入密码时的提示语
		#auth_basic_user_file /etc/nginx/pass_file; # 认证时用户密码文件存放路径
		autoindex on;            # 自动生成文件索引
		autoindex_exact_size on; # 显示文件大小
		autoindex_localtime on;  # 显示本地文件时间
	}
}</code></pre></figure>

<p>对于上述的配置，实际文件保存在 <code>/files</code> 目录下，另外需要保证 nginx 启动用户的访问权限，可以通过如下命令进行测试。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ wget http://files.cargo.com/repos/CentOS/7/local/x86_64/RPMS/MiniAgent-1.2.3-0.x86_64.rpm</code></pre></figure>

<h4 id="服务器静态文件">服务器静态文件</h4>

<p>用于前端页面的 css js 类型的文件。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># conf.d/bootsvr.conf
upstream bootsvrs {
        ip_hash;
        server 127.0.0.1:8180 max_fails=2 fail_timeout=2;
}

server {
        listen 80;
        server_name aspire.cargo.com;

        location /api/ {
                proxy_pass http://bootsvrs; 
                proxy_set_header X-Real-IP $remote_addr;
        }

        location ~ .*\.(html|htm|gif|jpg|jpeg|bmp|png|ico|txt|js|css)$ {   
                root /file/static/aspire/;
                expires 30d;
        } 
}</code></pre></figure>

<h4 id="其它">其它</h4>

<p>另外，简单的可以采用 python 提供模块，不过只能采用单线程。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 启动一个简单的文件服务器
$ python -m SimpleHTTPServer 9000

$ curl http://127.0.0.1:9000</code></pre></figure>

<p>可以直接通过 <a href="http://127.0.0.1:9000">http://127.0.0.1:9000</a> 地址访问，可以看到目录下的文件列表。</p>

<h4 id="faq">FAQ</h4>

<h5 id="404">404</h5>

<p>其中 Nginx 的日志保存在 <code>/var/log/nginx/{access.log,error.log}</code>，可以详细查看。</p>

<h3 id="ftp-服务">FTP 服务</h3>

<p>直接启动 vsftpd 服务器即可，在 CentOS 中可以通过 <code>systemctl start vsftpd</code>，详细可以参考 <a href="/post/network-service-ftp.html">FTP 服务简介</a> 中的介绍，这里简单介绍其常见的配置信息。</p>

<h3 id="yum-仓库">YUM 仓库</h3>

<p>为了测试，可以创建一个本地仓库。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 1. 创建本地yum仓库目录
$ mkdir -p /files/repos/CentOS/7/local/x86_64/RPMS
$ mkdir -p /files/repos/CentOS/7/debuginfo/x86_64/RPMS

----- 2. 复制文件
$ cp MiniAgent-* /files/repos/CentOS/7/local/x86_64/RPMS
$ cp MiniAgent-debuginfo-* /files/repos/CentOS/7/debuginfo/x86_64/RPMS

----- 3. 创建索引&amp;更新缓存
$ createrepo /files/repos/CentOS/7/local/x86_64
$ createrepo /files/repos/CentOS/7/debuginfo/x86_64
$ yum makecache

----- 4. 创建本地repo文件
$ cat&lt;&lt;-&quot;EOF&quot;&gt;/etc/yum.repos.d/CentOS-Local.repo
[local]
name=CentOS-$releasever - local packages for $basearch
baseurl=file:///files/repos/CentOS/$releasever/local/$basearch
enabled=1
gpgcheck=0
protect=1
[local-debuinfo]
name=CentOS-$releasever - local debuginfo for $basearch
baseurl=file:///files/repos/CentOS/$releasever/debuginfo/$basearch
enabled=1
gpgcheck=0
EOF</code></pre></figure>

<h2 id="mysql">MySQL</h2>

<p>这里数据库使用 MySQL 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 安装社区版本MySQL，新增配置
# rpm -Uvh http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm
# yum install mysql-community-server
# cat &lt;&lt; EOF &gt; /etc/my.cnf
[client]
password        = new_password
port            = 5506
socket          = /tmp/mysql-5506.sock
[mysqld]
user            = mysql
port            = 5506
socket          = /tmp/mysql-5506.sock
basedir         = /usr
datadir         = /tmp/data-5506
pid-file        = /tmp/data-5506/mysqld.pid
EOF

----- 初始化数据，可通过空白密码登陆
# mkdir /tmp/data-5506
# /usr/sbin/mysqld --initialize-insecure --basedir=/usr --user=mysql \
    --datadir=/tmp/data-5506
# systemctl start mysqld

----- 登陆并修改密码，第一次登陆时密码空白即可，分别对应了5.6以及5.7版本
$ mysql -h 127.1 -p
mysql&gt; UPDATE mysql.user SET password=PASSWORD(&#39;new_password&#39;) WHERE user=&#39;root&#39;;
mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;new_password&#39;;
mysql&gt; FLUSH PRIVILEGES;

mysql&gt; SET autocommit=ON;
mysql&gt; SHOW SESSION VARIABLES LIKE &#39;autocommit&#39;;
mysql&gt; SHOW GLOBAL VARIABLES LIKE &#39;autocommit&#39;;
mysql&gt; SET SESSION autocommit=ON;
mysql&gt; SET GLOBAL autocommit=ON;</code></pre></figure>

<!--
### 后台服务搭建

这里基于 Flask 和 MySQL 搭建后台服务器。
-->


        <hr>
      </div>
    </div>
  </div>
  <hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
