<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>BasicAgent 实现|JinYang's Blog</title>
  <meta name="keywords" content="">
  <meta name="description" content="">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-12 blog-main" style="min-width: 500px">
      <div class="post-container">
        <div class="blog-header">
          <h1>BasicAgent 实现</h1>
        </div>
        <hr>
        <h2 id="启动流程">启动流程</h2>

<figure class="highlight"><pre><code class="language-text" data-lang="text">1. 通过 DNS 解析获取 config.cargo.com 的 IP 地址信息，会依次尝试建立链接。
   可以先通过/etc/hosts配置，通过多行将该域名设置多个 IP 地址
       127.0.0.1   config.cargo.com
       127.0.0.2   config.cargo.com
       127.0.0.3   config.cargo.com

2. 发送初始化报文，同时可以根据上层策略决定是否重定向进行负载均衡。

3. 建立TLS链接。</code></pre></figure>

<h3 id="01-初始化报文">0.1 初始化报文</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">-----&gt; 请求报文
{
    &quot;method&quot;: &quot;init&quot;,                                      # 必选
    &quot;hostname&quot;: &quot;edd6c192-52cb-4133-a17a-e7d8aec03de7&quot;,    # 必选，指定同步命令类型
}

&lt;----- 响应报文
{
    &quot;method&quot;: &quot;redirect&quot;,                  # 必选
    &quot;server&quot;: &quot;127.0.10.1,10.92.1.130&quot;,    # 必选，重定向的地址
}</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">./boot -L /tmp/booter.log -P /tmp/booter.pid -f</code></pre></figure>

<h2 id="命令通道">命令通道</h2>

<p>用于在服务器上执行命令。</p>

<h3 id="同步命令">同步命令</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">-----&gt; 请求报文
{
    &quot;id&quot;: &quot;xxxxxx&quot;,
    &quot;method&quot;: &quot;sync.bash&quot;,    # 必选，指定同步命令类型
    &quot;cmd&quot;: &quot;ls&quot;,              # 必选，需要执行的命令
    &quot;timeout&quot;: 10,            # 可选，超时时间，默认120，最小1s
    &quot;user&quot;: &quot;root&quot;,           # 可选，执行用户，默认root
    &quot;group&quot;: &quot;root&quot;           # 可选，执行用户组，默认root
}

&lt;---- 响应报文，成功
{
    &quot;id&quot;: &quot;xxxxxxx&quot;,
    &quot;resp&quot;: &quot;success&quot;,
    &quot;retcode&quot;: 2,
    &quot;message&quot;: &quot;Normal termination&quot;
    &quot;data&quot;: &quot;xxxx&quot;
}
&lt;---- 响应报文，失败
{
    &quot;id&quot;: &quot;xxxxxxx&quot;,
    &quot;resp&quot;: &quot;failed&quot;,
    &quot;retcode&quot;: 3021,
    &quot;message&quot;: &quot;Invalid params&quot;
}</code></pre></figure>

<h3 id="异步任务">异步任务</h3>

<h2 id="查询接口">查询接口</h2>

<p>提供通用接口获取主机信息，例如内核信息、用户信息等。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">-----&gt; 请求报文
{
    &quot;id&quot;: &quot;xxxxxx&quot;,
    &quot;method&quot;: &quot;getinfo.users&quot;,  # 必选
    &quot;args&quot;: &quot;&quot;,                 # 可选，不同方法参数不同
}

&lt;---- 响应报文，成功
{
    &quot;id&quot;: &quot;xxxxxxx&quot;,
    &quot;resp&quot;: &quot;success&quot;,
    &quot;retcode&quot;: 2,
    &quot;message&quot;: &quot;Normal termination&quot;
    &quot;data&quot;: &quot;xxxx&quot;
}
&lt;---- 响应报文，失败
{
    &quot;id&quot;: &quot;xxxxxxx&quot;,
    &quot;resp&quot;: &quot;failed&quot;,
    &quot;retcode&quot;: 3021,
    &quot;message&quot;: &quot;Invalid params&quot;
}</code></pre></figure>

<h2 id="命令行">命令行</h2>

<p>可以通过命令行直接加载动态库获取数据。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">BasicAgentCtl [options]
参数：
    -c &lt;command&gt;    指定命令，例如getinfo.kernel、getinfo.users等；
    -a &lt;arguments&gt;  上述命令的参数，不同的指标参数略有区别；

===&gt; getinfo.users 获取用户信息，注意执行需要ROOT权限
./BasicAgentCtl -c &quot;getinfo.users&quot; -a &quot;-U root&quot; | python -m json.tool  # 指定用户
./BasicAgentCtl -c &quot;getinfo.users&quot; -a &quot;-A&quot; | python -m json.tool  # 所有
./BasicAgentCtl -c &quot;getinfo.users&quot; -a &quot;-u&quot; | python -m json.tool  # 普通用户
./BasicAgentCtl -c &quot;getinfo.users&quot; -a &quot;-S&quot; | python -m json.tool  # 系统用户

===&gt; getinfo.kernel 获取内核信息
./BasicAgentCtl -c &quot;getinfo.kernel&quot; | python -m json.tool</code></pre></figure>


        <hr>
      </div>
    </div>
  </div>
  <hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
