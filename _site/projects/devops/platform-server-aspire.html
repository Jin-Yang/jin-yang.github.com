<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>Aspire 实现|JinYang's Blog</title>
  <meta name="keywords" content="">
  <meta name="description" content="">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-12 blog-main" style="min-width: 500px">
      <div class="post-container">
        <div class="blog-header">
          <h1>Aspire 实现</h1>
        </div>
        <hr>
        <p>用来管理 BootAgent 。</p>

<h2 id="实现功能">实现功能</h2>

<p>通过 gRPC 实现通讯，同时提供 REST-API 接口。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">1. 子Agent管理。
   1.1 安装、卸载，启动、停止、重启。
   1.2 健康检查、资源限制。
2. 命令通道。
   2.1 修改BootAgent配置。上报时间间隔、Tags列表。
   2.2 Agent管理命令，也就是1.1的内容。
3. 前端展示。分为三个TAB页进行管理。
   3.1 DashBoard。主机总数、在线数、API 调用次数；Agent的部署数量、在线数。采用离线统计。
   3.2 主机展示。显示基本信息，包括AgentSN、Region分组、主机名、管理IP、OS类型、架构、版本类型、状态(在线、离线、删除)、最近更新时间(状态变化时才会修改)。下拉展示TAG信息。
   3.3 Agent版本管理。包括了BootAgent及其子Agent的版本信息，包括Agent名称、版本号、OS类型、架构、文件路径、安装命令、SHA256。
   3.4 TAG管理。包括TAG的Key/Value、绑定主机数、更新时间。</code></pre></figure>

<p>注意，所谓的命令通道是有限的功能，简单来说，保证成功率，但是不保证时效性。实现时有两种策略：</p>

<p>最简单的是单机或者通过TAG更新的任务，此时会为每台主机生成一个任务进行跟踪。</p>

<p>另外一类是全局任务，这一类任务在主机数过大时会导致生成任务列表耗时过大，因此会置位一个全局标记，在 BootAgent 上报状态信息时匹配对应的字段，如果不符合则执行对应的操作。(暂时不实现)</p>

<h2 id="agent-api">Agent API</h2>

<h3 id="自动注册">自动注册</h3>

<p>在 BootAgent 第一次启动时会尝试注册到服务端。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- POST /api/v1/agent/register
{
	&quot;hostname&quot;: &quot;127.0.0.1&quot;,                            # 可以通过hostname命令查看
	&quot;ipaddr&quot;: &quot;127.0.0.1&quot;,                              # 在发送注册信息时与服务端建立连接的IP
	&quot;agentsn&quot;: &quot;bfdcc18c-b6b9-4725-9c47-37fd93dba5b6&quot;   # 本地生成的UUID用来唯一标识一台主机
	&quot;tags&quot;: &quot;svc=ecs,cmpt=DB&quot;,                          # TODO: 可以根据固定的模版生成
}

----- 返回信息
{
	&quot;status&quot;: 0,
	&quot;agentsn&quot;: &quot;dcb886e9-04ed-41bb-9c12-4d2de12cd59b&quot;,  # 如果上层判断有冲突，则返回合法的AgentSN
	&quot;tags&quot;: &quot;svc=ecs,cmpt=DB&quot;,                          # 这里的tag一般是根据自动规则生成的
}</code></pre></figure>

<p>在注册时，需要保证 AgentSN 的唯一，如果有相同的 AgentSN 那么会再次检查 ipaddr 是否相同，如果相同那么认为是重复注册，此时会直接返回成功。否则，生成新的 AgentSN 。</p>

<h3 id="状态上报">状态上报</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">pyresttest http://booter.cargo.com:8180 contrib/tests/register.yaml --print-bodies=true --log=debug</code></pre></figure>

<h2 id="rest-api">REST-API</h2>

<p>提供了针对 Agent 的 API 接口，其对应的地址为 <code>booter.cargo.com:8180</code> 。</p>

<h3 id="响应格式">响应格式</h3>

<p>主要是分为了成功和失败的报文格式。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">{
	&quot;status&quot;: 130010,                        统一的错误码
	&quot;message&quot;: &quot;not found&quot;,                  报错信息，与错误码对应
	&quot;cause&quot;: &quot;no agent package found&quot;        具体的报错信息
}

{
	&quot;status&quot;: 0,                             表示正常
	&quot;message&quot;: &quot;success&quot;
	&quot;cause&quot;:&quot;already deleted&quot;                可选
}</code></pre></figure>

<h3 id="主机管理">主机管理</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- GET  /api/v1/server/host?agentsn=&quot;845d6374-7d4e-402f-87cc-2a780e794dd6&quot;
{

}</code></pre></figure>

<h3 id="包-vs-agent-管理">包 VS. Agent 管理</h3>

<p>会根据入参自动生成一个相对路径，一般为 <code>$PACKAGE_PATH/{OS}/{ARCH}/{FILENAME}</code> ，实际上包含了两类操作，分别是：A) 包管理；B) 元数据管理。</p>

<!-- repos/CentOS/7/local/x86_64/RPMS -->

<h4 id="包管理">包管理</h4>

<figure class="highlight"><pre><code class="language-text" data-lang="text">PUT    /api/v1/server/package/upload/CentOS/x86_64/BootAgent-1.2.3-rc1.x86_64.rpm
GET    /api/v1/server/package/download/CentOS/x86_64/BootAgent-1.2.3-rc1.x86_64.rpm
DELETE /api/v1/server/package/file/CentOS/x86_64/BootAgent-1.2.3-rc1.x86_64.rpm</code></pre></figure>

<!--
curl -v -X PUT -F "file=@/home/andy/Videos/RAFT.mp4" "http://localhost:8180/api/v1/server/package/upload/os/x86_64/RAFT.mp4"
curl -v -X DELETE "http://localhost:8180/api/v1/server/package/file/os/x86_64/RAFT.mp4"
curl -v -o RAFT.mp4 "http://localhost:8180/api/v1/server/package/download/os/x86_64/RAFT.mp4"
-->

<h4 id="agent-管理">Agent 管理</h4>

<p>通过 <code>name</code> <code>version</code> <code>arch</code> <code>os</code> 唯一确定一个安装包。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- POST   /api/v1/server/agent        上传包相关的元数据信息
{
	&quot;name&quot;:&quot;FoobarAgent&quot;,
	&quot;version&quot;:&quot;1.2.3-rc1&quot;,
	&quot;arch&quot;:&quot;x86_64&quot;,
	&quot;os&quot;:&quot;CentOS&quot;,
	&quot;file&quot;:&quot;FoobarAgent-1.2.3-rc1.x86_64.rpm&quot;
}

----- GET    /api/v1/server/agent?name=FoobarAgent&amp;version=1.2.4.-rc1&amp;offset=0&amp;limit=10&amp;order=asc&amp;sortby=id
{
	&quot;count&quot;: 2,
	&quot;offset&quot;: 0,
	&quot;limit&quot;: 10,
	&quot;packages&quot;: [{
		&quot;id&quot;: 7,
		&quot;name&quot;: &quot;FoobarAgent&quot;,
		&quot;os&quot;: &quot;linux&quot;,
		&quot;arch&quot;: &quot;x86_64&quot;,
		&quot;version&quot;: &quot;1.2.3-rc1&quot;
		&quot;file&quot;: &quot;FoobarAgent-1.2.3-rc1.x86_64.rpm&quot;,
		&quot;path&quot;: &quot;packages/linux/x86_64/FoobarAgent-1.2.3-rc1.x86_64.rpm&quot;,
		&quot;gmt_create&quot;: &quot;2018-11-09T00:14:27+08:00&quot;,
		&quot;gmt_modify&quot;: &quot;2018-11-09T00:14:27+08:00&quot;,
	}]
}

----- DELETE /api/v1/server/agent?name=FoobarAgent&amp;version=1.2.4.-rc1&amp;offset=0&amp;limit=10&amp;order=asc&amp;sortby=id</code></pre></figure>

<h3 id="任务管理">任务管理</h3>

<p>目前基于两种模式：</p>

<ol>
  <li>根据 AgentSN 。直接指定 AgentSN 列表，此时会拆解成子任务运行，当子任务运行完成则返回。</li>
  <li>基于 Tags 。会在一个时间窗内一直有效，如果与 Agent 上报的 tag 与之匹配，那么就会下发相关对任务信息。</li>
</ol>

<p>也就是说，前者适用于少量的 Agent 更新，可以控制数量；而后者适用于大量 Agent 的升级，只能控制时间范围，不能控制具体的更新数量。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- POST /api/v1/server/task 下发任务
{
	&quot;command&quot;: &quot;install&quot;,                 # 必选，任务类型
	&quot;agents&quot;: [                           # 服务器列表
		&quot;9b62aabb-eda4-4d62-b036-b605d887bde3&quot;,
		&quot;845d6374-7d4e-402f-87cc-2a780e794dd6&quot;
	],
	&quot;parameters&quot;: {
		&quot;url&quot;: &quot;http://xxxx&quot;,
		&quot;url&quot;: &quot;command://yum install MiniAgent -y&quot;,   # 通过命令安装
	}
}

{
	&quot;id&quot;: 135,                               # 自动生成的任务ID
	&quot;status&quot;: 0,                             # 状态码，0 表示成功
	&quot;message&quot;: &quot;success&quot;,                    # 返回的信息，可能是报错
	&quot;results&quot;: [{
		&quot;AgentSN&quot;: &quot;9b62aabb-eda4-4d62-b036-b605d887bde3&quot;,
	}, {
		&quot;AgentSN&quot;: &quot;845d6374-7d4e-402f-87cc-2a780e794dd6&quot;,
	}]
}

----- GET  /api/v1/server/task?id=1 查询任务</code></pre></figure>

<h2 id="表结构">表结构</h2>

<p>记录了 BootAgent 以及 Aspire 服务端所生成的事件信息，通过 <code>AgentSN</code>、<code>局部ID</code>、<code>发生时间戳</code> 唯一确定一个事件。</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">Aspire</span><span class="o">`</span><span class="p">;</span>
<span class="n">USE</span> <span class="o">`</span><span class="n">Aspire</span><span class="o">`</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">subtasks</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">subtasks</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">agentsn</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;该任务对应的Agent&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">status</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;状态 0: INIT&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">taskid</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;拆解前的任务ID&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="k">INDEX</span> <span class="n">idx_task</span><span class="p">(</span><span class="o">`</span><span class="n">taskid</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;针对任务拆解后的任务信息&quot;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">tasks</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">tasks</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">status</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;状态 0: INIT&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="k">user</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="ss">&quot;下发任务的用户名&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="k">count</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;拆解后的子任务数&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">complete</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;已经完成的子任务数&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">body</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;任务消息体&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;服务端下发的任务&quot;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">pendings</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">pendings</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">subtaskid</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">taskid</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
	<span class="o">`</span><span class="n">status</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;状态 0: INIT&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_schedule</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="k">INDEX</span> <span class="n">idx_sched</span><span class="p">(</span><span class="o">`</span><span class="n">gmt_schedule</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;正在处理的任务&quot;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">events</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">events</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">agentsn</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;那个机器发生的事件&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">category</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;事件的分类 0:Server&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">localid</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;机器的本地ID标示&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">occured</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;事件发生的时间戳&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="o">`</span><span class="n">uk_event</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">agentsn</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">localid</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">occured</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;Agent发生的事件记录&quot;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">agents</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">agents</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;名称&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">os</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;操作系统类型，例如Linux、Windows10等&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">arch</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;机器架构，例如x86_64、ARM等&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="k">version</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;版本号&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">file</span><span class="o">`</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;文件名称&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="o">`</span><span class="n">uk_name_version</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">os</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="n">arch</span><span class="o">`</span><span class="p">,</span> <span class="o">`</span><span class="k">version</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;Agent发布的版本信息&quot;</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">agents</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">version</span><span class="p">,</span> <span class="n">arch</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gmt_modify</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="ss">&quot;BasicAgent&quot;</span><span class="p">,</span> <span class="ss">&quot;0.1.1-1&quot;</span><span class="p">,</span> <span class="ss">&quot;x86_64&quot;</span><span class="p">,</span> <span class="ss">&quot;linux&quot;</span><span class="p">,</span>
                <span class="ss">&quot;BasicAgent-0.1.1-1.x86_64.rpm&quot;</span><span class="p">,</span> <span class="n">now</span><span class="p">());</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">agents</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">version</span><span class="p">,</span> <span class="n">arch</span><span class="p">,</span> <span class="n">os</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">gmt_modify</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="ss">&quot;MonitorAgent&quot;</span><span class="p">,</span> <span class="ss">&quot;0.1.2-1&quot;</span><span class="p">,</span> <span class="ss">&quot;x86_64&quot;</span><span class="p">,</span> <span class="ss">&quot;linux&quot;</span><span class="p">,</span>
                <span class="ss">&quot;MonitorAgent-0.1.2-1.x86_64.rpm&quot;</span><span class="p">,</span> <span class="n">now</span><span class="p">());</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">agentsn</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;AgentSN用来唯一标示一台主机&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">hostname</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="ss">&quot;主机名&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">ipaddr</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="ss">&quot;注册时连接到Server的客户端IP，管理面IP&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">region</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;所属region信息&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">status</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;主机状态 0:unknown 1:register 2:online 3:offline&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">feature</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span> <span class="k">COMMENT</span> <span class="ss">&quot;Agent所具有的特性 0: cgroup&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">step</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">300</span> <span class="k">COMMENT</span> <span class="ss">&quot;Agent的采集时间间隔，单位是秒&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">prevers</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="ss">&quot;上个版本，用来回滚&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">curvers</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">COMMENT</span> <span class="ss">&quot;当前版本号&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="o">`</span><span class="n">uk_agentsn</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">agentsn</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;保存主机基本信息&quot;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">tags</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">tags</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;TAG名称&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">value</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;TAG值&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;TAG信息表&quot;</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tags</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="ss">&quot;svc&quot;</span><span class="p">,</span> <span class="ss">&quot;ecs&quot;</span><span class="p">);</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">regions</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">regions</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;Region的名称&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;保存的Region信息&quot;</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">regions</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="ss">&quot;global&quot;</span><span class="p">);</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts_tags</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts_tags</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">hostid</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;主机ID信息&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">tagid</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;TAG ID信息&quot;</span><span class="p">,</span>
	<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">hostid</span><span class="p">,</span> <span class="n">tagid</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;主机与TAG的关联表&quot;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts_agents</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts_agents</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">hostid</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;主机ID信息&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">agentid</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;Agent版本信息&quot;</span><span class="p">,</span>
	<span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">hostid</span><span class="p">,</span> <span class="n">agentid</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;主机与Agent的关联表&quot;</span><span class="p">;</span></code></pre></figure>

<h2 id="api">API</h2>

<!--
https://my.oschina.net/henrylee2cn/blog/741315
-->

<!--
#### 3. 常驻进程管理

主要用于管理一些子进程，包括了监控、日志、安全相关的进程管理。

##### 3.1 表结构设计

常驻进程相关的数据同样保存在 `gearman.db` 文件中。


<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">daemon</span><span class="o">`</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">daemon</span><span class="o">`</span> <span class="p">(</span>
    <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="k">version</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="n">url</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="n">precheck</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
    <span class="o">`</span><span class="n">precheck_retries</span><span class="o">`</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="o">`</span><span class="k">start</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="n">start_delay</span><span class="o">`</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="o">`</span><span class="n">stop</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="o">`</span><span class="n">stop_timeout</span><span class="o">`</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="o">`</span><span class="k">check</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="o">`</span><span class="n">check_interval</span><span class="o">`</span> <span class="nb">INT</span><span class="p">,</span>
    <span class="o">`</span><span class="k">user</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="o">`</span><span class="k">group</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
    <span class="o">`</span><span class="n">pidfile</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
    <span class="o">`</span><span class="n">socket</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
    <span class="o">`</span><span class="n">env</span><span class="o">`</span> <span class="nb">TEXT</span><span class="p">,</span>
    <span class="o">`</span><span class="n">limits</span><span class="o">`</span> <span class="nb">TEXT</span><span class="p">,</span>
    <span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
    <span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span>
<span class="p">);</span></code></pre></figure>



##### 3.2 下发任务

这里只会更新数据库。


<figure class="highlight"><pre><code class="language-text" data-lang="text">{
    &quot;id&quot;: &quot;xxxxx&quot;,
    &quot;method&quot;: &quot;daemon.init&quot;,
    &quot;name&quot;: &quot;plugin_name&quot;,                   // 必选，任务名称 64
    &quot;version&quot;: &quot;1.0.1&quot;,                      // 必选，版本号 64
    &quot;url&quot;: &quot;http://your/monitor.rpm&quot;,        // 必选，下载安装包路径 512
    &quot;precheck&quot;: &quot;/your/program/path/check&quot;,  // 启动前检查命令 512
    &quot;precheck_retries&quot;: 3,                   // 检查重试次数
    &quot;start&quot;: &quot;/your/program/path/start&quot;,     // 必选，启动命令 512
    &quot;start_delay&quot;: 10,                       // 启动任务后sleep多久之后检查是否启动成功
    &quot;stop&quot;: &quot;/your/program/path/stop&quot;,       // 必选，停止任务 512
    &quot;stop_timeout&quot;: 10,                      // 停止任务超时时间，超时直接kill -9
    &quot;check&quot;: &quot;process&quot;,                      // 存活检查方式
    &quot;check_interval&quot;: 10,                    // 存活检查时间间隔
    &quot;user&quot;: &quot;user name&quot;,
    &quot;group&quot;: &quot;group name&quot;,
    &quot;pidfile&quot;: &quot;/var/run/program.pid&quot;,
    &quot;socket&quot;: &quot;/var/run/program.sock&quot;,
    &quot;env&quot;: {
         &quot;PATH&quot;:&quot;/usr/bin:/usr/sbin&quot;
    },
    &quot;limits&quot;: {
        &quot;hits&quot;: 5,
        &quot;cpu&quot;: &quot;5%&quot;,
        &quot;memory&quot;: &quot;100M&quot;
    }
}</code></pre></figure>


其中 stop 中可以使用 `<process|kill>:argument` 这种方式，前者会执行一个命令，后者则会发送信号给对应的进程。


#### 4. 服务端表结构设计


<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">hosts</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">hostname</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;可以是主机名、AgentSN等&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">region</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="ss">&quot;unkown&quot;</span> <span class="k">COMMENT</span> <span class="ss">&quot;所属region信息&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="n">status</span><span class="o">`</span> <span class="n">ENUM</span><span class="p">(</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="s1">&#39;offline&#39;</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="s1">&#39;unknown&#39;</span> <span class="k">COMMENT</span> <span class="ss">&quot;主机状态&quot;</span><span class="p">,</span>

	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;保存主机基本信息&quot;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">plugins</span><span class="o">`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="o">`</span><span class="n">plugins</span><span class="o">`</span> <span class="p">(</span>
	<span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
	<span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;插件名称&quot;</span><span class="p">,</span>
	<span class="o">`</span><span class="k">version</span><span class="o">`</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="ss">&quot;插件版本号信息&quot;</span><span class="p">,</span>

	<span class="o">`</span><span class="n">gmt_modify</span><span class="o">`</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
	<span class="o">`</span><span class="n">gmt_create</span><span class="o">`</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span> <span class="k">COMMENT</span> <span class="ss">&quot;插件信息&quot;</span><span class="p">;</span></code></pre></figure>




https://github.com/sevagas/swap_digger

## 直方图

High Dynamic Range Histogram
http://hdrhistogram.org/
https://github.com/HdrHistogram/HdrHistogram_c

https://github.com/powturbo/TurboHist
https://github.com/astrofrog/fast-histogram

Vector Field Histogram 机器人中的算法
https://github.com/agarie/vector-field-histogram
SSH加固
https://www.freebuf.com/articles/system/185846.html

https://www.freebuf.com/articles/web/186298.html
DNS后门
https://www.freebuf.com/articles/network/185324.html
https://www.freebuf.com/articles/system/185942.html
https://www.freebuf.com/sectool/185276.html

test/common.c
中对应的value_to_rate


/home/andy/Workspace/4-Aspire/gopath:/home/andy/Workspace/go
unexpected directory layout:
        import path: _/home/andy/Workspace/4-Aspire/gopath/src/github.com/aspire/taskinfo
        root: /home/andy/Workspace/4-Aspire/gopath/src
        dir: /home/andy/Workspace/4-Aspire/gopath/src/github.com/aspire/taskinfo
        expand root: /home/andy/Workspace/4-Aspire/vendor
        expand dir: /home/andy/Workspace/4-Aspire/taskinfo
        separator: /
-->


        <hr>
      </div>
    </div>
  </div>
  <hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
