<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>PostgreSQL 简单介绍|JinYang's Blog</title>
  <meta name="keywords" content="postgresql,简介">
  <meta name="description" content="PostgreSQL 可以说是目前功能最强大、特性最丰富和结构最复杂的开源数据库管理系统，其中有些特性甚至连商业数据库都不具备。这里简单介绍 PG 的常见操作。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>PostgreSQL 简单介绍</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2016-08-02 Tuesday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  database ,  postgresql ,  linux  
      
    </div>
  </div>
  <hr>
  <p>PostgreSQL 可以说是目前功能最强大、特性最丰富和结构最复杂的开源数据库管理系统，其中有些特性甚至连商业数据库都不具备。</p>

<p>这里简单介绍 PG 的常见操作。</p>

<!-- more -->

<p><img src="/images/databases/postgresql/postgresql-logo.jpg" alt="PostgreSQL Logo" title="PostgreSQL Logo" class="pull-center" width="30%" /></p>

<h2 id="简介">简介</h2>

<p>PostgreSQL 可以说是目前功能最强大、特性最丰富和结构最复杂的开源数据库管理系统，其中有些特性甚至连商业数据库都不具备。这个起源于加州大学伯克利分校的数据库，现已成为一项国际开发项目，并且拥有广泛的用户群，尤其是在海外，目前国内使用者也越来越多。</p>

<p>PostgreSQL 基本上算是见证了整个数据库理论和技术的发展历程，由 UCB 计算机教授 Michael Stonebraker 于 1986 年创建。在此之前，Stonebraker 教授主导了关系数据库 Ingres 研究项目，88 年，提出了 Postgres 的第一个原型设计。</p>

<p>MySQL 号称是使用最广泛的开源数据库，而 PG 则被称为功能最强大的开源数据库。</p>

<h3 id="安装">安装</h3>

<p>可以通过 yum 安装和源码安装，其中前者相比要简单很多，后者通常在调试源码时使用。</p>

<h4 id="通过-yum-安装">通过 YUM 安装</h4>

<p>在 CentOS 中，可以直接通过 YUM 进行安装，不过默认的版本可能会比较低，在 CentOS 7 上默认安装的是 9.2，可以通过 yum info 查看当前的版本。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># yum install postgresql postgresql-server</code></pre></figure>

<p>如果要安装最新版本，可以从 <a href="http://yum.postgresql.org/">yum.postgresql.org</a> 上下载 repos 安装包，安装数据源。这也是推荐的一种方式，以下的 XXX 标记，根据不同的版本有所区别，不过操作大致相同。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 安装相应PG版本的repository，并更新库
# rpm -ivh pgdg-centos-XXX.rpm
# yum update

----- 安装相应的版本，包括常用的pgadmin工具
# yum --enablerepo=pgdgXX install postgresqlXX-server pgadmin3_XX postgresqlXX-contrib

----- 另外，安装完之后需要配置PATH环境变量，并使之生效
# cat /etc/profile
pathmunge /usr/pgsql-X.X/bin
# source /etc/profile</code></pre></figure>

<p>通过 YUM 方式安装后，同时会创建一个 postgres 用户，以及同名用户组，直接切换到该用户即可，执行相关的数据库操作即可。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># su - postgres

----- 初始化db，如下是安装之后默认的数据存储目录
$ initdb -D /var/lib/pgsql/X.X/data</code></pre></figure>

<p>在 CentOS 7 中，对于会同时安装如下的启动文件，其它的 systemctl 操作基本就相同了。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># ls /usr/lib/systemd/system/postgresql-X.X.service
# systemctl start postgresql-X.X</code></pre></figure>

<h4 id="通过源码安装">通过源码安装</h4>

<p>直接从官网 <a href="https://www.postgresql.org">www.postgresql.org</a> 下载相应版本的源码包。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 可以选择新建PG专用的用户
# groupadd postgres
# useradd -g postgres postgres

----- 解压、编译
$ tar -xf postgresql-X.X.X.tar.bz2 &amp;&amp; cd postgresql-X.X.X
$ ./configure --prefix=/opt/postgre
$ make
# make install

----- 同样可以编译contrib目录下的一些工具
$ cd contrib &amp;&amp; make
# make install

----- 绑定数据库文件存储目录
$ export PGDATA=/home/andy/Workspace/databases/postgre/data
$ /opt/postgre/bin/initdb -D $PGDATA

----- 常见操作，如启动、停止数据库
$ /opt/postgre/bin/pg_ctl -D $PGDATA -l logfile start
$ /opt/postgre/bin/pg_ctl -D $PGDATA -l logfile stop</code></pre></figure>

<h3 id="日志查看">日志查看</h3>

<p>PG 的日志分为三类，分别是 <code>pg_log</code>、<code>pg_xlog</code> 和 <code>pg_clog</code>，一般保存在 <code>$PGDATA</code> 对应的目录下。</p>

<ol>
  <li>pg_log  数据库运行日志，默认开启，可以通过配置 <code>$PGDATA/postgresql.conf</code> 。</li>
  <li>pg_xlog WAL日志，强制开启。</li>
  <li>pg_clog 事务提交日志，记录事务的元数据，强制开启。</li>
</ol>

<h3 id="防火墙selinux-设置">防火墙、SELinux 设置</h3>

<p>PG 默认使用 <code>5432</code> 端口，也可以在 <code>postgresql.conf</code> 文件中设置，可以使用如下命令开启防火墙端口。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># firewall-cmd --add-port=5432/tcp                          # 暂时有效
# firewall-cmd --permanent --add-port=5432/tcp              # 永久生效
----- 在iptables中开启
# iptables -A INPUT -p tcp --dport 5432 -m state --state NEW,ESTABLISHED -j ACCEPT</code></pre></figure>

<p>如果开启了 SELinux 服务，可能会在使用中遇到各种各样的权限问题。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 修改数据库的存放位置，必须添加一些新上下文来匹配新位置
# semanage fcontext -a -t postgresql_db_t &quot;/new/location(/.*)?&quot;
----- 默认端口不起作用，需要匹配postgre的端口类型为你想要的端口
# semanage port -a -t postgresql_port_t -p tcp 5433
----- 如果APP需要通过TCP/IP与PG交互，你需要告诉SELinux允许这个操作
# setsebool -P httpd_can_network_connect_db on</code></pre></figure>

<h3 id="设置用户和数据库">设置用户和数据库</h3>

<p>创建一个用户，并为用户创建一个数据库。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ psql -U postgres -W
psql (9.3.2)
Type &quot;help&quot; for help.

postgres=# \password postgres         # 设置一下密码

----- 可以通过如下方式创建用户、数据库
postgres=# CREATE USER foobar WITH PASSWORD &#39;justkidding&#39;;
postgres=# CREATE DATABASE test OWNER foobar;

----- 也可以直接在shell中创建
$ createuser foobar
$ createdb --owner=foobar test</code></pre></figure>

<h3 id="配置">配置</h3>

<p>PG 主要使用了两个配置文件 <code>/var/lib/pgsql/data/{postgresql.conf, pg_hba.conf}</code>，其中一些配置参数可以通过命令行选项传给守护进程，此时会覆盖配置文件中的设置。</p>

<p>例如，如果想要修改服务的端口为 5433，创建一个名为 <code>/etc/systemd/system/postgresql.service</code> 的文件，包含以下内容。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">.include /lib/systemd/system/postgresql.service
[Service]
Environment=PGPORT=5433</code></pre></figure>

<p>当数据库安装后，可以通过编辑 <code>/var/lib/pgsql/data/pg_hba.conf</code> 文件来实现权限管理。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># TYPE    DATABASE        USER            ADDRESS                 METHOD
  host    all             all             127.0.0.1/32            md5
  local   all             postgres                                peer</code></pre></figure>

<h2 id="常见操作">常见操作</h2>

<p>接下来，我们使用默认的用户 postgres 登陆，执行一些 CURD (Create, Update, Read, Delete) 操作。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ /opt/postgre/bin/createdb test             # 创建test数据库
$ /opt/postgre/bin/psql test                 # 链接到test数据库
test=# create table test1(id integer);       # 建表
test=# insert into test1 values(1);          # 插入数据
test=# select * from test1;                  # 查询</code></pre></figure>

<p>也可以直接登陆创建。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ psql -U postgres -W                        # 直接登陆，默认无密码
postgres=# CREATE USER foobar WITH PASSWORD &#39;password&#39;;          # 创建用户
postgres=# CREATE DATABASE test OWNER foobar ENCODING &#39;UTF8&#39;;    # 以及数据库

$ psql -U foobar -W test
Password for user foobar: password
test=&gt; \q</code></pre></figure>

<p>可以直接修改配置文件，允许远程访问。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 修改/var/lib/pgsql/data/postgresql.conf
listen_addresses =&#39;*&#39;

----- 修改/var/lib/pgsql/data/pg_hba.conf
host    all             all             0.0.0.0/0            trust</code></pre></figure>

<h3 id="修改配置">修改配置</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 直接查看内部虚拟表
postgre=# SELECT name, unit FROM pg_settings;

----- 通过show命令查看
postgre=# SHOW ALL;
postgre=# SHOW maintenance_work_mem;

----- 修改数据库参数
postgre=# ALTER SYSTEM SET maintenance_work_mem= 1048576;

----- 恢复到默认设置值
postgre=# ALTER SYSTEM SET maintenance_work_mem= default;</code></pre></figure>

<p>可以直接修改 <code>postgresql.conf</code> 中的配置，然后重启。</p>

<h3 id="状态查看">状态查看</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看PG的当前进程
# ps auxww | grep ^postgres</code></pre></figure>

<p>主要包括了两类进程，分别是启动时的后台进程，以及用户连接的进程；对于前者，其中 stats collector 和 autovacuum launcher 两个进程是可选启动的，各个进程作用如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">postgres: 主进程，接收客户端连接，创建服务进程；启动时拉起和管理后台进程。
achiever process: 事务日志归档进程。</code></pre></figure>

<p>而用户进程通常格式如下：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">postgres: user database host activity</code></pre></figure>

<p>其中 activity 的状态为 idle (正在等待用户输入命令)、idle in transaction、waiting (等待锁) 等。</p>

<h3 id="ctid">CTID</h3>

<p>在 PG 中的 ctid 表示数据记录的物理行信息，用于标示一条记录位于那个数据块的那个位移上面，类似于 Oracle 中的 rowid 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">postgres=# CREATE TABLE test(x int, y varchar(30), z date) TABLESPACE ts_demo;
CREATE TABLE
postgres=# INSERT INTO test VALUES(1, &#39;ShangHai&#39;, now()), (2, &#39;NanJing&#39;, now()), (3, &#39;HangZhou&#39;, now());
INSERT 0 3
postgres=# INSERT INTO test SELECT generate_series(4, 1000), &#39;JiNan &#39;||generate_series(4, 1000), now();
postgres=# SELECT ctid, * FROM test;
postgres=# ANALYZE test;
postgres=# SELECT relpages, reltuples FROM pg_class WHERE relname = &#39;t&#39;;</code></pre></figure>

<p>当删除了数据之后，原有的空间不会自动释放，可以通过 vacuum tbl 回收。</p>

<!-- generate_series(0, 100, 2); -->

<h3 id="索引">索引</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 创建唯一约束
postgres=# ALTER TABLE tbl ADD CONSTRAINT UK_tbl_col UNIQUE(x, y);

----- 创建函数索引
postgres=# CREATE INDEX idx_tbl_col ON tbl USING btree(UPPER(x), y);

----- 创建部分索引
postgres=# CREATE INDEX idx_tbl_col ON tbl USING btree(UPPER(x), y) WHERE z IS NULL;</code></pre></figure>

<h3 id="常用命令">常用命令</h3>

<p>pgsql 常见的命令。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看帮助
postgre=# \h SELECT            # 查看SQL命令的帮助
postgre=# \?                   # 查看psql命令的帮助

----- 导入/导出数据
postgre=# \i file.sql          # 从某个文件导入
postgre=# COPY weather FROM &#39;file.txt&#39;;

----- 切换数据库，相当于MySQL的use dbname
postgre=# \c dbname username IP PORT

----- 查看数据库，相当于MySQL的show databases
postgre=# \l    \list

----- 查看表，相当于MySQL的show tables
postgre=# \dt

----- 查看表结构，相当于desc
postgre=# \d tblname           # \d+ tblname查看详细信息

----- 查看索引
postgre=# \di

----- 查看用户
postgre=# \du

----- 在文本编辑器中编译，退出后执行
postgre=# \e

----- 查看当前连接的信息
postgre=# \conninfo

----- 其它杂项
postgre=# \! shell-command                   # 执行终端的命令
postgre=# \set COMP_KEYWORD_CASE upper       # 设置自动提示关键字大写显示
postgre=# \x auto                            # 如果列较多时，通过行显示，其中\x表示直接行显示
postgre=# \pset null ¤                       # 当值为NULL时显示如下的字符，以区分空格</code></pre></figure>

<p>PG 中通过 <code>::</code> 进行类型转换；另外，支持一些常见的字符串匹配函数，如 <code>ilike</code>、<code>~*</code> 等，详细可以参考 <a href="https://www.postgresql.org/docs/9.6/static/functions-matching.html">Pattern Matching</a> 。</p>

<h2 id="常用概念">常用概念</h2>

<p>在 PostgreSQL 中，有各种各样的概念，常见的有表空间、数据库、模式、表、用户、角色等。</p>

<h3 id="角色-vs-用户">角色 VS. 用户</h3>

<p>这两个可以理解为相同，只是两者在创建时默认行为的区别，其它基本一致。文档中，对两者进行了简单的说明 <code>CREATE USER is the same as CREATE ROLE except that it implies LOGIN.</code> ，也就是说如下的命令是等价的。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">CREATE ROLE foobar PASSWORD &#39;foobar&#39; LOGIN;
CREATE USER foobar PASSWORD &#39;foobar&#39;;</code></pre></figure>

<h3 id="数据库-vs-模式">数据库 VS. 模式</h3>

<p>简单来说模式 (Schema) 就是对数据库 (Database) 的逻辑分割，而且在数据库创建的时候，已经默认创建了一个 public 模式，在此数据库中创建的对象，如表、函数、试图、索引、序列等都保存在这个模式中。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 1. 创建一个数据库
CREATE DATABASE tsdb;
----- 2. 链接到新建的数据库，并查看其中的模式
\c tsdb
\dn
----- 3. 新建一张测试表
CREATE TABLE test(id INTEGER NOT NULL);
\d
----- 4. 创建新的模式，同时设置属主为默认用户，并查看当前库所有的表
CREATE SCHEMA foobar AUTHORIZATION postgres;
CREATE TABLE foobar.test (id INTEGER NOT NULL);
SELECT * FROM pg_tables WHERE schemaname NOT IN(&#39;pg_catalog&#39;, &#39;information_schema&#39;);
----- 5. 如果通过\d查看时，需要设置搜索路径
SHOW search_path;
SET search_path TO &#39;foobar,public&#39;
\d</code></pre></figure>

<p>也就是说，数据库通过模式做逻辑区分，而且一个数据库至少包含一个模式，接到一个数据库后，可以通过 <code>search_path</code> 设置搜索顺序。</p>

<h3 id="表空间-vs-数据库">表空间 VS. 数据库</h3>

<p>在通过 <code>CREATE DATABASE dbname</code> 语句创建数据库时，默认的数据库所有者是当前创建数据库的角色，默认表空间是系统的默认表空间 pg_default ，其主要原因是创建是通过克隆数据库模板实现的。</p>

<p>如上创建数据库时，如果没有指明数据库模板，系统将默认克隆 template1 数据库，其默认表空间是 pg_default ，其完整的语句如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">CREATE DATABASE dbname OWNER foobar TEMPLATE template1 TABLESPACE tablespacename;</code></pre></figure>

<p>实际上可以通过如下的步骤进行测试：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 1. 切换到template1数据库并新建一个表进行测试
\c template1
CREATE TABLE test(id INTEGER NOT NULL);
INSERT INTO test VALUES (1);
----- 2. 创建一个表空间，需要注意对应的目录存在且为空
CREATE TABLESPACE tsfoobar OWNER postgres LOCATION &#39;/tmp/foobar&#39;;
----- 3. 创建一个数据库
CREATE DATABASE dbfoobar TEMPLATE template1 OWNERE postgres TABLESPACE tsfoobar;</code></pre></figure>

<p>链接查看新数据库时，实际上存在一个表，而且有上述写入的数据。表空间是一个存储区域，在一个表空间中可以存储多个数据库，尽管 PostgreSQL 不建议这么做，例如将索引保存到 SSD 中，而数据保存到 SATA 中。</p>

<h2 id="常用特性">常用特性</h2>

<h3 id="sequece">sequece</h3>

<p>序列对象，也被称为序列生成器，实际上就是用 <code>CREATE SEQUENCE</code> 创建的特殊的单行表，通常用来表生成唯一的标识符。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 直接在建表时使用serial类型，默认生成为tblname+colname+&#39;seq&#39;
postgres=# CREATE TABLE tbl_seq(id SERIAL, name TEXT);
CREATE TABLE
postgres=# \d tbl_seq
                         Table &quot;public.tbl_seq&quot;
 Column |  Type   |                      Modifiers
--------+---------+------------------------------------------------------
 id     | integer | not null default nextval(&#39;tbl_seq_id_seq&#39;::regclass)
 name   | text    |
postgres=# \d tbl_seq_id_seq
       Sequence &quot;public.tbl_seq_id_seq&quot;
    Column     |  Type   |        Value
---------------+---------+---------------------
 sequence_name | name    | tbl_seq_id_seq
 last_value    | bigint  | 1
 start_value   | bigint  | 1
 increment_by  | bigint  | 1
 max_value     | bigint  | 9223372036854775807
 min_value     | bigint  | 1
 cache_value   | bigint  | 1
 log_cnt       | bigint  | 0
 is_cycled     | boolean | f
 is_called     | boolean | f
Owned by: public.tbl_seq.id
postgres=# SELECT * FROM tbl_seq_id_seq;
 sequence_name  | last_value | start_value | increment_by | ...
----------------+------------+-------------+--------------+ ...
 tbl_seq_id_seq |          1 |           1 |            1 | ...
(1 row)

----- 单独创建序列，建表时指定，不过该列需要为int类型
postgres=# CREATE SEQUENCE seq_tblseq2 INCREMENT BY 1 MINVALUE 1 NO MAXVALUE START WITH 1;
CREATE SEQUENCE
postgres=# CREATE TABLE tbl_seq2(id INT NOT NULL DEFAULT nextval(&#39;seq_tblseq2&#39;), name TEXT);
CREATE TABLE</code></pre></figure>

<p>其中 <code>CREATE SEQUECE</code> 的语法可以参考 <a href="https://www.postgresql.com/docs/current/static/sql-createsequence.html">www.postgresql.com</a>，接下来看看如何使用序列。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">postgres=# INSERT INTO tbl_seq VALUES(nextval(&#39;tbl_seq_id_seq&#39;), &#39;Lucy&#39;);
INSERT 0 1
postgres=# INSERT INTO tbl_seq(name) VALUES(&#39;Andy&#39;);
INSERT 0 1</code></pre></figure>

<p>还有一个问题是在数据迁移之后，如何设置 sequence 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">postgres=# TRUNCATE tbl_seq;
TRUNCATE TABLE
postgres=# INSERT INTO tbl_seq(name) VALUES(&#39;Sanndy&#39;), (&#39;David&#39;), (&#39;Simon&#39;), (&#39;Peter&#39;);
INSERT 0 4
postgres=# select * from tbl_seq;
 id |  name
----+--------
  8 | Sanndy
  9 | David
 10 | Simon
 11 | Peter
(4 rows)
postgres=# COPY tbl_seq TO &#39;/tmp/tbl_seq.sql&#39;;
COPY 4
postgres=# TRUNCATE tbl_seq;
TRUNCATE TABLE

------ 尝试恢复
postgres=# BEGIN
BEGIN
postgres=# COPY tbl_seq FROM &#39;/tmp/tbl_seq.sql&#39;;
COPY 4
postgres=# SELECT setval(&#39;tbl_seq_id_seq&#39;, max(id)) from tbl_seq;
 setval
--------
     11
(1 row)
postgres=# END;
COMMIT

postgres=# INSERT INTO tbl_seq(name) VALUES(&#39;Monica&#39;);
INSERT 0 1
postgres=# select * from tbl_seq;
 id |  name
----+--------
  8 | Sanndy
  9 | David
 10 | Simon
 11 | Peter
 12 | Monica
(5 rows)</code></pre></figure>

<p>其它的一些常用函数还包括了：</p>

<ol>
  <li><code>nextval(seq)</code>：递增到下一个值，并返回当前值，即使多个会话并发执行该函数，每个进程也会安全的收到一个唯一的序列值。</li>
  <li><code>currval(seq)</code>：当前会话返回的最近一次的值，如果从没有执行过 <code>nextval()</code> 则会返回错误。</li>
  <li><code>setval(seq, bigint, boolean)</code>：重置序列对象的值，如果最后一个参数为 false，那么 nextval 首先返回该值，然后才开始递增。</li>
</ol>

<p>删除非常简单。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">postgres=# DROP SEQUENCE seq;</code></pre></figure>

<h3 id="cursor">cursor</h3>

<p>在一个查询中，可以使用游标 (cursor)，防止一个大查询超过了内容的容量，而对于 PL/pgSQL 来说，FOR 语句则默认使用了游标。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">postgre=# CREATE TABLE foobar(id INT);
CREATE TABLE
postgre=# INSERT INTO foobar VALUES(generate_series(1, 1000));
INSERT 0 1000

postgre=# BEGIN;
BEGIN
postgre=# DECLARE cur CURSOR FOR SELECT * FROM foobar;
DECLARE CURSOR
postgre=# FETCH FIRST FROM cur;           # 移动到第一行，并返回第一行数据
 id
----
  1
(1 row)
postgre=# FETCH NEXT FROM cur;            # 获取下一行
 id
----
  2
(1 row)
postgre=# MOVE LAST IN cur;               # 移动到最后
MOVE 1
postgre=# CLOSE cur;                      # 关闭游标
CLOSE CURSOR</code></pre></figure>

<p>另外，PG 允许在函数中返回对 cursor 的引用，这样就可以直接通过函数返回一个大的对象。</p>

<h3 id="常用程序">常用程序</h3>

<p>简单介绍下 PG 相关的程序，部分比较复杂的只是在此简单记录下，详细介绍可以参考后面的文章。</p>

<h4 id="pg_config">pg_config</h4>

<p>用来显示当前版本的一些配置参数，如 bin 目录、版本信息、cpp flags 等。</p>

<h4 id="pg_controldata">pg_controldata</h4>

<p>用来显示当前 cluster 的一些详细信息。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ pg_controldata -D $PGDATA</code></pre></figure>

<h4 id="pg_test_fsync">pg_test_fsync</h4>

<p>用于测试不同的 wal_sync_method 参数所具有的性能。</p>

<h4 id="pg_test_timing">pg_test_timing</h4>

<p>用于时间测试的程序，详细可以参考文档。</p>

<!--
# PL/pgSQL


<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="n">somefunc</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="nb">integer</span> <span class="k">AS</span> <span class="err">$$</span>
<span class="o">&lt;&lt;</span> <span class="n">outerblock</span> <span class="o">&gt;&gt;</span>
<span class="k">DECLARE</span>
<span class="n">quantity</span> <span class="nb">integer</span> <span class="p">:</span><span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="n">RAISE</span> <span class="n">NOTICE</span> <span class="s1">&#39;Quantity here is %&#39;</span><span class="p">,</span> <span class="n">quantity</span><span class="p">;</span> <span class="c1">-- Prints 30</span>
<span class="n">quantity</span> <span class="p">:</span><span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="c1">--</span>
<span class="c1">-- Create a subblock</span>
<span class="c1">--</span>
<span class="k">DECLARE</span>
<span class="n">quantity</span> <span class="nb">integer</span> <span class="p">:</span><span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="k">BEGIN</span>
<span class="n">RAISE</span> <span class="n">NOTICE</span> <span class="s1">&#39;Quantity here is %&#39;</span><span class="p">,</span> <span class="n">quantity</span><span class="p">;</span> <span class="c1">-- Prints 80</span>
<span class="n">RAISE</span> <span class="n">NOTICE</span> <span class="s1">&#39;Outer quantity here is %&#39;</span><span class="p">,</span> <span class="n">outerblock</span><span class="p">.</span><span class="n">quantity</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="n">RAISE</span> <span class="n">NOTICE</span> <span class="s1">&#39;Quantity here is %&#39;</span><span class="p">,</span> <span class="n">quantity</span><span class="p">;</span>
<span class="c1">-- Prints 50</span>
<span class="c1">-- Prints 50</span>
<span class="k">RETURN</span> <span class="n">quantity</span><span class="p">;</span>
<span class="k">END</span><span class="p">;</span>
<span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span></code></pre></figure>



## 多实例部署

有些常见的操作，如主备，需要在同一台机器上部署多个实例。

## WAL 日志解析

9.3 之后提供了 pg_xlogdump 工具用来解析 xlog 中的内容，对于之前的版本可以考虑使用 [xlogdump-github](https://github.com/snaga/xlogdump) 这个开源的软件。

通过该工具找到精准的误操作XID。

pg_ctl reload 重新加载即可。
-->

<h2 id="参考">参考</h2>

<p>可以参考官方网站 <a href="http://www.postgresql.org/">www.postgresql.org</a>，以及 <a href="http://www.postgres.cn/">PostgreSQL 中文社区</a> 。国内 PG 研究比较多的人，可以查看 <a href="http://blog.163.com/digoal@126/">PostgreSQL Research</a>。</p>

<p>源码可以参考 <a href="https://github.com/postgres/postgres">Github Postgres</a> 。</p>

<!--
pgcli.com
http://www.rails365.net/groups/postgresql

[xxxx](http://blog.itpub.net/30088583) 。

http://www.postgres.cn/news/viewone/1/99                 参考资料
https://github.com/ty4z2008/Qix/blob/master/pg.md

http://www.2cto.com/database/201608/541209.html
https://pan.baidu.com/share/home?uk=1982970774#category/type=0

pgadmin3  管理工具

PostgreSQL 9 Administration CookBook    一本不错的书籍
-->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/mysql-multi-threaded-slaves_init.html" title="MySQL 并行复制">&larr; Older</a></li> 
         <li class="next"><a href="/post/postgresql-misc_init.html" title="PG 常用命令">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1470067200',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/postgresql-introduce.html" data-title="PostgreSQL 简单介绍" data-url="/post/postgresql-introduce.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
