<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>Greenlet Gevent|JinYang's Blog</title>
  <meta name="keywords" content="python,greenlet,并发,协程,gevent">
  <meta name="description" content="对于服务器端的编程，从多进程，到多线程，再到异步回调，再到现在比较流行的协程的方式。对于 Python 来说，支持多进程；由于存在 GIL，实际对于线程会有性能影响。对于 Python 协程在此介绍一下 greenlet 的实现。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>Greenlet Gevent</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2014-09-04 Thursday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  python ,  program ,  linux  
      
    </div>
  </div>
  <hr>
  <p>对于服务器端的编程，从多进程，到多线程，再到异步回调，再到现在比较流行的协程的方式。对于 Python 来说，支持多进程；由于存在 GIL，实际对于线程会有性能影响。</p>

<p>对于 Python 协程在此介绍一下 greenlet 的实现。</p>

<!-- more -->

<h2 id="简介">简介</h2>

<h3 id="安装">安装</h3>

<p>在 CentOS 中，可以通过如下方式安装。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># pip install greenlet</code></pre></figure>

<!--

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">gr1</span><span class="p">.</span><span class="n">dead</span>         <span class="n">gr1</span><span class="p">.</span><span class="n">gettrace</span>     <span class="n">gr1</span><span class="p">.</span><span class="n">parent</span>       <span class="n">gr1</span><span class="p">.</span><span class="k">switch</span>
<span class="n">gr1</span><span class="p">.</span><span class="n">error</span>        <span class="n">gr1</span><span class="p">.</span><span class="n">gr_frame</span>     <span class="n">gr1</span><span class="p">.</span><span class="n">run</span>          <span class="n">gr1</span><span class="p">.</span><span class="n">throw</span>
<span class="n">gr1</span><span class="p">.</span><span class="n">getcurrent</span>   <span class="n">gr1</span><span class="p">.</span><span class="n">GreenletExit</span> <span class="n">gr1</span><span class="p">.</span><span class="n">settrace</span></code></pre></figure>

-->

<p>如下是简单的测试函数。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span>

<span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">print</span> <span class="mi">12</span><span class="p">,</span> <span class="n">arg</span>
    <span class="n">gr2</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
    <span class="k">print</span> <span class="mi">34</span>

<span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="k">print</span> <span class="mi">56</span>
    <span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
    <span class="k">print</span> <span class="mi">78</span>

<span class="n">gr1</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">test1</span><span class="p">)</span>
<span class="n">gr2</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">test2</span><span class="p">)</span>
<span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="s">&quot;foo bar&quot;</span><span class="p">)</span>

<span class="c"># OUTPUT:</span>
<span class="c"># 12 foo bar</span>
<span class="c"># 56</span>
<span class="c"># 34</span></code></pre></figure>

<h3 id="greenlet-入门">greenlet 入门</h3>

<p>首先查看如下的示例。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;coroutine foo&quot;</span>
    <span class="n">gr2</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">gr2</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">value</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;coroutine bar&quot;</span>
    <span class="k">return</span> <span class="s">&quot;bar return value&quot;</span>

<span class="n">gr1</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>

<span class="c"># OUTPUT:</span>
<span class="c"># coroutine foo</span>
<span class="c"># coroutine bar</span>
<span class="c"># bar return value</span></code></pre></figure>

<p>首先创建了一个名称为 gr1 的 greenlet 协程，然后调用 switch() 方法，让这个协程开始执行，也就是开始执行 foo() 函数。在 foo() 函数中，打印字符串，新建另外一个协程，并切换过去执行 … …</p>

<p>上述的例子基本和同步执行没有任何区别，接着修改下上述的代码，如下：</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;coroutine foo&quot;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">gr2</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
    <span class="k">print</span> <span class="s">&quot;coroutine end&quot;</span><span class="p">,</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">bar</span><span class="p">():</span>
    <span class="k">print</span> <span class="s">&quot;coroutine bar&quot;</span>
    <span class="k">return</span> <span class="s">&quot;coroutine bar return value&quot;</span>

<span class="n">gr1</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
<span class="n">gr2</span> <span class="o">=</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">gr1</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>
<span class="k">print</span> <span class="n">out</span>

<span class="c"># OUTPUT:</span>
<span class="c"># coroutine foo</span>
<span class="c"># coroutine bar</span>
<span class="c"># coroutine bar return value</span></code></pre></figure>

<p>可以看到，当协程 gr2 执行完 bar() 函数之后，将参数返回到了最外层，而没有返回到 foo() 中，而且可以看到 foo() 最后一行程序没有执行。So, WHY ???</p>

<h2 id="greenlent-层次关系">greenlent 层次关系</h2>

<p>上述的程序，主要是和 greenlet 的层次关系了相关。在 greenlet 模块的初始话的时候，就会先建立一个最顶层的 greenlet 对象，他属于 greenlet 层次关系中的 root 节点。</p>

<p>在创建 greenlet 的时候，如果在构造函数中并没有指明 parent 对象，那么构建出来的 greenlet 对象将会默认将当前环境所在的 greenlet 作为 parent，当这个 greenlet 对象执行完成之后，将会调度其 parent 继续执行，而且会将返回参数也传递过去。</p>

<p>而在上述代码中，gr1 和 gr2 他们两个的 parent 都默认设置为了初始化建立的 greenlet 对象，所以在 gr2 执行完之后，并没有返回到 gr1 的 foo 函数中，而是直接返回到了最外层。</p>

<h1 id="源码解析">源码解析</h1>

<p>Greenlet 是通过 C 语言实现的，也就是说，实际上是 C 语言实现的一个模块，首先看看一个简单的示例。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;Python.h&gt;</span>

<span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg2</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">arg1</span> <span class="o">+</span> <span class="n">arg2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">wrap_add</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//Convert the python input objects into C objects</span>
    <span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;ii&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg2</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="c1">//Call c function</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="n">arg2</span><span class="p">);</span>

    <span class="c1">//wrap the result from c function to python object.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="p">)</span><span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// define the PyMethodDef methods</span>
<span class="k">static</span> <span class="n">PyMethodDef</span> <span class="n">wrap_methods</span><span class="p">[]</span> <span class="o">=</span><span class="p">{</span>
    <span class="p">{</span><span class="s">&quot;add&quot;</span><span class="p">,</span> <span class="n">wrap_add</span><span class="p">,</span> <span class="n">METH_VARARGS</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// initilization function</span>
<span class="n">PyMODINIT_FUNC</span> <span class="nf">initfoobar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_InitModule</span><span class="p">(</span><span class="s">&quot;foobar&quot;</span><span class="p">,</span> <span class="n">wrap_methods</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>注意 C 文件名 foobar.c 和 PyMODINIT_FUNC initfoobar(void) 以及 Py_InitModule(“foobar”) 中的部分必须一致。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ gcc -fpic -c -I /usr/include/python2.7 foobar.c
$ gcc -shared -o foobar.so foobar.o
$ python
&gt;&gt;&gt; import foobar
&gt;&gt;&gt; foobar.add(1,2)</code></pre></figure>

<p>每个 greenlet 其实就是一个函数以及保存这个函数执行时的上下文，对于函数来说上下文也就是其 stack；同一个进程的所有的 greenlets 共用操作系统分配的用户栈。</p>

<h2 id="模块初始化">模块初始化</h2>

<p>首先，在导入模块的时候，会调用初始化函数。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">PyMODINIT_FUNC</span> <span class="nf">initgreenlet</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">**</span> <span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">c_api_object</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_PyGreenlet_API</span><span class="p">[</span><span class="n">PyGreenlet_API_pointers</span><span class="p">];</span>

    <span class="n">GREENLET_NOINLINE_INIT</span><span class="p">();</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Py_InitModule</span><span class="p">(</span><span class="s">&quot;greenlet&quot;</span><span class="p">,</span> <span class="n">GreenMethods</span><span class="p">);</span> <span class="c1">// 初始化greenlet模块</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">PyModule_AddStringConstant</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;__version__&quot;</span><span class="p">,</span> <span class="n">GREENLET_VERSION</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ts_curkey</span> <span class="o">=</span> <span class="n">PyString_InternFromString</span><span class="p">(</span><span class="s">&quot;__greenlet_ts_curkey&quot;</span><span class="p">);</span>
    <span class="n">ts_delkey</span> <span class="o">=</span> <span class="n">PyString_InternFromString</span><span class="p">(</span><span class="s">&quot;__greenlet_ts_delkey&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ts_curkey</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ts_delkey</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyType_Ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyGreenlet_Type</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">PyExc_GreenletError</span> <span class="o">=</span> <span class="n">PyErr_NewException</span><span class="p">(</span><span class="s">&quot;greenlet.error&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyExc_GreenletError</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">PyExc_GreenletExit</span> <span class="o">=</span> <span class="n">PyErr_NewException</span><span class="p">(</span><span class="s">&quot;greenlet.GreenletExit&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">PyExc_GreenletExit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ts_empty_tuple</span> <span class="o">=</span> <span class="n">PyTuple_New</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ts_empty_tuple</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ts_empty_dict</span> <span class="o">=</span> <span class="n">PyDict_New</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ts_empty_dict</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 1. 创建root greenlet对象，首先会将ts_current创建为main greenlet</span>
    <span class="n">ts_current</span> <span class="o">=</span> <span class="n">green_create_main</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ts_current</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">INITERROR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyGreenlet_Type</span><span class="p">);</span>

    <span class="c1">// 2. 为当前的模块添加属性，如下的这个是比较重要的，也就是greenlet的构造结构</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;greenlet&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">PyGreenlet_Type</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">PyExc_GreenletError</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">PyExc_GreenletError</span><span class="p">);</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">PyExc_GreenletExit</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GreenletExit&quot;</span><span class="p">,</span> <span class="n">PyExc_GreenletExit</span><span class="p">);</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GREENLET_USE_GC&quot;</span><span class="p">,</span> <span class="n">PyBool_FromLong</span><span class="p">(</span><span class="n">GREENLET_USE_GC</span><span class="p">));</span>
    <span class="n">PyModule_AddObject</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;GREENLET_USE_TRACING&quot;</span><span class="p">,</span> <span class="n">PyBool_FromLong</span><span class="p">(</span><span class="n">GREENLET_USE_TRACING</span><span class="p">));</span>

    <span class="cm">/* also publish module-level data as attributes of the greentype. */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">copy_on_greentype</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">PyObject</span><span class="o">*</span> <span class="n">o</span> <span class="o">=</span> <span class="n">PyObject_GetAttrString</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">o</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">PyGreenlet_Type</span><span class="p">.</span><span class="n">tp_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Expose C API ... ... */</span>
<span class="p">}</span></code></pre></figure>

<p>代码挺长，不过其实就是 1) 初始化；2) 创建默认的最顶层的 greenlet 对象，而且将 ts_current 这个全局变量指向它；3) 将 greenlet 模块添加到当前的 namespace 。</p>

<p>接下来看看这个初始化创建的顶层的 greenlet 对象是怎么创建的，其中创建顶层 greenlet 对象，栈底部为 -1，顶部为 1 。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyGreenlet</span><span class="o">*</span> <span class="nf">green_create_main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyGreenlet</span><span class="o">*</span> <span class="n">gmain</span><span class="p">;</span>  <span class="c1">//待会创建的顶层的greenlet的引用</span>
    <span class="c1">//创建一个字典对象</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">dict</span> <span class="o">=</span> <span class="n">PyThreadState_GetDict</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dict</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyErr_Occurred</span><span class="p">())</span>
            <span class="n">PyErr_NoMemory</span><span class="p">();</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 为当前线程创建main greenlet对象</span>
    <span class="n">gmain</span> <span class="o">=</span> <span class="p">(</span><span class="n">PyGreenlet</span><span class="o">*</span><span class="p">)</span> <span class="n">PyType_GenericAlloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">PyGreenlet_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gmain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">gmain</span><span class="o">-&gt;</span><span class="n">stack_start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 栈顶设置为1</span>
    <span class="n">gmain</span><span class="o">-&gt;</span><span class="n">stack_stop</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// 栈底设置为-1，char*是无符号，可以保证这个是最大值</span>
    <span class="n">gmain</span><span class="o">-&gt;</span><span class="n">run_info</span> <span class="o">=</span> <span class="n">dict</span><span class="p">;</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">dict</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">gmain</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>上述参数中，将 stack_stop 设置为 -1，因为是无符号，所以 -1 其实是最大值。在该函数中，其实最重要的就是设置了两个值：stack_stop、stack_start，其中后者为栈顶，保存了当前最新的栈内容。</p>

<h2 id="结构体定义">结构体定义</h2>

<p>接下来看看 greenlet 的真正结构体在头文件中的定义，如下所示。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/**</span>
<span class="cm"> * States:</span>
<span class="cm"> * stack_stop == NULL &amp;&amp; stack_start == NULL:  did not start yet</span>
<span class="cm"> * stack_stop != NULL &amp;&amp; stack_start == NULL:  already finished</span>
<span class="cm"> * stack_stop != NULL &amp;&amp; stack_start != NULL:  active</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_greenlet</span> <span class="p">{</span> <span class="c1">// 协程对应的C结构体</span>
    <span class="n">PyObject_HEAD</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">stack_start</span><span class="p">;</span>             <span class="c1">// 栈顶，NULL标示已经结束了或未开始</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">stack_stop</span><span class="p">;</span>              <span class="c1">// 栈底</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">stack_copy</span><span class="p">;</span>              <span class="c1">// 栈保存到的内存地址</span>
    <span class="kt">intptr_t</span> <span class="n">stack_saved</span><span class="p">;</span>          <span class="c1">// 栈保存在外面的大小</span>
    <span class="k">struct</span> <span class="n">_greenlet</span><span class="o">*</span> <span class="n">stack_prev</span><span class="p">;</span>  <span class="c1">// 栈之间的上下层关系</span>
    <span class="k">struct</span> <span class="n">_greenlet</span><span class="o">*</span> <span class="n">parent</span><span class="p">;</span>      <span class="c1">// 父对象，构成greenlet对象的层次关系</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">run_info</span><span class="p">;</span>            <span class="c1">// 对应的run对象（函数）</span>
    <span class="k">struct</span> <span class="n">_frame</span><span class="o">*</span> <span class="n">top_frame</span><span class="p">;</span>      <span class="c1">// 这里可以理解为主要是控制python程序计数器</span>
    <span class="kt">int</span> <span class="n">recursion_depth</span><span class="p">;</span>           <span class="c1">// 栈深度</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">weakreflist</span><span class="p">;</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">exc_type</span><span class="p">;</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">exc_value</span><span class="p">;</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">exc_traceback</span><span class="p">;</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">dict</span><span class="p">;</span>
<span class="p">}</span> <span class="n">PyGreenlet</span><span class="p">;</span></code></pre></figure>

<p>其中 stack_start、stack_stop 分别指向当前协程栈的顶部和底部，当前栈的内容从栈顶出、入栈；另外，如上所示，可以通过这几个标志位的值来判断当前 greenlet 对象的状态。</p>

<p>另外，通过如下的结构体定义 C 语言与 Python 的对应关系，其中包括了相应的方法，例如 __init__()、__new__() 等。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="n">PyTypeObject</span> <span class="n">PyGreenlet_Type</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">PyVarObject_HEAD_INIT</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="s">&quot;greenlet.greenlet&quot;</span><span class="p">,</span>                <span class="cm">/* tp_name */</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">PyGreenlet</span><span class="p">),</span>                 <span class="cm">/* tp_basicsize */</span>
    <span class="mi">0</span><span class="p">,</span>                                  <span class="cm">/* tp_itemsize */</span>
    <span class="p">(</span><span class="n">destructor</span><span class="p">)</span><span class="n">green_dealloc</span><span class="p">,</span>          <span class="cm">/* tp_dealloc */</span>
    <span class="o">&amp;</span><span class="n">green_as_number</span><span class="p">,</span>                   <span class="cm">/* tp_as _number*/</span>
    <span class="n">Py_TPFLAGS_DEFAULT</span> <span class="o">|</span> <span class="n">Py_TPFLAGS_BASETYPE</span> <span class="o">|</span> <span class="n">GREENLET_GC_FLAGS</span><span class="p">,</span>   <span class="cm">/* tp_flags */</span>
    <span class="p">(</span><span class="n">traverseproc</span><span class="p">)</span><span class="n">GREENLET_tp_traverse</span><span class="p">,</span> <span class="cm">/* tp_traverse */</span>
    <span class="p">(</span><span class="n">inquiry</span><span class="p">)</span><span class="n">GREENLET_tp_clear</span><span class="p">,</span>         <span class="cm">/* tp_clear */</span>
    <span class="mi">0</span><span class="p">,</span>                                  <span class="cm">/* tp_richcompare */</span>
    <span class="n">offsetof</span><span class="p">(</span><span class="n">PyGreenlet</span><span class="p">,</span> <span class="n">weakreflist</span><span class="p">),</span>  <span class="cm">/* tp_weaklistoffset */</span>
    <span class="n">green_methods</span><span class="p">,</span>                      <span class="cm">/* tp_methods, 对象方法的定义 */</span>
    <span class="n">green_getsets</span><span class="p">,</span>                      <span class="cm">/* tp_getset, 属性方法 */</span>
    <span class="n">offsetof</span><span class="p">(</span><span class="n">PyGreenlet</span><span class="p">,</span> <span class="n">dict</span><span class="p">),</span>         <span class="cm">/* tp_dictoffset，这个对象的dict的偏移 */</span>
    <span class="p">(</span><span class="n">initproc</span><span class="p">)</span><span class="n">green_init</span><span class="p">,</span>               <span class="cm">/* tp_init，初始化，这里主要是设置run以及parent */</span>
    <span class="n">GREENLET_tp_alloc</span><span class="p">,</span>                  <span class="cm">/* tp_alloc，内存分配，其实也就是分配sizeof(PyGreenlet)的大小 */</span>
    <span class="n">green_new</span><span class="p">,</span>                          <span class="cm">/* tp_new, 构造函数，这里会将parent默认的设置为全局的greenlet */</span>
    <span class="n">GREENLET_tp_free</span><span class="p">,</span>                   <span class="cm">/* tp_free，释放 */</span>
    <span class="p">(</span><span class="n">inquiry</span><span class="p">)</span><span class="n">GREENLET_tp_is_gc</span><span class="p">,</span>         <span class="cm">/* tp_is_gc */</span>
<span class="p">};</span></code></pre></figure>

<h2 id="初始化">初始化</h2>

<p>上述的结构体中，包含了构造、初始化函数，Python 函数在执行时，分别调用 __new__()、__init__() 函数，在此也就分别对应了 green_new() 和 green_init() 函数；接下来，我们依次查看这两个函数。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// 创建一个gr对象，默认将parent指向当前环境所属的gr对象，如果构造函数中指定，则会在init设置</span>
<span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">green_new</span><span class="p">(</span><span class="n">PyTypeObject</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwds</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 先用基本对象来构造</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">o</span> <span class="o">=</span> <span class="n">PyBaseObject_Type</span><span class="p">.</span><span class="n">tp_new</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">ts_empty_tuple</span><span class="p">,</span> <span class="n">ts_empty_dict</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STATE_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">ts_current</span><span class="p">);</span>
        <span class="c1">// 默认将parent设置为ts_current，意味着新建gr的parent就是创建gr的对象</span>
        <span class="p">((</span><span class="n">PyGreenlet</span><span class="o">*</span><span class="p">)</span> <span class="n">o</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ts_current</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>在该函数中，非常清楚，首先构造父类，接着将当前 greenlet 设置未默认的 parent，也就是说假如在 A 中创建另外一个 greenlet B，则会将 B 的 parent 设置为 A；如果初始化时传入 parent 参数，则会在后面的 init 函数中设置。</p>

<p>接下来看看 __init__() 函数。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// 主要是检查设置run以及parent</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">green_init</span><span class="p">(</span><span class="n">PyGreenlet</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">kwargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">run</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">nparent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kwlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;run&quot;</span><span class="p">,</span> <span class="s">&quot;parent&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span> <span class="c1">// 查看两个对象是否存在</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTupleAndKeywords</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s">&quot;|OO:green&quot;</span><span class="p">,</span> <span class="n">kwlist</span><span class="p">,</span>
                     <span class="o">&amp;</span><span class="n">run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nparent</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">run</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// run对象必须存在，否则需要进行设置</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">green_setrun</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nparent</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">nparent</span> <span class="o">!=</span> <span class="n">Py_None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">green_setparent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">nparent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// 判断parent链是否正常</span>
    <span class="c1">// 在初始化的时候可以没有parent</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>这里初始化函数主要是设置构造的时候传递进来的执行函数，也就是 run 对象，然后就如果有传递 parent 的话，将会将这个 greenlet 对象的 parent 设置为传递进来的 greenlet 对象。</p>

<h2 id="任务切换">任务切换</h2>

<p>gr1.switch(“foo”) 实际会调用 green_switch() 函数，最终调用 g_switch()，实际的入参是 target=gr1、args=”foo”，函数的实现如下。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="c1">// 第一个参数是执行switch的greenlet对象，第二参数是参数数组，第三个是关键字参数</span>
<span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">green_switch</span><span class="p">(</span><span class="n">PyGreenlet</span><span class="o">*</span> <span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="n">Py_XINCREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
    <span class="c1">// 实际是调用g_switch方法来进行栈的切换</span>
    <span class="k">return</span> <span class="n">single_result</span><span class="p">(</span><span class="n">g_switch</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">));</span>
<span class="p">}</span></code></pre></figure>

<p>接着看看 g_switch() 函数的实现。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span><span class="o">*</span> <span class="nf">g_switch</span><span class="p">(</span><span class="n">PyGreenlet</span><span class="o">*</span> <span class="n">target</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* _consumes_ a reference to the args tuple and kwargs dict,</span>
<span class="cm">       and return a new tuple reference */</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">run_info</span><span class="p">;</span>

    <span class="cm">/* check ts_current */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STATE_OK</span><span class="p">)</span> <span class="p">{</span>     <span class="c1">// 查看当前gr状态，如果有异常则减少参数的引用计数，并返回</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 1. 获取运行信息</span>
    <span class="n">run_info</span> <span class="o">=</span> <span class="n">green_statedict</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">run_info</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">run_info</span> <span class="o">!=</span> <span class="n">ts_current</span><span class="o">-&gt;</span><span class="n">run_info</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
        <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_GreenletError</span><span class="p">,</span> <span class="n">run_info</span>
                <span class="o">?</span> <span class="s">&quot;cannot switch to a different thread&quot;</span>
                <span class="o">:</span> <span class="s">&quot;cannot switch to a garbage collected greenlet&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ts_passaround_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>      <span class="c1">// 保存switch传进来的参数</span>
    <span class="n">ts_passaround_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">;</span>

    <span class="cm">/* find the real target by ignoring dead greenlets,</span>
<span class="cm">       and if necessary starting a greenlet. */</span>
    <span class="c1">// 2. 找到真正需要指定的greenlet</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// 通过parent引用向上遍历，只要找到一个可用的就停止</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyGreenlet_ACTIVE</span><span class="p">(</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>   <span class="c1">// 找到一个可用的greenlet，start!=NULL</span>
            <span class="n">ts_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>            <span class="c1">// 指向运行的greenlet</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">g_switchstack</span><span class="p">();</span>         <span class="c1">// 切换到这个栈，里面会调用slp_switch方法，用汇编实现</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyGreenlet_STARTED</span><span class="p">(</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// 如果都没有启动，那么需要初始化，stop!=NULL</span>
            <span class="kt">void</span><span class="o">*</span> <span class="n">dummymarker</span><span class="p">;</span>             <span class="c1">// 通过该对象地址来分割新创建栈，用来做新栈的底部</span>
            <span class="n">ts_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">g_initialstub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummymarker</span><span class="p">);</span> <span class="c1">// 对于没有启动的协程，这里需要进行初始化</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span> <span class="cm">/* retry the switch */</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* For a very short time, immediately after the &#39;atomic&#39;</span>
<span class="cm">       g_switchstack() call, global variables are in a known state.</span>
<span class="cm">       We need to save everything we need, before it is destroyed</span>
<span class="cm">       by calls into arbitrary Python code. */</span>

    <span class="c1">//这里处理switch返回参数，这里</span>
    <span class="c1">//这里可以看出来，其实switch的返回值也是通过ts_passaround_args，ts_passaround_kwargs这两个全局变量来传递的</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">ts_passaround_args</span><span class="p">;</span>
    <span class="n">ts_passaround_args</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">ts_passaround_kwargs</span><span class="p">;</span>
    <span class="n">ts_passaround_kwargs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//如果在栈的切换的时候出现了错误</span>
        <span class="cm">/* Turn switch errors into switch throws */</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">ts_origin</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
        <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">PyGreenlet</span> <span class="o">*</span><span class="n">origin</span><span class="p">;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">ts_origin</span><span class="p">;</span>
        <span class="n">ts_origin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">origin</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* We need to figure out what values to pass to the target greenlet</span>
<span class="cm">       based on the arguments that have been passed to greenlet.switch(). If</span>
<span class="cm">       switch() was just passed an arg tuple, then we&#39;ll just return that.</span>
<span class="cm">       If only keyword arguments were passed, then we&#39;ll pass the keyword</span>
<span class="cm">       argument dict. Otherwise, we&#39;ll create a tuple of (args, kwargs) and</span>
<span class="cm">       return both. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="c1">//没有关键字参数，那么直接返回参数列表</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_Size</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PySequence_Length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">kwargs</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>  <span class="c1">//两种参数都有</span>
    <span class="p">{</span>
        <span class="n">PyObject</span> <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">PyTuple_New</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tuple</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
            <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">PyTuple_SET_ITEM</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="n">PyTuple_SET_ITEM</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">tuple</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>//(1)先获取运行信息，参数啥的(2)从切换到的greenlet开始，找到一个可以运行的greenlet对象，通过parent向上遍历
//(3)如果这个greenlet已经是active了，那么直接调用g_switchstack方法，如果这个greenlet还没有启动，那么需要g_initialstub进行初始化</p>

<p>gr1(new_greenlet)，默认stack_start = NULL(没有运行),stack_stop = NULL(没有启动)，因而执行g_initialstub()
dummymarker设置为栈底
为什么要将dummymarker栈底设置于此处？
g_initialstub的栈中包含函数需要的参数等数据，然而&amp;dummymarker的位置恰为g_initialstub栈的ebp。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c">               <span class="o">|</span>     <span class="o">^^^</span>       <span class="o">|</span>
               <span class="o">|</span>  <span class="n">older</span> <span class="n">data</span>   <span class="o">|</span>
               <span class="o">|</span>               <span class="o">|</span>
  <span class="n">stack_stop</span> <span class="p">.</span> <span class="o">|</span><span class="n">_______________</span><span class="o">|</span>
        <span class="p">.</span>      <span class="o">|</span>               <span class="o">|</span>
        <span class="p">.</span>      <span class="o">|</span> <span class="n">greenlet</span> <span class="n">data</span> <span class="o">|</span>
        <span class="p">.</span>      <span class="o">|</span>   <span class="n">in</span> <span class="n">stack</span>    <span class="o">|</span>
        <span class="p">.</span>    <span class="o">*</span> <span class="o">|</span><span class="n">_______________</span><span class="o">|</span> <span class="p">.</span> <span class="p">.</span>  <span class="n">_____________</span>  <span class="n">stack_copy</span> <span class="o">+</span> <span class="n">stack_saved</span>
        <span class="p">.</span>      <span class="o">|</span>               <span class="o">|</span>     <span class="o">|</span>             <span class="o">|</span>
        <span class="p">.</span>      <span class="o">|</span>     <span class="n">data</span>      <span class="o">|</span>     <span class="o">|</span><span class="n">greenlet</span> <span class="n">data</span><span class="o">|</span>
        <span class="p">.</span>      <span class="o">|</span>   <span class="n">unrelated</span>   <span class="o">|</span>     <span class="o">|</span>    <span class="n">saved</span>    <span class="o">|</span>
        <span class="p">.</span>      <span class="o">|</span>      <span class="n">to</span>       <span class="o">|</span>     <span class="o">|</span>   <span class="n">in</span> <span class="n">heap</span>   <span class="o">|</span>
 <span class="n">stack_start</span> <span class="p">.</span> <span class="o">|</span>     <span class="n">this</span>      <span class="o">|</span> <span class="p">.</span> <span class="p">.</span> <span class="o">|</span><span class="n">_____________</span><span class="o">|</span> <span class="n">stack_copy</span>
               <span class="o">|</span>   <span class="n">greenlet</span>    <span class="o">|</span>
               <span class="o">|</span>               <span class="o">|</span>
               <span class="o">|</span>  <span class="n">newer</span> <span class="n">data</span>   <span class="o">|</span>
               <span class="o">|</span>     <span class="n">vvv</span>       <span class="o">|</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">PyObject</span> <span class="o">*</span> <span class="nf">g_switch</span><span class="p">(</span><span class="n">PyGreenlet</span><span class="o">*</span> <span class="n">target</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">PyObject</span><span class="o">*</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* _consumes_ a reference to the args tuple and kwargs dict,</span>
<span class="cm">       and return a new tuple reference */</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">PyObject</span><span class="o">*</span> <span class="n">run_info</span><span class="p">;</span>

    <span class="cm">/* check ts_current */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">STATE_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
        <span class="n">run_info</span> <span class="o">=</span> <span class="n">green_statedict</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">run_info</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">run_info</span> <span class="o">!=</span> <span class="n">ts_current</span><span class="o">-&gt;</span><span class="n">run_info</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
                <span class="n">PyErr_SetString</span><span class="p">(</span><span class="n">PyExc_GreenletError</span><span class="p">,</span> <span class="n">run_info</span>
                                <span class="o">?</span> <span class="s">&quot;cannot switch to a different thread&quot;</span>
                                <span class="o">:</span> <span class="s">&quot;cannot switch to a garbage collected greenlet&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ts_passaround_args</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>
        <span class="n">ts_passaround_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">;</span>

        <span class="cm">/* find the real target by ignoring dead greenlets,</span>
<span class="cm">           and if necessary starting a greenlet. */</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">PyGreenlet_ACTIVE</span><span class="p">(</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">ts_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">g_switchstack</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyGreenlet_STARTED</span><span class="p">(</span><span class="n">target</span><span class="p">))</span> <span class="p">{</span>
                        <span class="kt">void</span><span class="o">*</span> <span class="n">dummymarker</span><span class="p">;</span>
                        <span class="n">ts_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
                        <span class="n">err</span> <span class="o">=</span> <span class="n">g_initialstub</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummymarker</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">continue</span><span class="p">;</span> <span class="cm">/* retry the switch */</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* For a very short time, immediately after the &#39;atomic&#39;</span>
<span class="cm">           g_switchstack() call, global variables are in a known state.</span>
<span class="cm">           We need to save everything we need, before it is destroyed</span>
<span class="cm">           by calls into arbitrary Python code. */</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">ts_passaround_args</span><span class="p">;</span>
        <span class="n">ts_passaround_args</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">ts_passaround_kwargs</span><span class="p">;</span>
        <span class="n">ts_passaround_kwargs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* Turn switch errors into switch throws */</span>
                <span class="n">assert</span><span class="p">(</span><span class="n">ts_origin</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
                <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">PyGreenlet</span> <span class="o">*</span><span class="n">origin</span><span class="p">;</span>
<span class="cp">#if GREENLET_USE_TRACING</span>
                <span class="n">PyGreenlet</span> <span class="o">*</span><span class="n">current</span><span class="p">;</span>
                <span class="n">PyObject</span> <span class="o">*</span><span class="n">tracefunc</span><span class="p">;</span>
<span class="cp">#endif</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">ts_origin</span><span class="p">;</span>
                <span class="n">ts_origin</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#if GREENLET_USE_TRACING</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">ts_current</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">tracefunc</span> <span class="o">=</span> <span class="n">PyDict_GetItem</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">run_info</span><span class="p">,</span> <span class="n">ts_tracekey</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">Py_INCREF</span><span class="p">(</span><span class="n">tracefunc</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">g_calltrace</span><span class="p">(</span><span class="n">tracefunc</span><span class="p">,</span> <span class="n">args</span> <span class="o">?</span> <span class="nl">ts_event_switch</span> <span class="p">:</span> <span class="n">ts_event_throw</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">current</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="cm">/* Turn trace errors into switch throws */</span>
                                <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
                                <span class="n">Py_CLEAR</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">tracefunc</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
                <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">origin</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* We need to figure out what values to pass to the target greenlet</span>
<span class="cm">           based on the arguments that have been passed to greenlet.switch(). If</span>
<span class="cm">           switch() was just passed an arg tuple, then we&#39;ll just return that.</span>
<span class="cm">           If only keyword arguments were passed, then we&#39;ll pass the keyword</span>
<span class="cm">           argument dict. Otherwise, we&#39;ll create a tuple of (args, kwargs) and</span>
<span class="cm">           return both. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_Size</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">args</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PySequence_Length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">kwargs</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
                <span class="n">PyObject</span> <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">PyTuple_New</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">tuple</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
                        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">kwargs</span><span class="p">);</span>
                        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">PyTuple_SET_ITEM</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
                <span class="n">PyTuple_SET_ITEM</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">tuple</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>greenlet 是通过 stack_stop、stack_start 来保存其 stack 的栈底和栈顶的，如果出现将要执行的greenlet的stack_stop和目前栈中的greenlet重叠的情况,就要把这些重叠的greenlet的栈中数据临时保存到heap中.保存的位置通过stack_copy和stack_saved来记录,以便恢复的时候从heap中拷贝回栈中stack_stop和stack_start的位置.不然就会出现其栈数据会被破坏的情况.所以应用程序创建的这些greenlet就是通过不断的拷贝数据到heap中或者从heap中拷贝到栈中来实现并发的.对于io型的应用程序使用coroutine真的非常舒服.</p>

<p>下面是greenlet的一个简单的栈空间模型(from greenlet.c)</p>

<p>greenlet是python众多协程实现技术中的一种，eventlet是基于greenlet实现的。而eventlet和libev又是gevent的核心。greenlet的上下文切换清晰易懂，可以结合IO事件循环构建出一些高效的事件处理逻辑。不同于 yield 类型的上下文切换，greenlet的上下文切换从表现形式上看更纯粹，可以直接 switch 到另一个greenlet，不用管目标greenlet是否已经在运行，不同greenlet之间处于完全对等的状态，可以相互 switch 。基于 yield 实现的协程往往只能切换回自己的直接或间接调用者，要想在嵌套的调用中切换出去是比较麻烦的。本质上是因为 yield 只能保留栈顶的帧，Python3对此有改进，可以通过 yield from 嵌套的挂起内层过程调用，但依然不能任意的切换到其他上下文。而greenlet就可以，只要一个过程被封装进一个greenlet，可以认为这个greenlet就成了一个可以随时挂起和恢复的实体。当然这种灵活性的代价是代码的逻辑会变得混乱，debug会更难，不过如果适当的使用greenlet，却可以收到很好的效果，比如之前介绍过的Motor。</p>

<p>协程是用户态下的上下文切换技术，是对线程时间片的再切分。所谓上下文，一般是指一个子过程调用，比如一个函数。另一方面，我们知道，Python虚拟机的原理是通过栈帧对象PyFrameObject抽象出运行时（栈，指令，符号表，常量表等），通过执行 PyEval_EvalFrameEx 这个C级别的函数来逐个解析字节码指令。也就是说可调用对象都是通过 PyEval_EvalFrameEx 来执行自己的PyFrameObject的，而按照调用的先后顺序，当前PyFrameObject的 f_back 指针会指向上一个PyFrameObject，这样，某一个时刻，当前线程的栈帧对象按调用的先后顺序形成了一个链表， 线程的top_frame属性正好是链表的表头（栈顶），这就是当前线程正在运行的帧。从这种状态可以看出，对于Python而言，切换当前栈顶的帧是容易的，只要保留栈顶的PyFrameObject，回退到栈顶下的一帧就行，这也是 yield 的基本原理。但问题是，Python的栈帧对象本身从一开始并不是为协程设计的，所以栈帧与栈帧之间的这种执行的先后顺序（其实可以理解为执行栈）语言本身却没有提供恢复和挂起的机制。这就要求假如你想任意切换上下文的话，必须实现一个机制，可以保存一个执行栈。</p>

<p>通过上面的分析，可以看到，要想在Python中在两个子过程中作任意的挂起和恢复的话，需要做到两点：
保存当前子过程的执行栈。 恢复目标子过程的执行栈，并恢复栈顶的状态继续执行。</p>

<p>greenlet之所以可以在任意两个greenlet之间作切换，就是因为其实现了上述的两点。其总共加起来2000多行C代码，其中内联了一小部分但确实相当关键的汇编代码，看懂greenlet的代码至少要把C语言的过程调用原理、汇编、进程的堆栈、Python的虚拟机执行原理等弄清楚，如果有一个不懂，就不用看源码了，能用起来就好。毕竟有些部分很绕，光看源码分析也不一定能完全消化吸收，有些东西也很难用文字表达，只可意会，不可言传。</p>

<p>greenlet的基本原理简单说起来就是:
将一个子过程封装进一个greenlet里，而一个greenlet代表了一段C的栈内存。 在greenlet里执行Python的子过程(通常是个函数)，当要切换出去的时候，保存当前greenlet的栈内存，方法是memcpy到堆上，也就是说每一个greenlet可能都需要在堆上保存上下文，挂起的时候就把栈内存memcpy到堆上，恢复的时候再把堆上的上下文（运行的时候栈内存的内容）拷贝到栈上，然后释放堆上的内存。 恢复栈顶只需要将当前线程的top_frame修改为恢复的greenlet的top_frame就行。</p>

<p>greenlet的基本原则：
除了main greenlet之外，任意一个greenlet都有唯一一个父greenlet。 假如当前greenlet执行完毕，回到自己的父greenlet即可。 可以通过给switch方法的参数来在不同greenlet之间传递数据。</p>

<p>greenlet实现的关键是先切换C函数的栈，而切换和恢复C的栈需要将%ebp（函数栈底）、%esp（函数栈顶）等寄存器的值保存到本地变量，而恢复的时候就可以通过从堆上拷贝的内存，来恢复寄存器的值。从而达到恢复上下文的目的。</p>

<!--
http://blog.csdn.net/fjslovejhl/article/details/38824963
http://blog.csdn.net/RingoShen/article/details/51119232    openstack基础_eventlet
http://luckybins.blog.51cto.com/786164/1605902
http://www.tuicool.com/articles/BfiQfuU
http://www.jianshu.com/p/cd41c14b19f4
http://www.bubuko.com/infodetail-345777.html
http://www.cnblogs.com/Security-Darren/p/4167961.html
http://rootk.com/post/python-greenlet.html
http://blog.csdn.net/shuaijiasanshao/article/details/51475571
-->

<h2 id="参考">参考</h2>

<p>源码可以从 <a href="https://github.com/python-greenlet/greenlet">github-greenlet</a> 下载，或者从 <a href="https://pypi.python.org/pypi/greenlet">Lightweight in-process concurrent programming</a>，以及帮助文档 <a href="http://greenlet.readthedocs.io/en/latest/">greenlet: Lightweight concurrent programming</a> 。</p>

<p>可以参考官方文档 <a href="http://sdiehl.github.io/gevent-tutorial/">gevent For the Working Python Developer</a>，或者 <a href="http://xlambda.com/gevent-tutorial/">gevent程序员值南</a> 。</p>


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/linux-leap-seconds-basic-introduce.html" title="闰秒简介">&larr; Older</a></li> 
         <li class="next"><a href="/post/linux-bash-pitfalls.html" title="Bash 安全编程">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1409760000',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/python-gevent-greenlet.html" data-title="Greenlet Gevent" data-url="/post/python-gevent-greenlet.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
