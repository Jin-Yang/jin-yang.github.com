<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>ZeroMQ 简介|JinYang's Blog</title>
  <meta name="keywords" content="zeromq">
  <meta name="description" content="ZMQ (Zero Message Queue) 是一个 C++ 编写的高性能分布式消息队列，是一个非常简单好用的传输层，使得 Socket 编程更加简单、简洁和性能更高效。目前比较常用的消息中间件产品包括了 RabbitMQ、ZeroMQ、ActiveMQ，三者分别通过　Erlang、C++、Java 实现，相比而言，ZMQ 是一个简单的库，而非单独的中间件产品。接下来简单介绍一下 ZMQ 的相关内容。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>ZeroMQ 简介</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2016-06-10 Friday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  network  
      
    </div>
  </div>
  <hr>
  <p>ZMQ (Zero Message Queue) 是一个 C++ 编写的高性能分布式消息队列，是一个非常简单好用的传输层，使得 Socket 编程更加简单、简洁和性能更高效。</p>

<p>目前比较常用的消息中间件产品包括了 RabbitMQ、ZeroMQ、ActiveMQ，三者分别通过　Erlang、C++、Java 实现，相比而言，ZMQ 是一个简单的库，而非单独的中间件产品。</p>

<p>接下来简单介绍一下 ZMQ 的相关内容。</p>

<!-- more -->

<h2 id="简介">简介</h2>

<p><a href="http://zeromq.org/">ZMQ (Zero Message Queue)</a> 的资料非常全，相关的资料基本都保存在 <a href="http://zeromq.org/community">zeromq.org - community</a> 中，例如一些经常使用的链接包括了示例 <a href="http://zguide.zeromq.org/page:all">ZMQ - The Guide</a>、相关的设计文档 <a href="http://zeromq.org/area:whitepapers">Interesting Whitepapers</a>、及各种语言的示例程序 <a href="https://github.com/imatix/zguide/tree/master/examples/">Github Zguide Examples</a> 。</p>

<p>ZMQ 的作者是 Martin Sustrik，其中的绝大多数的代码是由他来维护的，可以看下源码中的 MAINTAINERS 文件。另外，他还维护了：<a href="http://nanomsg.org">nanomsg</a> 封装了网络编程中常见的模型、<a href="http://libmill.org">libmill</a> 基于 C 的类 Go 库，据说可以支持 2KW 个协程，每秒 5KW 次上下文切换 (没有给出硬件配置，不过如果属实，性能确实有点恐怖)。</p>

<h3 id="advanced-message-queuing-protocol">Advanced Message Queuing Protocol</h3>

<p><a href="http://www.amqp.org/">AMQP</a>，高级消息队列协议，一个应用层的开放标准协议，为面向消息的中间件而设计，主要用于各个组件之间的解耦，基于该协议的客户端与消息中间件可以自由传递消息，消息的发送者无需知道消息使用者的存在，反之亦然。</p>

<p>AMQP 协议的主要特征是面向消息、队列、路由（包括点对点和发布/订阅）、可靠性、安全，是一种二进制协议，提供客户端应用与消息中间件之间异步、安全、高效地交互。目前，AMQP 1.0 已经成了国际标准，可以直接从官网下载相关的文档。</p>

<p>RabbitMQ 是一个开源的 AMQP 实现，服务器端使用 Erlang 语言编写，支持多种客户端，例如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等。</p>

<p>不过 ZMQ 并非基于 AMQP 协议的实现，两者的区别可以参考 <a href="http://zeromq.org/docs:welcome-from-amqp">Welcome from AMQP</a> 。</p>

<h3 id="zmq-安装">ZMQ 安装</h3>

<p>在 CentOS7 中可以直接通过如下命令安装，依赖 EPEL；另外 czmq 是对 ZMQ 的封装。目前 ZMQ 已经到了 Version 4，可以不指定版本号直接安装最新的，或者安装指定的版本。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 安装最新的V4版本
# yum --enablerepo=epel install zeromq zeromq-devel czmq

----- 安装V3版本
# yum --enablerepo=epel install zeromq3 zeromq3-devel czmq</code></pre></figure>

<p>当然可以通过源码进行编译安装，ZMQ 依赖一个加密库 libsodium ，可以直接通过 yum 进行安装。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># yum --enablerepo=epel install libsodium-devel</code></pre></figure>

<p>源码可以直接从 <a href="https://github.com/zeromq">Github ZeroMQ</a> 上下载，包括了 libzmq 在内的各种源码。编译也非常简单，直接通过如下方式编译即可。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 最简单的编译方法，默认安装在/usr/local目录下
$ ./configure &amp;&amp; make
# make install

----- 也可以指定不依赖于sodium库
$ ./configure --prefix=/usr --without-libsodium &amp;&amp; make
# make install</code></pre></figure>

<p>ZMQ 提供了三个基本的通信模型，分别是 “Request-Reply”、”Publisher-Subscriber”、”Parallel Pipeline”，接下来通过示例看看应该如何使用 ZMQ 。</p>

<h2 id="示例">示例</h2>

<p>相关的文档可以直接参考 <a href="http://zguide.zeromq.org/page:all">ZMQ - The Guide</a>，而示例程序保存在 <a href="https://github.com/imatix/zguide/tree/master/examples/">Github Zguide Examples</a>，在此我们将使用 C/C++ 为例，主要以 C++ 为例。</p>

<p>对于 C++ 程序，从 ZMQ-3.2 后，zmq.hpp 被移到了 <a href="https://github.com/zeromq/cppzmq">cppzmq github</a> 中，可以直接下载 zmq.hpp 文件，然后保存到 /usr/include 目录下即可，或者通过 yum 安装。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># yum --enablerepo=epel install cppzmq-devel</code></pre></figure>

<p>而对于 C 程序，会依赖于 <a href="https://github.com/zeromq/czmq">czmq github</a>，在 CentOS 中可以直接通过如下命令安装。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># yum --enablerepo=epel install czmq czmq-devel</code></pre></figure>

<p>然后可以直接在 zguide 目录下通过如下方式编译。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 调转到示例目录下
$ cd examples/C++

----- 编译单个示例程序hwclient
$ ./build hwclient

----- 编译所有的示例程序
$ ./build all</code></pre></figure>

<p>接下来看看一些示例。</p>

<h3 id="request-reply">Request-Reply</h3>

<p>一个非常简单的 Hello World 程序，服务端接收客户端请求 “Hello” 字符串，并将 “World” 字符串返回给客户端。</p>

<p><img src="/images/network/zmq-examples-request-reply.svg" alt="ZeroMQ Examples Request Reply Mode" title="ZeroMQ Examples Request Reply Mode" class="pull-center" /></p>

<p>服务端程序 hwserver.cpp 。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;zmq.hpp&gt;</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">//  Prepare our context and socket</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">context_t</span> <span class="n">context</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">socket</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_REP</span><span class="p">);</span>
    <span class="n">socket</span><span class="p">.</span><span class="n">bind</span> <span class="p">(</span><span class="s">&quot;tcp://*:5555&quot;</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">request</span><span class="p">;</span>

        <span class="c1">//  Wait for next request from client</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">recv</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Received Hello&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

        <span class="c1">//  Do some &#39;work&#39;</span>
    	<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

        <span class="c1">//  Send reply back to client</span>
        <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">reply</span> <span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="n">memcpy</span> <span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="n">data</span> <span class="p">(),</span> <span class="s">&quot;World&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">send</span> <span class="p">(</span><span class="n">reply</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>客户端程序 hwclient.cpp 。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;zmq.hpp&gt;</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">//  Prepare our context and socket</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">context_t</span> <span class="n">context</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">socket</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_REQ</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Connecting to hello world server...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">socket</span><span class="p">.</span><span class="n">connect</span> <span class="p">(</span><span class="s">&quot;tcp://localhost:5555&quot;</span><span class="p">);</span>

    <span class="c1">//  Do 10 requests, waiting each time for a response</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">request_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">request_nbr</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">request_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">request</span> <span class="p">(</span><span class="mi">5</span><span class="p">);</span>
        <span class="n">memcpy</span> <span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="p">(),</span> <span class="s">&quot;Hello&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Sending Hello &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">request_nbr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;...&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">send</span> <span class="p">(</span><span class="n">request</span><span class="p">);</span>

        <span class="c1">//  Get the reply.</span>
        <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">reply</span><span class="p">;</span>
        <span class="n">socket</span><span class="p">.</span><span class="n">recv</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">reply</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Received World &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">request_nbr</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>在这里可以先启动 client，然后再启动 server，效果是相同的，这与传统的 socket 编程不同。不过如果中途 server 宕掉了，重新启动 server 后 client 是不会自动恢复的，对于这种场景处理会比较麻烦，后面再讨论。</p>

<p>另外，ZMQ 通信单元是消息，而且它只知道消息的 bytes 大小，并不关心消息格式，所以，可以自由选择消息格式，例如 XML、Thrift、Msgpack 等。</p>

<h3 id="publish-subscribe">Publish-Subscribe</h3>

<p>在此采用的是一个天气预报的订阅模式，由一个节点提供信息源，由其他的节点，接受信息源的信息。</p>

<p><img src="/images/network/zmq-examples-publish-subscribe.svg" alt="ZeroMQ Examples Publish Subscribe Mode" title="ZeroMQ Examples Publish Subscribe Mode" class="pull-center" /></p>

<p>如下是服务端的代码 wuserver.cpp 。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;zmq.hpp&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;time.h&gt;</span>

<span class="cp">#define within(num) (int) ((float) num * random () / (RAND_MAX + 1.0))</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">//  Prepare our context and publisher</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">context_t</span> <span class="n">context</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">publisher</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_PUB</span><span class="p">);</span>
    <span class="n">publisher</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;tcp://*:5556&quot;</span><span class="p">);</span>
    <span class="n">publisher</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;ipc://weather.ipc&quot;</span><span class="p">);</span>             <span class="c1">// Not usable on Windows.</span>

    <span class="c1">//  Initialize random number generator</span>
    <span class="n">srandom</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">time</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">zipcode</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">relhumidity</span><span class="p">;</span>

        <span class="c1">//  Get values that will fool the boss</span>
        <span class="n">zipcode</span>     <span class="o">=</span> <span class="n">within</span> <span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">within</span> <span class="p">(</span><span class="mi">215</span><span class="p">)</span> <span class="o">-</span> <span class="mi">80</span><span class="p">;</span>
        <span class="n">relhumidity</span> <span class="o">=</span> <span class="n">within</span> <span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>

        <span class="c1">//  Send message to all subscribers</span>
        <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">message</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
        <span class="n">snprintf</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&quot;%05d %d %d&quot;</span><span class="p">,</span> <span class="n">zipcode</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">relhumidity</span><span class="p">);</span>
        <span class="n">publisher</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>以及客户端 wuclient.cpp 。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;zmq.hpp&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;sstream&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">context_t</span> <span class="n">context</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">//  Socket to talk to server</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Collecting updates from weather server...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">subscriber</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_SUB</span><span class="p">);</span>
    <span class="n">subscriber</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;tcp://localhost:5556&quot;</span><span class="p">);</span>

    <span class="c1">//  Subscribe to zipcode, default is NYC, 10001</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="n">argv</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span> <span class="s">&quot;10001 &quot;</span><span class="p">;</span>
    <span class="n">subscriber</span><span class="p">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">ZMQ_SUBSCRIBE</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">filter</span><span class="p">));</span>

    <span class="c1">//  Process 100 updates</span>
    <span class="kt">int</span> <span class="n">update_nbr</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">total_temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">update_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">update_nbr</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">update_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">update</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">zipcode</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">relhumidity</span><span class="p">;</span>

        <span class="n">subscriber</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">update</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">istringstream</span> <span class="n">iss</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">update</span><span class="p">.</span><span class="n">data</span><span class="p">()));</span>
        <span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">zipcode</span> <span class="o">&gt;&gt;</span> <span class="n">temperature</span> <span class="o">&gt;&gt;</span> <span class="n">relhumidity</span> <span class="p">;</span>
        <span class="n">total_temp</span> <span class="o">+=</span> <span class="n">temperature</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Average temperature for zipcode &#39;&quot;</span><span class="o">&lt;&lt;</span> <span class="n">filter</span>
              <span class="o">&lt;&lt;</span><span class="s">&quot;&#39; was &quot;</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">total_temp</span> <span class="o">/</span> <span class="n">update_nbr</span><span class="p">)</span> <span class="o">&lt;&lt;</span><span class="s">&quot;F&quot;</span>
              <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>简单来说，这里的代码会在服务器端生成随机的 zipcode、temperature、relhumidity，分别代表城市代码、温度值和湿度值，该值服务端会不断的广播消息。客户端会设置过滤参数，只接受特定城市代码的信息，当收集完了以后，也就是 100 个，那么会做一个平均值，并输出。</p>

<p>需要注意的是，这里必须通过 zmq_setsockopt() 设置 ZMQ_SUBSCRIBE，也就是设置一个过滤值，相当于设定一个订阅频道，否则收不到任何消息。</p>

<p>服务端一直在不断的广播，如果中途有 Subscriber 退出，并不会影响服务端的广播，如果 Subscriber 再连接上来时，收到的就是服务端后来发送的信息了。也就是说，对于比较晚加入的，或者是中途离开的订阅者，必然会丢失掉一部分信息，这是这个模式的一个问题。对于 Slow Joiner 的问题，稍后会解决。</p>

<p>如果 Publisher 中途离开，所有的 Subscriber 会 hold 住，待 Publisher 再上线时，会继续接收信息。</p>

<h3 id="parallel-pipeline">Parallel Pipeline</h3>

<p>这一模型通常用在类似于 Map-Reduce 的场景，通常有三部分组成，包括了一个生成可并行处理任务的节点 (ventilator)、多个对任务进行并行处理的节点 (worker)、一个收集处理结果的节点 (sink) 。</p>

<p><img src="/images/network/zmq-examples-parallel-pipeline.svg" alt="ZeroMQ Examples Parallel Pipeline Mode" title="ZeroMQ Examples Parallel Pipeline Mode" class="pull-center" /></p>

<p>例如，需要统计各个机器的日志，我们可以将统计任务分发到多个节点，最后收集统计结果，做个汇总。</p>

<p>在如下的示例中，taskvent 生成了 100 个任务，然后启动各个 work 之后由各个 work 进行处理，最后由 tasksink 作统计。其中，work 就是接收任务，然后 sleep 一段时间。</p>

<p>生成多个任务 taskvent.cpp 。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;zmq.hpp&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>

<span class="cp">#define within(num) (int) ((float) num * random () / (RAND_MAX + 1.0))</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">context_t</span> <span class="n">context</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">//  Socket to send messages on</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span>  <span class="n">sender</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_PUSH</span><span class="p">);</span>
    <span class="n">sender</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;tcp://*:5557&quot;</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Press Enter when the workers are ready: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">getchar</span> <span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Sending tasks to workers...</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="c1">//  The first message is &quot;0&quot; and signals start of batch</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">sink</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_PUSH</span><span class="p">);</span>
    <span class="n">sink</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;tcp://localhost:5558&quot;</span><span class="p">);</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">message</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">sink</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

    <span class="c1">//  Initialize random number generator</span>
    <span class="n">srandom</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">time</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>

    <span class="c1">//  Send 100 tasks</span>
    <span class="kt">int</span> <span class="n">task_nbr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">total_msec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">//  Total expected cost in msecs</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">task_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">task_nbr</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">task_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">workload</span><span class="p">;</span>
        <span class="c1">//  Random workload from 1 to 100msecs</span>
        <span class="n">workload</span> <span class="o">=</span> <span class="n">within</span> <span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">total_msec</span> <span class="o">+=</span> <span class="n">workload</span><span class="p">;</span>

        <span class="n">message</span><span class="p">.</span><span class="n">rebuild</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="n">sprintf</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">workload</span><span class="p">);</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Total expected cost: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">total_msec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; msec&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">sleep</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>              <span class="c1">//  Give 0MQ time to deliver</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>任务处理程序 taskwork.cpp 。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &quot;zhelpers.hpp&quot;</span>
<span class="cp">#include &lt;string&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">context_t</span> <span class="n">context</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

    <span class="c1">//  Socket to receive messages on</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">receiver</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_PULL</span><span class="p">);</span>
    <span class="n">receiver</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;tcp://localhost:5557&quot;</span><span class="p">);</span>

    <span class="c1">//  Socket to send messages to</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">sender</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ZMQ_PUSH</span><span class="p">);</span>
    <span class="n">sender</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">&quot;tcp://localhost:5558&quot;</span><span class="p">);</span>

    <span class="c1">//  Process tasks forever</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">message</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">workload</span><span class="p">;</span>           <span class="c1">//  Workload in msecs</span>

        <span class="n">receiver</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">smessage</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">data</span><span class="p">()),</span> <span class="n">message</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

        <span class="n">std</span><span class="o">::</span><span class="n">istringstream</span> <span class="n">iss</span><span class="p">(</span><span class="n">smessage</span><span class="p">);</span>
        <span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">workload</span><span class="p">;</span>

        <span class="c1">//  Do the work</span>
        <span class="n">s_sleep</span><span class="p">(</span><span class="n">workload</span><span class="p">);</span>

        <span class="c1">//  Send results to sink</span>
        <span class="n">message</span><span class="p">.</span><span class="n">rebuild</span><span class="p">();</span>
        <span class="n">sender</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>

        <span class="c1">//  Simple progress indicator for the viewer</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>处理结果 tasksink.cpp 。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;zmq.hpp&gt;</span>
<span class="cp">#include &lt;time.h&gt;</span>
<span class="cp">#include &lt;sys/time.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">//  Prepare our context and socket</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">context_t</span> <span class="n">context</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">socket_t</span> <span class="n">receiver</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">ZMQ_PULL</span><span class="p">);</span>
    <span class="n">receiver</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;tcp://*:5558&quot;</span><span class="p">);</span>

    <span class="c1">//  Wait for start of batch</span>
    <span class="n">zmq</span><span class="o">::</span><span class="kt">message_t</span> <span class="n">message</span><span class="p">;</span>
    <span class="n">receiver</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">);</span>

    <span class="c1">//  Start our clock now</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tstart</span><span class="p">;</span>
    <span class="n">gettimeofday</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tstart</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">//  Process 100 confirmations</span>
    <span class="kt">int</span> <span class="n">task_nbr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">total_msec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     <span class="c1">//  Total calculated cost in msecs</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">task_nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">task_nbr</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">task_nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">receiver</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">task_nbr</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">==</span> <span class="n">task_nbr</span><span class="p">)</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
        <span class="k">else</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;.&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//  Calculate and report duration of batch</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tend</span><span class="p">,</span> <span class="n">tdiff</span><span class="p">;</span>
    <span class="n">gettimeofday</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tend</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">tend</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&lt;</span> <span class="n">tstart</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tdiff</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">tend</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">tdiff</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">tend</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">tdiff</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">tend</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
        <span class="n">tdiff</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">tend</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">total_msec</span> <span class="o">=</span> <span class="n">tdiff</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">tdiff</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Total elapsed time: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">total_msec</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; msec</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>如上，ventilator 使用的是 SOCKET_PUSH，将任务分发到 Worker；而 Worker 使用 SOCKET_PULL 从上游接受任务，并使用 SOCKET_PUSH 将结果汇集到 Sink。需要注意的是，任务分发时同样有一个负载均衡的路由功能，worker 可以随时自由加入，ventilator 可以均衡将任务分发出去。</p>

<h2 id="其它">其它</h2>

<p>PGM 是一个可靠且可伸缩的多播协议，通过该协议，接收方可以检测丢失、请求重新传输丢失的数据或者通知应用程序无法恢复的丢失情形；OpenPGM 是一个基于 PGM 协议的实现。</p>


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/mysql-proxy_init.html" title="MySQL 代理设置">&larr; Older</a></li> 
         <li class="next"><a href="/post/zeromq-architecture.html" title="ZeroMQ 架构">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1465488000',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/zeromq-introduce.html" data-title="ZeroMQ 简介" data-url="/post/zeromq-introduce.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
