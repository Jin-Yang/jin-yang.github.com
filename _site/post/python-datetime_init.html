<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>Python 时间操作|JinYang's Blog</title>
  <meta name="keywords" content="">
  <meta name="description" content="">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>Python 时间操作</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2015-06-26 Friday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  program ,  python  
      
    </div>
  </div>
  <hr>
  <!-- more -->

<p>Python 与时间处理相关的提供了 datetime、time、calendar 三个模块，而且还有三方模块 pytz 可以使用；另外，datetime 模块中又存在 datetime、time 类，不要与相应的模块混淆。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">datetime.date        理想化的日期对象，有年月日三个属性
datetime.time        理想化的时间对象，不考虑闰秒，有时分秒微秒和时区五个属性
datetime.datetime    上述两个对象的组合
datetime.timedelta   可用于上述三个对象的差值
datetime.tzinfo      时区信息

time                 各种时间操作转换的方法
calendar             提供日历相关的方法
pytz                 使用Olson TZ Database解决时区、夏令时等相关的计算问题</code></pre></figure>

<p>简单来说，在 Pyton 中，与时间相关的时间类型主要有如下的四种。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">datetime</span>

<span class="c">#----- 1. time string 用于打印输出的字符串</span>
<span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()</span>             <span class="c"># &#39;Fri June 26 21:02:55 2015&#39;</span>

<span class="c">#----- 2. datetime tuple 包含了年月日-时分秒微妙-时区信息</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>  <span class="c"># datetime.datetime(2012, 12, 17, 21, 3, 44, 139715)</span>

<span class="c">#----- 3. time tuple 也就是time.struct_time对象类型</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span>  <span class="c"># time.struct_time(tm_year=2017, tm_mon=1, tm_mday=2,</span>
                    <span class="c"># tm_hour=10, tm_min=10, tm_sec=48, tm_wday=0, tm_yday=2, tm_isdst=-1)</span>

<span class="c">#----- 4. timestamp 时间戳类型，从1970-01-01 00:00:00 GMT以来的秒数</span>
<span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>              <span class="c"># 1355749338.05917</span></code></pre></figure>

<!--
1. string 转换为其它
初始化:
    date_str = "2015-06-26 22:53:59"

1.1 string => datetime obj
导入:
    import datetime
    datetime.datetime.strptime(string, format)
eg
    ----------------------------------------------
    >>> dt_obj = datetime.datetime.strptime(date_str, "%Y-%m-%d %H:%M:%S")
    >>> dt_obj
    datetime.datetime(2008, 11, 10, 17, 53, 59)
    ----------------------------------------------

1.2 string => time obj
导入:
    import time
    time.strptime(string, format)
eg
    ----------------------------------------------
    #time模块有类似datetime中的strptime()函数
    >>> date_str = "2008-11-10 17:53:59"
    >>> t_obj = time.strptime(date_str, "%Y-%m-%d %H:%M:%S")
    >>> t_obj
    time.struct_time(tm_year=2008, tm_mon=11, tm_mday=10, tm_hour=17, tm_min=53, tm_sec=59, tm_wday=0, tm_yday=315, tm_isdst=-1)
    ----------------------------------------------

2. datetime obj转换为其它
datetime obj转换为其它类型,用的都是datetime的函数
初始化:
    dt_obj = datetime.datetime(2008, 11, 10, 17, 53, 59)
2.1 dt obj => string
    ----------------------------------------------
    date_str = dt_obj.strftime("%Y-%m-%d %H:%M:%S")
    ----------------------------------------------
2.2 dt obj => time obj
    ----------------------------------------------
    time_tuple = dt_obj.timetuple()
    ----------------------------------------------

3. time obj转换为其它
初始化:
    time_tuple = (2008, 11, 12, 13, 51, 18, 2, 317, 0)
3.1 time obj => string
    ----------------------------------------------
    date_str = time.strftime("%Y-%m-%d %H:%M:%S", time_tuple)
    ----------------------------------------------
3.2 time obj => datetime obj
    ----------------------------------------------
    datetime.datetime(*time_tuple[0:6])
    ----------------------------------------------
3.3 time obj => timestamp
    ----------------------------------------------
    ts = time.mktime(time_tuple)
    ----------------------------------------------

4. timestamp转换为其它
初始化:
    timestamp = 1226527167.595983
--!!--注意以下两种都使用local时区
4.1 timestamp => dt obj
    ----------------------------------------------
    dt_obj = datetime.fromtimestamp(timestamp)
    ----------------------------------------------
4.2 timestamp => time obj
    ----------------------------------------------
    time_tuple = time.localtime(timestamp)
    ----------------------------------------------
--!!--以下两种方式和时区相关,比较标准时区时间和本地时区时间
4.3 使用UTC => dt obj
    ----------------------------------------------
    #本地时区时间
    >>> datetime.datetime.fromtimestamp(tm)
    datetime.datetime(2012, 12, 17, 23, 39, 58, 401881)
    #标准时区时间
    >>> datetime.datetime.utcfromtimestamp(tm)
    datetime.datetime(2012, 12, 17, 15, 39, 58, 401881)
    ----------------------------------------------
4.4 使用UTC => time obj
    ----------------------------------------------
    #本地时区时间
    >>> time.localtime(tm)
    time.struct_time(tm_year=2012, tm_mon=12, tm_mday=17, tm_hour=23, tm_min=39, tm_sec=58, tm_wday=0, tm_yday=352, tm_isdst=0)
    #标准时区时间
    >>> time.gmtime(tm)
    time.struct_time(tm_year=2012, tm_mon=12, tm_mday=17, tm_hour=15, tm_min=39, tm_sec=58, tm_wday=0, tm_yday=352, tm_isdst=0)
    ----------------------------------------------
-->

<p><img src="/images/python/datetime-transform.jpg" alt="datetime transfrom" title="datetime transfrom" class="pull-center" /></p>

<h2 id="时间处理">时间处理</h2>

<p>很多与日期、时间的 api 都在 datetime 模块内，其中常见的操作如下。</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">datetime</span>

<span class="c">#----- 1. 日期输出格式化 datetime=&gt;string</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span> <span class="c"># &#39;2015-04-07 19:11:21&#39;</span>
<span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S %Z&#39;</span><span class="p">)</span> <span class="c"># Sun, 01 Jan 2017 02:10:33 GMT</span>

<span class="c">#----- 2. 日期输出格式化 string=&gt;datetime</span>
<span class="n">t_str</span> <span class="o">=</span> <span class="s">&#39;2015-04-07 19:11:21&#39;</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">t_str</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>

<span class="c">#----- 3. 两个日期相差多少天</span>
<span class="n">d1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s">&#39;2015-06-15 18:11:27&#39;</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s">&#39;2015-06-02 18:11:27&#39;</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="k">print</span> <span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span><span class="n">days</span>

<span class="c">#----- 4. 今天的n天后的日期</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="k">print</span> <span class="p">(</span><span class="n">now</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&#39;</span><span class="p">)</span></code></pre></figure>

<p>其中，时间格式化的参数内容与 man date 相同，可以直接参考。</p>

<h2 id="xxx">xxx</h2>

<p>由于国家和地区可以自己选择时区以及是否使用夏令时，所以pytz模块在有需要的情况下得更新自己的时区以及夏令时相关的信息。比如当前pytz版本的OLSON_VERSON = ‘2013g’, 就是包括了Morocco可以使用夏令时。
如何正确为你所用</p>

<p>不是题外话的题外话，客户端必须正确收集用户的timezone信息。比较常见的一个错误是，保存用户所在时区的偏移值。比如对于中国的时区，保存了＋8。这里其实丢失了用户所在的地区（同样的时间偏移，可能对应多个国家或者地区）。而且如果用户所在时区是有夏令时的话，在每年开始和结束夏令时的时候，这个偏移值都是要发生变化的。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&gt;&gt;&gt; import pytz
&gt;&gt;&gt; pytz.all_timezones                      # 查看所有的timezone
[...,&#39;Asia/Shanghai&#39;, ...]                  # 选择上海的时区，也就是东八区
&gt;&gt;&gt; pytz.timezone(&#39;Asia/Shanghai&#39;)          # 构建tzinfo对象
&lt;DstTzInfo &#39;Asia/Shanghai&#39; LMT+8:06:00 STD&gt;</code></pre></figure>

<p>我们开始要把timezone加入时间的转换里面了。</p>

<p>首先，timestamp和datetime的转换。timestamp，一个数字，表示从UTC时间1970/01/01开始的秒数。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">&gt;&gt;&gt; import datetime
&gt;&gt;&gt; datetime.datetime.fromtimestamp(0, pytz.timezone(&#39;UTC&#39;))   # 含有时区信息
datetime.datetime(1970, 1, 1, 0, 0, tzinfo=&lt;UTC&gt;)
&gt;&gt;&gt; tz = pytz.timezone(&#39;Asia/Shanghai&#39;)                        # 上海则早8小时
&gt;&gt;&gt; datetime.fromtimestamp(0, tz)
datetime.datetime(1970, 1, 1, 8, 0, tzinfo=&lt;DstTzInfo &#39;Asia/Shanghai&#39; CST+8:00:00 STD&gt;)</code></pre></figure>

<p>如上，timestamp 是和 UTC 绑定的，不同的时区会有不同的时间偏移。</p>

<p>给定一个timestamp，构建datetime的时候无论传入的是什么时区，对应出来的结果都是同一个时间。 但是python里面这里有个坑。</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>ts = 1408071830
dt = datetime.fromtimestamp(ts, tz)
datetime.datetime(2014, 8, 15, 11, 3, 50, tzinfo=&lt;DstTzInfo ‘Asia/Shanghai’ CST+8:00:00 STD&gt;)
time.mktime(dt.timetuple())
1408100630.0
dt.timetuple()
time.struct_time(tm_year=2014, tm_mon=8, tm_mday=15, tm_hour=11, tm_min=3, tm_sec=50, tm_wday=4, tm_yday=227, tm_isdst=0)
dt.astimezone(pytz.utc)
datetime.datetime(2014, 8, 15, 3, 3, 50, tzinfo=<UTC>)
time.mktime(dt.astimezone(pytz.utc).timetuple())
1408071830.0</UTC></p>
    </blockquote>
  </blockquote>
</blockquote>

<p>time模块的mktime方法支持从timetuple取得timestamp，datetime对象可以直接转换成timetuple。这时候直接使用time.mktime(dt.timetuple())看起来就是很自然的获取timestamp方法。但是我们注意到timetuple方法是直接把当前时间的年月日时分秒直接取出来的。所以这个转换过程在timetuple这个方法这一步丢了时区信息。根据timestamp的定义，正确的方法是把datetime对象利用asttimezone显式转换成UTC时间。</p>

<p>第二，datetime和date以及time的关系 datetime模块同时提供了datetime对象，time对象，date对象。他们之间的关系可以从如下代码简单看出来。</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>d = datetime.date(2014, 8, 20)
t = datetime.time(11, 30)
dt = datetime.datetime.combine(d, t)
datetime.datetime(2014, 8, 20, 11, 30)
dt.date()
datetime.date(2014, 8, 20)
dt.time()
datetime.time(11, 30)</p>
    </blockquote>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <blockquote>
      <p>dt = datetime.datetime.fromtimestamp(1405938446, pytz.timezone(‘UTC’))
datetime.datetime(2014, 7, 21, 10, 27, 26, tzinfo=<UTC>)
dt.date()
datetime.date(2014, 7, 21)
dt.time()
datetime.time(10, 27, 26)
dt.timetz()
datetime.time(10, 27, 26, tzinfo=<UTC>)</UTC></UTC></p>
    </blockquote>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <blockquote>
      <p>datetime.datetime.combine(dt.date(), dt.time())
datetime.datetime(2014, 7, 21, 10, 27, 26)
datetime.datetime.combine(dt.date(), dt.timetz())
datetime.datetime(2014, 7, 21, 10, 27, 26, tzinfo=<UTC>)</UTC></p>
    </blockquote>
  </blockquote>
</blockquote>

<p>简单说就是，datetime可以取得date和time对象，datetime和time对象可以带timezone信息。date和time对象可以使用datetime.datetime.combine合并获得datetime对象。</p>

<p>第三，日期的加减 datetime，date对象都可以使用timedelta来进行。
    直接看代码</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>d1 = datetime.datetime(2014, 5, 20)
d2 = d1+datetime.timedelta(days=1, hours=2)
d1
datetime.datetime(2014, 5, 20, 0, 0)
d2
datetime.datetime(2014, 5, 21, 2, 0)
x = d2 - d1
x
datetime.timedelta(1, 7200)
x.seconds
7200
x.days
1</p>
    </blockquote>
  </blockquote>
</blockquote>

<pre><code>第四，如何对datetime对象正确设置timezone信息
</code></pre>

<p>先看代码。</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>ddt1 = datetime.datetime(2014, 8, 20, 10, 0, 0, 0, pytz.timezone(‘Asia/Shanghai’))
ddt1
datetime.datetime(2014, 8, 20, 10, 0, tzinfo=&lt;DstTzInfo ‘Asia/Shanghai’ LMT+8:06:00 STD&gt;)
ddt2
 datetime.datetime(2014, 8, 20, 11, 0)</p>
    </blockquote>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <blockquote>
      <p>ddt1.astimezone(pytz.utc)
datetime.datetime(2014, 8, 20, 1, 54, tzinfo=<UTC>)
ddt2.astimezone(pytz.utc)
ValueError: astimezone() cannot be applied to a naive datetime</UTC></p>
    </blockquote>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <blockquote>
      <p>tz = timezone(‘Asia/Shanghai’)
tz.localize(ddt1)
ValueError: Not naive datetime (tzinfo is already set)
tz.localize(ddt2)
datetime.datetime(2014, 8, 20, 11, 0, tzinfo=&lt;DstTzInfo ‘Asia/Shanghai’ CST+8:00:00 STD&gt;)</p>
    </blockquote>
  </blockquote>
</blockquote>

<p>这里抛出来的ValueError，引入了一个naive datetime的概念。简单说naive datetime就是不知道时区信息的datetime对象。没有timezone信息的datetime理论上讲不能定位到具体的时间点。所以对于设定了timezone的datetime对象，可以使用astimezone方法将timezone设定为另一个。对于不包含timezone的datetime对象，使用timezone.localize方法设定timezone。</p>

<p>但是，这里有没有发现一个问题？我们明明设定的是11点整的，使用astimezone之后跑出来个54分是想怎样？</p>

<p>我们注意到，datetime直接传入timezone对象构建出来的带timezone的datetime对象和使用locallize方法构建出来的datetime对象，在打印出来的时候tzinfo显示有所不同，一个是LMT+8:06，一个是CST+8:00，不用说了，54分就搁这来的吧。LMT学名Local Mean Time，用于比较平均日出时间的。有兴趣的可以自己看看Shanghai和Urumqi的LMT时间。CST是China Standard Time，不用解释了。根据pytz的文档，</p>

<p>Unfortunately using the tzinfo argument of the standard datetime constructors ‘’does not work’’ with pytz for many timezones.
It is safe for timezones without daylight saving transitions though, such as UTC:
The preferred way of dealing with times is to always work in UTC, converting to localtime only when generating output to be read by humans.
…
You can take shortcuts when dealing with the UTC side of timezone conversions. normalize() and localize() are not really necessary when there are no daylight saving time transitions to deal with.</p>

<p>我们按照这个说法再试试看，如下，这回pytz.timezone(‘Asia/Shanghai’)没有再玩幺蛾子了。</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>x = datetime.datetime(2014, 8, 20, 10, 0, 0, 0, pytz.utc)
x
datetime.datetime(2014, 8, 20, 10, 0, tzinfo=<UTC>)
x.astimezone(pytz.timezone('Asia/Shanghai'))
datetime.datetime(2014, 8, 20, 18, 0, tzinfo=&lt;DstTzInfo 'Asia/Shanghai' CST+8:00:00 STD&gt;)</UTC></p>
    </blockquote>
  </blockquote>
</blockquote>

<p>所以最保险的方法是使用locallize方法构造带时区的时间。</p>

<p>顺带说下，里面提到了normalize是用来校正计算的时间跨越DST切换的时候出错的情况，还是参见文档，关键部分摘录如下：</p>

<p>This library differs from the documented Python API for tzinfo implementations; if you want to create local wallclock times you need to use the localize() method documented in this document. In addition, if you perform date arithmetic on local times that cross DST boundaries, the result may be in an incorrect timezone (ie. subtract 1 minute from 2002-10-27 1:00 EST and you get 2002-10-27 0:59 EST instead of the correct 2002-10-27 1:59 EDT). A normalize() method is provided to correct this. Unfortunately these issues cannot be resolved without modifying the Python datetime implementation (see PEP-431).</p>

<pre><code>回到最初的问题，我程序需要给用户两天后的21点发送通知，这个时间怎么计算？
</code></pre>

<blockquote>
  <blockquote>
    <blockquote>
      <p>import pytz
import time
import datetime
tz = pytz.timezone(‘Asia/Shanghai’)
user_ts = int(time.time())
d1 = datetime.datetime.fromtimestamp(user_ts)
d1x = tz.localize(d1)
d1x
datetime.datetime(2015, 5, 26, 1, 43, 41, tzinfo=&lt;DstTzInfo ‘Asia/Shanghai’ CST+8:00:00 STD&gt;)</p>
    </blockquote>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <blockquote>
      <p>d2 = d1x + datetime.timedelta(days=2)
d2
datetime.datetime(2015, 5, 28, 1, 43, 41, tzinfo=&lt;DstTzInfo ‘Asia/Shanghai’ CST+8:00:00 STD&gt;)
d2.replace(hour=21, minute=0)
d2
datetime.datetime(2015, 5, 28, 21, 0, 41, tzinfo=&lt;DstTzInfo ‘Asia/Shanghai’ CST+8:00:00 STD&gt;)</p>
    </blockquote>
  </blockquote>
</blockquote>

<p>基本步骤为，根据时间戳和时区信息构建正确的时间d1x，使用timedelta进行对时间进行加减操作，使用replace方法替换小时等信息。</p>

<p>总结，基本上时间相关的这些方法，大部分你都可以直接按照自己的需要封装到一个独立的utility模块，然后就不需要再去管它了。你要做的是，至少有一个人先正确地管一下。</p>

<p>http://tech.glowing.com/cn/dealing-with-timezone-in-python/</p>


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/network-netfilter-iptables.html" title="Linux 的防火墙">&larr; Older</a></li> 
         <li class="next"><a href="/post/mysql-executor.html" title="MySQL 执行简介">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1435248000',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/python-datetime_init.html" data-title="Python 时间操作" data-url="/post/python-datetime_init.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
