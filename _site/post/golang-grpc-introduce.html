<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>GoLang gRPC 简介|JinYang's Blog</title>
  <meta name="keywords" content="grpc,golang">
  <meta name="description" content="gRPC 一开始由 google 开发，是一款开源的远程过程调用 (RPC) 系统。在 gRPC 里客户端应用可以像调用本地对象一样直接调用另一台不同的机器上服务端应用的方法，能够更容易地创建分布式应用和服务。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>GoLang gRPC 简介</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2018-07-01 Sunday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  program ,  golang ,  linux  
      
    </div>
  </div>
  <hr>
  <p>gRPC 一开始由 google 开发，是一款开源的远程过程调用 (RPC) 系统。</p>

<p>在 gRPC 里客户端应用可以像调用本地对象一样直接调用另一台不同的机器上服务端应用的方法，能够更容易地创建分布式应用和服务。</p>

<!-- more -->

<p><img src="/images/go/grpc-introduce.png" alt="grpc introduce" title="grpc introduce" class="pull-center" width="70%" /></p>

<h2 id="http2">HTTP2</h2>

<p><img src="/images/network/http2-introduce.png" alt="grpc introduce" title="grpc introduce" class="pull-center" width="70%" /></p>

<h3 id="http1x">HTTP/1.x</h3>

<p><code>HTTP/1.x</code> 协议是一个文本协议，可读性好但是不高效。</p>

<h4 id="parser">Parser</h4>

<p>如果要解析一个完整的 HTTP 请求，首先需要能正确的读出 <code>HTTP header</code>；其各个 fields 使用 <code>\r\n</code> 分隔，跟 body 之间使用 <code>\r\n\r\n</code> 分隔；然后从 header 里面的 <code>content-length</code> 拿到 body 的 size，从而读取 body。</p>

<p>可以参考 <a href="https://github.com/nodejs/http-parser">http-parse</a> 中的实现。</p>

<h4 id="requestresponse">Request/Response</h4>

<p>在交互时，每个连接只能一问一答，客户端发送了请求之后必须等待响应之后才能继续发送下一次请求。机制简单但是网络利用率不高，需要大量交互时通常需要保持长连接。</p>

<h4 id="push">Push</h4>

<p>1.x 是没有推送机制的，通常使用 <code>long polling</code> 或者 <code>Web-Socket</code> 方式，而后者严格意义上来说已经不再属于 HTTP 了。</p>

<h3 id="http2-1">HTTP/2</h3>

<p>这是一个二进制协议，这也就意味着它的可读性几乎为 0，但幸运的是，我们还是有很多工具，譬如 Wireshark， 能够将其解析出来。</p>

<!--
在了解 HTTP/2 之前，需要知道一些通用术语：

Stream(数据流) 双向流，一个连接可以有多个数据流，有唯一的标识符和可选的优先级信息；
Message(消息) 也就是逻辑上面的请求和响应，可以包含多个帧；
Frame(帧) 数据传输的最小单位，可以交错发送，然后在对端进行重新组装。
-->

<h2 id="grpc-简介">gRPC 简介</h2>

<p>关于 gRPC 中如何使用的 HTTP2 协议，可以参考 <a href="https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-HTTP2.md">gRPC over HTTP2</a> 。</p>

<p>分别是 Unary 以及 Stream 两种模式，前者是最简单的方式，一次请求一次响应。</p>

<p>当使用流模式时，可以向服务器或者客户端发送批量的数据，服务器和客户端在接收这些数据的时候，不必等接收到全部消息才开始处理，而是接收到第一条消息的时就可以立即处理，显然比类 HTTP 1.1 的方式响应更快。</p>

<p>例如，有一批个人的收入记录，发送给服务器计算个人所得税，那么两端都可以以流式发送，从而两端并行计算。</p>

<p>总计有四种方式：</p>

<ol>
  <li>简单模式。客户端使用存根发送请求到服务器并等待响应返回，就像平常的函数调用。</li>
  <li>服务端流式。客户端发送请求到服务器，拿到一个流去读取返回的消息序列，此时客户端需要一直读取直到没有任何消息。</li>
  <li>客户端流式。客户端写入一个消息序列并将其发送到服务器，一旦客户端完成写入消息，它等待服务器完成读取返回它的响应。</li>
  <li>双向流式。双方使用读写流去发送一个消息序列，两个流独立操作，客户端和服务器可以以任意喜欢的顺序读写。</li>
</ol>

<p>依次对应的声明为。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">rpc GetFeature(Point) returns (Feature) {}
rpc ListFeatures(Rectangle) returns (stream Feature) {}
rpc RecordRoute(stream Point) returns (RouteSummary) {}
rpc RouteChat(stream RouteNote) returns (stream RouteNote) {}</code></pre></figure>

<h3 id="安装-golang-版本-grpc">安装 GoLang 版本 gRPC</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看当前golang编译器版本
$ go version

----- 通过在线方式安装，-u 更新到最新版本，-v 显示详细信息
$ go get -u -v  google.golang.org/grpc

----- 离线下载解压到如下目录，并安装
$ echo $GOPATH/src
$ go install google.golang.org/grpc</code></pre></figure>

<p>离线版本可以从 <a href="https://github.com/grpc/grpc-go/releases">GitHub gRPC</a> 上下载，其中会有一堆的依赖，依次安装即可，其中 <code>golang.org/x/net</code> 与 <a href="https://github.com/golang/net">GitHub Net</a> 相同，<code>golang.org/x/text</code> 与 <a href="https://github.com/golang/text/releases">GitHub Text</a> 相同。</p>

<!--
google.golang.org/genproto/googleapis/rpc/status
https://github.com/google/go-genproto
-->

<h4 id="安装-protoc-及其插件">安装 protoc 及其插件</h4>

<p>在 CentOS7 中默认安装的是 V2 版本，为此需要确保安装的版本。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看 protoc 是否安装，确保是3.0版本
$ which protoc
$ protoc --version

----- 安装插件
$ go install github.com/golang/protobuf/proto
$ go install github.com/golang/protobuf/protoc-gen-go

----- 测试是否安装成功
$ protoc -I helloworld/ helloworld/helloworld.proto --go_out=plugins=grpc:helloworld</code></pre></figure>

<p>如果上述的 protoc 版本有误，可以从 <a href="https://github.com/google/protobuf/releases">GitHub ProtoBuf</a> 上下载，然后添加到 <code>$GOPATH/bin</code> 目录下，为了确保使用的是最新版本，需要确保该路径在 PATH 前面。</p>

<p>当然，也可以通过 <code>yum remove protobuf-compiler</code> 直接卸载掉。</p>

<h5 id="依赖">依赖</h5>

<p>这里简单列举一些常见的依赖：</p>

<ul>
  <li><a href="https://github.com/google/go-genproto">google.golang.org/genproto</a></li>
</ul>

<h4 id="运行示例">运行示例</h4>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ cd $GOPATH/src/google.golang.org/grpc/examples
$ go run greeter_server/main.go
$ go run greeter_client/main.go</code></pre></figure>

<h3 id="示例代码">示例代码</h3>

<p>有如下的目录结构。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">client.go
server.go
proto/
 |-helloworld.proto</code></pre></figure>

<p>通过如下命令生成 go 文件。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ mkdir proto/helloworld
$ protoc -I proto proto/helloworld.proto --go_out=plugins=grpc:proto/helloworld</code></pre></figure>

<p>其中 <code>helloworld.proto</code>、<code>client.go</code> 和 <code>server.go</code> 的代码为。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">syntax = &quot;proto3&quot;;

package helloworld;

// The greeting service definition.
service Greeter {
	// Sends a greeting
	rpc SayHello (HelloRequest) returns (HelloReply) {}
}

// The request message containing the user&#39;s name.
message HelloRequest {
	string name = 1;
}

// The response message containing the greetings
message HelloReply {
	string message = 1;
}</code></pre></figure>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;log&quot;</span>
        <span class="s">&quot;os&quot;</span>
        <span class="s">&quot;time&quot;</span>

        <span class="s">&quot;golang.org/x/net/context&quot;</span>
        <span class="s">&quot;google.golang.org/grpc&quot;</span>
        <span class="nx">pb</span> <span class="s">&quot;./proto/helloworld&quot;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
        <span class="nx">address</span>     <span class="p">=</span> <span class="s">&quot;localhost:50051&quot;</span>
        <span class="nx">defaultName</span> <span class="p">=</span> <span class="s">&quot;world&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Set up a connection to the server.</span>
        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="nx">address</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">WithInsecure</span><span class="p">())</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;did not connect: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NewGreeterClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>

        <span class="c1">// Contact the server and print out its response.</span>
        <span class="nx">name</span> <span class="o">:=</span> <span class="nx">defaultName</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">{</span>
                <span class="nx">name</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
        <span class="k">defer</span> <span class="nx">cancel</span><span class="p">()</span>
        <span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">SayHello</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">name</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;could not greet: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Greeting: %s&quot;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;log&quot;</span>
        <span class="s">&quot;net&quot;</span>

        <span class="nx">pb</span> <span class="s">&quot;./proto/helloworld&quot;</span>
        <span class="s">&quot;golang.org/x/net/context&quot;</span>
        <span class="s">&quot;google.golang.org/grpc&quot;</span>
        <span class="s">&quot;google.golang.org/grpc/reflection&quot;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
        <span class="nx">addr</span> <span class="p">=</span> <span class="s">&quot;127.0.0.1:50051&quot;</span>
<span class="p">)</span>

<span class="c1">// server is used to implement helloworld.GreeterServer.</span>
<span class="kd">type</span> <span class="nx">server</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// SayHello implements helloworld.GreeterServer</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">)</span> <span class="nx">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">{</span><span class="nx">Message</span><span class="p">:</span> <span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Name</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="nx">addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to listen: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">()</span>
        <span class="nx">pb</span><span class="p">.</span><span class="nx">RegisterGreeterServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">server</span><span class="p">{})</span>
        <span class="c1">// Register reflection service on gRPC server.</span>
        <span class="nx">reflection</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to serve: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>如果要简单运行，可以直接执行如下命令(环境变量PWD是内置的)。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ GOPATH=$GOROOT:$PWD go run server.go
$ GOPATH=$GOROOT:$PWD go run client.go</code></pre></figure>

<p>或者直接将两个文件进行编译。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ go build client.go
$ go build server.go</code></pre></figure>

<p>因为前者引入了编译的过程，所以看起来运行的比较慢。</p>

<p>另外也可以参考 <a href="https://github.com/kelseyhightower/grpc-hello-service">GitHub - gRPC Hello Service</a> 以及 <a href="https://github.com/jergoo/go-grpc-example">GitHub - gRPC Examples</a>，后者提供了一系列的介绍，包括鉴权、拦截器、Trace 等。</p>

<!--
## 反射

关于gRPC中的Reflection可以参考
https://chromium.googlesource.com/external/github.com/grpc/grpc-go/+/refs/heads/master/Documentation/server-reflection-tutorial.md
-->

<h2 id="拦截器-interceptor">拦截器 Interceptor</h2>

<p>可以在服务端接收到请求后，先对请求中的数据做一些处理后再转交给指定的服务处理并响应，常见的如权限校验、日志、接口调用延迟等，这里简单打印下客户端的 IP 地址。</p>

<h3 id="获取ip">获取IP</h3>

<p>gRPC 服务和客户端之间是通过 http2 进行交互，其中包含了客户端的地址信息，</p>

<p>在 gRPC 源码 <code>peer/peer.go</code> 中包含了创建的上下文信息，其中就记录的远端地址；而且在 gRPC 请求中默认都会含有 Context 值，这样就可以通过如下方法获取。</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nx">getClietIP</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">pr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;getClinetIP, invoke FromContext() failed&quot;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">pr</span><span class="p">.</span><span class="nx">Addr</span> <span class="o">==</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;getClientIP, peer.Addr is nil&quot;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">addSlice</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">pr</span><span class="p">.</span><span class="nx">Addr</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">addSlice</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></figure>

<p>注意：在使用 stream 方式时 context 值可以直接从 stream 中获取，也就是 <code>stream.Context()</code> 。</p>

<h3 id="增加拦截器">增加拦截器</h3>

<p>将服务端的代码修改为如下。</p>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;fmt&quot;</span>
        <span class="s">&quot;log&quot;</span>
        <span class="s">&quot;net&quot;</span>

        <span class="nx">pb</span> <span class="s">&quot;./proto/helloworld&quot;</span>
        <span class="s">&quot;golang.org/x/net/context&quot;</span>
        <span class="s">&quot;google.golang.org/grpc&quot;</span>
        <span class="s">&quot;google.golang.org/grpc/peer&quot;</span>
        <span class="s">&quot;google.golang.org/grpc/reflection&quot;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
        <span class="nx">port</span> <span class="p">=</span> <span class="s">&quot;:50051&quot;</span>
<span class="p">)</span>

<span class="c1">// server is used to implement helloworld.GreeterServer.</span>
<span class="kd">type</span> <span class="nx">server</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// SayHello implements helloworld.GreeterServer</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">)</span> <span class="nx">SayHello</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="nx">pb</span><span class="p">.</span><span class="nx">HelloReply</span><span class="p">{</span><span class="nx">Message</span><span class="p">:</span> <span class="s">&quot;Hello &quot;</span> <span class="o">+</span> <span class="nx">in</span><span class="p">.</span><span class="nx">Name</span><span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">getClietIP</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">peer</span><span class="p">.</span><span class="nx">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;getClinetIP, invoke FromContext() failed&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">pr</span><span class="p">.</span><span class="nx">Addr</span> <span class="o">==</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;getClientIP, peer.Addr is nil&quot;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">pr</span><span class="p">.</span><span class="nx">Addr</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to listen: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">opts</span> <span class="p">[]</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ServerOption</span>

        <span class="c1">// Register interceptor</span>
        <span class="kd">var</span> <span class="nx">interceptor</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInterceptor</span>
        <span class="nx">interceptor</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">info</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryServerInfo</span><span class="p">,</span>
			<span class="nx">handler</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryHandler</span><span class="p">)</span> <span class="p">(</span><span class="nx">resp</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">cli</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">getClietIP</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Failed to get client address&quot;</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Client address is&quot;</span><span class="p">,</span> <span class="nx">cli</span><span class="p">)</span>
                <span class="k">return</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">opts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">UnaryInterceptor</span><span class="p">(</span><span class="nx">interceptor</span><span class="p">))</span>

        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">(</span><span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
        <span class="nx">pb</span><span class="p">.</span><span class="nx">RegisterGreeterServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">server</span><span class="p">{})</span>
        <span class="c1">// Register reflection service on gRPC server.</span>
        <span class="nx">reflection</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to serve: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h2 id="stream">Stream</h2>

<p>普通的 gRPC 是直接返回一个定义的 HelloReply 对象，而流式响应可以通过 Send 方法返回多个 HelloReply 对象，对象流序列化后流式返回。</p>

<p>目录结构同上。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ mkdir proto/helloworld
$ protoc -I proto proto/helloworld.proto --go_out=plugins=grpc:proto/helloworld</code></pre></figure>

<p>其中 <code>helloworld.proto</code>、<code>client.go</code> 和 <code>server.go</code> 的代码为。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">syntax = &quot;proto3&quot;;

package helloworld;

service Math {
        rpc Max (stream Request) returns (stream Response) {}
}

message Request {
        int32 num = 1;
}

message Response {
        int32 result = 1;
}</code></pre></figure>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;context&quot;</span>
        <span class="s">&quot;io&quot;</span>
        <span class="s">&quot;log&quot;</span>
        <span class="s">&quot;math/rand&quot;</span>
        <span class="s">&quot;time&quot;</span>

        <span class="nx">pb</span> <span class="s">&quot;./proto/helloworld&quot;</span>
        <span class="s">&quot;google.golang.org/grpc&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">rand</span><span class="p">.</span><span class="nx">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">())</span>

        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">Dial</span><span class="p">(</span><span class="s">&quot;:50005&quot;</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">WithInsecure</span><span class="p">())</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;can not connect with server %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1">// create stream</span>
        <span class="nx">client</span> <span class="o">:=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NewMathClient</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
        <span class="nx">stream</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">Max</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;openn stream error %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">max</span> <span class="kt">int32</span>
        <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Context</span><span class="p">()</span>
        <span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>

        <span class="c1">// first goroutine sends random increasing numbers to stream</span>
        <span class="c1">// and closes it after 10 iterations</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
                        <span class="c1">// generate random nummber and send it to stream</span>
                        <span class="nx">rnd</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Intn</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
                        <span class="nx">req</span> <span class="o">:=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">Num</span><span class="p">:</span> <span class="nx">rnd</span><span class="p">}</span>
                        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;can not send %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                        <span class="p">}</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%d sent&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Num</span><span class="p">)</span>
                        <span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">200</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">CloseSend</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}()</span>

        <span class="c1">// second goroutine receives data from stream</span>
        <span class="c1">// and saves result in max variable</span>
        <span class="c1">//</span>
        <span class="c1">// if stream is finished it closes done channel</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">{</span>
                        <span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">Recv</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
                                <span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
                                <span class="k">return</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;can not receive %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                        <span class="p">}</span>
                        <span class="nx">max</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Result</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;new max %d received&quot;</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}()</span>

        <span class="c1">// third goroutine closes done channel if context is done</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
        <span class="p">}()</span>

        <span class="o">&lt;-</span><span class="nx">done</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;finished with max=%d&quot;</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s">&quot;io&quot;</span>
        <span class="s">&quot;log&quot;</span>
        <span class="s">&quot;net&quot;</span>

        <span class="nx">pb</span> <span class="s">&quot;./proto/helloworld&quot;</span>
        <span class="s">&quot;google.golang.org/grpc&quot;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">server</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">server</span><span class="p">)</span> <span class="nx">Max</span><span class="p">(</span><span class="nx">srv</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">Math_MaxServer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Start new math server&quot;</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">max</span> <span class="kt">int32</span>
        <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Context</span><span class="p">()</span>

        <span class="k">for</span> <span class="p">{</span>
                <span class="c1">// exit if context is done or continue</span>
                <span class="k">select</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
                        <span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
                <span class="k">default</span><span class="p">:</span>
                <span class="p">}</span>

                <span class="c1">// receive data from stream</span>
                <span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Recv</span><span class="p">()</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
                        <span class="c1">// return will close stream from server side</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;exit&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">nil</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;receive error %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="p">}</span>

                <span class="c1">// continue if number reveived from stream less than max</span>
                <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Num</span> <span class="o">&lt;=</span> <span class="nx">max</span> <span class="p">{</span>
                        <span class="k">continue</span>
                <span class="p">}</span>

                <span class="c1">// update max and send it to stream</span>
                <span class="nx">max</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Num</span>
                <span class="nx">resp</span> <span class="o">:=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">Response</span><span class="p">{</span><span class="nx">Result</span><span class="p">:</span> <span class="nx">max</span><span class="p">}</span>
                <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">srv</span><span class="p">.</span><span class="nx">Send</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">resp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;send error %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;send new max=%d&quot;</span><span class="p">,</span> <span class="nx">max</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">lis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="s">&quot;:50005&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to listen: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">NewServer</span><span class="p">()</span>
        <span class="nx">pb</span><span class="p">.</span><span class="nx">RegisterMathServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">server</span><span class="p">{})</span>
        <span class="nx">reflection</span><span class="p">.</span><span class="nx">Register</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">lis</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;failed to serve: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h2 id="负载均衡器">负载均衡器</h2>

<p>这里每次的请求都会进行负载均衡，而非每个连接，也即是说，即使只有一个链接，请求仍然会在服务器间做负载均衡。</p>

<p>在 <a href="https://github.com/grpc/grpc/blob/master/doc/load-balancing.md">Load Balancing in gRPC</a> 中有关于 LB 的设计理念，以及一个相关的设计方案。</p>

<!--
https://segmentfault.com/a/1190000008672912
https://segmentfault.com/a/1190000015231956

Resolver and balancer API changes(gRPC新的负载均衡方案实现)
https://github.com/menghanl/proposal/blob/936c96af113915efbbf8e78e16aa18cf73575e62/L9-go-resolver-balancer-API.md

实现的一种方案
https://segmentfault.com/a/1190000010471761
-->

<h2 id="gateway">GateWay</h2>

<p>在使用 gRPC 通讯的同时对外提供 REST-API 接口，其中的一个解决方案就是 <code>gRPC-gateway</code>，这是对 RPC 的扩展，实现 REST 给 RPC 的协议转换。</p>

<p><img src="/images/programs/grpc-gateway.png" alt="grpc gateway" title="grpc gateway" class="pull-center" width="80%" /></p>

<p>这是 protoc 的一个插件，它读取 gRPC 服务定义，并生成一个反向代理服务器，将 RESTful JSON API 转换为 gRPC，此服务器是根据 gRPC 定义中的自定义选项生成的。</p>

<h3 id="安装">安装</h3>

<p>直接从 <a href="http://github.com/grpc-ecosystem/grpc-gateway">GitHub gRPC ecosystem</a> 下载代码，然后通过如下方式生成插件。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway
$ go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger</code></pre></figure>

<h3 id="示例">示例</h3>

<p>同样有如下的目录结构。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">client.go
server.go
proto/
 |-helloworld.proto</code></pre></figure>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 生成proto/helloworld/helloworld.pb.go文件
$ protoc -I proto -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
	--go_out=plugins=grpc:proto/helloworld proto/helloworld.proto

----- 生成proto/helloworld/helloworld.pb.gw.go文件
$ protoc -I proto -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
	--grpc-gateway_out=logtostderr=true:proto/helloworld proto/helloworld.proto

----- 生成helloworld.swagger.json文件，非必须
$ protoc -I proto -I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
	--swagger_out=logtostderr=true:. proto/helloworld.proto</code></pre></figure>

<!--
https://github.com/grpc-ecosystem/grpc-gateway/tree/master/examples
https://segmentfault.com/a/1190000013408485
https://segmentfault.com/a/1190000008106582

package main

import (
	//"crypto/tls"
	"fmt"
	//"io/ioutil"
	"log"
	"net"
	"net/http"
	"strings"

	"github.com/grpc-ecosystem/grpc-gateway/runtime"
	"golang.org/x/net/context"
	"google.golang.org/grpc"

	pb "./proto/helloworld"
	//"google.golang.org/grpc/credentials"
	//"google.golang.org/grpc/grpclog"
)

// 定义helloHttpService并实现约定的接口
type helloHttpService struct{}

// HelloHttpService ...
var HelloHttpService = helloHttpService{}

func (h helloHttpService) SayHello(ctx context.Context, in *pb.HelloRequest) (*pb.HelloReply, error) {
	resp := new(pb.HelloReply)
	resp.Message = "Hello " + in.Name + "."

	return resp, nil
}

// grpcHandlerFunc 检查请求协议并返回http handler
func grpcHandlerFunc(grpcServer *grpc.Server, otherHandler http.Handler) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// TODO(tamird): point to merged gRPC code rather than a PR.
		// This is a partial recreation of gRPC's internal checks https://github.com/grpc/grpc-go/pull/514/files#diff-95e9a25b738459a2d3030e1e6fa2a718R61
		if r.ProtoMajor == 2 && strings.Contains(r.Header.Get("Content-Type"), "application/grpc") {
			grpcServer.ServeHTTP(w, r)
		} else {
			otherHandler.ServeHTTP(w, r)
		}
	})
}

func main() {
	endpoint := "127.0.0.1:50052"

	// grpc server
	/*
		creds, err := credentials.NewServerTLSFromFile("../../keys/server.pem", "../../keys/server.key")
		if err != nil {
			grpclog.Fatalf("Failed to generate credentials %v", err)
		}
	*/
	conn, _ := net.Listen("tcp", endpoint)
	//grpcServer := grpc.NewServer(grpc.Creds(creds))
	grpcServer := grpc.NewServer()
	pb.RegisterGreeterServer(grpcServer, HelloHttpService)

	// http-grpc gateway
	ctx := context.Background()
	ctx, cancel := context.WithCancel(ctx)
	defer cancel()
	/*
		dcreds, err := credentials.NewClientTLSFromFile("../../keys/server.pem", "server name")
		if err != nil {
			grpclog.Fatalf("Failed to create TLS credentials %v", err)
		}
		dopts := []grpc.DialOption{grpc.WithTransportCredentials(dcreds)}
	*/
	dopts := []grpc.DialOption{grpc.WithInsecure()}
	gwmux := runtime.NewServeMux()
	err := pb.RegisterGreeterHandlerFromEndpoint(ctx, gwmux, endpoint, dopts)
	if err != nil {
		fmt.Printf("serve: %v\n", err)
		return
	}

	mux := http.NewServeMux()
	mux.Handle("/", gwmux)

	if err != nil {
		panic(err)
	}

	// 开启HTTP服务
	/*
		cert, _ := ioutil.ReadFile("../../keys/server.pem")
		key, _ := ioutil.ReadFile("../../keys/server.key")
		var demoKeyPair *tls.Certificate
		pair, err := tls.X509KeyPair(cert, key)
		if err != nil {
			panic(err)
		}
		demoKeyPair = &pair
	*/

	srv := &http.Server{
		Addr:    endpoint,
		Handler: grpcHandlerFunc(grpcServer, mux),
		/*
			TLSConfig: &tls.Config{
				Certificates: []tls.Certificate{*demoKeyPair},
			},
		*/
	}

	fmt.Printf("grpc and https on port: %d\n", 50052)

	//err = srv.Serve(tls.NewListener(conn, srv.TLSConfig))

	err = srv.Serve(conn)
	if err != nil {
		log.Fatal("ListenAndServe: ", err)
	}

	return
}
-->

<h2 id="其它">其它</h2>

<h3 id="监听地址">监听地址</h3>

<p>在调用 <code>net.Listen()</code> 时，如果通过 <code>:8080</code> 方式指定端口，那么可能会监听到 IPv6 地址上，如果要使用 IPv4 那么需要显示指定 <code>127.0.0.1:8080</code> 。</p>

<h3 id="undefined">undefined</h3>

<p>例如 <code>undefined: proto.ProtoPackageIsVersion2</code> ，一般是由于版本过低导致。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ go get -u github.com/golang/protobuf/{proto,protoc-gen-go}</code></pre></figure>

<h2 id="参考">参考</h2>

<p><a href="https://github.com/grpc-ecosystem/awesome-grpc">Awesome gRPC</a> 一些比较经典的 gRPC 资源。</p>

<!--
HTTP2 的协议详解
https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn


https://github.com/grpc/grpc/blob/master/doc/health-checking.md
https://github.com/go-training/grpc-health-check


./configure --prefix=/usr
export PKG_CONFIG_PATH=/usr/lib/pkgconfig && make

如果不行只能手动下载包了。

$ git clone -b $(curl -L https://grpc.io/release) https://github.com/grpc/grpc
$ cd grpc
$ git submodule update --init
$ make
$ [sudo] make install

默认会安装到如下的目录下。

/usr/local/lib
/usr/local/include/grpc
/usr/local/share/grpc

https://www.jianshu.com/p/48ad37e8b4ed

pkg-config --list-all

export PKG_CONFIG_PATH=/usr/lib/pkgconfig && pkg-config --list-all

go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger

gRPC的相关介绍
https://github.com/EDDYCJY/blog
-->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/linux-kernel-hang-task-panic-introduce.html" title="Linux Hang Task 简介">&larr; Older</a></li> 
         <li class="next"><a href="/post/golang-http-structure-echo-introduce.html" title="GoLang Echo 简介">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1530374400',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/golang-grpc-introduce.html" data-title="GoLang gRPC 简介" data-url="/post/golang-grpc-introduce.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
