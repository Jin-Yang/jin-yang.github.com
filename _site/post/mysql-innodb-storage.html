<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>InnoDB 存储空间|JinYang's Blog</title>
  <meta name="keywords" content="mysql,innodb,表空间,table space">
  <meta name="description" content="InnoDB 表空间 (table space) 用来组织存储保存的数据，本文中对表空间管理进行分析。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>InnoDB 存储空间</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2015-06-09 Tuesday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  mysql ,  database  
      
    </div>
  </div>
  <hr>
  <p>InnoDB 表空间 (table space) 用来组织存储保存的数据，本文中对表空间管理进行分析。</p>

<!-- more -->

<h2 id="简介">简介</h2>

<p>InnoDB 实现的表空间是在文件系统之上又构建的一层逻辑存储的空间管理，每个表空间在逻辑上划分为了如下的几层结构，依次包括 table space、segment inode、extent、page、record 。</p>

<p><img src="/images/databases/mysql/innodb-tablespace.png" alt="innodb files" class="pull-center" /></p>

<p>如图所示，InnoDB 最小读写单位是 Page；为了高效管理，又将连续的 64 个页称为 “extent”，而且在一个表空间中，通常是以 “extent” 为单位进行资源分配。</p>

<p>除此之外，还在 extents 上层添加了一个 segment inode 管理，最多可以管理 256 个 extents。如果 page 采用默认的 16K，那么对应的 extent 大小为 64*16K=1M，而 segment 对应 256M 。</p>

<h3 id="参数设置">参数设置</h3>

<p>首先确认几个与表空间管理相关的参数，也就是打开独立表空间，且采用默认的页大小为 16K 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SHOW VARIABLES LIKE &#39;innodb_file_per_table&#39;;
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| innodb_file_per_table | ON    |
+-----------------------+-------+
1 row in set (0.01 sec)

mysql&gt; SHOW VARIABLES LIKE &#39;innodb_page_size&#39;;
+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| innodb_page_size | 16384 |
+------------------+-------+
1 row in set (0.00 sec)</code></pre></figure>

<h3 id="工具">工具</h3>

<p>在查看表空间时可以使用几个常用的工具，可以参考 <a href="/reference/databases/mysql/innodb_page_info">innodb_page_info</a> 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看每个页的详细信息
$ innodb_page_info -v dept_emp.ibd</code></pre></figure>

<h2 id="文件格式详解">文件格式详解</h2>

<p>InnoDB 的存储文件格式如上图所示，我们直接从大到小介绍其结构，依次从 space file -&gt; segment -&gt; extent -&gt; page -&gt; row 逐一介绍。</p>

<h3 id="space-file-格式">Space File 格式</h3>

<p>Space File 主要包括了两类：系统空间 (system space) 和 表空间 (Per-table space files)。一个表空间文件，实际就是一系列 Pages 的组合 (最大 2<sup>32</sup>)，为了方便管理，你可以理解为做了三级的划分，分别是 segment、extent、page 。</p>

<p>其基本结构如下所示：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0 KiB   +---------------------------------------------------+
        |   FSP_HDR: Filespace Header / Extent Descriptor   |
16 KiB  +---------------------------------------------------+
        |       IBUF_BITMAP: Insert Buffer Bookeeping       |
32 KiB  +---------------------------------------------------+
        |           INODE: Index Node Information           |
48 KiB  +---------------------------------------------------+
   |    |                                                   |
   |    ~                  More pages ...                   ~
   v    |                                                   |
256 MiB +---------------------------------------------------+
   |    |   XDES: Extent descriptor for next 16,384 pages   |
   |    +---------------------------------------------------+
   |    |  IBUF_BITMAP: IBUF Bitmap for next 16,384 pages   |
   |    +---------------------------------------------------+
   |    |                                                   |
   |    ~                  More pages ...                   ~
   v    |                                                   |
512 MiB +---------------------------------------------------+
   |    |   XDES: Extent descriptor for next 16,384 pages   |
   |    +---------------------------------------------------+
   |    |  IBUF_BITMAP: IBUF Bitmap for next 16,384 pages   |
   |    +---------------------------------------------------+
   |    |                                                   |
   |    ~                  More pages ...                   ~
   |    |                                                   |
   v    +---------------------------------------------------+</code></pre></figure>

<p>对于 Page0 肯定是 “File SPace HeaDeR”，其中维护了 extent 相关的信息，例如那些是空闲的、满的、有碎片的 (fragmented)。在 FSP_HDR 页中，只能维护 256 个 extent 相关的信息 (16,384 pages==256MiB)，这也就导致每隔 256M 都需要有一个 XDES 来管理接下来的 extent 元信息。</p>

<!--
The third page in each space (page 2) will be an INODE page, which is used to store lists related to file segments (groupings of extents plus an array of singly-allocated “fragment” pages). Each INODE page can store 85 INODE entries, and each index requires two INODE entries. (A more detailed discussion of INODE entries and file segments is reserved for a future post.)

Alongside each FSP_HDR or XDES page will also be an IBUF_BITMAP page, which is used for bookkeeping information related to insert buffering, and is outside the scope of this post.
-->

<h4 id="系统空间">系统空间</h4>

<p>在系统空间中的固定位置保存了与 InnoDB 相关的关键信息，其中的 FSP_HDR、IBUF_BITMAP、INODE 三个页都是相同的，只是之后的页会有区别。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0 KiB    +---------------------------------------------------+
         |   FSP_HDR: Filespace Header / Extent Descriptor   |
16 KiB   +---------------------------------------------------+
         |       IBUF_BITMAP: Insert Buffer Bookeeping       |
32 KiB   +---------------------------------------------------+
         |           INODE: Index Node Information           |
48 KiB   +---------------------------------------------------+
         |             SYS: Insert Buffer Header             |
64 KiB   +---------------------------------------------------+
   |     |            INDEX: Insert Buffer Header            |
   |     +---------------------------------------------------+
   |     |        TRX_SYS: Transaction System Header         |
   |     +---------------------------------------------------+
   |     |           SYS: First Rollback Segment             |
   |     +---------------------------------------------------+
   |     |           SYS: Data Dictionary Header             |
   |     +---------------------------------------------------+
   |     |                                                   |
   |     ~                  More pages ...                   ~
   v     |                                                   |
Page 64  +---------------------------------------------------+
         |      Double Write Buffer Block 1 (64 pages)       |
Page 128 +---------------------------------------------------+
         |      Double Write Buffer Block 2 (64 pages)       |
Page 192 +---------------------------------------------------+
   |     |                                                   |
   |     ~                  More pages ...                   ~
   |     |                                                   |
   v     +---------------------------------------------------+</code></pre></figure>

<!--
Page3 以下的页定义为：

Page 3, type SYS: Headers and bookkeeping information related to insert buffering.
Page 4, type INDEX: The root page of the index structure used for insert buffering.
Page 5, type TRX_SYS: Information related to the operation of InnoDB’s transaction system, such as the latest transaction ID, MySQL binary log information, and the location of the double write buffer extents.
Page 6, type SYS: The first rollback segment page. Additional pages (or whole extents) are allocated as needed to store rollback segment data.
Page 7, type SYS: Headers related to the data dictionary, containing root page numbers for the indexes that make up the data dictionary. This information is required to be able to find any other indexes (tables), as their root page numbers are stored in the data dictionary itself.
Pages 64-127: The first block of 64 pages (an extent) in the double write buffer. The double write buffer is used as part of InnoDB’s recovery mechanism.
Pages 128-191: The second block of the double write buffer.

All other pages are allocated on an as-needed basis to indexes, rollback segments, undo logs, etc.
-->

<h4 id="表空间-per-table-space-files">表空间 Per-table Space Files</h4>

<p>这需要打开 innodb_file_per_table 变量之后才会生效。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0 KiB    +---------------------------------------------------+
         |   FSP_HDR: Filespace Header / Extent Descriptor   |
16 KiB   +---------------------------------------------------+
         |       IBUF_BITMAP: Insert Buffer Bookeeping       |
32 KiB   +---------------------------------------------------+
         |           INODE: Index Node Information           |
48 KiB   +---------------------------------------------------+
         |         INDEX: Root page of first index           |
64 KiB   +---------------------------------------------------+
   |     |        INDEX: Root page of second index           |
   |     +---------------------------------------------------+
   |     |              INDEX: Node pages ...                |
   |     +---------------------------------------------------+
   |     |              INDEX: Leaf pages ...                |
   |     +---------------------------------------------------+
   |     |     ALLOCATED: Reserved bu unused pages ...       |
   |     +---------------------------------------------------+
   |     |                                                   |
   |     ~                  More pages ...                   ~
   |     |                                                   |
   v     +---------------------------------------------------+</code></pre></figure>

<!--
Ignoring “fast index creation” which adds indexes at runtime, after the requisite 3 initial pages, the next pages allocated in the space will be the root pages of each index in the table, in the order they were defined in the table creation. Page 3 will be the root of the clustered index, Page 4 will be the root of the first secondary key, etc.

Since most of InnoDB’s bookkeeping structures are stored in the system space, most pages allocated in a per-table space will be of type INDEX and store table data.
-->

<h3 id="segment">Segment</h3>

<p>在 segment 中保存了与 extent 相关的元数据，实际上是在空间文件的固定位置保存了 extent 的元数据信息，其格式为 FSP_HDR/XDES，其结构也非常简单，在 Page Body 中保存了 256 个 extent descriptors 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">00000 +---------------------------------------------------+
      |                  FIL header (38)                  |
00038 +---------------------------------------------------+
      |   FSP Header (zero-filled for XDES pages) (112)   |
00150 +---------------------------------------------------+
      |     XDES Entry   0 (pages     0 ~    63) (40)     |
00190 +---------------------------------------------------+
      |     XDES Entry   1 (pages    64 ~   127) (40)     |
00230 +---------------------------------------------------+
      |     XDES Entry   2 (pages   128 ~   191) (40)     |
00270 +---------------------------------------------------+
      |     XDES Entry   3 (pages   192 ~   255) (40)     |
00310 +---------------------------------------------------+
      |                                                   |
      ~                    ... ...                        ~
      |                                                   |
10310 +---------------------------------------------------+
      |     XDES Entry 254 (pages 16256 ~ 16319) (40)     |
10350 +---------------------------------------------------+
      |     XDES Entry 255 (pages 16320 ~ 16383) (40)     |
10390 +---------------------------------------------------+
      |                                                   |
      ~            (Empty Space: 5,986 bytes)             ~
      |                                                   |
16376 +---------------------------------------------------+
      |                   FIL Trailer (8)                 |
16384 +---------------------------------------------------+</code></pre></figure>

<p>该页的类型同样在 fil0fil.h 中定义。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define FIL_PAGE_INODE      3   </span><span class="cm">/*!&lt; Index node */</span><span class="cp"></span></code></pre></figure>

<p>该类型的页定义为 inode，这与文件系统中的 inode 概念有点混淆，实际上与文件系统中的概念完全不同，在 InnoDB 中只是描述了与 extent 相关的信息。</p>

<h3 id="extents-and-extent-descriptors">Extents and extent descriptors</h3>

<p>extent 是为了更加方便的管理 page，也可以称为簇或者区，对于 16KiB 大小的 page 一个 extent 管理 64 个，其定义在 fsp0types.h 文件中定义，不同大小的页，对应的 extent 也有所不同。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cm">/** File space extent size in pages</span>
<span class="cm">page size | file space extent size</span>
<span class="cm">----------+-----------------------</span>
<span class="cm">   4 KiB  | 256 pages = 1 MiB</span>
<span class="cm">   8 KiB  | 128 pages = 1 MiB</span>
<span class="cm">  16 KiB  |  64 pages = 1 MiB</span>
<span class="cm">  32 KiB  |  64 pages = 2 MiB</span>
<span class="cm">  64 KiB  |  64 pages = 4 MiB</span>
<span class="cm">*/</span>
<span class="cm">/** File space extent size (one megabyte if default two or four if not) in pages */</span>
<span class="cp">#define FSP_EXTENT_SIZE     ((UNIV_PAGE_SIZE &lt;= (16384) ?   \</span>
<span class="cp">                (1048576U / UNIV_PAGE_SIZE) :   \</span>
<span class="cp">                ((UNIV_PAGE_SIZE &lt;= (32768)) ?  \</span>
<span class="cp">                (2097152U / UNIV_PAGE_SIZE) :   \</span>
<span class="cp">                (4194304U / UNIV_PAGE_SIZE))))</span></code></pre></figure>

<p>extent 是通过一个叫簇描述符 (extent descriptor) 来表示的，对应了上述的 XDES Entry，详细格式如下：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">N    +------------------------------------+
     |        File Segment ID (8)         |
N+8  +------------------------------------+
     |    List node for XDES list (12)    |
N+20 +------------------------------------+
     |            State (4)               |
N+24 +------------------------------------+
     |      Page State Bitmap (16)        |
     |  2 bits per page, 1=free, 2=clean  |
N+40 +------------------------------------+</code></pre></figure>

<p>详细的宏定义在 fsp0fsp.h 头文件中。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define XDES_ID                            0</span>
<span class="cp">#define XDES_FLST_NODE                     8</span>
<span class="cp">#define XDES_STATE      (FLST_NODE_SIZE + 8)</span>
<span class="cp">#define XDES_BITMAP    (FLST_NODE_SIZE + 12)</span>

<span class="cp">#define XDES_SIZE (XDES_BITMAP + UT_BITS_IN_BYTES(FSP_EXTENT_SIZE * XDES_BITS_PER_PAGE))</span></code></pre></figure>

<p>每个 extent descriptor 会管理 64 个 pages，最后的 16Bytes 用来标识这 64 个 page 的状态，如空闲、半空闲，主要目的是为了能够快速从这 64 个 page 中找到空闲的 page。</p>

<!--
XDES_ID 存放该extent所属segment的id

XDES_FLST_NODE实际是一个文件链表节点，这样可以把extent descriptor组织成一个链表，实际上我们在extent更上层管理extent时会把extent链在一起组成链表，那么实际链表的节点就是extent descriptor的这个字段，比如某个segment的extent free list和表空间的extent frag list都是通过这个节点组织extent链表的，这个后续详细说明

XDES_STATE标识该extent descriptor所代表的extent的所属状态，定义如下：

/* States of a descriptor */
#define    XDES_FREE     1    /* extent is in free list of space */
#define    XDES_FREE_FRAG     2    /* extent is in free fragment list of space */
#define    XDES_FULL_FRAG     3    /* extent is in full fragment list of space */
#define    XDES_FSEG     4    /* extent belongs to a segment */
-->

<h3 id="page">Page</h3>

<p>页是 InnoDB 中的最小的逻辑存储单位，很多基本操作都是以页为单位进行，在 <code>include/univ.i</code> 文件中通过宏指定，默认大小是 16K。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define UNIV_PAGE_SIZE      ((ulint) srv_page_size)</span></code></pre></figure>

<p>而变量 <code>srv_page_size</code> 的大小，实际对应了 <code>innodb_page_size</code> 参数。与页相关的宏定义基本都在 fil0fil.h 头文件中，其中定义了多种页类型，其中比较常见的举例如下：</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define FIL_PAGE_INDEX      17855    </span><span class="c1">// 数据索引页</span>
<span class="cp">#define FIL_PAGE_UNDO_LOG   2        </span><span class="c1">// 事务回滚日志页</span>
<span class="cp">#define FIL_PAGE_INODE      3        </span><span class="c1">// inode页，用来管理segment</span></code></pre></figure>

<p>如上所述，默认每个页的大小为 16K=16384Byte，每个页通过一个 int32 类型的值标识其在表空间中页的偏移量，也就是说默认的表空间最大是 2<sup>32</sup> x 16 KiB = 64 TiB 。</p>

<h4 id="页格式">页格式</h4>

<p>所有 page 的格式都是相同的，由 page_header、page_body、page_trailer 三部分组成。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">00000 +-------------------------------------------+
      |      FIL header (38) FIL_PAGE_DATA        |
00038 +-------------------------------------------+
      |    Body, other headers and page data,     |
      |        depending on page type.            |
      |                                           |
      |     Total usable space: 16,338 bytes      |
      |                                           |
16376 +-------------------------------------------+
      |    FIL Trailer (8) FIL_PAGE_DATA_END      |
16384 +-------------------------------------------+</code></pre></figure>

<p>如上，包括了 page 的头信息，占 38 个字节，像页类型这样的元数据信息会保存在该字段中；page trailer 也就是页末尾的最后 8 个字节；剩余中间的部分作为 page body，也即页的实体信息，对这部分来说不同的页类型包含了不同的内容。</p>

<p>而对应页内各个 field 的大小，是在 fil0fil.h 头文件中通过宏进行定义。需要注意的是，很大一部分宏，实际定义的是在页内的偏移量，可以参考其注释。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define FIL_PAGE_DATA       38  </span><span class="cm">/*!&lt; start of the data on the page */</span><span class="cp"></span>
<span class="cp">#define FIL_PAGE_DATA_END   8   </span><span class="cm">/*!&lt; size of the page trailer */</span><span class="cp"></span></code></pre></figure>

<p>页中其它的偏移量同样在 fil0fil.h 头文件中定义。</p>

<h4 id="headertailer">Header+Tailer</h4>

<p>其中，Header 和 Tailer 中保存元信息的详细内容如下所示：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">00000 +-------------------------------------------+
      |                 Checksum (4)              |
00004 +-------------------------------------------+
      |          Offset (Page Number) (4)         |
00008 +-------------------------------------------+
      |          Previous Page Number (4)         |
00012 +-------------------------------------------+
      |            Next Page Number (4)           |
00016 +-------------------------------------------+
      |     LSN for last page modification (8)    |
00024 +-------------------------------------------+
      |               Page Type (2)               |
00026 +-------------------------------------------+
      |     Flush LSN OR version+checksum (8)     |
00034 +-------------------------------------------+
      |               Space ID (4)                |
00038 +-------------------------------------------+
      |                                           |
      ~                 ... ...                   ~
      |                                           |
16376 +-------------------------------------------+
      |          Old-style Checksum (4)           |
16380 +-------------------------------------------+
      |          Low 32 bit of LSN (4)            |
16384 +-------------------------------------------+</code></pre></figure>

<p>在 Page Header 中，各个字段的占用空间以及大致的含义如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">FIL_PAGE_SPACE_OR_CHKSUM    # 4，对于大于4.0.14的版本，存储的为checksum，否则为0
FIL_PAGE_OFFSET             # 4，页号page no，一般是在表空间的物理偏移量
FIL_PAGE_PREV               # 4，前一页的page no，B+tree的叶子节点是通过链表串起来，很多类型的页不需要该值
FIL_PAGE_NEXT               # 4，后一页的page no
FIL_PAGE_LSN                # 8，更改记录时最大的redo log lsn，一般用在redo log恢复时使用
FIL_PAGE_TYPE               # 2，page的类型
FIL_PAGE_FILE_FLUSH_LSN     # 8，space文件最后被flush是的redo log lsn，只在第一页中设置
FIL_PAGE_SPACE_ID           # 4，最后被归档的archive log file序号，同样只在space的第一个页中被设置</code></pre></figure>

<p>这里的页号 (page no) 实际上是相对于整个表空间的偏移量，表空间可以包含有多个文件，而这个页号是连续的。在各个页的头部中，还保存了前后页的 page no，从而形成了类似双像链表的结构。</p>

<p>不同类型的页对应 body 部分的数据结构是不同的，因此需要根据 header 中的页类型来解析该页的数据。另外，页号会在页初始化完成之后赋值，可以用来校验通过偏移量读取的页是否正确。</p>

<p>对于 tailer 来说，高 4 位是用来存储 FIL_PAGE_LSN 的部分信息，低 4 位用来表示 page 页中数据老的 checksum 信息。</p>

<h4 id="checksum">checksum</h4>

<p>在 5.6.3 中，引入了 <a href="http://dev.mysql.com/doc/refman/en/innodb-parameters.html#sysvar_innodb_checksum_algorithm">innodb_checksum_algorithm</a> 这一变量，用于设置 checksum 的计算方式，默认采用的是 INNODB 。其中 checksum 分别在 header 和 tailer 保存，在 tailer 中保存的是老的方式，后面将会被取消掉。</p>

<h2 id="index">Index</h2>

<p>在 InnoDB 中，所有的都是通过 Index 表示，包括主表和索引表，该类型的页同样在 fil0fil.h 中定义。</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#define FIL_PAGE_INDEX      17855   </span><span class="cm">/*!&lt; B-tree node */</span><span class="cp"></span></code></pre></figure>

<p>该页的结构如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">00000 +-------------------------------+
      |       FIL header (38)         |
00038 +-------------------------------+
      |      INDEX Header (36)        |
00074 +-------------------------------+
      |       FSEG Header (20)        |
00094 +-------------------------------+
      |     System Records (26)       |
00120 +-------------------------------+
      |                               |
      ~        User Records           ~
      |                               |
      +-------------------------------+
 Top  |         Free Space            |
      +-------------------------------+
      |                               |
      ~       Page Directory          ~
      |                               |
16376 +-------------------------------+
      |       FIL Trailer (8)         |
16384 +-------------------------------+</code></pre></figure>

<h4 id="index-header">Index Header</h4>

<figure class="highlight"><pre><code class="language-text" data-lang="text">38 +-------------------------------+
   |  Number of Directory Slots (2)
40 +-------------------------------+
   | Heap Top Positon (2)          |
42 +-------------------------------+
   | Number of Heap Records / Format Flag (2)
44 +-------------------------------+</code></pre></figure>

<h4 id="system-records">System Records</h4>

<p>每个 INDEX 页都包含两个被称为 infimum 和 supremum 的系统记录，而且其偏移量是固定的，分别为 offset 99 以及 offset 112 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">094 +------------------------------------+
    |       Info Flags (4 bits)          |
    +------------------------------------+
    |  Number of Records Owned (4 bits)  |
095 +------------------------------------+
    |          Order (13 bits)           |
    +------------------------------------+
    |        Record Type (3 bits)        |
097 +------------------------------------+
    |       Next Record Offset (2)       |
099 +------------------------------------+
    |           &quot;infimum\0&quot; (8)          |
107 +------------------------------------+
    |       Info Flags (4 bits)          |
    +------------------------------------+
    |  Number of Records Owned (4 bits)  |
108 +------------------------------------+
    |          Order (13 bits)           |
    +------------------------------------+
    |        Record Type (3 bits)        |
110 +------------------------------------+
    |       Next Record Offset (2)       |
112 +------------------------------------+
    |           &quot;supremum\0&quot; (8)         |
120 +------------------------------------+</code></pre></figure>

<p>rem0rec.cc</p>

<h2 id="record">Record</h2>

<p>记录头信息如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">094 +------------------------------------+
    |       Info Flags (4 bits)          |
    +------------------------------------+
    |  Number of Records Owned (4 bits)  |
095 +------------------------------------+
    |          Order (13 bits)           |
    +------------------------------------+
    |        Record Type (3 bits)        |
097 +------------------------------------+
    |       Next Record Offset (2)       |
099 +------------------------------------+
    |           &quot;infimum\0&quot; (8)          |
107 +------------------------------------+
    |       Info Flags (4 bits)          |
    +------------------------------------+
    |  Number of Records Owned (4 bits)  |
108 +------------------------------------+
    |          Order (13 bits)           |
    +------------------------------------+
    |        Record Type (3 bits)        |
110 +------------------------------------+
    |       Next Record Offset (2)       |
112 +------------------------------------+
    |   Next Record Offset (2)           |
N   +------------------------------------+</code></pre></figure>

<p>其中 index page body 由 5 部分组成：body header、recorders、free recorders、free heap 和 page directory，其中 body header 的结构定义如下：</p>

<h2 id="实践">实践</h2>

<p>如上，介绍了 InnoDB 存储的数据格式，接下来实际查看下；本文中在测试的时候，使用的工具可以参考 <a href="https://github.com/jeremycole/innodb_ruby">innodb_ruby</a> 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 新建表
mysql&gt; create table test.foobar (id int);
Query OK, 0 rows affected (0.05 sec)

----- 新建之后，直接查看状态
$ innodb_space -f test/foobar.ibd space-page-type-regions
start       end         count       type
0           0           1           FSP_HDR
1           1           1           IBUF_BITMAP
2           2           1           INODE
3           3           1           INDEX
4           5           2           FREE (ALLOCATED)</code></pre></figure>

<p>此时，只分配了标准的空间页，总共 6 Pages，包括了 FSP_HDR、IBUF_BITMAP、INODE、ROOT INDEX page，而且还有两个已经分配的未使用的页。</p>

<h2 id="参考">参考</h2>

<p>关于表空间的介绍可以参考 PPT <a href="/reference/mysql/InnoDBFileFormat.pdf">InnoDB Internals: InnoDB File Formats and Source Code Structure</a> 的介绍，上面的很多图片是直接从该 PPT 复制下来的。</p>

<p>关于 InnoDB 的文件格式，详细内容可以参考 Jeremy Cole 的一系列文章 <a href="https://blog.jcole.us/innodb/">InnoDB internals, structures, and behavior</a> ，对文件存储格式讲解的十分详细。</p>

<!--
http://www.itpub.net/thread-1813772-1-1.html
http://blog.csdn.net/yuanrxdu/article/details/41925279
http://blog.csdn.net/yuanrxdu/article/details/4221598
http://www.linuxidc.com/Linux/2016-03/128827.htm
http://www.cnblogs.com/zhoujinyi/archive/2012/10/17/2726462.html

innodb文件类型格式整理，故障恢复
https://github.com/chhabhaiya/undrop-for-innodb
http://www.askmaclean.com/archives/mysql-recover-innodb.html


Chapter 22 InnoDB Storage Engine
https://dev.mysql.com/doc/internals/en/innodb.html

MySQL · 引擎特性 · InnoDB文件系统管理
https://yq.aliyun.com/articles/5586
-->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/linux-basic-conception-for-time-details.html" title="Linux 时间基本概念">&larr; Older</a></li> 
         <li class="next"><a href="/post/python-modules-logging.html" title="Python Logging 模块">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1433779200',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/mysql-innodb-storage.html" data-title="InnoDB 存储空间" data-url="/post/mysql-innodb-storage.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
