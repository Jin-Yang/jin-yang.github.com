<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>systemd 使用简介|JinYang's Blog</title>
  <meta name="keywords" content="systemd,简介,linux,init">
  <meta name="description" content="现在一般新发行的版本会采用新的 init 进程，也就是 systemd ，其中启动过程可以通过 man bootup 查看。在此，简单介绍一下 systemd 。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>systemd 使用简介</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2015-09-17 Thursday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  linux ,  misc  
      
    </div>
  </div>
  <hr>
  <p>现在一般新发行的版本会采用新的 init 进程，也就是 systemd ，其中启动过程可以通过 man bootup 查看。</p>

<p>在此，简单介绍一下 systemd 。</p>

<!-- more -->

<h2 id="简介">简介</h2>

<p>Linux 内核通过执行 init 将 CPU 的控制权限，交给其它的任务，在 CentOS 中可以通过如下命令查看 init 来自于那个包。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ rpm -qif `which init`</code></pre></figure>

<p>init 进程经历了，SysV、Upstart 以及 systemd，而 systemd 是最具争议的一个项目，因为其不只替换了 init，而且还包括了一整套的系统任务。</p>

<p>作为最新的系统和服务管理器，其设计思路借鉴了 Mac 的启动程序 Launchd，兼容 SysV 和 LSB 的启动脚本。事实上其作用远不仅是启动系统，它还接管了系统服务的启动、结束、状态查询和日志归档等职责，并支持定时任务和通过特定事件，如插入特定 USB 设备和特定端口数据触发的任务。</p>

<p>其有以下特性：支持并行化任务、同时采用 socket 和 D-BUS 总线式激活服务、按需启动相应的守护进程、利用 Linux 的 cgroup 监控进程、支持快照和系统恢复、维护挂载点和自动挂载点，各服务间基于依赖关系进行精密控制。</p>

<!--
Systemd同时也清晰地处理了系统关机过程。它在/usr/lib/systemd/目录下有三个脚本，分别叫systemd-halt.service，systemd-poweroff.service，systemd-reboot.service。这几个脚本会在用户选择关机，重启或待机时执行。在接收到关机事件时，systemd首先卸载所有文件系统并停止所有内存交换设备，断开存储设备，之后停止所有剩下的进程。
-->

<p>可以通过 pstree 查看启动的进程树，接下来查看一下 systemd 的特性。</p>

<h2 id="systemd">Systemd</h2>

<p>Systemd 使用 <code>target</code> 来处理引导和服务管理过程，这些 systemd 里的 <code>target</code> 文件被用于分组不同的引导单元以及启动同步进程。</p>

<p>如果 A 要求 B 在 A 之前运行，则在 [Unit] 段中添加 Requires=B 和 After=B，如果依赖关系是可选的，可添加 Wants=B 和 After=B；注意 Wants= 和 Requires= 并不意味着 After=，即如果 After= 选项没有设置，这两个单元将被并行启动。</p>

<h3 id="执行顺序">执行顺序</h3>

<p>执行的第一个目标是 <code>/etc/systemd/system/default.target</code>，对于桌面版本，通常会指向 <code>/usr/lib/systemd/system/graphical.target</code>，该文件为文本，可以查看其实际会依次依赖于 <code>multi-user.target =&gt; basic.target =&gt; sysinit.target</code> 。</p>

<p>另外，<code>local-fs.target</code> 单元并不会启动用户相关的服务，它只处理与文件系统相关的底层核心服务，会根据 <code>/etc/fstab</code> 和 <code>/etc/inittab</code> 来执行相关操作。</p>

<p><code>sysinit.target</code> 会启动重要的系统服务例如系统挂载，内存交换空间和设备，内核补充选项等等。<code>basic.target</code> 会启动普通服务特别是图形管理服务，它通过 <code>/etc/systemd/system/basic.target.wants</code> 目录来决定哪些服务会被启动。</p>

<p>在这个阶段，会启动 <code>multi-user.target</code> 而这个 target 将自己的子单元放在目录 <code>/etc/systemd/system/multi-user.target.wants</code> 里。这个 target 为多用户支持设定系统环境，非 root 用户会在这个阶段的引导过程中启用。防火墙相关的服务也会在这个阶段启动。</p>

<p>登陆是通过 <code>systemd-logind.service</code> 进行，可以通过 <code>systemctl help systemd-logind.service</code> 查看帮助，通常是针对 XWindow，而终端登陆则通过 <code>/usr/lib/systemd/system/getty@.service</code> 执行。</p>

<p>依赖关系可以查看 <a href="https://www.freedesktop.org/software/systemd/man/bootup.html">System bootup process</a> 。</p>

<h3 id="启动优化">启动优化</h3>

<p>sysvinit 只能一次一个串行地启动进程，而 Systemd 则并行地启动系统服务进程，并且最初仅启动确实被依赖的那些服务，极大地减少了系统引导的时间。</p>

<p>任何启动项，只要是在系统启动时有被执行到，不论启动成功还是失败，systemd 都能够记录下他们的状态，可以通过 systemctl 查看当前的服务。</p>

<p>详细信息可以通过 <code>systemctl status systemd-logind.service</code> 查看；启动的结构树可以通过 <code>systemd-cgls</code> 查看。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># systemd-analyze                         ← 查看系统引导用时
# systemd-analyze time                    ← 同上
# systemd-analyze blame                   ← 查看初始化任务所消耗的时间
# systemd-analyze plot &gt; systemd.svg      ← 将启动过程输出为svg图
# systemd-cgtop                           ← 查看资源的消耗状态</code></pre></figure>

<h3 id="常用-systemctl-命令">常用 systemctl 命令</h3>

<p>通过 systemctl 命令可以管理整个系统。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看、设置、取消开机启动
# systemctl is-enabled nginx
# systemctl enable nginx
# systemctl disable nginx

----- 启动、停止、kill、重启、查看服务状态
# systemctl start nginx
# systemctl stop nginx
# systemctl kill nginx
# systemctl restart nginx
$ systemctl status nginx

----- 修改service之后重新加载
# systemctl daemon-reload

----- 杀死一个服务的所有进程，传递信号到指定服务的所有进程
# systemctl kill crond.service
----- 指定信号类型，如下两者相同，所有fork的进程都会被杀死
# systemctl kill -s SIGKILL crond.service
# systemctl kill -s 9 crond.service
----- 发送指定信号到服务的主进程
# systemctl kill -s HUP --kill-who=main crond.service

----- 其它操作
# systemctl                               ← 列出正在运行的单元
# systemctl list-units                    ← 同上
# systemctl list-units --type service     ← 同上，只是以service为单位
# systemctl --failed                      ← 查看失败的任务
# systemctl list-unit-files               ← 所有已经安装的任务
# systemctl list-dependencies nginx       ← 查看特定服务的依赖关系</code></pre></figure>

<p>所有可用的单元文件存放在 <code>/usr/lib/systemd/system</code> 和 <code>/etc/systemd/system</code> 目录中，一个单元配置文件可以为，系统服务(.service) 、挂载点(.mount)、sockets(.sockets)、系统设备、交换分区/文件、启动目标(target)、文件系统路径、由 systemd 管理的计时器，详见 <code>man 5 systemd.unit</code> 。</p>

<p>通过enable 设置为开机启动时，相当于在 <code>/etc/systemd/system/default.target</code> 符号链接指向的目标对应目录下添加指向 nginx 的符号链接。</p>

<h3 id="设置启动级别">设置启动级别</h3>

<p>在 sysVinit 的 <code>runlevels</code> 大多是以数字分级的，而在 CentOS 7 中可以通过 systemd 修改运行的等级，常用的命令如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 列出当前系统支持的所有等级
# systemctl list-units --type=target

----- 查看当前等级，并设置当前以及默认的等级
# systemctl get-default
# systemctl isolate graphical.target
# systemctl set-default graphical.target

----- 查看所有已经启动的服务，包括启动失败的
$ systemctl list-units --type=service</code></pre></figure>

<p>实际上在通过 <code>isolate</code> 设置启动方式的时候是将 <code>/etc/systemd/system/default.target</code> 指向对应的启动等级。</p>

<h3 id="日志管理">日志管理</h3>

<p>journald 是 systemd 独有的日志系统，替换了 sysVinit 中的 syslog 守护进程，通过命令 journalctl 读取日志。</p>

<p>Systemd 统一管理所有 Unit 的启动日志，好处是，只需要 journalctl 一个命令，就可以查看所有日志 (内核日志和应用日志) 的内容；配置文件为 /etc/systemd/journald.conf 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看某个Unit的日志
# journalctl -u nginx.service
# journalctl -u nginx.service --since today

----- 实时滚动显示某个Unit的最新日志
# journalctl -u nginx.service -f

# 合并显示多个 Unit 的日志
$ journalctl -u nginx.service -u php-fpm.service --since today</code></pre></figure>

<p>更多内容可以查看 <a href="https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs">How To Use Journalctl to View and Manipulate Systemd Logs</a> 。</p>

<!--

<figure class="highlight"><pre><code class="language-text" data-lang="text"># journalctl                               // 查看日志
# journalctl -b                            // 启动日志
# journalctl -f                            // 实时显示系统日志
# journalctl /usr/sbin/dnsmasq             // 查看特定任务的日志</code></pre></figure>

-->

<h3 id="电源管理">电源管理</h3>

<p>systemctl 命令也可以用来关机、重启、挂起、休眠。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># systemctl poweroff
# systemctl reboot
# systemctl suspend
# systemctl hibernate</code></pre></figure>

<h3 id="时区设置">时区设置</h3>

<p>systemd 提供了一个 timedatectl 命令行，可用于配置时区信息。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 查看当前所支持的时区信息
$ timedatectl list-timezones
----- 选择上述中的时区，然后设置
# timedatectl set-timezone zone
----- 查看当前时区设置的状态
# timedatectl status</code></pre></figure>

<h2 id="管理目标">管理目标</h2>

<p>服务 systemctl 脚本存放在 <code>/usr/lib/systemd/</code> 目录下，有系统 (system) 和用户 (user) 之分，前者开机后无需登录即可运行，后者则需要在用户登录后才能运行程序。</p>

<p>常见的服务如 nginx 等存放在 <code>/usr/lib/systemd/system</code> 目录下；下面以 nginx 为例，编写脚本时可以直接参考 nginx 的编写方法。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/run/nginx.pid
# Nginx will fail to start if /run/nginx.pid already exists but has the wrong
# SELinux context. This might happen when running `nginx -t` from the cmdline.
# https://bugzilla.redhat.com/show_bug.cgi?id=1268621
ExecStartPre=/usr/bin/rm -f /run/nginx.pid
ExecStartPre=/usr/sbin/nginx -t
ExecStart=/usr/sbin/nginx
ExecReload=/bin/kill -s HUP $MAINPID
KillMode=process
KillSignal=SIGQUIT
TimeoutStopSec=5
PrivateTmp=true

[Install]
WantedBy=multi-user.target</code></pre></figure>

<p>一个服务以 .service 结尾，一般会分为 3 部分：<code>[Unit]</code>、<code>[Service]</code> 和 <code>[Install]</code> 。</p>

<p>服务脚本按照上面编写完成后，以 754 的权限保存在 <code>/usr/lib/systemd/system</code> 目录下，这时就可以利用 <code>systemctl</code> 进行配置了。</p>

<h3 id="unit">Unit</h3>

<p>设置描述、帮助文档、启动顺序以及服务的启动依赖条件等，如下是 SSHD 服务的。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.service
Wants=sshd-keygen.service</code></pre></figure>

<p><code>After</code> 和 <code>Before</code> 分别设置在哪些服务之后或者之前启动，用于配置各个服务的启动顺序，注意，这里是启动顺序而非依赖关系。</p>

<p>通过 <code>Wants</code> 和 <code>Requires</code> 设置弱依赖和强依赖关系，前者表示依赖的服务启停不会影响当前服务，或者表示如果依赖退出，那么该服务同时退出。</p>

<h3 id="service">Service</h3>

<p>用于配置如何启动服务；注意，命令应该使用绝对路径。</p>

<!--
#  forking：ExecStart字段将以fork()方式启动，此时父进程将会退出，子进程将成为主进程
#  oneshot：类似于simple，但只执行一次，Systemd 会等它执行完，才启动其他服务
#  dbus：类似于simple，但会等待 D-Bus 信号后启动
#  idle：类似于simple，但是要等到其他任务都执行完，才会启动该服务。一种使用场合是为让该服务的输出，不与其他服务的输出相混合
-->

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">User</span><span class="o">=</span>nginx
<span class="nv">Group</span><span class="o">=</span>nginx
<span class="nv">PIDFile</span><span class="o">=</span>/run/nginx.pid

<span class="nv">Type</span><span class="o">=</span>forking                               <span class="c"># 定义启动类型</span>
<span class="c">#  simple : 默认值，通过ExecStart字段启动进程</span>
<span class="c">#  notify : 类似于simple，服务启动结束后会发出通知信号，然后Systemd再启动其他服务</span>

<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/nginx      <span class="c"># 依赖环境，可以指定多个</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/default/nginx

<span class="nv">ExecStartPre</span><span class="o">=</span>/usr/bin/rm -f /run/nginx.pid <span class="c"># 启动服务之前执行的命令</span>
<span class="nv">ExecStartPre</span><span class="o">=</span>/usr/sbin/nginx -t
<span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/nginx                  <span class="c"># 启动时，多个会被最后一个覆盖</span>
<span class="nv">ExecStartPost</span><span class="o">=</span>                             <span class="c"># 启动服务之后执行的命令</span>
<span class="nv">ExecReload</span><span class="o">=</span>/bin/kill -s HUP <span class="nv">$MAINPID</span>       <span class="c"># 重启服务时执行的命令</span>
<span class="nv">ExecStop</span><span class="o">=</span>                                  <span class="c"># 停止服务时执行的命令</span>
<span class="nv">ExecStopPost</span><span class="o">=</span>                              <span class="c"># 停止服务之后执行的命令</span>
<span class="nv">TimeoutStopSec</span><span class="o">=</span><span class="m">5</span>                           <span class="c"># 设置停止超时时间</span>

<span class="nv">KillMode</span><span class="o">=</span>process                           <span class="c"># 重启行为配置，详见如下介绍</span>
<span class="c">#  control-group : 默认值，当前控制组里面的所有子进程，都会被杀掉</span>
<span class="c">#  process       : 只杀主进程，信号可以通过如下方式定义</span>
<span class="c">#  mixed         : 主进程将收到SIGTERM信号，子进程收到SIGKILL信号</span>
<span class="c">#  none          : 没有进程会被杀掉，只是执行服务的stop命令</span>
<span class="nv">KillSignal</span><span class="o">=</span>SIGQUIT

<span class="nv">Restart</span><span class="o">=</span>on-failure                         <span class="c"># 意外失败后重启方式，正常停止不重启</span>
<span class="c">#  no          : 默认值，退出后不重启</span>
<span class="c">#  on-success  : 只有正常退出时(退出状态码为0)，才会重启</span>
<span class="c">#  on-failure  : 非正常退出时 (退出状态码非0)，包括被信号终止和超时，才会重启</span>
<span class="c">#  on-abnormal : 只有被信号终止和超时，才会重启</span>
<span class="c">#  on-abort    : 只有在收到没有捕捉到的信号终止时，才会重启</span>
<span class="c">#  on-watchdog : 超时退出，才会重启</span>
<span class="c">#  always      : 不管是什么退出原因，总是重启</span>
<span class="nv">RestartSec</span><span class="o">=</span><span class="m">10</span>                              <span class="c"># 重启服务之前，需要等待的秒数，默认100ms</span>

<span class="nv">PrivateTmp</span><span class="o">=</span>True                            <span class="c"># 给服务分配独立的临时空间</span></code></pre></figure>

<p>在所有的服务配置之前，都可以加上一个连词号 (<code>-</code>)，表示 “抑制错误”，也即即使发生错误也不影响其他命令的执行。</p>

<h3 id="install">Install</h3>

<p>在通过 enable 设置为开机启动时，添加到那个 target 里面，也即定义如何安装这个配置文件，即怎样做到开机启动。</p>

<h3 id="资源隔离">资源隔离</h3>

<p>相关内容可以查看 <a href="/post/linux-container-cgroup-introduce.html">容器之 CGroup</a> 。</p>

<h2 id="其它">其它</h2>

<p>systemd 带来了一整套与操作系统交互的新途径，如可以用 hostnamectl 获得机器的 hostname 和其它有用的独特信息。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># hostnamectl                              // 查看机器信息</code></pre></figure>

<p>除了 restart 命令，也可以使用 try-start 选项，它只会在服务已经在运行中的时候重启服务。</p>

<!--

在sysvinit的时代，如果需要结束一个服务及其启动的所有进程，可能会遇到一些糟糕的进程无法正确结束掉，即便是我们使用kill，killall等命令来结束它们，到了systemd的时代一切都变得不一样，systemd号称是第一个能正确的终结一项服务的程序，下面来看看具体如何操作的：
# systemctl kill crond.service
或者指定一个信号发送出去
# systemctl kill -s SIGKILL crond.service
例如可以像这样执行一次reload操作
# systemctl kill -s HUP --kill-who=main crond.service

http://www.csdn.net/article/2015-01-08/2823477/1<br><br>
http://www.linuxidc.com/Linux/2014-11/110023.htm<br><br>
http://www.linuxidc.com/Linux/2014-12/110777.htm<br><br>
http://www.ithov.com/linux/136324.shtml  比较详细介绍了原理

首先，使用systemctl start [服务名（也是文件名）]可测试服务是否可以成功运行，如果不能运行则可以使用systemctl status [服务名（也是文件名）]查看错误信息和其他服务信息，然后根据报错进行修改，直到可以start，如果不放心还可以测试restart和stop命令。

接着，只要使用systemctl enable xxxxx就可以将所编写的服务添加至开机启动即可。

这样看来，虽然systemctl比较陌生，但是其实比init.d那种方式简单不少，而且使用简单，systemctl能简化的操作还有很多，现在也有不少的资料，看来RHEL/CentOS比其他的Linux发行版还是比较先进的，此次更新也终于舍弃了Linux 2.6内核，无论是速度还是稳定性都提升不少。

如果使用 systemd 日志可以直接打印到 STDOUT ，然后由 systemd 统一管理。


bcmp ：比较两个内存中的内容
bcopy : 复制内存中的内容
bzero ： 将一个内存内容全清零
ffs : 在一个整数中查找第一个值为真的位
index : 查找字符串中第一个出现的指定字符
memccpy ：复制内存中的内容
memchr ：在一块内存指定范围内查找一个指定字符
memcmp ：比较内存中存放的内容
memcpy ： 复制一块内存内容到另一块
memfrob ： 对某个内存区重新编码
memmove ： 复制内存内容
memset ：将某值填入到一个内存区域
rindex ：查找字符串中最后一个出现的指定字符
* strcat ：将一个字符串连接到另一个字符串的尾部
* strncat ：将一个字符串的前n个字符连接到另一个字符串的尾部
strchr ；查找字符串中指定字符
strcmp ：比较两个字符串
strcoll ：根据当前环境信息来比较字符串
strcpy ：复制一个字符串的内容到另一个字符串中
strdup ：复制字符串的内容
strfry ：随机重组一个字符串
strlen ： 返回字符串的长度
* strncasecmp ：忽略大小写比较两个字符串
* strcasecmp ：忽略大小写比较字符串
strncmp ：比较字符串前n个字符
strncpy ： 复制字符串的前n个字符
strpbrk ：查找字符串中第一个出现的指定字符
strrchr ：查找字符串中最后一个出现的指定字符
strspn ：计算字符串中由指定字符集字符组成的子字符串的长度
strcspn ：计算字符串中由非指定字符集字符组成的子字符串的长度

https://github.com/jnavila/memtester


    # 查看所有日志（默认情况下 ，只保存本次启动的日志）
    $ sudo journalctl

    # 查看内核日志（不显示应用日志）
    $ sudo journalctl -k

    # 查看系统本次启动的日志
    $ sudo journalctl -b
    $ sudo journalctl -b -0

    # 查看上一次启动的日志（需更改设置）
    $ sudo journalctl -b -1

    # 查看指定时间的日志
    $ sudo journalctl --since="2012-10-30 18:17:16"
    $ sudo journalctl --since "20 min ago"
    $ sudo journalctl --since yesterday
    $ sudo journalctl --since "2015-01-10" --until "2015-01-11 03:00"
    $ sudo journalctl --since 09:00 --until "1 hour ago"

    # 显示尾部的最新10行日志
    $ sudo journalctl -n

    # 显示尾部指定行数的日志
    $ sudo journalctl -n 20

    # 实时滚动显示最新日志
    $ sudo journalctl -f

    # 查看指定服务的日志
    $ sudo journalctl /usr/lib/systemd/systemd

    # 查看指定进程的日志
    $ sudo journalctl _PID=1

    # 查看某个路径的脚本的日志
    $ sudo journalctl /usr/bin/bash

    # 查看指定用户的日志
    $ sudo journalctl _UID=33 --since today



    # 查看指定优先级（及其以上级别）的日志，共有8级
    # 0: emerg
    # 1: alert
    # 2: crit
    # 3: err
    # 4: warning
    # 5: notice
    # 6: info
    # 7: debug
    $ sudo journalctl -p err -b

    # 日志默认分页输出，--no-pager 改为正常的标准输出
    $ sudo journalctl --no-pager

    # 以 JSON 格式（单行）输出
    $ sudo journalctl -b -u nginx.service -o json

    # 以 JSON 格式（多行）输出，可读性更好
    $ sudo journalctl -b -u nginx.serviceqq
     -o json-pretty

    # 显示日志占据的硬盘空间
    $ sudo journalctl --disk-usage

    # 指定日志文件占据的最大空间
    $ sudo journalctl --vacuum-size=1G

    # 指定日志文件保存多久
    $ sudo journalctl --vacuum-time=1years
-->

<h3 id="自动登陆">自动登陆</h3>

<p>在此查看下如何自动登陆，首先创建一个新的类似于 <code>getty@.service</code> 的服务。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># cp /lib/systemd/system/getty@.service /etc/systemd/system/autologin@.service
# ln -s /etc/systemd/system/autologin@.service /etc/systemd/system/getty.target.wants/getty@tty8.service
# vi /etc/systemd/system/getty.target.wants/getty@tty8.service
...
ExecStart=-/sbin/mingetty --autologin USERNAME %I
Restart=no
...
Alias=getty.target.wants/getty@tty8.service</code></pre></figure>

<p>最后重新加载守护进程，运行服务：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># systemctl daemon-reload
# systemctl start getty@tty8.service</code></pre></figure>

<p>需要注意的是，如果你退出了 tty8 的会话，你需要等到下次重新启动才能使用，除非你给 Restart 的值是 <code>'always'</code>，这样可以使用 systemctl 手动开启，不过，出于安全考虑，强烈建议不要那么做。</p>

<h3 id="对比">对比</h3>

<p><img src="/images/linux/systemd-sysvinit.jpg" alt="SystemD VS. SysVinit" title="SystemD VS. SysVinit" class="pull-center" width="90%" /></p>

<h3 id="杂项">杂项</h3>

<p>如果重启过于频繁会报 “uagent.service start request repeated too quickly, refusing to start.”</p>

<h2 id="参考">参考</h2>

<p><a href="http://www.freedesktop.org/wiki/Software/systemd/">systemd System and Service Manager</a>，system daemon 官方网站。</p>

<!--
http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html

可以用来保护相关的目录
ProtectSystem=full
PrivateDevices=yes
PrivateTmp=yes
NoNewPrivileges=true
-->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/program-c-string-stuff.html" title="C 语言的字符串">&larr; Older</a></li> 
         <li class="next"><a href="/post/linux-container-cgroup-introduce.html" title="容器之 CGroup">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1442419200',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/linux-systemd.html" data-title="systemd 使用简介" data-url="/post/linux-systemd.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
