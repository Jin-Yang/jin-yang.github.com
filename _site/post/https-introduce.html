<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>HTTPS 协议详解|JinYang's Blog</title>
  <meta name="keywords" content="https,ssl,tls">
  <meta name="description" content="我们知道 HTTP 采用的是明文传输，而在互联网中，比如要在淘宝买个东西，使用支付宝转个帐，必须要保证这些信息只有客户端和服务器才知道的，也就是通过 HTTPS 协议。接下来，我们就看看 HTTPS 协议是如何实现的。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>HTTPS 协议详解</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2014-06-07 Saturday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  linux ,  webserver ,  misc  
      
    </div>
  </div>
  <hr>
  <p>我们知道 HTTP 采用的是明文传输，而在互联网中，比如要在淘宝买个东西，使用支付宝转个帐，必须要保证这些信息只有客户端和服务器才知道的，也就是通过 HTTPS 协议。</p>

<p>接下来，我们就看看 HTTPS 协议是如何实现的。</p>

<!-- more -->

<p><img src="/images/linux/https-logo.jpg" alt="https logo" title="https logo" class="pull-center" /></p>

<h2 id="简介">简介</h2>

<p>Secure Hypertext Transfer Protocol, HTTPS 也就是安全超文本传输协议，是一个安全通信通道，它基于 HTTP 开发用于在客户计算机和服务器之间交换信息。</p>

<p>实际上，简单来说，它是 HTTP 的安全版，是使用 SSL(Secure Socket Layer)/TLS(Transport Layer Security) 加密的 HTTP 协议。通过 TLS/SSL 协议的的身份验证、信息加密和完整性校验的功能，从而避免信息窃听、信息篡改和信息劫持的风险。</p>

<p>简单来说，HTTPS 提供了加密 (Encryption)、认证 (Verification)、鉴定 (Identification) 三种功能。如下的解释中，假设是张三和李四在通讯。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">私密性(Confidentiality/Privacy):
    也就是提供信息加密；保证信息只有张三和李四知道，而不会被窃听。
可信性(Authentication):
    身份验证，主要是服务器端的，有些银行也会对客户端进行认证；用来证明李四就是李四。
完整性(Message Integrity):
    保证信息传输过程中的完整性，防止被修改；李四接收到的消息就是张三发送的。</code></pre></figure>

<p>如下是 SSL/TLS 协议的介绍。</p>

<h3 id="ssltls-协议">SSL/TLS 协议</h3>

<p>SSL 最初是在 1996 年由 Netscape 发布，由于一些安全的原因 SSL v1.0 和 SSL v2.0 都没有公开，直到 1996 年的 SSL v3.0。TLS 是 v3.0 的升级版，目前市面上所有的 HTTPS 都是用的是 TLS 而非 SSL，而且很多地方都混用两者。</p>

<p><img src="/images/linux/https-ssl-tls-layer.png" alt="https" title="https" class="pull-center" width="75%" /></p>

<p>其中上图中顶层的三块又组成了 SSL Handshaking Protocols，在处理时有三种状态。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">empty state -------------------&gt; pending state ------------------&gt; current state

             Handshake Protocol                Change Cipher Spec</code></pre></figure>

<p>当完成握手后，客户端和服务端确定了加密、压缩和 MAC 算法及其参数，数据通过指定算法处理；而之前的所有操作都是明文传输的。</p>

<h3 id="关键技术">关键技术</h3>

<p>首先，在实现时加密算法是公开的，而私密性是通过密钥保证的。另外，为了实现上述的机制，需要一些比较常见的技术。</p>

<p>其中与密码学相关的内容，可以参考 <a href="/blog/encryption-introduce.html">加密算法简介</a> 。</p>

<h4 id="私钥交换-key-exchange-algorithms">私钥交换 Key Exchange Algorithms</h4>

<p>发送信息的时候，需要通过对称加密来加密数据，此时就涉及到了私钥的交换，通常使用的算法包括了 Diffie-Hellman、RSA 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Bob&#39;s Public Key + Alice&#39;s Secret Key     Bob&#39;s Secret Key (Decrypt)
          |-----&gt;--------&gt;-------&gt;--------&gt;------&gt;-----|
                                              Get Alice&#39;s Secret Key</code></pre></figure>

<p>对于 RSA 来说，所有人都知道 Bob 的公钥，只需要将 Alice 的私钥通过公钥进行加密即可，该信息只有通过 Bob 的私钥才可以解密。</p>

<p>当然，在实际使用时还会增加其它的随机值。</p>

<h4 id="数字证书-digital-certificates">数字证书 Digital Certificates</h4>

<p>到此，需要通过一种方法获取到 Bob 的公钥，这就是通过数字证书获取的。数字证书中除了包括了公钥信息，还有与 Bob 相关的信息。</p>

<h4 id="数字证书认证机构-certification-authority-ca">数字证书认证机构 Certification Authority, CA</h4>

<p>接下来解决的是，如何确认数字证书的拥有着就像它声明的那样，为此引入了 Public Key Infrastructure, PKI ，包括一些与数字证书相关的软件、硬件等信息。</p>

<p>CA 就是一个三方机构，用来证明 Bob 确实就是 Bob 。</p>

<p>CA 认证分为三类：DV (domain validation)，OV (organization validation)，EV (extended validation)，证书申请难度从前往后递增，貌似 EV 这种不仅仅是有钱就可以申请的。</p>

<h4 id="数字签名-消息完整性">数字签名 消息完整性</h4>

<p>实际上有篇很不错的文章 <a href="http://www.youdzone.com/signature.html">What is a Digital Signature?</a> ，也可以参考 <a href="/reference/linux/What is a Digital Signature.mht">本地文章</a>，在此就不做过多介绍了。</p>

<h2 id="执行流程">执行流程</h2>

<p>我们直接从 WireShark 的官网网站上下载了一个 HTTPS 的示例，详细的下载地址可以参考文章末尾的参考内容。</p>

<!--

<figure class="highlight"><pre><code class="language-text" data-lang="text">     Client                 |   Server
                            |
                            |
                            |
                            |
+----------------------     |      -------------------
|=== Client Hello ===       |
                            |
                            |
                            |
                            |
                            |
                            |
                            |
                            |
                            |
                            |
                            |</code></pre></figure>

-->

<p>首先，是正常的 TCP 开始的三次握手连接，在此就不做过多的介绍了；完成之后才会开始 SSL 之间的沟通，这也是接下来重点介绍的内容。</p>

<p>在进行正常的数据传输之前，会有一个协商的过程，包括了协议的版本、会话ID、加密算法 (含有一套，后面介绍)、压缩方法；另外，在该阶段，还会相互交换服务端和客户端的随机值。</p>

<h3 id="1-client-hello">1. Client Hello</h3>

<p>示例中有两个会话的数据传输，分别是 SSLv2.0 以及 SSLv3.0，现在一般使用的是 v3.0，其中 v2.0 在该阶段会使用 challenge 机制，不过不太清楚详细内容，在 <a href="https://tools.ietf.org/rfc/rfc6101.txt">RFC-6101</a> 中略有介绍。</p>

<p>这里，仅介绍 v3.0 的内容。</p>

<p><img src="/images/linux/https-protocol-00.png" alt="https" title="https" class="pull-center" width="80%" /></p>

<p>在上述的图片中，包括了协议的版本信息，还有些比较重要的信息。</p>

<h5 id="随机数">随机数</h5>

<p>开始的四个字节以 Unix 时间格式记录了客户端 UTC 时间 (从1970年1月1日开始到当前时刻所经历的秒数)；接着后面有 28 字节的随机数，在后面的过程中我们会用到这个 <strong>客户端的随机数</strong> 。</p>

<h5 id="session-id-sid">Session ID, SID</h5>

<p>一般来说，第一次建立连接的时候 ID 是一个空值 (NULL)，当然也有可能会重用之前的会话，从而避免一个完整的握手过程。</p>

<h5 id="密文族-cipher-suites">密文族 (Cipher Suites)</h5>

<p>密文族是浏览器所支持的加密算法的清单，整个密文族有 20 种。</p>

<p>另外，有是还会有 Server_name 的扩展，能告诉服务器浏览器当前尝试访问的域名。</p>

<h3 id="2-server-hello">2. Server Hello</h3>

<p>在服务端回复的报文中，包含了三部分子信息：Server Hello、Certificate、Server Hello Done，实际上这是第一个会话的内容，如果复用会话，这里的报文内容会有所区别。</p>

<p><img src="/images/linux/https-protocol-01.png" alt="https" title="https" class="pull-center" width="80%" /></p>

<h4 id="server-hello">Server Hello</h4>

<p>在服务器发送的 Hello 握手报文中，同样包括了 4 字节的 UTC 时间戳以及 28 字节随机数；还有会话 ID 以及服务器最终选择的加密族。</p>

<p>可以看到，在一堆加密族中，最终选择的是 TLS_RSA_WITH_3DES_EDE_CBC_SHA，这也就意味着将会使用 RSA 公钥加密算法来区分证书签名和交换密钥；通过 3DES_EDE_CBC 加密算法来加密数据；利用 SHA 来做 hash 校验信息。</p>

<h4 id="certificate">Certificate</h4>

<p>也就是证书信息，该证书允许客户端在服务器上进行认证，证书的内容是明文保存的，可以通过浏览器查看，当然也包括了 WireShark 。</p>

<p><img src="/images/linux/https-protocol-02.png" alt="https" title="https" class="pull-center" width="67%" /></p>

<h4 id="server-hello-done">Server Hello Done</h4>

<p>这是一个零字节信息，用于告诉客户端整个协商过程已经结束，并且表明服务器不会再向客户端询问证书。</p>

<h3 id="3-校验证书">3. 校验证书</h3>

<p>此时，浏览器已经获取了服务器的证书，浏览器会通过证书确认网站是否受信，它会检查支持的域名、是否在证书有效时间范围内、确认证书所携带的公共密钥已被授权用于交换密钥。</p>

<p>为什么我们要信任这个证书？证书中所包含的签名是一串非常长的大端格式的数字：</p>

<p><img src="/images/linux/https-protocol-03.png" alt="https" title="https" class="pull-center" width="67%" /></p>

<p>在验证证书的有效性的时候，会逐级去寻找签发者的证书，直至根证书为结束，然后通过公钥一级一级验证数字签名的正确性。</p>

<h3 id="4-生成-premaster">4. 生成 Premaster</h3>

<p>当客户端通过了证书校验之后，会生成 48 字节的随机数，称为 Pre-master Secret 。如前所述，最终选择 RSA 来交换密钥，此时 pre-master 会用来计算 master secret 以及 key block 。</p>

<p><img src="/images/linux/https-protocol-04.png" alt="https" title="https" class="pull-center" width="67%" /></p>

<p>其中，pre-master secret 在发送时，会通过服务器的公钥进行加密。</p>

<p>另外，该报文中还包括了 “Change Cipher Spec” ，用来告知服务器，后面客户端发送的信息，都是按照之前协商好的算法进行。</p>

<p>而最后的 “Encrypted Handshake Message” 则包含了之前通讯中的 hash 和 MAC 信息。</p>

<h3 id="5-计算-master-secret-以及-key-block">5. 计算 Master Secret 以及 Key Block</h3>

<p>到此为止，服务端和客户端都知道了 Pre-master secret (48Bytes) + Client.random (28Bytes) + Server.random (28Bytes)，接下来就会按照协议，通过如下的算法生成 Master Secret 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">master_secret = PRF(pre_master_secret, &quot;master secret&quot;, ClientHello.random + ServerHello.random)</code></pre></figure>

<p>其中 PRF 是一个随机函数，定义如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">PRF(secret, label, seed) = P_MD5(S1, label + seed) XOR P_SHA-1(S2, label + seed)</code></pre></figure>

<p>在计算 Master Secret 的同时，服务器和客户端还会同时计算 Key Block ，算法如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">key_block = PRF(SecurityParameters.master_secret, &quot;key expansion&quot;,
    SecurityParameters.server_random + SecurityParameters.client_random);</code></pre></figure>

<p>Key Block 会被分为不同的 Blocks。</p>

<p><img src="/images/linux/https-key-blocks.png" alt="https" title="https" class="pull-center" /></p>

<p>其中，MAC Key 用来对数据进行验证的，Encryption Key 用来对数据进行加解密的会话密钥。</p>

<h3 id="6-服务端确认加密">6. 服务端确认加密</h3>

<p>服务端在收到客户端发送的 “Encrypted Message” 消息之后，会对其中的值进行校验，如果校验失败则会关闭连接。</p>

<p><img src="/images/linux/https-protocol-05.png" alt="https" title="https" class="pull-center" width="67%" /></p>

<p>校验成功则会与客户端一样发送 “Change Cipher Spec” 。</p>

<h3 id="7-发送加密信息">7. 发送加密信息</h3>

<p>到此为止，双方就可以愉快的发送加密信息了。</p>

<h3 id="8-杂项">8. 杂项</h3>

<p>记录下，杂七杂八的东西。</p>

<h4 id="encrypted-handshake-message">Encrypted Handshake Message</h4>

<p>实际上，在应用数据在传输之前，也就是在握手中的加密数据，要附加上 MAC Secret，然后再对这个数据包使用 write encryption key 进行加密。</p>

<p>在服务端收到密文之后，使用 Client write encryption key 进行解密，客户端收到服务端的数据之后使用 Server write encryption key 进行解密，然后使用各自的 write MAC key 对数据的完整性包括是否被串改进行验证。</p>

<h4 id="premaster-secret">Premaster Secret</h4>

<p>其长度为 48 个字节，前 2 个字节是协议版本号，剩下的 46 个字节填充一个随机数。</p>

<!--
PreMaster secret前两个字节是TLS的版本号，这是一个比较重要的用来核对握手数据的版本号，因为在Client Hello阶段，客户端会发送一份加密套件列表和当前支持的SSL/TLS的版本号给服务端，而且是使用明文传送的，如果握手的数据包被破解之后，攻击者很有可能串改数据包，选择一个安全性较低的加密套件和版本给服务端，从而对数据进行破解。所以，服务端需要对密文中解密出来对的PreMaster版本号跟之前Client Hello阶段的版本号进行对比，如果版本号变低，则说明被串改，则立即停止发送任何消息。
-->

<p>需要注意，前两个随机数都是明文传输的，窃听者是可以轻易获取到的，只有最后一个 PreMaster Secret 是加密传输的，只有拥有服务器私钥才能解密，一旦 PreMaster Secret 泄露，那么本次通信就就完全可被破解了。</p>

<h4 id="关于随机数">关于随机数</h4>

<p>如上，是通过三个随机数来生成最终的 Master Secret 的，SSL 协议不信任每个主机都能生成完全随机的随机数，所以这里需要服务器和客户端共生成 3 个随机数，每增加一个自由度，随机性就会相应增加。</p>

<h2 id="其它">其它</h2>

<h3 id="cipher-suite">Cipher Suite</h3>

<p>在协商阶段，服务器和客户端会协商使用的加密协议，如下是客户端提供的协议，服务端会选择相应的协议。</p>

<p><img src="/images/linux/https-cipher-specs.png" alt="https cipher specs" title="https cipher specs" class="pull-center" /></p>

<p>在示例中，会使用 TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)，其中每组包含了四部分信息，分别是：</p>

<ul>
  <li>密钥交换算法。客户端与服务器之间在握手的过程中如何认证，用到的算法包括 RSA、Diffie-Hellman、ECDH、PSK 等；</li>
  <li>加密算法。加密消息流，该名称后通常会带有两个数字，分别为密钥的长度和初始向量的长度；如果是一个数则表示相同，如 DES、RC2、RC4、AES 等；</li>
  <li>报文认证信息码 (MAC) 算法。用于创建报文摘要，防止被篡改，从而确保消息的完整性，如 MD5、SHA 等。</li>
</ul>

<p>对于上述的协议，实际使用的算法如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">TLS_RSA_WITH_AES_256_CBC_SHA (0x0035)
   基于 TLS 协议；
   使用 RSA 作为密钥交换算法；
   加密算法是 AES，其中密钥和初始向量的长度都是 256；
   MAC 算法，在这里就是哈希算法是 SHA。</code></pre></figure>

<h2 id="ca-证书详情">CA 证书详情</h2>

<p>假设你要通过支付宝转笔钱，首先要根服务器建立连接，浏览器收到了服务器发送的证书，其中包括了服务器的公钥，那么怎么证明收到的公钥就是该服务器的呢？</p>

<p><img src="/images/linux/https-ca-intro.png" alt="https" title="https" class="pull-center" width="50%" /></p>

<p>如果无法解决如上的问题，那么就可能会导致中间人攻击，以及信息抵赖，这时，CA 就出场了。</p>

<p>解决上述身份验证问题的关键是确保获取的公钥途径是合法的，能够验证服务器的身份信息，为此需要引入权威的第三方机构 (Certificated Authority, CA)，一个第三方可信证书颁发机构，具有权威性、公正性的机构。</p>

<p>CA 负责核实公钥的拥有者的信息，并颁发认证 “证书”，同时能够为使用者提供证书验证服务，即 PKI 体系。</p>

<h3 id="证书内容">证书内容</h3>

<p>证书包含的内容可以概述为三部分，用户的信息、用户的公钥、还有 CA 中心对该证书里面的信息的签名。</p>

<p><img src="/images/linux/https-ca-github.png" alt="https" title="https" class="pull-center" width="60%" /></p>

<p>如上是 Firfox 显示的 Github 中的证书，该页面显示了证书中比较重要的内容，而详细的信息可以从 Details 标签页中查看。</p>

<p>下面是详细内容：</p>

<ul>
  <li>
    <p>版本号(Version)，用来指明 X.509 证书的格式版本，包括了 V1、V2、V3；</p>
  </li>
  <li>
    <p>序列号(Serial Number)，CA 分配给证书的唯一标识符，用于证书被取消时；</p>
  </li>
  <li>
    <p>签名算法(Signature Algorithm)，CA 签发证书使用的签名算法，如 sha256WithRSAEncryption；</p>
  </li>
  <li>
    <p>签发机构名(Issuer)，标识签发证书的 CA 的 X.500 DN(DN-Distinguished Name) 名字，包括了国家(C)、省市(ST)、地区(L)、组织机构(O)、单位部门(OU)、通用名(CN)、邮箱地址；</p>
  </li>
  <li>
    <p>有效期(Validity)，指定证书的有效期，包括了开始和失效日期；</p>
  </li>
  <li>
    <p>证书用户名(Subject)，使用该证书的机构，包含的内容与签发机构名相同；</p>
  </li>
  <li>
    <p>证书持有者公钥信息(Subject Public Key Info)，包括了公钥值以及公钥使用的算法；</p>
  </li>
  <li>
    <p>扩展项(extension)，V3 证书对 V2 的扩展项，以使证书能够附带额外信息；</p>
  </li>
</ul>

<h3 id="证书链">证书链</h3>

<p>.减少根证书结构的管理工作量，可以更高效的进行证书的审核与签发;</p>

<p>b.根证书一般内置在客户端中，私钥一般离线存储，一旦私钥泄露，则吊销过程非常困难，无法及时补救;</p>

<p>c.中间证书结构的私钥泄露，则可以快速在线吊销，并重新为用户签发新的证书;</p>

<p>d.证书链四级以内一般不会对 HTTPS 的性能造成明显影响。</p>

<p>CA 机构能够签发证书，同样也存在机制宣布以往签发的证书无效，也就是吊销证书。证书使用者不合法，CA 需要废弃该证书；或者私钥丢失，使用者申请让证书无效。</p>

<h3 id="提交验证流程">提交验证流程</h3>

<p>首先，介绍下服务器的开发者是如何向 CA 申请证书的。</p>

<p>服务器的开发者向 CA 提出申请，CA 在核实申请者的身份之后，会用自己的私钥对信息进行加密，也就是数字签名；服务器则将这份由 CA 颁发的公钥证书在握手阶段发送给客户端，证书就相当于是服务器的身份证。</p>

<p><img src="/images/linux/encrypt-digital-signature.jpg" alt="encrypt digital signature" title="encrypt digital signature" class="pull-center" width="60%" /></p>

<p>在验证证书的有效性的时候，会逐级去寻找签发者的证书，直至根证书为结束，然后通过公钥一级一级验证数字签名的正确性。</p>

<p><img src="/images/linux/https-client-verify.gif" alt="client verify" title="client verify" class="pull-center" width="60%" /></p>

<p>也就是说，无论如何，都需要有根证书才可以的，其中有些浏览器是使用的系统的，而有些是自己管理。</p>

<h3 id="自签名证书">自签名证书</h3>

<p>如上所述，Firefox 使用自己的证书管理器 (Certificates Manager)，并没有像 IE 和 Chrome 那样直接使用系统中的证书存储，所以，对于 Firefox 来说，需要将自签发的 SSL 证书导入受信任根证书。</p>

<p>对于 Firefox 来说，证书的管理在 Edit =&gt; Preferences =&gt; Advanced =&gt; Certificates 中，可以选择导入、导出、删除等操作。</p>

<h2 id="攻击">攻击</h2>

<p>Web 安全是一项系统工程，任何细微疏忽都可能导致整个安全壁垒土崩瓦解。</p>

<p>如上所述，虽然 HTTPS 提供了 内容加密、数据完整性、身份认证 三大安全保证；但是，也会受到非法根证书、服务端配置错误、SSL 库漏洞、私钥被盗等等风险的影响。</p>

<h3 id="man-in-the-middle">Man-in-the-middle</h3>

<p>也就是中间人攻击，能够与网络通讯两端分别创建连接，交换其收到的数据，使得通讯两端都认为自己直接与对方对话，事实上整个会话都被中间人所控制。</p>

<p>类似于一些抓包调试工具，基本都是通过创建本地 Proxy 服务，再修改浏览器 Proxy 设置来达到拦截流量的目的，它们的工作原理与中间人攻击一致，常见的有 Fiddler、Charles 和 Whistle。</p>

<p>在此主要讨论 HTTPS 中间人，简单示意如下：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Server &lt;---&gt; Local Proxy &lt;---&gt; Browser
         ^                 ^
       HTTPS(1)          HTTPS(2)</code></pre></figure>

<p>上述 HTTPS(1) 连接，是中间人冒充客户端与服务端建立的连接，由于 HTTPS 服务端一般不认证客户端身份，这一步通常没有问题。</p>

<p>对于 HTTPS(2) 连接来说，中间人想要冒充服务端，必须拥有对应域名的证书私钥，而攻击者要拿到私钥，只能通过这些手段：1）去网站服务器上拿；2）从 CA 处签发证书；3）自己签发证书。</p>

<p>要防范前两点，需要保障主机安全避免私钥被盗，避免攻击者重签证书；对于自签证书，需要防止在客户端添加内置根证书，如下是 Fiddler 工具添加的受信根证书。</p>

<p><img src="/images/linux/https-man-in-the-middle.png" alt="https root" title="https root" class="pull-center" width="60%" /></p>

<h3 id="rsa-private-key">RSA Private Key</h3>

<p>在参考中有介绍如何通过 FireFox + Wireshark 抓包直接读取并分析网卡数据，这里的示例实际提供了私钥，所以看看如何通过私钥来解密这个网站的加密流量。</p>

<p>打开 Wireshark 的 SSL 协议设置，也就是 Edit =&gt; Preferences =&gt; Protocols =&gt; SSL，把 IP、端口、协议和证书私钥都配上，其中私钥必须存为 PEM 格式。</p>

<p><img src="/images/linux/https-protocol-10.png" alt="https" title="https" class="pull-center" width="80%" /></p>

<p>然后就可以看到，密文已经被解密了，只能解密 HTTP-1，而不能解密 HTTP-2。</p>

<h2 id="参考">参考</h2>

<p>一篇介绍 https 不错的文章，可以参考中文版 <a href="http://blog.jobbole.com/48369/">HTTPS连接的前几毫秒发生了什么</a>，或者英文版 <a href="http://www.moserware.com/2009/06/first-few-milliseconds-of-https.html">The First Few Milliseconds of an HTTPS Connection</a>，或者 <a href="/reference/linux/The First Few Milliseconds of an HTTPS Connection.mht">本地保存的版本</a>；细节内容也可以参考协议的实现 <a href="https://tools.ietf.org/rfc/rfc6101.txt">SSL V3.0</a> 。</p>

<p>其中的示例是从 <a href="https://wiki.wireshark.org/SampleCaptures">WireShark SampleCaptures</a> 上下载的，也就是 <a href="https://wiki.wireshark.org/SampleCaptures?action=AttachFile&amp;do=get&amp;target=snakeoil2_070531.tgz">SSL with decryption keys</a>，也可以从 <a href="/reference/linux/ssl-example.tar.bz2">本地</a> 下载。</p>

<h4 id="其它-1">其它</h4>

<p>一些常见的技巧可以参考：</p>

<ul>
  <li>
    <p><a href="http://blog.jobbole.com/95106/">使用 Wireshark 调试 HTTP/2 流量</a>，通过 FireFox 导出密钥，可以参考 <a href="/reference/linux/Wireshark_HTTP_2.mht">本地文档</a> 。</p>
  </li>
  <li>
    <p>网站检测的链接 <a href="https://www.ssllabs.com/">SSL LABS</a>、<a href="https://www.sslshopper.com/ssl-checker.html">SSL Shopper</a>、<a href="https://www.chinassl.net/ssltools/ssl-checker.html">China SSL</a> 。</p>
  </li>
</ul>

<!--

openssl s_client -connect 10.44.32.91~94\81~84:443

一个关于SSL不错的Blog
https://blog.ivanristic.com/SSL_Threat_Model.png
HTTPS的七个误解（译文）
http://www.ruanyifeng.com/blog/2011/02/seven_myths_about_https.html
浅谈三种解密 HTTPS 流量的方法
http://www.2cto.com/article/201603/496004.html
很详细介绍的SSL
https://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/
TLS/SSL 高级进阶
https://segmentfault.com/a/1190000007283514
HTTPS 理论详解与实践
https://segmentfault.com/a/1190000004985253

https://www.wosign.com/faq/faq2016-0309-04.htm
http://blog.jobbole.com/86660/
http://www.itrus.cn/service_13html
http://resources.infosecinstitute.com/cryptography-101-with-ssl/
-->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/linux-timer-functions.html" title="Linux 时间函数">&larr; Older</a></li> 
         <li class="next"><a href="/post/gimp_init.html" title="GIMP">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1402070400',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/https-introduce.html" data-title="HTTPS 协议详解" data-url="/post/https-introduce.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
