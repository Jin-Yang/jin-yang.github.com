<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>你所不知道的 Linux 定时任务|JinYang's Blog</title>
  <meta name="keywords" content="linux,crontab,cron,定时任务">
  <meta name="description" content="在 Linux 中，我们经常使用 cron 执行一些定时任务，只需要配置一下时间，它就可以周期的执行一些任务。不知道你是否清楚它的详细用法？是否发现，脚本单独运行时是好好的，放到 cron 任务里却挂了！！！一个部署了 crond 的服务器，系统资源却被莫名其妙的被占满了，Why？？？">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>你所不知道的 Linux 定时任务</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2015-07-28 Tuesday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  linux  
      
    </div>
  </div>
  <hr>
  <p>在 Linux 中，我们经常使用 cron 执行一些定时任务，只需要配置一下时间，它就可以周期的执行一些任务。</p>

<p>不知道你是否清楚它的详细用法？是否发现，脚本单独运行时是好好的，放到 cron 任务里却挂了！！！一个部署了 crond 的服务器，系统资源却被莫名其妙的被占满了，Why？？？</p>

<!-- more -->

<h2 id="数学挂钟">数学挂钟</h2>

<p>在讨论 cron 前，首先看一个很有意思的数学挂钟，这个时钟通过各种符号计算公式表示 1~12 个数字。SO, JUST FOR FUN。</p>

<p><img src="/images/linux/cronie-mathematic-clock.jpg" alt="mathematic-clock" title="数字钟" class="pull-center" width="300" /></p>

<h4 id="1-勒让德-legendre-常数">1. 勒让德 (Legendre) 常数</h4>

<p>其值为 1 ，可以参考 <a href="https://zh.wikipedia.org/zh/%E5%8B%92%E8%AE%A9%E5%BE%B7%E5%B8%B8%E6%95%B0" title="勒让德常数">维基百科</a>，大致摘抄如下：勒让德在研究素数的分布情况时，发现 pi(x) 满足以下等式：</p>

<p><img src="/images/linux/cronie-legendre.png" alt="legendre-const" title="勒让德常数" class="pull-center" /></p>

<p>其中 B 是一个常数，称为勒让德常数，他估计 B 大约为 1.08366，但不管它的值是什么，只要它存在，就证明了素数定理。该值经过高斯等大佬的努力，最后被数学家 Charles Jean 证明为 1。</p>

<h4 id="2-无穷递减等比数列">2. 无穷递减等比数列</h4>

<p>该数列的求和后值为 2 ，其首项为 1，公比为 1/2，也就是 1 + 1/2 + 1/4 + 1/8 + … 1/(2^i)，当 i 趋于无穷大时，最终和为 2 。</p>

<h4 id="3-在-xmlhtml-中用于标识">3. 在 XML、HTML 中用于标识</h4>

<p>简单来说，也就是说若将上述代码放在浏览器里，显示的就是 3 。其中，&amp;# 后面接十进制字符，&amp;#x 后面接十六进制字符，十六进制的 33 就对应 ASCII 中的 ‘3’。</p>

<p>可以简单测试下，其中后面就是 <code>&amp;#x33;</code> 对应的值 3 。</p>

<h4 id="4-同余问题">4. 同余问题</h4>

<p>可以参考 <a href="https://en.wikipedia.org/wiki/Modular_multiplicative_inverse">Modular Multiplicative Inverse</a>，令 x≡2<sup>-1</sup>(mod 7)，2x≡1(mod 7)，则 x=4 。</p>

<h4 id="5-黄金分割">5. 黄金分割</h4>

<p>其中 φ=(√5+1)/2 是黄金分割数，那么将其带进表达式就得 5 。</p>

<h4 id="6-阶乘">6. 阶乘</h4>

<p>3 的阶乘，3!=3x2x1=6 。</p>

<h4 id="7-循环小数">7. 循环小数</h4>

<p>用于表示 6.9999… 其中 9 的头上一横，表示循环节是 9 。可以按照无穷递减等比数列查看，该值等于：6.9999… = 6 + 0.9 + 0.09 + 0.009 + 0.0009 + … = 7 。</p>

<h4 id="8-二进制">8. 二进制</h4>

<p>通过二进制表示的 8 ，其中黑色表示 1 ，其它表示 0 ，也即二进制 1000 。</p>

<h4 id="9-四进值">9. 四进值</h4>

<p>以四进制表示的 9 ，21(四进制) = 2 * 4 + 1 = 9 。</p>

<h4 id="10-组合">10. 组合</h4>

<p>5 取 2 的组合数，也即 5!/(2!*3!) = 10 。</p>

<h4 id="11-十六进制">11. 十六进制</h4>

<p>其中 A 是 10，B 是 11，C 是 12 。</p>

<h4 id="12-立方根">12. 立方根</h4>

<p>这个很简单，12<sup>3</sup> = 1728，也就是 1728 的立方根就是 12 。</p>

<p>OK，接下来进入正题。</p>

<h2 id="简介">简介</h2>

<p>在 Linux 平台上如果需要实现定时或者周期执行某一个任务，可以通过编写 cron 脚本来实现。Linux 默认会在开机时启动 crond 进程，该进程负责读取调度任务并执行，用户只需要将相应的调度脚本写入 cron 的调度配置文件中。</p>

<p>另外，需要注意的是，cron 采用的是分钟级的调度，如果要更高精度的，只能用其它方法。</p>

<p>而且，<strong>每次执行时都是并发执行</strong>，而非串行。</p>

<h3 id="安装启动">安装、启动</h3>

<p>在很多的发行版本中，cron 是默认安装的，包括了 crond+crontab 两个主要命令。前者是后台任务，用于调度执行；后者用来编译、查看、管理定时任务。</p>

<p>在 CentOS 7 中，该服务是默认安装的，如果没有，则可以安装 cronie 包，然后通过如下命令启动 crond 服务。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># systemctl start crond</code></pre></figure>

<p>其它的相关操作与 systemctl 指令相同，如 status、restart、stop 等操作。</p>

<h3 id="相关配置文件">相关配置文件</h3>

<p>与 cron 相关的有如下的几个文件，其中前几个是调度相关的文件：</p>

<ol>
  <li>/etc/crontab<br />全局配置文件；同时每个用户有自己的 cron 配置文件，这些文件在 <code>/var/spool/cron</code> 目录下。</li>
  <li>/etc/cron.deny /etc/cron.allow<br />分别表示不能/能使用 crontab 命令的用户。如果两个文件同时存在，那么 <code>/etc/cron.allow</code> 优先；如果两个文件都不存在，那么只有超级用户可以安排作业。</li>
  <li>/etc/cron.d/ /etc/{cron.daily,cron.hourly,cron.monthly,cron.weekly}<br />保存的配置文件，后面详解。</li>
  <li>/var/log/cron<br />默认的日志文件。如果配置使用了 syslog，那么日志会发送到 <code>/var/log/messages</code> 文件中。</li>
</ol>

<p>对于 CentOS 7 来说，有 <code>cron.deny</code> 文件，但是为空，而且没有 <code>cron.allow</code> 文件，这也就意味着所有的用户都可以创建 cron 任务。</p>

<h3 id="配置定时任务">配置定时任务</h3>

<p>定时任务包括了两类：</p>

<ul>
  <li>
    <p>系统级任务 (/etc/crontab)。需要 root 权限，其中第六部分指定了用户名，也就是说能以任意用户执行命令；通常用于系统服务或者一些重要的任务。</p>
  </li>
  <li>
    <p>用户级任务 (/var/spool/cron/)。注意，此时的第六部分为用户需要执行的命令，而且只能以创建任务的用户身份执行。</p>
  </li>
</ul>

<p>如果用的任务不是以 hourly monthly weekly 方式执行，则可以将相应的 crontab 写入到 crontab 或 cron.d 目录中。如，可以在 cron.d 目录下新建脚本 echo-date.sh。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed</code></pre></figure>

<p>通常来说，我们是通过 crontab 命令来管理定时任务，常用的参数有：</p>

<ul>
  <li>-e，编辑 crontab 任务，默认使用当前用户。</li>
  <li>-l，列出用户所有的定时任务；注意，不会显示 /etc 目录下的配置任务。</li>
  <li>-r，删除所有的定时任务。</li>
  <li>-u，指定用户名。</li>
</ul>

<p>最常见的是通过 <code>crontab -e</code> 编辑 crontab 任务，此时会通过环境变量 <code>$EDITOR</code> 定义的值，调用相应的编辑器，例如 <code>export EDITOR="/usr/bin/vim"</code>，通过 vim 进行编辑。此时会在 <code>/tmp</code> 目录下生成一个临时文件，当编辑完成后替换掉 <code>/var/spool/cron/</code> 中对应用户的文件。</p>

<p>另外，也可以编辑一个临时文件如 <code>contabs.tmp</code>，编辑后通过 <code>contab contabs.tmp</code> 命令导入新的配置。一般不建议直接修改 <code>/etc/</code> 下的相关配置文件。</p>

<p>通常来说，需要检查 <code>/etc/crontab</code> 文件、<code>/etc/cron.*/</code> 目录，以及 <code>/var/spool/cron/</code> 目录。</p>

<h2 id="anacron">Anacron</h2>

<p>其实在官方的源码中，还包括了一个 anacron 指令，而 CentOS 7 中是包含在 anaconda-core 包中的；所以，如果使用 anacron 命令，必须安装该包。</p>

<h3 id="简介-1">简介</h3>

<p>像服务器来说，Linux 主机通常是 24 全天全年的处于开机状态，此时只需要 atd 与 crond 这两个服务即可；而对于像我们自己的电脑，经常关机，那么我们就需要 anacron 的帮助了。</p>

<p>anacron 并不能取代 cron，而是以天为单位或者是在启动后立刻进行 anacron 的动作。它会去侦测停机期间该执行但未执行的 crontab 任务，并将该任务运行一遍后，anacron 就会自动停止。</p>

<p>通过 anacron 命令，我们可以选择串行执行（默认）、强制执行（不判断时间戳）、立即执行未执行任务（不延迟等待）等操作。其配置文件是 <code>/etc/anacrontab</code>，每次执行完成会在 <code>/var/spool/anacron/</code> 目录下保存运行的时间点。</p>

<h3 id="任务配置">任务配置</h3>

<figure class="highlight"><pre><code class="language-text" data-lang="text">SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
# the maximal random delay added to the base delay of the jobs
RANDOM_DELAY=45
# the jobs will be started during the following hours only
START_HOURS_RANGE=3-22

#period in days   delay in minutes   job-identifier   command
1                 5                  cron.daily       nice run-parts /etc/cron.daily
7                 25                 cron.weekly      nice run-parts /etc/cron.weekly
@monthly          45                 cron.monthly     nice run-parts /etc/cron.monthly</code></pre></figure>

<p>其中开头定义了一些环境变量等信息，而配置项的含义如下：</p>

<ol>
  <li>period in days：指定指令执行的周期，即指定任务在多少天内执行一次，也可以使用宏定义，如 <code>@day</code>、<code>@weekly</code>、<code>@monthly</code>。</li>
  <li>delay in minutes：当命令已经就绪后，并非立即执行，而是要延迟等待一段时间。</li>
  <li>job-identifier：每次启动时都会在 <code>/var/spool/anacron</code> 里面建立一个以 job-identifier 为文件名的文件，记录着任务完成的时间。</li>
  <li>command：要运行的命令，其中 run-parts 用来运行整个目录的可执行程序。</li>
</ol>

<h3 id="命令详解">命令详解</h3>

<p>实际上，anacron 也是一个 cron 任务，可以通过 <code>ls /etc/cron*/*anacron</code> 查看。通常是通过 <code>anacron -s</code> 执行，以 <code>anacron -s cron.daily</code> 为例，会有如下的步骤：</p>

<ol>
  <li>由配置文件 <code>/etc/anacrontab</code> 解析到 <code>cron.daily</code> 这项工作名称的执行周期为一天。</li>
  <li>从 <code>/var/spool/anacron/cron.daily</code> 取出最近一次运行 anacron 的时间戳。</li>
  <li>把取出的时间戳与当前的时间戳相比较，如果差异超过了一天，那么就准备进行命令。</li>
  <li>若准备执行命令，根据 <code>/etc/anacrontab</code> 的配置，计算延迟的时间。</li>
  <li>延迟时间后，开始运行后续命令，也就是 <code>run-parts /etc/cron.daily</code> 这串命令。</li>
  <li>运行完毕后，anacron 程序结束。</li>
</ol>

<p>另外，需要注意的是，命令执行通常为串行执行。</p>

<h2 id="示例">示例</h2>

<p>在配置 crontab 任务时，有几个特殊的符号：A) <code>"*"</code> 所有的取值范围内的数字；B) <code>"/"</code> 每的意思，如 <code>"*/5"</code> 表示每 5 个单位；C) <code>"-"</code> 从某个数字到某个数字；D) <code>","</code> 用来分开几个离散的数字。</p>

<p>以下举几个例子说明问题：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">*/10 * * * *     echo &quot;Ten minutes ago.&quot; &gt;&gt; /tmp/foo.txt    // 每十分钟执行一次
0 6 * * *        echo &quot;Good morning.&quot; &gt;&gt; /tmp/foo.txt       // 每天早上6点
0 */2 * * *      echo &quot;Have a break now.&quot; &gt;&gt; /tmp/foo.txt   // 每两个小时
45 4 1,10,22 * * echo &quot;Restart server.&quot; &gt;&gt; /tmp/foo.txt     // 每月1、10、22日的4:45
0 23-7/2,8 * * * echo &quot;Have a good dream.&quot; &gt;&gt; /tmp/foo.txt  // 晚上11点到早上8点之间每两个小时，早上八点
0 11 4 * 1-3     echo &quot;Just kidding.&quot; &gt;&gt; /tmp/foo.txt       // 每月4号和每周的周一到周三的早上11点
45 11 * * 0,6    echo &quot;Have a good lunch.&quot; &gt;&gt; /tmp/foo.txt  // 每周六、周日的11点45分
0 9 * * 1-5      echo &quot;Work hard.&quot; &gt;&gt; /tmp/foo.txt          // 从周一到周五的9点
2 8-16/3 * * *   echo &quot;Some examples.&quot; &gt;&gt; /tmp/foo.txt      // 8:02、11:02、14:02执行

0,30 18-23 * * *    echo &quot;Same.&quot; &gt;&gt; /tmp/foo.txt            // 每天18:00到23:00之间每隔30分钟
0-59/30 18-23 * * * echo &quot;Same.&quot; &gt;&gt; /tmp/foo.txt            // 同上
*/30 18-23 * * *    echo &quot;Same.&quot; &gt;&gt; /tmp/foo.txt            // 同上</code></pre></figure>

<!--
at -f test-cron.sh -v 10:25    // -f指定脚本文件，-v指定运行时间
-->

<p>另外，需要注意的几点：</p>

<ol>
  <li>可以在 crontab 的命令中使用环境变量，如：<code>*/1 * * * * echo $HOME</code> 。</li>
  <li>第三个域和第五个域是 “或” 操作。</li>
</ol>

<p>通常，使用 <code>crontab -e</code> 进行的配置是针对某个用户的，而编辑 <code>/etc/crontab</code> 是针对系统的任务。</p>

<h3 id="特殊用法">特殊用法</h3>

<p>除了上述的写法外，crontab 提供了一些简单的时间定义方法，如：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">@daily         echo &quot;Hi&quot; &gt;&gt; /tmp/foo.txt</code></pre></figure>

<p>除此之外还有如下类似的类型，可以通过 <code>man 5 crontab</code> 查看。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">@reboot    :    Run once after reboot.
@yearly    :    Run once a year, ie.  &quot;0 0 1 1 *&quot;.
@annually  :    Run once a year, ie.  &quot;0 0 1 1 *&quot;.
@monthly   :    Run once a month, ie. &quot;0 0 1 * *&quot;.
@weekly    :    Run once a week, ie.  &quot;0 0 * * 0&quot;.
@daily     :    Run once a day, ie.   &quot;0 0 * * *&quot;.
@hourly    :    Run once an hour, ie. &quot;0 * * * *&quot;.</code></pre></figure>

<!--
 SHELL=/bin/bash
 PATH=/sbin:/bin:/usr/sbin:/usr/bin
 MAILTO=root      //如果出现错误，或者有数据输出，数据作为邮件发给这个帐号
 HOME=/    //使用者运行的路径,这里是根目录

# run-parts
01 * * * * root run-parts /etc/cron.hourly //每小时执行/etc/cron.hourly内的脚本
02 4 * * * root run-parts /etc/cron.daily //每天执行/etc/cron.daily内的脚本
22 4 * * 0 root run-parts /etc/cron.weekly //每星期执行/etc/cron.weekly内的脚本
42 4 1 * * root run-parts /etc/cron.monthly //每月去执行/etc/cron.monthly内的脚本
大家注意"run-parts"这个参数了，如果去掉这个参数的话，后面就可以写要运行的某个脚本名，而不是文件夹名了。
-->

<h3 id="常用技巧">常用技巧</h3>

<p>可以通过如下命令查看所有用户的 cron 定时任务，注意需要使用 root 权限。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="k">for</span> user in <span class="k">$(</span>cut -f1 -d: /etc/passwd<span class="k">)</span><span class="p">;</span> <span class="k">do</span> <span class="nb">echo</span> <span class="s2">&quot;### Crontabs for $user ####&quot;</span><span class="p">;</span> crontab -u <span class="nv">$user</span> -l<span class="p">;</span> <span class="k">done</span></code></pre></figure>

<p>需要注意的是，上述脚本只能显示 user 的 crontabs，如果要查看所有的还需要解析 <code>/etc/crontab</code>、<code>/etc/crontab.d</code>、<code>/etc/cron.daily</code> 等配置文件中的任务。</p>

<h2 id="常见问题">常见问题</h2>

<p>简单记录在使用 crontab 时遇到的问题。</p>

<h3 id="-导致的问题">’%’ 导致的问题</h3>

<p>例如写个了一个 shell 脚本，其中参数中使用了 <code>'%'</code>，那么在 cron 任务中就可能会执行错误，或者与预期的不符。为简单起见只是将传入的参数保存在 <code>/tmp/foobar.log</code> 中，脚本文件为 <code>/tmp/foobar.sh</code>，其内容如下：</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">echo</span> <span class="nv">$1</span> &gt;&gt; /tmp/foobar.log</code></pre></figure>

<p>然后我们新建一个 cron 任务，内容如下：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">*/1 * * * * /tmp/foobar.sh &quot;`date &#39;+%Y-%m-%d %H:%M:%S&#39;`&quot; &gt; /dev/null 2&gt;&amp;1</code></pre></figure>

<p>正常来说在 <code>/tmp/foobar.log</code> 中会每隔 1 分钟打印一条日志，而实际上却没有。查看 <code>/var/log/cron</code> 日志可以发现，实际执行的命令是 <code>/tmp/foobar.sh `date +</code>，汗 ^_^””</p>

<p>实际上，在 cron 任务中，<code>'%'</code> 是有特殊意义的，在这里需要转义，通过 <code>man 5 crontab</code> 查看帮助，可以看到如下内容：</p>

<blockquote>
  <p>A “%” character in the command, unless escaped with a backslash (\), will be changed into newline characters, and all data after the first % will be sent to the command as standard input.</p>
</blockquote>

<p>也就是说，如果 % 没有通过 \ 转义，那么就会被替换成换行，上述命令的正确打开姿势是：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">*/1 * * * * /tmp/foobar.sh &quot;`date &#39;+\%Y-\%m-\%d \%H:\%M:\%S&#39;`&quot; &gt; /dev/null 2&gt;&amp;1</code></pre></figure>

<h3 id="输出字符引发的血案">输出字符引发的血案</h3>

<p>现象是，登陆一台公用的跳板机时，当尝试从个人帐号切换到公用帐号时发现报错，是由于进程数超过了最大限制 (ulimit -u)，然后通过 ps aux 发现有很多进程，其中比较多的是如下的两条命令：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">/usr/sbin/postdrop -r
/usr/sbin/sendmail -FCronDaemon -i -odi -oem -oi -t -f root</code></pre></figure>

<p>基本可以确定是邮件的发送服务导致的，那么是什么程序调用的呢？通过 pstree 发现，其父进程为 crond 。</p>

<p>然后，通过 <code>du -i</code> 查看，发现 <code>/var</code> 的 inode 数目使用了 <code>100%</code>，通过如下命令查看根目录下的文件数目，也就是大约每个子目录中 inode 的数目。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ for dir in `ls -1Ad /*`; do echo -e &quot;${dir} \t\t `find ${dir} | wc -l`&quot;; done</code></pre></figure>

<p>然后，可以逐层向下查找，最后可以发现是 <code>/var/spool/postfix/maildrop</code> 目录下有大量的文件。通过 file 命令查看是 data 类型，实际上该目录下的文件可以通过 strings 命令查看，其内容为 crond 发送的邮件。</p>

<p>大概定位到了原因，先恢复掉。kill 掉所有 postdrop、sendmail 进程，然后清空 maildrop 目录下的文件。此时如果直接通过 <code>rm * -f</code> 删除，会由于文件过多而报错，可以通过如下两种方式进行删除。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text"># find /tmp -type f -exec rm {} \;
# ls | xargs rm -vf</code></pre></figure>

<p>OK，环境已经恢复，那么具体是什么原因导致的呢？</p>

<p>查看 cronie 的源码可以发现，crond 会 fork 一个子进程去执行任务，而该进程有会再 fork 一个孙子进程执行真正的命令，代码的调用逻辑如下。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">main()                       # C入口函数
 |-job_runqueue()            # 执行队列中的命令
   |-do_command()            # 此时会fork一个子进程执行，主进程继续工作
     |-child_process()       # 再fork一个进程，通过execle执行shell命令
       |-execle()            # 执行真正的shell指令，在孙子进程中执行</code></pre></figure>

<p>在 <code>child_process()</code> 函数中通过 <code>fork()</code> 子进程前，会创建两个管道 (stdin+stdout) 用来与子进程通讯，分别表示输入和输出。默认情况下，crontab 会将命令执行的输出，通过邮件发送给用户。</p>

<p>而在查看 <code>/var/log/maillog</code> 日志发现，是由于 pickup 管道不存在，导致邮件一直在积压。</p>

<p>通常来说，我们不需要发送邮件，为了防止上述问题的发生，可以配置运行脚本输出为 <code>&gt;/dev/null 2&gt;&amp;1</code>，来避免 crontab 运行中有内容输出。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">0 * * * * /path/to/script.sh    &gt; /dev/null
0 * * * * /path/to/script.sh    &gt; /dev/null 2&gt;&amp;1
0 * * * * /path/to/command arg1 &gt; /dev/null 2&gt;&amp;1 || true</code></pre></figure>

<p>或者直接在 crontab 文件的顶部设置 MAILTO 变量为空，也就是 <code>MAILTO=""</code> 。</p>

<p>当然，如果有必要，可以将输出发送到指定邮箱，但是需要首先确保邮件服务是正常的，然后添加如下配置项：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">MAILTO=&quot;ooops@foobar.com&quot;
0 3 * * * echo &quot;Helloooo!&quot;</code></pre></figure>

<h2 id="参考">参考</h2>

<p>源码可以从 <a href="https://fedorahosted.org/cronie/">cronie project</a> 官方网站下载，相关的帮助可以查看 man 1 crontab (命令行语法相关)、man 5 crontab (配置文件相关)。</p>

<!-- images -->

<!-- URLs -->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/mysql-transaction_init.html" title="MySQL 事务处理">&larr; Older</a></li> 
         <li class="next"><a href="/post/mysql-replication-mmm_init.html" title="MySQL 高可用 MMM">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1438012800',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/details-about-cronie.html" data-title="你所不知道的 Linux 定时任务" data-url="/post/details-about-cronie.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
