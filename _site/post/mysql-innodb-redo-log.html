<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>InnoDB Redo Log|JinYang's Blog</title>
  <meta name="keywords" content="mysql,innodb,redo log,重做日志">
  <meta name="description" content="">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>InnoDB Redo Log</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2016-03-08 Tuesday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  mysql ,  database  
      
    </div>
  </div>
  <hr>
  <p>当事务需要修改某条记录时，会先记录到 redo log，在此介绍下其实现。</p>

<!-- more -->

<h2 id="简介">简介</h2>

<p>InnoDB 有 Buffer Pool 也就是数据库的页面缓存，对数据页的任何修改都会先在 BP 上修改，然后这样的页面将被标记为 dirty 并被放到专门的 flush list 上，后续将由 master thread 或专门的刷脏线程阶段性的将这些页面写入磁盘。</p>

<p>这样带来的好处是避免每次写操作都会导致大量的随机 IO，阶段性的刷脏可以将多次对页面的修改合并成一次 IO 操作，同时异步写入也降低了访问的时延。</p>

<p>然而，如果在脏页未刷入磁盘时，服务器或者进程非正常关闭，将会导致这些修改操作丢失，如果写入操作正在进行，甚至会由于损坏数据文件导致数据库不可用。</p>

<p>为了避免上述问题，InnoDB 会将所有对页面的修改操作写入一个特定的文件，也就是 redolog，并在数据库启动时从此文件进行恢复操作。这样推迟了 BP 页面的刷脏，提升了数据库的吞吐，有效的降低了访问时延；带来的问题是额外的写 redo log 操作的开销 (顺序 IO 速度较快)，以及数据库启动时恢复操作所需的时间。</p>

<p>接下来将结合 MySQL 代码看下 Log 文件的结构、生成过程以及数据库启动时的恢复流程。</p>

<h3 id="lsn">LSN</h3>

<p>LSN(Log Sequence Number，日志序列号，ib_uint64_t) 保存在 log_sys.lsn 中，在 log_init() 中初始化，初始值为 LOG_START_LSN(8192) 。改值实际上对应日志文件的偏移量，新的 LSN＝旧的LSN + 写入的日志大小，在调用日志写入函数时，LSN 就一直随着写入的日志长度增加。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">#define OS_FILE_LOG_BLOCK_SIZE      512
#define LOG_START_LSN       ((lsn_t) (16 * OS_FILE_LOG_BLOCK_SIZE))</code></pre></figure>

<p>日志通过 log_write_low()@log/log0log.c 函数写入。</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">log_write_low</span><span class="p">(</span><span class="n">byte</span><span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="n">ulint</span> <span class="n">str_len</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">log_t</span><span class="o">*</span> <span class="n">log</span> <span class="o">=</span> <span class="n">log_sys</span><span class="p">;</span>
<span class="nl">part_loop</span><span class="p">:</span>
    <span class="p">...</span> <span class="p">...</span>                                        <span class="c1">// 计算写入日志的长度</span>
    <span class="n">ut_memcpy</span><span class="p">(</span><span class="n">log</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">log</span><span class="o">-&gt;</span><span class="n">buf_free</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span> <span class="c1">// 将日志内容拷贝到log buffer</span>
    <span class="p">...</span> <span class="p">...</span>
    <span class="n">log</span><span class="o">-&gt;</span><span class="n">lsn</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>如上所述，LSN 是不会减小的，它是日志位置的唯一标记，在重做日志写入、checkpoint 构建和 PAGE 头里面都有 LSN。</p>

<p>例如当前重做日志的 LSN=2048，这时候调用 log_write_low() 写入一个长度为 700 的日志，2048 刚好是 4 个 block 长度，那么需要存储 700 长度的日志，需要两个 block(单个block只能存496个字节)，那么很容易得出新的 LSN 为。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">LSN=2048+700+2*LOG_BLOCK_HDR_SIZE(12)+LOG_BLOCK_TRL_SIZE(4)=2776</code></pre></figure>

<!--
lsn是联系dirty page、redo log record和redo log file的纽带，每个redo log record被拷贝到内存的log buffer时会产生一个相关联的lsn，而每个页面修改时会产生一个log record，从而每个数据库的page也会有一个相关联的lsn，这个lsn记录在每个page的header字段中。为了保证WAL（Write-Ahead-Logging）要求的逻辑，dirty page要求其关联lsn的log record已经被写入log file才允许执行flush操作。<br><br>

从上面的结构定义可以看出有很多LSN相关的定义，那么这些LSN直接的关系是怎么样的呢？理解这些LSN之间的关系对理解整个重做日志系统的运作机理会有极大的信心。以下各种LSN的解释：
<ul><li>
lsn<br>
当前log系统最后写入日志时的LSN。</li><br><li>

flush_lsn<br>
redo-log buffer最后一次数据刷盘数据末尾的LSN，作为下次刷盘的起始LSN。</li><br><li>

written_to_some_lsn<br>
单个日志组最后一次日志刷盘时的起始LSN。</li><br><li>

written_to_all_lsn<br>
所有日志组最后一次日志刷盘是的起始LSN。

 last_checkpoint_lsn        最后一次建立checkpoint日志数据起始的LSN

 next_checkpoint_lsn        下一次建立checkpoint的日志    数据起始的LSN,用log_buf_pool_get_oldest_modification获得的

 archived_lsn               最后一次归档日志数据起始的LSN
 next_archived_lsn          下一次归档日志数据的其实LSN
</li></ul>



b)        文件为顺序写入，当达到最后一个文件末尾时，会从第一个文件开始顺序复用。

c)        lsn: Log Sequence Number，是一个递增的整数。 Ib_logfile中的每次写入操作都包含至少1个log，每个log都带有一个lsn。在内存page修复过程中，只有大于page_lsn的log才会被使用。

d)        lsn的保存在全局变量log_sys中。递增数值等于每个log的实际内容长度。即如果新增的一个log长度是len，则log_sys->lsn += len.

e)        ib_logfile每次写入以512（OS_FILE_LOG_BLOCK_SIZE）字节为单位。实际写入函数 log_group_write_buf (log/log0log.c)

f)         每次写盘后是否flush，由参数innodb_flush_log_at_trx_commit控制。

在 innodb 中，维护了一个全局变量 struct log_struct log_sys ，
written_to_all_lsn
n表示实际已经写盘的lsn。需要这个值是因为并非每次生成log后就写盘。
flushed_to_disk_lsn
表示刷到磁盘的lsn。需要这个值是因为并非每次写盘后就flush。
buf
待写入的内容保存在buf中
buf_size
buf的大小。由配置中innodb_log_buffer_size决定，实际大小为innodb_log_buffer_size /16k * 16k。
buf_next_to_write
buf中下一个要写入磁盘的位置
buf_free
buf中实际内容的最后位置。当buf_free> buf_next_to_write时，说明内存中还有数据未写盘。



log 采用循环写法，
有三种情况――overflow， checkpoint和commit――可以导致写盘操作
如果data buffer满了，InnoDB将最近使用的buffer写入到数据库中，但是不可能足够的快。这种情况下，页头的LSN就起作用了。第一，InnoDB检查它的LSN是否比log文件中最近的log记录的LSN大，只有当log赶上了data的时候，才会将数据写到磁盘。换句话说，数据页不会写盘，直到相应的log记录需要写盘的时候。这就是先写日志策略。
-->

<h3 id="变量设置">变量设置</h3>

<p>简单来说 InnoDB 通过两个核心参数 <code>innodb_buffer_pool_size</code>、<code>innodb_log_file_size</code>，分别定义了数据缓存和 redolog 的大小，而后者的大小也决定了 BP 中可以有多少脏页。当然，也不能因此就增大 redolog 文件的大小，这样，可能会导致系统启动时 Crash Recovery 时间增大。</p>

<p>redolog 保存在 <code>innodb_log_group_home_dir</code> 参数指定的目录下，文件名为 ib_logfile*；undolog 保存在共享表空间 ibdata* 文件中。</p>

<p>redolog 由一组固定大小的文件组成，顺序写入，而且文件循环使用，文件名为 ib_logfileN (其中N为从0开始的数字)，可以通过 <code>innodb_log_file_size</code> 和 <code>innodb_log_files_in_group</code> 参数控制文件的大小和数目，日志总大小为两者之积。</p>

<h4 id="innodb_log_file_size">innodb_log_file_size</h4>

<p>简单来说，该变量设置时至少要保证 redo log 在峰值的时候可以容纳 1 小时的日志，当前的写入值可以通过如下方式查看。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; pager grep sequence
PAGER set to &#39;grep sequence&#39;
mysql&gt; SHOW ENGINE INNODB STATUS\G select sleep(60); SHOW ENGINE INNODB STATUS\G
Log sequence number 3836410803
1 row in set (0.06 sec)
1 row in set (1 min 0.00 sec)
Log sequence number 3838334638
1 row in set (0.05 sec)

mysql&gt; SHOW GLOBAL STATUS LIKE &#39;Innodb_os_log_written&#39;;
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| Innodb_os_log_written | 1024  |
+-----------------------+-------+
1 row in set (0.00 sec)</code></pre></figure>

<p>其实，通过上述的两个变量查看的值会有些区别，一般后者的计算值会偏大，严格来说：LSN 是在写入 log buffer 时递增；而 <code>Innodb_os_log_written</code> 则是在写入文件时递增的。</p>

<p>而将 redo log buffer 中的内容写入到文件的时候是以 512 字节为单位来写的，而且会覆盖写。</p>

<p>简单举例来说：</p>

<ol>
  <li>
    <p>事务 A 写了 100B 日志，此时 LSN 的值增加 100，而刷到磁盘时，会从某个偏移开始写入 512B，也就是说 innodb_os_log_written 增加 512 ，只是这 512B 本次有效的只有 100B 。</p>
  </li>
  <li>
    <p>B 写了 200B 日志，此时 LSN 的值增加 200，刷磁盘时 innodb_os_log_written 又增加 512 。</p>
  </li>
</ol>

<p>也就是说最好参考 <code>SHOW ENGINE INNODB STATUS</code> 变量中的 <code>Log sequence number</code> 计算值。</p>

<!-- https://www.percona.com/blog/2012/10/08/measuring-the-amount-of-writes-in-innodb-redo-logs/ -->

<h4 id="innodb_log_buffer_size">innodb_log_buffer_size</h4>

<p>该参数就是用来设置 InnoDB 的 Log Buffer 大小，系统默认值为 16MB，主要作用就是缓冲 redo log 数据，增加缓存可以使大事务在提交前不用写入磁盘，从而提高写 IO 性能。</p>

<p>可以通过系统状态参数，查看性能统计数据来分析 Log 的使用情况：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SHOW STATUS LIKE &#39;innodb_log%&#39;;
+---------------------------+-------+
| Variable_name             | Value |
+---------------------------+-------+
| Innodb_log_waits          | 0     |  由于缓存过小，导致事务必须等待的次数
| Innodb_log_write_requests | 30    |  日志写请求数
| Innodb_log_writes         | 21    |  向日志文件的物理写次数
+---------------------------+-------+
3 rows in set (0.03 sec)</code></pre></figure>

<!--
通过这三个状态参数我们可以很清楚的看到 Log Buffer 的等待次数等性能状态。

当然，如果完全从 Log Buffer 本身来说，自然是大一些会减少更多的磁盘 IO。但是由于 Log 本身是 为了保护数据安全而产生的，而 Log 从 Buffer 到磁盘的刷新频率和控制数据安全一致的事务直接相关， 并且也有相关参数来控制（innodb_flush_log_at_trx_commit），所以关于 Log 相关的更详细的实现机 制和优化在后面的“事务优化”中再做更详细的分析，这里就不展开了。

innodb_additional_mem_pool_size 参数理解

innodb_additional_mem_pool_size 所设置的是用于存放 Innodb 的字典信息和其他一些内部结构所 需要的内存空间。所以我们的 Innodb 表越多，所需要的空间自然也就越大，系统默认值仅有 1MB。当 然，如果 Innodb 实际运行过程中出现了实际需要的内存比设置值更大的时候，Innodb 也会继续通过 OS 来申请内存空间，并且会在 MySQL 的错误日志中记录一条相应的警告信息让我们知晓。

从我个人的经验来看，一个常规的几百个 Innodb 表的 MySQL，如果不是每个表都是上百个字段的 话，20MB 内存已经足够了。当然，如果你有足够多的内存，完全可以继续增大这个值的设置。实际上， innodb_additional_mem_pool_size 参数对系统整体性能并无太大的影响，所以只要能存放需要的数据即 可，设置超过实际所需的内存并没有太大意义，只是浪费内存而已。
-->

<h2 id="文件结构">文件结构</h2>

<p>先明确下常用概念，每个日志组都会在第一个文件中有头部信息，通过 LOG_FILE_HDR_SIZE 宏定义，也就是 4*OS_FILE_LOG_BLOCK_SIZE(512) 。</p>

<p>redolog 写入通常是以 <code>OS_FILE_LOG_BLOCK_SIZE</code> (512字节，编译时设置) 为单位顺序写入文件，每个 LogBlock (512B) 包含了一个 header 段、一个 tailer 段、一组 LogRecords (多条记录组成)；每条记录都有自己的 LSN，表示从日志记录创建开始到特定的日志记录已经写入的字节数。</p>

<p>接着看看各个部分的定义。</p>

<h3 id="头部信息">头部信息</h3>

<p>头部信息，在 log0log.h 文件中定义，简单看下常用的保存字段。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">LOG_HEADER_FORMAT
  之前为LOG_GROUP_ID，用于标示redolog的分组ID，但是现在只支持一个分组；
LOG_HEADER_START_LSN
  日志文件记录的初始LSN，占用8字节，注意其偏移量与老版本有所区别；
LOG_HEADER_CREATOR
  备份程序会将填写备份程序和创建时间，通常是使用xtrabackup、mysqlbackup时会填充；
LOG_CHECKPOINT_1/2
  在头文件中定义的checkpoint位置，注意只有日志组了的第一文件会有该记录，每次checkpoint都会更新这两个值；</code></pre></figure>

<p>块的宏偏移量同样在 log0log.h 文件中定义，其中头部包括了 LOG_BLOCK_HDR_SIZE(12) 个字节，详细如下：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">LOG_BLOCK_HDR_NO
  四字节标示这是第几个block块，该值是通过LSN计算得来，详见log_block_convert_lsn_to_no()函数；
LOG_BLOCK_HDR_DATA_LEN
  两字节表示该block中已经有多少字节被使用；
LOG_BLOCK_FIRST_REC_GROUP
  两个字节表示该block中作为一个新的MTR开始log
LOG_BLOCK_CHECKPOINT_NO
  四个字节表示该block的checkpoint，也就是log_sys-&gt;next_checkpoint_no；
LOG_BLOCK_CHECKSUM
  四个字节记录了该block的校验值，通过innodb_checksum_algorithm变量指定算法；</code></pre></figure>

<!--
innodb_fast_shutdown

innodb_force_recovery
innodb_force_recovery_crash

????LSN对应了日志文件的偏移量，为了减小故障恢复时间，引入了Checkpoint机制，

InnoDB在启动时会自动检测InnoDB数据和事务日志是否一致，是否需要执行相应的操作？？？保证数据一致性；当然，故障恢复时间与事务日志的大小相关。
-->

<h2 id="源码解析">源码解析</h2>

<p>在此涉及到两块内存缓冲，包括了 mtr_t 、log_sys 等内部结构，接下来一一介绍。</p>

<h3 id="数据结构">数据结构</h3>

<p>首先看下 InnoDB 在内存中保存的一个全局变量，也就是 <code>log_t* log_sys=NULL;</code> 定义，其维护了一块称为 log buffer 的全局内存区域，也就是 <code>log_sys-&gt;buff</code>，同时维护有若干 lsn 值等信息表示 logging 进行的状态；会在 <code>log_init()</code> 中对所有的内部区域进行分配并对各个变量进行初始化。</p>

<p>变量 log_sys 是 InnoDB 日志系统的中枢及核心对象，控制着日志的拷贝、写入、checkpoint 等核心功能，是连接 InnoDB 日志文件及 log buffer 的枢纽。</p>

<p>接下来，简单介绍下 log_t 中比较重要的字段值：</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="k">struct</span> <span class="kt">log_t</span><span class="p">{</span>
  <span class="kt">char</span>        <span class="n">pad1</span><span class="p">[</span><span class="n">CACHE_LINE_SIZE</span><span class="p">];</span>
  <span class="kt">lsn_t</span>       <span class="n">lsn</span><span class="p">;</span>                    <span class="c1">// 接下来将要生成的log record使用此lsn的值；</span>
  <span class="n">ulint</span>       <span class="n">buf_size</span><span class="p">;</span>               <span class="c1">// buf大小，通过innodb-log-buffer-size变量指定</span>
  <span class="n">ulint</span>       <span class="n">buf_free</span><span class="p">;</span>               <span class="c1">// 下条log record写入的位置</span>
  <span class="n">ulint</span>       <span class="n">max_buf_free</span><span class="p">;</span>           <span class="c1">// 当buf_free超过该值后，需要进行刷新，可以查看log_free_check()函数</span>
  <span class="n">byte</span><span class="o">*</span>       <span class="n">buf</span><span class="p">;</span>                    <span class="c1">// 全局的log buffer</span>
  <span class="n">ulint</span>       <span class="n">buf_next_to_write</span><span class="p">;</span>      <span class="c1">// 下条记录写入到磁盘的偏移量</span>
  <span class="kt">lsn_t</span>       <span class="n">write_lsn</span><span class="p">;</span>              <span class="c1">// 已经写入的LSN</span>
  <span class="kt">lsn_t</span>       <span class="n">flushed_to_disk_lsn</span><span class="p">;</span>    <span class="c1">// 已经刷新到磁盘的LSN值，小于该值的日志已经被安全地记录到了磁盘上</span>

  <span class="n">UT_LIST_BASE_NODE_T</span><span class="p">(</span><span class="kt">log_group_t</span><span class="p">)</span>    <span class="c1">// 日志组，当前版本仅支持一组日志</span>
          <span class="n">log_groups</span><span class="p">;</span>                 <span class="c1">// 包含了当前日志组的文件个数、每个文件的大小、space id等信息</span>

  <span class="kt">lsn_t</span>       <span class="n">log_group_capacity</span><span class="p">;</span>     <span class="c1">// 当前日志文件的总容量在log_calc_max_ages()中计算，</span>
                                      <span class="c1">// (redo-log文件大小-头部)*0.9，其中乘0.9是一个安全系数</span>

  <span class="kt">lsn_t</span>       <span class="n">max_modified_age_async</span><span class="p">;</span>
                  <span class="cm">/*!&lt; when this recommended</span>
<span class="cm">                  value for lsn -</span>
<span class="cm">                  buf_pool_get_oldest_modification()</span>
<span class="cm">                  is exceeded, we start an</span>
<span class="cm">                  asynchronous preflush of pool pages */</span>
  <span class="kt">lsn_t</span>       <span class="n">max_modified_age_sync</span><span class="p">;</span>
                  <span class="cm">/*!&lt; when this recommended</span>
<span class="cm">                  value for lsn -</span>
<span class="cm">                  buf_pool_get_oldest_modification()</span>
<span class="cm">                  is exceeded, we start a</span>
<span class="cm">                  synchronous preflush of pool pages */</span>
  <span class="kt">lsn_t</span>       <span class="n">max_checkpoint_age_async</span><span class="p">;</span>
                  <span class="cm">/*!&lt; when this checkpoint age</span>
<span class="cm">                  is exceeded we start an</span>
<span class="cm">                  asynchronous writing of a new</span>
<span class="cm">                  checkpoint */</span>
  <span class="kt">lsn_t</span>       <span class="n">max_checkpoint_age</span><span class="p">;</span>
                  <span class="cm">/*!&lt; this is the maximum allowed value</span>
<span class="cm">                  for lsn - last_checkpoint_lsn when a</span>
<span class="cm">                  new query step is started */</span>
  <span class="kt">ib_uint64_t</span> <span class="n">next_checkpoint_no</span><span class="p">;</span>
                  <span class="cm">/*!&lt; next checkpoint number */</span>
  <span class="kt">lsn_t</span>       <span class="n">last_checkpoint_lsn</span><span class="p">;</span>
                  <span class="cm">/*!&lt; latest checkpoint lsn */</span>
  <span class="kt">lsn_t</span>       <span class="n">next_checkpoint_lsn</span><span class="p">;</span>
                  <span class="cm">/*!&lt; next checkpoint lsn */</span></code></pre></figure>

<!--
上述结构体中的很多值会在初始化的时候进行设置，调用流程如下。

So log_sys->buf_next_to_write is between 0 and log_sys->buf_free, log_sys->write_lsn is equal or less log_sys->lsn, log_sys->flushed_to_disk_lsn is less or equal to log_sys->write_lsn.


log_sys->buf_free
 
写入buffer的起始偏移量


log_sys->write_lsn
 当前正在执行的写操作使用的临界lsn值；
log_sys->current_flush_lsn
 当前正在执行的write + flush操作使用的临界lsn值，一般和log_sys->write_lsn相等；

log_sys->buf_next_to_write
 
buffer中还未写到log file的起始偏移量。下次执行write+flush操作时，将会从此偏移量开始
log_sys->max_buf_free
 
确定flush操作执行的时间点，当log_sys->buf_free比此值大时需要执行flush操作，具体看log_check_margins函数


lsn是联系dirty page，redo log record和redo log file的纽带。在每个redo log record被拷贝到内存的log buffer时会产生一个相关联的lsn，而每个页面修改时会产生一个log record，从而每个数据库的page也会有一个相关联的lsn，这个lsn记录在每个page的header字段中。为了保证WAL（Write-Ahead-Logging）要求的逻辑，dirty page要求其关联lsn的log record已经被写入log file才允许执行flush操作。
-->

<h3 id="日志生成">日志生成</h3>

<p>mtr (mini-transactions) 在代码中对应了 <code>struct mtr_t</code> 结构体，其内部有一个局部 buffer，会将一组 log record 集中起来，然后批量写入 log buffer；mtr_t 的结构体如下所示：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">struct mtr_t {
  struct Impl {
    mtr_buf_t  m_memo;  // 由此mtr涉及的操作所造成的脏页列表
    mtr_buf_t  m_log;   // mtr的局部缓存，记录log-records；
  };
};</code></pre></figure>

<p>其中 m_memo 对象会记录与本次事务相关的页以及锁信息，并在提交时 (复制到 log buffer) 之后将脏页添加到 flush_list 并释放所持有的锁，详细的内容可以参考 <code>mtr_commit()-&gt;mtr_memo_pop_all()</code> 函数调用。</p>

<p>简单来说，log record 的生成过程如下：</p>

<ol>
  <li>创建一个 mtr_t 类型的对象；</li>
  <li>执行 <code>mtr_start()</code> 初始化 mtr_t 的字段，包括 local buffer；</li>
  <li>在对 BP 中的 Page 进行修改的同时，调用 <code>mlog_write_ulint()</code>、<code>mlog_write_string()</code>、<code>mlog_write_null()</code> 类似函数，生成 redo log record 并保存在 local buffer 中；</li>
  <li>执行 <code>mtr_commit()</code> 将 local buffer 中的日志拷贝到全局的 <code>log_sys-&gt;buf+log_sys-&gt;buf_free</code>，同时将脏页添加到 flush list，供后续执行 flush 操作时使用。</li>
</ol>

<p>对于这一过程的执行，可以将 <code>page_cur_insert_rec_write_log()</code> 函数作为参考。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mtr_commit()                          提交mtr，对应了mtr_t::commit()@mtr0mtr.cc
 |-mtr_t::Command::execute()          执行，同样在mtr0mtr.cc文件中
   |-mtr_t::Command::prepare_write()  准备写入，会返回字节数
     |-fil_names_write_if_was_clean()
       |-fil_names_dirty_and_write()  如果在fil_names_clear()之后这是第一次写入</code></pre></figure>

<!--
## 参考


Innodb redo log archiving
https://www.percona.com/blog/2014/03/28/innodb-redo-log-archiving/
-->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/mysql-innodb-checkpoint.html" title="InnoDB Checkpoint">&larr; Older</a></li> 
         <li class="next"><a href="/post/memcached-introduce_init.html" title="分布式缓存 memcached">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1457366400',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/mysql-innodb-redo-log.html" data-title="InnoDB Redo Log" data-url="/post/mysql-innodb-redo-log.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
