<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>MySQL 启动脚本|JinYang's Blog</title>
  <meta name="keywords" content="mysql,database,启动,脚本">
  <meta name="description" content="mysqld_safe 是一个 shell 脚本，通常用来启动 MySQL 服务进程，在这篇文章中，我们看下该脚本具体做了什么。">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>MySQL 启动脚本</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2015-04-10 Friday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  mysql ,  database  
      
    </div>
  </div>
  <hr>
  <p>mysqld_safe 是一个 shell 脚本，通常用来启动 MySQL 服务进程，在这篇文章中，我们看下该脚本具体做了什么。</p>

<!-- more -->

<h2 id="简介">简介</h2>

<p>该 shell 脚本，详细交代了 MySQL 的启动流程：查找 MySQL 相关目录；解析配置文件；调用 mysqld 程序来启动实例。常见的配置项有：</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">--help
    查看帮助。

--no-defaults
    不要读任何配置项文件。如果给出，必须首选该选项。
--defaults-extra-file=path
    除了通用选项文件所读取的选项文件名。如果给出，必须首选该选项。
--defaults-file=path
    读取的代替通用选项文件的选项文件名。如果给出，必须首选该选项。

--basedir=path
    指定 MySQL 安装目录的路径。
--datadir=path
    数据目录的路径。

--syslog, --skip-syslog
    是否使用syslog记录mysqld_safe的日志。如果是skip-syslog，会写到文件中，默认是hostname.err。
--log-error
    指定错误日志的文件路径，需要同时设置--skip-syslog 。</code></pre></figure>

<p>接下来看看 mysqld_safe 是如何执行的。</p>

<h3 id="执行流程简介">执行流程简介</h3>

<p>如下是其简单的处理流程。</p>

<h5 id="1-检查系统和选项">1. 检查系统和选项</h5>

<p>强制设置四个选项，并检查其有效性，包括了默认配置、basedir、datadir、plugin-dir 。</p>

<h5 id="2-检查myisam表">2. 检查MyISAM表</h5>

<p>默认是注释掉的，也可以在启动前检查 MyISAM 表。</p>

<h5 id="3-监控服务">3. 监控服务</h5>

<p>在 MySQL 服务器异常宕机时，mysqld_safe 默认会自动重启服务，而正常关闭则不会重启服务，那么它是如何判断 MySQL 是否是正常关闭的呢？能否控制不自动重启呢？</p>

<p>如果 MySQL 服务正常关闭，默认会删除 PID 文件，mysqld_safe 会通过判断是否存在该文件来决定是否要重新拉起 MySQL 服务；当然，如果想即使 MySQL 服务宕机也不启动文件，也可以新建一个名为 PID 文件名+ <code>.shutdown</code> 的文件即可，例如 /tmp/mysql.pid.shutdown 。</p>

<p>在此，还有些异常处理：</p>

<ol>
  <li>如果在 MySQL 服务在一秒以内重启，则说明有异常，此时会通过 <code>sleep 1</code> 休眠一秒。</li>
  <li>在发现 MySQL 宕后，默认会检查是否有 mysqld 进程 hanging ，如果有，则直接通过 <code>kill -9</code> 强制关闭。</li>
</ol>

<h5 id="4-记录日志">4. 记录日志</h5>

<p>将 mysqld 的错误消息发送到数据目录中的 host_name.err 文件，或者写入到 syslog 中。</p>

<!--
6. 将mysqld_safe的屏幕输出发送到数据目录中的host_name.safe文件
-->

<h2 id="源码解析">源码解析</h2>

<p>该脚本实际上最终会通过 <code>eval_log_error()</code> 函数启动 MySQL 服务，并将输出日志记录到文件或者 syslog 中，这个函数应该是 mysqld_safe 脚本的核心处理函数。</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/sh</span>

<span class="c">#----- 首先是一些变量参数的定义</span>
<span class="nv">KILL_MYSQLD</span><span class="o">=</span>1<span class="p">;</span>              <span class="c"># 试图kill多余的mysqld_safe程序，1表示需要kill</span>
<span class="nv">MYSQLD</span><span class="o">=</span>                     <span class="c"># mysqld二进制可执行文件的目录名称</span>
<span class="nv">niceness</span><span class="o">=</span><span class="m">0</span>                  <span class="c"># 进程的调度优先级</span>
<span class="nv">mysqld_ld_preload</span><span class="o">=</span>          <span class="c"># 通常指定libjemalloc.so.1所在路径</span>
<span class="nv">mysqld_ld_library_path</span><span class="o">=</span>     <span class="c"># 库目录</span>

<span class="c">#----- 下面的变量用于设置日志，默认不打开错误日志，不使用syslog</span>
<span class="nv">logging</span><span class="o">=</span>init                <span class="c"># 日志记录状态，init(输出到终端)，可以查看log_generic()</span>
<span class="nv">want_syslog</span><span class="o">=</span><span class="m">0</span>               <span class="c"># 是否要使用syslog</span>
<span class="nv">syslog_tag</span><span class="o">=</span>                 <span class="c"># 如果使用，则需要增加的标示</span>
<span class="nv">user</span><span class="o">=</span><span class="s1">&#39;mysql&#39;</span>                <span class="c"># 启动时使用的用户，也就是指定--user的选项值</span>
<span class="nv">pid_file</span><span class="o">=</span>                   <span class="c"># pid文件的路径</span>
<span class="nv">err_log</span><span class="o">=</span>                    <span class="c"># 错误日志的路径</span>
<span class="nv">timestamp_format</span><span class="o">=</span>UTC        <span class="c"># 使用UTC时间格式</span>

<span class="c">#----- 定义的syslog中标志位，在后面需要写入日志到syslog中时使用</span>
<span class="nv">syslog_tag_mysqld</span><span class="o">=</span>mysqld
<span class="nv">syslog_tag_mysqld_safe</span><span class="o">=</span>mysqld_safe
<span class="nv">syslog_facility</span><span class="o">=</span>daemon

<span class="nb">trap</span> <span class="s1">&#39;&#39;</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">15</span>            <span class="c"># 不允许程序在终端上被kill，包括挂起、中断、退出、系统终止</span>
<span class="nb">trap</span> <span class="s1">&#39;&#39;</span> <span class="m">13</span>                  <span class="c"># 也包括SIGPIPE，可以通过kill -l查看数字对应的信号量</span>

<span class="c">#----- 设置默认权限为770，可以查看umask(2)，为了兼容所以处理的时候比较复杂</span>
<span class="nb">umask </span><span class="m">007</span>                               <span class="c"># fallback</span>
<span class="nv">UMASK</span><span class="o">=</span><span class="s2">&quot;${UMASK-0640}&quot;</span>
<span class="nv">fmode</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$UMASK&quot;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/[^0246]//g&#39;</span><span class="sb">`</span>
<span class="nv">octalp</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$fmode&quot;</span><span class="p">|</span>cut -c1<span class="sb">`</span>
<span class="nv">fmlen</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$fmode&quot;</span><span class="p">|</span>wc -c<span class="p">|</span>sed -e <span class="s1">&#39;s/ //g&#39;</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;x$octalp&quot;</span> !<span class="o">=</span> <span class="s2">&quot;x0&quot;</span> -o <span class="s2">&quot;x$UMASK&quot;</span> !<span class="o">=</span> <span class="s2">&quot;x$fmode&quot;</span> -o <span class="s2">&quot;x$fmlen&quot;</span> !<span class="o">=</span> <span class="s2">&quot;x5&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nv">fmode</span><span class="o">=</span>0640
  <span class="nb">echo</span> <span class="s2">&quot;UMASK must be a 3-digit mode with an additional leading 0 to indicate octal.&quot;</span> &gt;<span class="p">&amp;</span>2
  <span class="nb">echo</span> <span class="s2">&quot;The first digit will be corrected to 6, the others may be 0, 2, 4, or 6.&quot;</span> &gt;<span class="p">&amp;</span>2
<span class="k">fi</span>
<span class="nv">fmode</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$fmode&quot;</span><span class="p">|</span>cut -c3-4<span class="sb">`</span>
<span class="nv">fmode</span><span class="o">=</span><span class="s2">&quot;6$fmode&quot;</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;x$UMASK&quot;</span> !<span class="o">=</span> <span class="s2">&quot;x0$fmode&quot;</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;UMASK corrected from $UMASK to 0$fmode ...&quot;</span>
<span class="k">fi</span>

<span class="c">#----- 使用的默认配置文件，可以在命令行中指定</span>
<span class="nv">defaults</span><span class="o">=</span>
<span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
  --no-defaults<span class="p">|</span>--defaults-file<span class="o">=</span>*<span class="p">|</span>--defaults-extra-file<span class="o">=</span>*<span class="o">)</span>
   <span class="nv">defaults</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span><span class="p">;</span> <span class="nb">shift</span>
   <span class="p">;;</span>
<span class="k">esac</span>

<span class="c">#----- 使用--help选项时输出的使用帮助信息</span>
usage <span class="o">()</span> <span class="o">{</span>
        cat <span class="s">&lt;&lt;EOF</span>
<span class="s">Usage: $0 [OPTIONS]</span>
<span class="s">  --no-defaults              Don&#39;t read the system defaults file</span>
<span class="s">  ... ...</span>
<span class="s">EOF</span>
        <span class="nb">exit </span>1
<span class="o">}</span>

<span class="c">#----- 相当于which，检索$PATH中的路径，打印出命令的全路径</span>
my_which <span class="o">()</span>        <span class="c"># 该函数只在my_which logger用到，也就是转换为/usr/bin/logger</span>
<span class="o">{</span>
  <span class="nv">save_ifs</span><span class="o">=</span><span class="s2">&quot;${IFS-UNSET}&quot;</span>     <span class="c"># 保存当前的分隔符，用于后面恢复IFS</span>
  <span class="nv">IFS</span><span class="o">=</span>:                       <span class="c"># 使用:来分割PATH中的路径</span>
  <span class="nv">ret</span><span class="o">=</span>0
  <span class="k">for</span> file                    <span class="c"># 等同于for file in $*</span>
  <span class="k">do</span>
    <span class="k">for</span> dir in <span class="nv">$PATH</span>
    <span class="k">do</span>
      <span class="k">if</span> <span class="o">[</span> -f <span class="s2">&quot;$dir/$file&quot;</span> <span class="o">]</span>
      <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;$dir/$file&quot;</span>
        <span class="k">continue</span> <span class="m">2</span>            <span class="c"># 跳出外层循环</span>
      <span class="k">fi</span>
    <span class="k">done</span>

	<span class="nv">ret</span><span class="o">=</span><span class="m">1</span>  <span class="c">#signal an error</span>
	<span class="nb">break</span>
<span class="nb">  </span><span class="k">done</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$save_ifs&quot;</span> <span class="o">=</span> UNSET <span class="o">]</span>  <span class="c"># 重置IFS变量</span>
  <span class="k">then</span>
    <span class="nb">unset </span>IFS
  <span class="k">else</span>
    <span class="nv">IFS</span><span class="o">=</span><span class="s2">&quot;$save_ifs&quot;</span>
  <span class="k">fi</span>
  <span class="k">return</span> <span class="nv">$ret</span>  <span class="c"># Success</span>
<span class="o">}</span>

<span class="c">#----- 通用的日志输出，被log_error和log_notice函数调用</span>
log_generic <span class="o">()</span> <span class="o">{</span>
  <span class="nv">priority</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>        <span class="c"># 日志级别，有daemon.error和daemon.notice两种类别</span>
  <span class="nb">shift</span>

<span class="nb">  </span><span class="nv">msg</span><span class="o">=</span><span class="s2">&quot;`eval $DATE` mysqld_safe $*&quot;</span>     <span class="c"># 设置日志格式，时间+mysqld_safe+日志</span>
  <span class="nb">echo</span> <span class="s2">&quot;$msg&quot;</span>
  <span class="k">case</span> <span class="nv">$logging</span> in
    init<span class="o">)</span> <span class="p">;;</span>                            <span class="c"># 只输出到命令行，不记录到日志</span>
    file<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;$msg&quot;</span> &gt;&gt; <span class="s2">&quot;$err_log&quot;</span> <span class="p">;;</span>  <span class="c"># 输出到错误日志文件</span>
    <span class="c"># 用logger命令将日志记录到系统日志syslog</span>
    syslog<span class="o">)</span> logger -t <span class="s2">&quot;$syslog_tag_mysqld_safe&quot;</span> -p <span class="s2">&quot;$priority&quot;</span> <span class="s2">&quot;$*&quot;</span> <span class="p">;;</span>
    both<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;$msg&quot;</span> &gt;&gt; <span class="s2">&quot;$err_log&quot;</span><span class="p">;</span> logger -t <span class="s2">&quot;$syslog_tag_mysqld_safe&quot;</span> -p <span class="s2">&quot;$priority&quot;</span> <span class="s2">&quot;$*&quot;</span> <span class="p">;;</span>
    *<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&quot;Internal program error (non-fatal):&quot;</span> <span class="se">\</span>
           <span class="s2">&quot; unknown logging method &#39;$logging&#39;&quot;</span> &gt;<span class="p">&amp;</span>2
      <span class="p">;;</span>
  <span class="k">esac</span>
<span class="o">}</span>

log_error <span class="o">()</span> <span class="o">{</span>
  log_generic <span class="k">${</span><span class="nv">syslog_facility</span><span class="k">}</span>.error <span class="s2">&quot;$@&quot;</span> &gt;<span class="p">&amp;</span>2
<span class="o">}</span>

log_notice <span class="o">()</span> <span class="o">{</span>
  log_generic <span class="k">${</span><span class="nv">syslog_facility</span><span class="k">}</span>.notice <span class="s2">&quot;$@&quot;</span>
<span class="o">}</span>

<span class="c">#----- 记录日志的初始化操作，会根据日志类新记录一些初始化日志</span>
eval_log_error <span class="o">()</span> <span class="o">{</span>
  <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>                              <span class="c"># 最后的eval命令会解析$cmd中的值并执行命令</span>
  <span class="k">case</span> <span class="nv">$logging</span> in
    file<span class="o">)</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;$cmd &gt;&gt; &quot;</span><span class="sb">`</span>shell_quote_string <span class="s2">&quot;$err_log&quot;</span><span class="sb">`</span><span class="s2">&quot; 2&gt;&amp;1&quot;</span> <span class="p">;;</span>
    syslog<span class="o">)</span>
      <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;$cmd 2&gt;&amp;1 | logger -t &#39;$syslog_tag_mysqld&#39; -p daemon.error&quot;</span>
      <span class="p">;;</span>
    *<span class="o">)</span>
      <span class="nb">echo</span> <span class="s2">&quot;Internal program error (non-fatal):&quot;</span> <span class="se">\</span>
           <span class="s2">&quot; unknown logging method &#39;$logging&#39;&quot;</span> &gt;<span class="p">&amp;</span>2
    <span class="p">;;</span>
  <span class="k">esac</span>

  <span class="c">#!!!可以如下命令查看真正执行的命令!!!</span>
  <span class="c">#echo &quot;Running mysqld: [$cmd]&quot;</span>
  <span class="nb">eval</span> <span class="s2">&quot;$cmd&quot;</span>
<span class="o">}</span>

<span class="c">#----- 转义函数，用于在非&quot;a-z&quot;、&quot;A-Z&quot;、&quot;0-9&quot;、&#39;/&#39;、&#39;_&#39;、&#39;.&#39;、&#39;=&#39;、&#39;-&#39;的特殊字符前加上转义字符&quot;\&quot;</span>
shell_quote_string<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">&quot;$1&quot;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s,\([^a-zA-Z0-9/_.=-]\),\\\1,g&#39;</span> <span class="c"># sed中的\1代表引用前面\(\)中匹配的值</span>
<span class="o">}</span>

<span class="c">#----- 该函数用于解析配置文件中的选项，并赋值给相应的变量，无法识别则转递给服务器</span>
parse_arguments<span class="o">()</span> <span class="o">{</span>
  <span class="nv">pick_args</span><span class="o">=</span>
  <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> PICK-ARGS-FROM-ARGV
  <span class="k">then</span>
    <span class="nv">pick_args</span><span class="o">=</span>1
    <span class="nb">shift</span>
<span class="nb">  </span><span class="k">fi</span>

  <span class="k">for</span> arg <span class="k">do</span>        <span class="c"># 取出参数值</span>
    <span class="nv">val</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$arg&quot;</span> <span class="p">|</span> sed -e <span class="s2">&quot;s;--[^=]*=;;&quot;</span><span class="sb">`</span>
    <span class="nv">optname</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$arg&quot;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/^\(--[^=]*\)=.*$/\1/&#39;</span><span class="sb">`</span>
    <span class="nv">optname_subst</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$optname&quot;</span> <span class="p">|</span> sed <span class="s1">&#39;s/_/-/g&#39;</span><span class="sb">`</span>
    <span class="nv">arg</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$arg</span> <span class="p">|</span> sed <span class="s2">&quot;s/^$optname/$optname_subst/&quot;</span><span class="sb">`</span>
    <span class="k">case</span> <span class="s2">&quot;$arg&quot;</span> in  <span class="c"># 将参数值传递给对应的变量</span>
      --basedir<span class="o">=</span>*<span class="o">)</span> <span class="nv">MY_BASEDIR_VERSION</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --datadir<span class="o">=</span>*<span class="o">)</span> <span class="nv">DATADIR</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --pid-file<span class="o">=</span>*<span class="o">)</span> <span class="nv">pid_file</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --plugin-dir<span class="o">=</span>*<span class="o">)</span> <span class="nv">PLUGIN_DIR</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --user<span class="o">=</span>*<span class="o">)</span> <span class="nv">user</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span><span class="p">;</span> <span class="nv">SET_USER</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>

      <span class="c"># 有些值已经在my.cnf配置文件的[mysqld_safe]组下设置，可被命令行覆盖</span>
      --log-error<span class="o">=</span>*<span class="o">)</span> <span class="nv">err_log</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --port<span class="o">=</span>*<span class="o">)</span> <span class="nv">mysql_tcp_port</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --socket<span class="o">=</span>*<span class="o">)</span> <span class="nv">mysql_unix_port</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>

      <span class="c"># 如下的配置项必须在配置文件的[mysqld_safe]组中设置</span>
      --core-file-size<span class="o">=</span>*<span class="o">)</span> <span class="nv">core_file_size</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --ledir<span class="o">=</span>*<span class="o">)</span> <span class="nv">ledir</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --malloc-lib<span class="o">=</span>*<span class="o">)</span> set_malloc_lib <span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --mysqld<span class="o">=</span>*<span class="o">)</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$pick_args&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
          log_error <span class="s2">&quot;--mysqld option can only be used as command line option, found in config file&quot;</span>
          <span class="nb">exit </span>1
        <span class="k">fi</span>
        <span class="nv">MYSQLD</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --mysqld-version<span class="o">=</span>*<span class="o">)</span>
        <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$pick_args&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
          log_error <span class="s2">&quot;--mysqld-version option can only be used as command line option, found in config file&quot;</span>
          <span class="nb">exit </span>1
        <span class="k">fi</span>
        <span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$val&quot;</span>
        <span class="k">then</span>
          <span class="nv">MYSQLD</span><span class="o">=</span><span class="s2">&quot;mysqld-$val&quot;</span>
          <span class="nv">PLUGIN_VARIANT</span><span class="o">=</span><span class="s2">&quot;/$val&quot;</span>
        <span class="k">else</span>
          <span class="nv">MYSQLD</span><span class="o">=</span><span class="s2">&quot;mysqld&quot;</span>
        <span class="k">fi</span>
        <span class="p">;;</span>
      --nice<span class="o">=</span>*<span class="o">)</span> <span class="nv">niceness</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --open-files-limit<span class="o">=</span>*<span class="o">)</span> <span class="nv">open_files</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --open-files-limit<span class="o">=</span>*<span class="o">)</span> <span class="nv">open_files</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --skip-kill-mysqld*<span class="o">)</span> <span class="nv">KILL_MYSQLD</span><span class="o">=</span><span class="m">0</span> <span class="p">;;</span>
      --mysqld-safe-log-timestamps<span class="o">=</span>*<span class="o">)</span> <span class="nv">timestamp_format</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --syslog<span class="o">)</span> <span class="nv">want_syslog</span><span class="o">=</span><span class="m">1</span> <span class="p">;;</span>
      --skip-syslog<span class="o">)</span> <span class="nv">want_syslog</span><span class="o">=</span><span class="m">0</span> <span class="p">;;</span>
      --syslog-tag<span class="o">=</span>*<span class="o">)</span> <span class="nv">syslog_tag</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span> <span class="p">;;</span>
      --timezone<span class="o">=</span>*<span class="o">)</span> <span class="nv">TZ</span><span class="o">=</span><span class="s2">&quot;$val&quot;</span><span class="p">;</span> <span class="nb">export </span>TZ<span class="p">;</span> <span class="p">;;</span>   <span class="c"># 生效了一下时区设置</span>

      --help<span class="o">)</span> usage <span class="p">;;</span>                         <span class="c"># 调用了usage函数，输出帮助信息</span>

      *<span class="o">)</span>
        <span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$pick_args&quot;</span>
        <span class="k">then</span>
          append_arg_to_args <span class="s2">&quot;$arg&quot;</span>            <span class="c"># 将其他命令行参数值附加到$arg的后面</span>
        <span class="k">fi</span>
        <span class="p">;;</span>
    <span class="k">esac</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="c"># 添加到LD_PRELOAD，使用空格分割</span>
add_mysqld_ld_preload<span class="o">()</span> <span class="o">{</span>
  <span class="nv">lib_to_add</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
  log_notice <span class="s2">&quot;Adding &#39;$lib_to_add&#39; to LD_PRELOAD for mysqld&quot;</span>

  <span class="k">case</span> <span class="s2">&quot;$lib_to_add&quot;</span> in
    *<span class="s1">&#39; &#39;</span>*<span class="o">)</span>
      <span class="c"># Must strip path from lib, and add it to LD_LIBRARY_PATH</span>
      <span class="nv">lib_file</span><span class="o">=</span><span class="sb">`</span>basename <span class="s2">&quot;$lib_to_add&quot;</span><span class="sb">`</span>
      <span class="k">case</span> <span class="s2">&quot;$lib_file&quot;</span> in
        *<span class="s1">&#39; &#39;</span>*<span class="o">)</span>
          <span class="c"># The lib file itself has a space in its name, and can&#39;t</span>
          <span class="c"># be used in LD_PRELOAD</span>
          log_error <span class="s2">&quot;library name &#39;$lib_to_add&#39; contains spaces and can not be used with LD_PRELOAD&quot;</span>
          <span class="nb">exit </span>1
          <span class="p">;;</span>
      <span class="k">esac</span>
      <span class="nv">lib_path</span><span class="o">=</span><span class="sb">`</span>dirname <span class="s2">&quot;$lib_to_add&quot;</span><span class="sb">`</span>
      <span class="nv">lib_to_add</span><span class="o">=</span><span class="s2">&quot;$lib_file&quot;</span>
      <span class="o">[</span> -n <span class="s2">&quot;$mysqld_ld_library_path&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">mysqld_ld_library_path</span><span class="o">=</span><span class="s2">&quot;$mysqld_ld_library_path:&quot;</span>
      <span class="nv">mysqld_ld_library_path</span><span class="o">=</span><span class="s2">&quot;$mysqld_ld_library_path$lib_path&quot;</span>
      <span class="p">;;</span>
  <span class="k">esac</span>

  <span class="c"># LD_PRELOAD is a space-separated</span>
  <span class="o">[</span> -n <span class="s2">&quot;$mysqld_ld_preload&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">mysqld_ld_preload</span><span class="o">=</span><span class="s2">&quot;$mysqld_ld_preload &quot;</span>
  <span class="nv">mysqld_ld_preload</span><span class="o">=</span><span class="s2">&quot;${mysqld_ld_preload}$lib_to_add&quot;</span>
<span class="o">}</span>


<span class="c"># Returns LD_PRELOAD (and LD_LIBRARY_PATH, if needed) text, quoted to be</span>
<span class="c"># suitable for use in the eval that calls mysqld.</span>
<span class="c">#</span>
<span class="c"># All values in mysqld_ld_preload are prepended to LD_PRELOAD.</span>
mysqld_ld_preload_text<span class="o">()</span> <span class="o">{</span>
  <span class="nv">text</span><span class="o">=</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$mysqld_ld_preload&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">new_text</span><span class="o">=</span><span class="s2">&quot;$mysqld_ld_preload&quot;</span>
    <span class="o">[</span> -n <span class="s2">&quot;$LD_PRELOAD&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">new_text</span><span class="o">=</span><span class="s2">&quot;$new_text $LD_PRELOAD&quot;</span>
    <span class="nv">text</span><span class="o">=</span><span class="s2">&quot;${text}LD_PRELOAD=&quot;</span><span class="sb">`</span>shell_quote_string <span class="s2">&quot;$new_text&quot;</span><span class="sb">`</span><span class="s1">&#39; &#39;</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$mysqld_ld_library_path&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">new_text</span><span class="o">=</span><span class="s2">&quot;$mysqld_ld_library_path&quot;</span>
    <span class="o">[</span> -n <span class="s2">&quot;$LD_LIBRARY_PATH&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">new_text</span><span class="o">=</span><span class="s2">&quot;$new_text:$LD_LIBRARY_PATH&quot;</span>
    <span class="nv">text</span><span class="o">=</span><span class="s2">&quot;${text}LD_LIBRARY_PATH=&quot;</span><span class="sb">`</span>shell_quote_string <span class="s2">&quot;$new_text&quot;</span><span class="sb">`</span><span class="s1">&#39; &#39;</span>
  <span class="k">fi</span>

  <span class="nb">echo</span> <span class="s2">&quot;$text&quot;</span>
<span class="o">}</span>

<span class="c"># set_malloc_lib LIB</span>
<span class="c"># - If LIB is empty, do nothing and return</span>
<span class="c"># - If LIB is &#39;tcmalloc&#39;, look for tcmalloc shared library in $malloc_dirs.</span>
<span class="c">#   tcmalloc is part of the Google perftools project.</span>
<span class="c"># - If LIB is an absolute path, assume it is a malloc shared library</span>
<span class="c">#</span>
<span class="c"># Put LIB in mysqld_ld_preload, which will be added to LD_PRELOAD when</span>
<span class="c"># running mysqld.  See ld.so for details.</span>
set_malloc_lib<span class="o">()</span> <span class="o">{</span>
  <span class="c"># This list is kept intentionally simple.</span>
  <span class="nv">malloc_dirs</span><span class="o">=</span><span class="s2">&quot;/usr/lib /usr/lib64 /usr/lib/i386-linux-gnu /usr/lib/x86_64-linux-gnu&quot;</span>
  <span class="nv">malloc_lib</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$malloc_lib&quot;</span> <span class="o">=</span> tcmalloc <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">malloc_lib</span><span class="o">=</span>
    <span class="k">for</span> libdir in <span class="k">$(</span><span class="nb">echo</span> <span class="nv">$malloc_dirs</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
      <span class="k">for</span> flavor in _minimal <span class="s1">&#39;&#39;</span> _and_profiler _debug<span class="p">;</span> <span class="k">do</span>
        <span class="nv">tmp</span><span class="o">=</span><span class="s2">&quot;$libdir/libtcmalloc$flavor.so&quot;</span>
        <span class="c">#log_notice &quot;DEBUG: Checking for malloc lib &#39;$tmp&#39;&quot;</span>
        <span class="o">[</span> -r <span class="s2">&quot;$tmp&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="k">continue</span>
        <span class="nv">malloc_lib</span><span class="o">=</span><span class="s2">&quot;$tmp&quot;</span>
        <span class="nb">break </span>2
      <span class="k">done</span>
    <span class="k">done</span>

    <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$malloc_lib&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      log_error <span class="s2">&quot;no shared library for --malloc-lib=tcmalloc found in $malloc_dirs&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="c"># Allow --malloc-lib=&#39;&#39; to override other settings</span>
  <span class="o">[</span> -z  <span class="s2">&quot;$malloc_lib&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="k">return</span>

  <span class="k">case</span> <span class="s2">&quot;$malloc_lib&quot;</span> in
    /*<span class="o">)</span>
      <span class="k">if</span> <span class="o">[</span> ! -r <span class="s2">&quot;$malloc_lib&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        log_error <span class="s2">&quot;--malloc-lib can not be read and will not be used&quot;</span>
        <span class="nb">exit </span>1
      <span class="k">fi</span>

      <span class="c"># Restrict to a the list in $malloc_dirs above</span>
      <span class="k">case</span> <span class="s2">&quot;$(dirname &quot;</span><span class="nv">$malloc_lib</span><span class="s2">&quot;)&quot;</span> in
        /usr/lib<span class="o">)</span> <span class="p">;;</span>
        /usr/lib64<span class="o">)</span> <span class="p">;;</span>
        /usr/lib/i386-linux-gnu<span class="o">)</span> <span class="p">;;</span>
        /usr/lib/x86_64-linux-gnu<span class="o">)</span> <span class="p">;;</span>
        *<span class="o">)</span>
          log_error <span class="s2">&quot;--malloc-lib must be located in one of the directories: $malloc_dirs&quot;</span>
          <span class="nb">exit </span>1
          <span class="p">;;</span>
      <span class="k">esac</span>
      <span class="p">;;</span>
    *<span class="o">)</span>
      log_error <span class="s2">&quot;--malloc-lib must be an absolute path or &#39;tcmalloc&#39;; &quot;</span> <span class="se">\</span>
        <span class="s2">&quot;ignoring value &#39;$malloc_lib&#39;&quot;</span>
      <span class="nb">exit </span>1
      <span class="p">;;</span>
  <span class="k">esac</span>

  add_mysqld_ld_preload <span class="s2">&quot;$malloc_lib&quot;</span>
<span class="o">}</span>

<span class="c">#########################################################</span>
<span class="c"># 正式工作开始了！！！</span>
<span class="c">#########################################################</span>

<span class="c">#########################################################</span>
<span class="c"># 1. 查找base目录和mysqld所在目录</span>
<span class="c">#########################################################</span>
<span class="k">if</span> <span class="nb">echo</span> <span class="s1">&#39;/opt/mysql-5.7/share&#39;</span> <span class="p">|</span> grep <span class="s1">&#39;^/opt/mysql-5.7&#39;</span> &gt; /dev/null
<span class="k">then</span>
  <span class="c"># 一口气用了三个替换，分别为：</span>
  <span class="c"># 第一步：将/opt/mysql-5.7/share去除开始的basedir，转换为/share</span>
  <span class="c"># 第二步：将/share开头的/转换为空，也就是share</span>
  <span class="c"># 第三步：在share开头加上./，结果即：./share</span>
  <span class="nv">relpkgdata</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s1">&#39;/opt/mysql-5.7/share&#39;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s,^/opt/mysql-5.7,,&#39;</span> -e <span class="s1">&#39;s,^/,,&#39;</span> -e <span class="s1">&#39;s,^,./,&#39;</span><span class="sb">`</span>
<span class="k">else</span>
  <span class="c"># pkgdatadir is not relative to prefix</span>
  <span class="nv">relpkgdata</span><span class="o">=</span><span class="s1">&#39;/opt/mysql-5.7/share&#39;</span>
<span class="k">fi</span>

<span class="k">case</span> <span class="s2">&quot;$0&quot;</span> in
  /*<span class="o">)</span>
  <span class="nv">MY_PWD</span><span class="o">=</span><span class="s1">&#39;/opt/mysql-5.7&#39;</span>
  <span class="p">;;</span>
  *<span class="o">)</span>
  <span class="nv">MY_PWD</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
  <span class="nv">MY_PWD</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$MY_PWD</span><span class="sb">`</span>
  <span class="p">;;</span>
<span class="k">esac</span>

<span class="c"># 查找mysqld可执行文件，分别判断了libexec和sbin目录，找不到就使用bin目录</span>
<span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$MY_BASEDIR_VERSION&quot;</span> -a -d <span class="s2">&quot;$MY_BASEDIR_VERSION&quot;</span>
<span class="k">then</span>
  <span class="c"># BASEDIR is already overridden on command line.  Do not re-set.</span>

  <span class="c"># Use BASEDIR to discover le.</span>
  <span class="k">if</span> <span class="nb">test</span> -x <span class="s2">&quot;$MY_BASEDIR_VERSION/libexec/mysqld&quot;</span>
  <span class="k">then</span>
    <span class="nv">ledir</span><span class="o">=</span><span class="s2">&quot;$MY_BASEDIR_VERSION/libexec&quot;</span>
  <span class="k">elif</span> <span class="nb">test</span> -x <span class="s2">&quot;$MY_BASEDIR_VERSION/sbin/mysqld&quot;</span>
  <span class="k">then</span>
    <span class="nv">ledir</span><span class="o">=</span><span class="s2">&quot;$MY_BASEDIR_VERSION/sbin&quot;</span>
  <span class="k">else</span>
    <span class="nv">ledir</span><span class="o">=</span><span class="s2">&quot;$MY_BASEDIR_VERSION/bin&quot;</span>
  <span class="k">fi</span>
<span class="k">elif</span> <span class="nb">test</span> -f <span class="s2">&quot;$relpkgdata&quot;</span>/english/errmsg.sys -a -x <span class="s2">&quot;$MY_PWD/bin/mysqld&quot;</span>
<span class="k">then</span>
  <span class="nv">MY_BASEDIR_VERSION</span><span class="o">=</span><span class="s2">&quot;$MY_PWD&quot;</span>		<span class="c"># Where bin, share and data are</span>
  <span class="nv">ledir</span><span class="o">=</span><span class="s2">&quot;$MY_PWD/bin&quot;</span>			<span class="c"># Where mysqld is</span>
<span class="c"># Check for the directories we would expect from a source install</span>
<span class="k">elif</span> <span class="nb">test</span> -f <span class="s2">&quot;$relpkgdata&quot;</span>/english/errmsg.sys -a -x <span class="s2">&quot;$MY_PWD/libexec/mysqld&quot;</span>
<span class="k">then</span>
  <span class="nv">MY_BASEDIR_VERSION</span><span class="o">=</span><span class="s2">&quot;$MY_PWD&quot;</span>		<span class="c"># Where libexec, share and var are</span>
  <span class="nv">ledir</span><span class="o">=</span><span class="s2">&quot;$MY_PWD/libexec&quot;</span>		<span class="c"># Where mysqld is</span>
<span class="k">elif</span> <span class="nb">test</span> -f <span class="s2">&quot;$relpkgdata&quot;</span>/english/errmsg.sys -a -x <span class="s2">&quot;$MY_PWD/sbin/mysqld&quot;</span>
<span class="k">then</span>
  <span class="nv">MY_BASEDIR_VERSION</span><span class="o">=</span><span class="s2">&quot;$MY_PWD&quot;</span>		<span class="c"># Where sbin, share and var are</span>
  <span class="nv">ledir</span><span class="o">=</span><span class="s2">&quot;$MY_PWD/sbin&quot;</span>			<span class="c"># Where mysqld is</span>
<span class="c"># Since we didn&#39;t find anything, used the compiled-in defaults</span>
<span class="k">else</span>
  <span class="nv">MY_BASEDIR_VERSION</span><span class="o">=</span><span class="s1">&#39;/opt/mysql-5.7&#39;</span>
  <span class="nv">ledir</span><span class="o">=</span><span class="s1">&#39;/opt/mysql-5.7/bin&#39;</span>
<span class="k">fi</span>


<span class="c">#########################################################</span>
<span class="c"># 2. 查找base目录和mysqld所在目录</span>
<span class="c">#########################################################</span>
<span class="c"># 可以从my_print_defaults脚本中获得默认的读取my.cnf顺序，如下</span>
<span class="c">#   Default options are read from the following files in the given order:</span>
<span class="c">#   /etc/mysql/my.cnf /etc/my.cnf ~/.my.cnf</span>
<span class="c"># 2.1 查找下BASEDIR目录</span>
<span class="k">if</span> <span class="nb">test</span> -d <span class="nv">$MY_BASEDIR_VERSION</span>/data/mysql
<span class="k">then</span>
  <span class="nv">DATADIR</span><span class="o">=</span><span class="nv">$MY_BASEDIR_VERSION</span>/data
<span class="c"># Next try where the source installs put it</span>
<span class="k">elif</span> <span class="nb">test</span> -d <span class="nv">$MY_BASEDIR_VERSION</span>/var/mysql
<span class="k">then</span>
  <span class="nv">DATADIR</span><span class="o">=</span><span class="nv">$MY_BASEDIR_VERSION</span>/var
<span class="c"># Or just give up and use our compiled-in default</span>
<span class="k">else</span>
  <span class="nv">DATADIR</span><span class="o">=</span>/opt/data
<span class="k">fi</span>

<span class="k">if</span> <span class="nb">test</span> -z <span class="s2">&quot;$MYSQL_HOME&quot;</span>
<span class="k">then</span>
  <span class="nv">MYSQL_HOME</span><span class="o">=</span><span class="nv">$MY_BASEDIR_VERSION</span>
<span class="k">fi</span>
<span class="nb">export </span>MYSQL_HOME

<span class="c"># 2.2 找到my_print_defaults所在目录，并打印[mysqld]和[mysqld_safe]中的配置项，然后与从命令行</span>
<span class="c">#     传入的参数合并，优先级为</span>
<span class="k">if</span> <span class="nb">test</span> -x <span class="s2">&quot;$MY_BASEDIR_VERSION/bin/my_print_defaults&quot;</span>
<span class="k">then</span>
  <span class="nv">print_defaults</span><span class="o">=</span><span class="s2">&quot;$MY_BASEDIR_VERSION/bin/my_print_defaults&quot;</span>
<span class="k">elif</span> <span class="nb">test</span> -x <span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>/my_print_defaults
<span class="k">then</span>
  <span class="nv">print_defaults</span><span class="o">=</span><span class="s2">&quot;`dirname $0`/my_print_defaults&quot;</span>
<span class="k">elif</span> <span class="nb">test</span> -x ./bin/my_print_defaults
<span class="k">then</span>
  <span class="nv">print_defaults</span><span class="o">=</span><span class="s2">&quot;./bin/my_print_defaults&quot;</span>
<span class="k">elif</span> <span class="nb">test</span> -x /opt/mysql-5.7/bin/my_print_defaults
<span class="k">then</span>
  <span class="nv">print_defaults</span><span class="o">=</span><span class="s2">&quot;/opt/mysql-5.7/bin/my_print_defaults&quot;</span>
<span class="k">elif</span> <span class="nb">test</span> -x /opt/mysql-5.7/bin/mysql_print_defaults
<span class="k">then</span>
  <span class="nv">print_defaults</span><span class="o">=</span><span class="s2">&quot;/opt/mysql-5.7/bin/mysql_print_defaults&quot;</span>
<span class="k">else</span>
  <span class="nv">print_defaults</span><span class="o">=</span><span class="s2">&quot;my_print_defaults&quot;</span>
<span class="k">fi</span>

<span class="c"># 这个函数可以将一个指定的参数附加到$arg中(在此同时执行了转义操作)</span>
append_arg_to_args <span class="o">()</span> <span class="o">{</span>
  <span class="nv">args</span><span class="o">=</span><span class="s2">&quot;$args &quot;</span><span class="sb">`</span>shell_quote_string <span class="s2">&quot;$1&quot;</span><span class="sb">`</span>
<span class="o">}</span>
<span class="nv">args</span><span class="o">=</span>

<span class="c"># 通过SET_USER变量判断来源，2：初始值；1：配置文件或者命令行中配置；0：没有配置</span>
<span class="nv">SET_USER</span><span class="o">=</span>2
<span class="c"># 解析配置文件中的参数，只显示[mysqld]和[server]分组中的内容</span>
parse_arguments <span class="sb">`</span><span class="nv">$print_defaults</span> <span class="nv">$defaults</span> --loose-verbose mysqld server<span class="sb">`</span>
<span class="k">if</span> <span class="nb">test</span> <span class="nv">$SET_USER</span> -eq 2
<span class="k">then</span>
 <span class="nv">SET_USER</span><span class="o">=</span>0
<span class="k">fi</span>
<span class="c"># 如上，又读取[safe_mysqld]和[mysqld_safe]分组中配置项</span>
parse_arguments <span class="sb">`</span><span class="nv">$print_defaults</span> <span class="nv">$defaults</span> --loose-verbose mysqld_safe safe_mysqld<span class="sb">`</span>
<span class="c"># 用命令行输入选项，也就是$@，从而可以覆盖配置文件中的选项</span>
parse_arguments PICK-ARGS-FROM-ARGV <span class="s2">&quot;$@&quot;</span>

<span class="c"># Sort out date command from $timestamp_format early so we&#39;ll start off</span>
<span class="c"># with correct log messages.</span>
<span class="k">case</span> <span class="s2">&quot;$timestamp_format&quot;</span> in
    UTC<span class="p">|</span>utc<span class="o">)</span>       <span class="nv">DATE</span><span class="o">=</span><span class="s2">&quot;date -u +%Y-%m-%dT%H:%M:%S.%06NZ&quot;</span><span class="p">;;</span>
    SYSTEM<span class="p">|</span>system<span class="o">)</span> <span class="nv">DATE</span><span class="o">=</span><span class="s2">&quot;date +%Y-%m-%dT%H:%M:%S.%06N%:z&quot;</span><span class="p">;;</span>
    HYPHEN<span class="p">|</span>hyphen<span class="o">)</span> <span class="nv">DATE</span><span class="o">=</span><span class="s2">&quot;date +&#39;%Y-%m-%d %H:%M:%S&#39;&quot;</span><span class="p">;;</span>
    LEGACY<span class="p">|</span>legacy<span class="o">)</span> <span class="nv">DATE</span><span class="o">=</span><span class="s2">&quot;date +&#39;%y%m%d %H:%M:%S&#39;&quot;</span><span class="p">;;</span>
    *<span class="o">)</span>             <span class="nv">DATE</span><span class="o">=</span><span class="s2">&quot;date -u +%Y-%m-%dT%H:%M:%S.%06NZ&quot;</span><span class="p">;</span>
                   log_error <span class="s2">&quot;unknown data format $timestamp_format, using UTC&quot;</span><span class="p">;;</span>
<span class="k">esac</span>

<span class="c"># 2.3 查找plugin目录</span>
<span class="c"># Use user-supplied argument</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;${PLUGIN_DIR}&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">plugin_dir</span><span class="o">=</span><span class="s2">&quot;${PLUGIN_DIR}&quot;</span>
<span class="k">else</span>
  <span class="c"># Try to find plugin dir relative to basedir</span>
  <span class="k">for</span> dir in lib64/mysql/plugin lib64/plugin lib/mysql/plugin lib/plugin
  <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;${MY_BASEDIR_VERSION}/${dir}&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      <span class="nv">plugin_dir</span><span class="o">=</span><span class="s2">&quot;${MY_BASEDIR_VERSION}/${dir}&quot;</span>
      <span class="nb">break</span>
<span class="nb">    </span><span class="k">fi</span>
  <span class="k">done</span>
  <span class="c"># Give up and use compiled-in default</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;${plugin_dir}&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">plugin_dir</span><span class="o">=</span><span class="s1">&#39;/opt/mysql-5.7/lib/plugin&#39;</span>
  <span class="k">fi</span>
<span class="k">fi</span>
<span class="nv">plugin_dir</span><span class="o">=</span><span class="s2">&quot;${plugin_dir}${PLUGIN_VARIANT}&quot;</span>

<span class="c"># A pid file is created for the mysqld_safe process. This file protects the</span>
<span class="c"># server instance resources during race conditions.</span>
<span class="nv">safe_pid</span><span class="o">=</span><span class="s2">&quot;$DATADIR/mysqld_safe.pid&quot;</span>
<span class="k">if</span> <span class="nb">test</span> -f <span class="nv">$safe_pid</span>
<span class="k">then</span>
  <span class="nv">PID</span><span class="o">=</span><span class="sb">`</span>cat <span class="s2">&quot;$safe_pid&quot;</span><span class="sb">`</span>
  <span class="k">if</span> <span class="nb">kill</span> -0 <span class="nv">$PID</span> &gt; /dev/null 2&gt; /dev/null
  <span class="k">then</span>
    <span class="k">if</span> ps wwwp <span class="nv">$PID</span> <span class="p">|</span> grep -v mysqld_safe <span class="p">|</span> grep -- <span class="nv">$MYSQLD</span> &gt; /dev/null
    <span class="k">then</span>
      log_error <span class="s2">&quot;A mysqld_safe process already exists&quot;</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$safe_pid&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    rm -f <span class="s2">&quot;$safe_pid&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="nb">test</span> -f <span class="s2">&quot;$safe_pid&quot;</span>
  <span class="k">then</span>
    log_error <span class="s2">&quot;Fatal error: Can&#39;t remove the mysqld_safe pid file&quot;</span>
    <span class="nb">exit </span>1
  <span class="k">fi</span>
<span class="k">fi</span>

<span class="c"># Insert pid proerply into the pid file.</span>
ps -e <span class="p">|</span> grep  <span class="o">[</span>m<span class="o">]</span>ysqld_safe <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> sed -n 1p &gt; <span class="nv">$safe_pid</span>
<span class="c"># End of mysqld_safe pid(safe_pid) check.</span>



<span class="c">#########################################################</span>
<span class="c"># log日志方式设置，共stdin,file,syslog三种</span>
<span class="c">#########################################################</span>

<span class="c"># 如果是写入到syslog，则判断logger工具是否可用</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$want_syslog</span> -eq <span class="m">1</span> <span class="o">]</span>
<span class="k">then</span>
  my_which logger &gt; /dev/null 2&gt;<span class="p">&amp;</span>1
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span>
  <span class="k">then</span>
    log_error <span class="s2">&quot;--syslog requested, but no &#39;logger&#39; program found.  Please ensure</span>
<span class="s2">     that &#39;logger&#39; is in your PATH, or do not specify the --syslog option to mysqld_safe.&quot;</span>
    <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$safe_pid&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      rm -f <span class="s2">&quot;$safe_pid&quot;</span>                 <span class="c"># Clean Up of mysqld_safe.pid file.</span>
    <span class="k">fi</span>
    <span class="nb">exit </span>1
  <span class="k">fi</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$want_syslog</span> -eq <span class="m">1</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$syslog_tag&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="c"># Sanitize the syslog tag</span>
    <span class="nv">syslog_tag</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">&quot;$syslog_tag&quot;</span> <span class="p">|</span> sed -e <span class="s1">&#39;s/[^a-zA-Z0-9_-]/_/g&#39;</span><span class="sb">`</span>
    <span class="nv">syslog_tag_mysqld_safe</span><span class="o">=</span><span class="s2">&quot;${syslog_tag_mysqld_safe}-$syslog_tag&quot;</span>
    <span class="nv">syslog_tag_mysqld</span><span class="o">=</span><span class="s2">&quot;${syslog_tag_mysqld}-$syslog_tag&quot;</span>
  <span class="k">fi</span>
  log_notice <span class="s2">&quot;Logging to syslog.&quot;</span>
  <span class="nv">logging</span><span class="o">=</span>syslog
<span class="k">fi</span>
<span class="c"># 如果是将日志记录到文件中</span>
<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$err_log&quot;</span> -o <span class="nv">$want_syslog</span> -eq <span class="m">0</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$err_log&quot;</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="c"># 如果没有.err后缀，则为err_log添加一个；此时，mysqld和mysqld_safe会写入到</span>
    <span class="c"># 同一个日志文件中。如果是&quot;--log-error=foo.&quot;则认为文件名是有效的</span>

    <span class="c"># 这里是识别文件名的字符总数量(包括.)，如果没有设置后缀或者以&#39;/&#39;结尾则返回0</span>
    <span class="k">if</span> expr <span class="s2">&quot;$err_log&quot;</span> : <span class="s1">&#39;.*\.[^/]*$&#39;</span> &gt; /dev/null
    <span class="k">then</span>
        :
    <span class="k">else</span>
      <span class="nv">err_log</span><span class="o">=</span><span class="s2">&quot;$err_log&quot;</span>.err
    <span class="k">fi</span>

    <span class="k">case</span> <span class="s2">&quot;$err_log&quot;</span> in
      /* <span class="o">)</span> <span class="p">;;</span>
      * <span class="o">)</span> <span class="nv">err_log</span><span class="o">=</span><span class="s2">&quot;$DATADIR/$err_log&quot;</span> <span class="p">;;</span>
    <span class="k">esac</span>
  <span class="k">else</span>
    <span class="c"># 默认设置的错误日志名称</span>
    <span class="nv">err_log</span><span class="o">=</span><span class="nv">$DATADIR</span>/<span class="sb">`</span>hostname<span class="sb">`</span>.err
  <span class="k">fi</span>

  <span class="c"># 同时会将该参数添加到mysqld启动的参数中</span>
  append_arg_to_args <span class="s2">&quot;--log-error=$err_log&quot;</span>

  <span class="c"># 提示日志写入到的文件名称</span>
  log_notice <span class="s2">&quot;Logging to &#39;$err_log&#39;.&quot;</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$want_syslog</span> -eq <span class="m">1</span> <span class="o">]</span>
  <span class="k">then</span>
    <span class="nv">logging</span><span class="o">=</span>both
  <span class="k">else</span>
    <span class="nv">logging</span><span class="o">=</span>file <span class="c"># 正式把logging改成file使用错误日志来记录日志</span>
  <span class="k">fi</span>

  <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;$err_log&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>                  <span class="c"># if error log already exists,</span>
    touch <span class="s2">&quot;$err_log&quot;</span>                            <span class="c"># we just append. otherwise,</span>
    chmod <span class="s2">&quot;$fmode&quot;</span> <span class="s2">&quot;$err_log&quot;</span>                   <span class="c"># fix the permissions here!</span>
  <span class="k">fi</span>
<span class="k">fi</span>


<span class="c"># 设置--user选项</span>
<span class="nv">USER_OPTION</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">if</span> <span class="nb">test</span> -w / -o <span class="s2">&quot;$USER&quot;</span> <span class="o">=</span> <span class="s2">&quot;root&quot;</span> <span class="c"># 根目录是否可写，或者当前用户为root</span>
<span class="k">then</span>
  <span class="k">if</span> <span class="nb">test</span> <span class="s2">&quot;$user&quot;</span> !<span class="o">=</span> <span class="s2">&quot;root&quot;</span> -o <span class="nv">$SET_USER</span> <span class="o">=</span> 1
  <span class="k">then</span>
    <span class="nv">USER_OPTION</span><span class="o">=</span><span class="s2">&quot;--user=$user&quot;</span>
  <span class="k">fi</span>
  <span class="c"># 创建错误日志，并将日志授权给指定的用户</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nv">$want_syslog</span> -eq <span class="m">0</span> -a ! -h <span class="s2">&quot;$err_log&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    touch <span class="s2">&quot;$err_log&quot;</span>
    chown <span class="nv">$user</span> <span class="s2">&quot;$err_log&quot;</span>
  <span class="k">fi</span>
  <span class="c"># 这里它还对当前用户做了ulimit设置，包括可以打开的文件数量--open_files-limit选项</span>
  <span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$open_files&quot;</span>
  <span class="k">then</span>
    <span class="nb">ulimit</span> -n <span class="nv">$open_files</span>
  <span class="k">fi</span>
<span class="k">fi</span>

<span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$open_files&quot;</span>
<span class="k">then</span>
  append_arg_to_args <span class="s2">&quot;--open-files-limit=$open_files&quot;</span>
<span class="k">fi</span>

<span class="nv">safe_mysql_unix_port</span><span class="o">=</span><span class="k">${</span><span class="nv">mysql_unix_port</span><span class="k">:-${</span><span class="nv">MYSQL_UNIX_PORT</span><span class="k">:-</span><span class="p">/tmp/mysql.sock</span><span class="k">}}</span>
<span class="c"># 确保 $safe_mysql_unix_port 目录是存在的</span>
<span class="c"># Make sure that directory for $safe_mysql_unix_port exists</span>
<span class="nv">mysql_unix_port_dir</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$safe_mysql_unix_port</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$mysql_unix_port_dir</span> <span class="o">]</span>
<span class="k">then</span>
  <span class="k">if</span> <span class="o">[</span> ! -h <span class="nv">$mysql_unix_port_dir</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    mkdir <span class="nv">$mysql_unix_port_dir</span>
    chown <span class="nv">$user</span> <span class="nv">$mysql_unix_port_dir</span>
    chmod <span class="m">755</span> <span class="nv">$mysql_unix_port_dir</span>
  <span class="k">fi</span>
<span class="k">fi</span>

<span class="c"># 如果用户没有制定mysqld程序的名称，这里就默认赋值为mysqld</span>
<span class="c"># If the user doesn&#39;t specify a binary, we assume name &quot;mysqld&quot;</span>
<span class="k">if</span> <span class="nb">test</span> -z <span class="s2">&quot;$MYSQLD&quot;</span>
<span class="k">then</span>
  <span class="nv">MYSQLD</span><span class="o">=</span>mysqld
<span class="k">fi</span>

<span class="c"># 下面几段分别是对 mysqld ， pid ， port文件选项的检查和设置，省略100个字</span>
<span class="k">if</span> <span class="nb">test</span> ! -x <span class="s2">&quot;$ledir/$MYSQLD&quot;</span>
<span class="k">then</span>
  log_error <span class="s2">&quot;The file $ledir/$MYSQLD</span>
<span class="s2">does not exist or is not executable. Please cd to the mysql installation</span>
<span class="s2">directory and restart this script from there as follows:</span>
<span class="s2">./bin/mysqld_safe&amp;</span>
<span class="s2">See http://dev.mysql.com/doc/mysql/en/mysqld-safe.html for more information&quot;</span>
  <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$safe_pid&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    rm -f <span class="s2">&quot;$safe_pid&quot;</span>                 <span class="c"># Clean Up of mysqld_safe.pid file.</span>
  <span class="k">fi</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="k">if</span> <span class="nb">test</span> -z <span class="s2">&quot;$pid_file&quot;</span>
<span class="k">then</span>
  <span class="nv">pid_file</span><span class="o">=</span><span class="s2">&quot;$DATADIR/`hostname`.pid&quot;</span>
<span class="k">else</span>
  <span class="k">case</span> <span class="s2">&quot;$pid_file&quot;</span> in
    /* <span class="o">)</span> <span class="p">;;</span>
    * <span class="o">)</span>  <span class="nv">pid_file</span><span class="o">=</span><span class="s2">&quot;$DATADIR/$pid_file&quot;</span> <span class="p">;;</span>
  <span class="k">esac</span>
<span class="k">fi</span>
append_arg_to_args <span class="s2">&quot;--pid-file=$pid_file&quot;</span>

<span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$mysql_unix_port&quot;</span>
<span class="k">then</span>
  append_arg_to_args <span class="s2">&quot;--socket=$mysql_unix_port&quot;</span>
<span class="k">fi</span>
<span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$mysql_tcp_port&quot;</span>
<span class="k">then</span>
  append_arg_to_args <span class="s2">&quot;--port=$mysql_tcp_port&quot;</span>
<span class="k">fi</span>

<span class="c"># 接下来是关于优先级的设置</span>
<span class="k">if</span> <span class="nb">test</span> <span class="nv">$niceness</span> -eq 0
<span class="k">then</span>
  <span class="nv">NOHUP_NICENESS</span><span class="o">=</span><span class="s2">&quot;nohup&quot;</span>
<span class="k">else</span>
  <span class="nv">NOHUP_NICENESS</span><span class="o">=</span><span class="s2">&quot;nohup nice -$niceness&quot;</span>
<span class="k">fi</span>

<span class="c"># Using nice with no args to get the niceness level is GNU-specific.</span>
<span class="c"># This check could be extended for other operating systems (e.g.,</span>
<span class="c"># BSD could use &quot;nohup sh -c &#39;ps -o nice -p $$&#39; | tail -1&quot;).</span>
<span class="c"># But, it also seems that GNU nohup is the only one which messes</span>
<span class="c"># with the priority, so this is okay.</span>
<span class="c"># 将当前的默认优先级设置为0</span>
<span class="k">if</span> nohup nice &gt; /dev/null 2&gt;<span class="p">&amp;</span>1
<span class="k">then</span>
  <span class="c"># normal_niceness记载默认的调度优先级</span>
    <span class="nv">normal_niceness</span><span class="o">=</span><span class="sb">`</span>nice<span class="sb">`</span>
  <span class="c"># nohup_niceness记载使用nohup执行方式的调度优先级</span>
    <span class="nv">nohup_niceness</span><span class="o">=</span><span class="sb">`</span>nohup nice 2&gt;/dev/null<span class="sb">`</span>

    <span class="nv">numeric_nice_values</span><span class="o">=</span>1
  <span class="c"># 这个for是为了检查$normal_niceness $nohup_niceness两个变量值的合法性</span>
    <span class="k">for</span> val in <span class="nv">$normal_niceness</span> <span class="nv">$nohup_niceness</span>
    <span class="k">do</span>
        <span class="k">case</span> <span class="s2">&quot;$val&quot;</span> in
            -<span class="o">[</span>0-9<span class="o">]</span> <span class="p">|</span> -<span class="o">[</span>0-9<span class="o">][</span>0-9<span class="o">]</span> <span class="p">|</span> -<span class="o">[</span>0-9<span class="o">][</span>0-9<span class="o">][</span>0-9<span class="o">]</span> <span class="p">|</span> <span class="se">\</span>
             <span class="o">[</span>0-9<span class="o">]</span> <span class="p">|</span>  <span class="o">[</span>0-9<span class="o">][</span>0-9<span class="o">]</span> <span class="p">|</span>  <span class="o">[</span>0-9<span class="o">][</span>0-9<span class="o">][</span>0-9<span class="o">]</span> <span class="o">)</span>
                <span class="p">;;</span>
            * <span class="o">)</span>
                <span class="nv">numeric_nice_values</span><span class="o">=</span><span class="m">0</span> <span class="p">;;</span>
        <span class="k">esac</span>
    <span class="k">done</span>

  <span class="c"># 这个判断结构很重要</span>
  <span class="c"># 它保证了使用nohup执行的mysqld程序在调度优先级上不会低于直接执行mysqld程序的方式</span>
    <span class="k">if</span> <span class="nb">test</span> <span class="nv">$numeric_nice_values</span> -eq 1
    <span class="k">then</span>
        <span class="nv">nice_value_diff</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$nohup_niceness</span> - <span class="nv">$normal_niceness</span><span class="sb">`</span>
        <span class="k">if</span> <span class="nb">test</span> <span class="nv">$?</span> -eq <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="nv">$nice_value_diff</span> -gt <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
            nice --<span class="nv">$nice_value_diff</span> <span class="nb">echo </span>testing &gt; /dev/null 2&gt;<span class="p">&amp;</span>1
        <span class="k">then</span>
            <span class="c"># nohup increases the priority (bad), and we are permitted</span>
            <span class="c"># to lower the priority with respect to the value the user</span>
            <span class="c"># might have been given</span>
      <span class="c"># 进入分支说明$nohup_niceness的值比$normal_niceness大，即nohup执行方式调度优先级比正常执行方式低</span>
      <span class="c"># 这是不希望看到的，所以下面就人为的提升了nohup的优先级（降低niceness的值）</span>
            <span class="nv">niceness</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$niceness</span> - <span class="nv">$nice_value_diff</span><span class="sb">`</span>
            <span class="nv">NOHUP_NICENESS</span><span class="o">=</span><span class="s2">&quot;nice -$niceness nohup&quot;</span>
        <span class="k">fi</span>
    <span class="k">fi</span>
<span class="k">else</span>
  <span class="c"># 下面是测试nohup在当前系统中是否可用，不可用的话就置空NOHUP_NICENESS</span>
    <span class="k">if</span> nohup <span class="nb">echo </span>testing &gt; /dev/null 2&gt;<span class="p">&amp;</span>1
    <span class="k">then</span>
        :
    <span class="k">else</span>
        <span class="c"># nohup doesn&#39;t work on this system</span>
        <span class="nv">NOHUP_NICENESS</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>

<span class="c"># Try to set the core file size (even if we aren&#39;t root) because many systems</span>
<span class="c"># don&#39;t specify a hard limit on core file size.</span>
<span class="c"># 指定core file大小，即使非root用户也尝试设置</span>
<span class="k">if</span> <span class="nb">test</span> -n <span class="s2">&quot;$core_file_size&quot;</span>
<span class="k">then</span>
  <span class="nb">ulimit</span> -c <span class="nv">$core_file_size</span>
<span class="k">fi</span>


<span class="c"># 如果已经存在一个pid文件，则检查是否有已经启动的mysqld进程，如果已经启动则退出</span>
<span class="k">if</span> <span class="nb">test</span> -f <span class="s2">&quot;$pid_file&quot;</span>
<span class="k">then</span>
  <span class="nv">PID</span><span class="o">=</span><span class="sb">`</span>cat <span class="s2">&quot;$pid_file&quot;</span><span class="sb">`</span>
  <span class="c"># 检查进程是否存在</span>
  <span class="k">if</span> <span class="nb">kill</span> -0 <span class="nv">$PID</span> &gt; /dev/null 2&gt; /dev/null
  <span class="k">then</span>
    <span class="k">if</span> ps wwwp <span class="nv">$PID</span> <span class="p">|</span> grep -v mysqld_safe <span class="p">|</span> grep -- <span class="nv">$MYSQLD</span> &gt; /dev/null
    <span class="k">then</span>    <span class="c"># The pid contains a mysqld process</span>
      log_error <span class="s2">&quot;A mysqld process already exists&quot;</span>
      <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$safe_pid&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        rm -f <span class="s2">&quot;$safe_pid&quot;</span>                 <span class="c"># Clean Up of mysqld_safe.pid file.</span>
      <span class="k">fi</span>
      <span class="nb">exit </span>1
    <span class="k">fi</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$pid_file&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      rm -f <span class="s2">&quot;$pid_file&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="nb">test</span> -f <span class="s2">&quot;$pid_file&quot;</span>
  <span class="k">then</span>
    log_error <span class="s2">&quot;Fatal error: Can&#39;t remove the pid file:</span>
<span class="s2">$pid_file</span>
<span class="s2">Please remove it manually and start $0 again;</span>
<span class="s2">mysqld daemon not started&quot;</span>
    <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$safe_pid&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
      rm -f <span class="s2">&quot;$safe_pid&quot;</span>                 <span class="c"># Clean Up of mysqld_safe.pid file.</span>
    <span class="k">fi</span>
    <span class="nb">exit </span>1
  <span class="k">fi</span>
<span class="k">fi</span>

<span class="c">#</span>
<span class="c"># Uncomment the following lines if you want all tables to be automatically</span>
<span class="c"># checked and repaired during startup. You should add sensible key_buffer</span>
<span class="c"># and sort_buffer values to my.cnf to improve check performance or require</span>
<span class="c"># less disk space.</span>
<span class="c"># Alternatively, you can start mysqld with the &quot;myisam-recover&quot; option. See</span>
<span class="c"># the manual for details.</span>
<span class="c">#</span>
<span class="c"># echo &quot;Checking tables in $DATADIR&quot;</span>
<span class="c"># $MY_BASEDIR_VERSION/bin/myisamchk --silent --force --fast --medium-check $DATADIR/*/*.MYI</span>
<span class="c"># $MY_BASEDIR_VERSION/bin/isamchk --silent --force $DATADIR/*/*.ISM</span>

<span class="c"># Does this work on all systems?</span>
<span class="c">#if type ulimit | grep &quot;shell builtin&quot; &gt; /dev/null</span>
<span class="c">#then</span>
<span class="c">#  ulimit -n 256 &gt; /dev/null 2&gt;&amp;1		# Fix for BSD and FreeBSD systems</span>
<span class="c">#fi</span>


<span class="c">#########################################################</span>
<span class="c"># 开始拼接执行语句</span>
<span class="c">#########################################################</span>
<span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;`mysqld_ld_preload_text`$NOHUP_NICENESS&quot;</span>

<span class="c"># 检查一下命令以及参数，如果需要则进行转义操作</span>
<span class="k">for</span> i in  <span class="s2">&quot;$ledir/$MYSQLD&quot;</span> <span class="s2">&quot;$defaults&quot;</span> <span class="s2">&quot;--basedir=$MY_BASEDIR_VERSION&quot;</span> <span class="se">\</span>
  <span class="s2">&quot;--datadir=$DATADIR&quot;</span> <span class="s2">&quot;--plugin-dir=$plugin_dir&quot;</span> <span class="s2">&quot;$USER_OPTION&quot;</span>
<span class="k">do</span>
  <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;$cmd &quot;</span><span class="sb">`</span>shell_quote_string <span class="s2">&quot;$i&quot;</span><span class="sb">`</span>
<span class="k">done</span>
<span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;$cmd $args&quot;</span>
<span class="c"># Avoid &#39;nohup: ignoring input&#39; warning</span>
<span class="nb">test</span> -n <span class="s2">&quot;$NOHUP_NICENESS&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">cmd</span><span class="o">=</span><span class="s2">&quot;$cmd &lt; /dev/null&quot;</span>

log_notice <span class="s2">&quot;Starting $MYSQLD daemon with databases from $DATADIR&quot;</span>

<span class="c"># variable to track the current number of &quot;fast&quot; (a.k.a. subsecond) restarts</span>
<span class="nv">fast_restart</span><span class="o">=</span>0
<span class="c"># maximum number of restarts before trottling kicks in</span>
<span class="nv">max_fast_restarts</span><span class="o">=</span>5
<span class="c"># flag whether a usable sleep command exists</span>
<span class="nv">have_sleep</span><span class="o">=</span>1


<span class="c">#########################################################</span>
<span class="c"># 后台循环，如果mysqld宕，会尝试自动拉起服务进程</span>
<span class="c">#########################################################</span>
<span class="k">while</span> <span class="nb">true</span>
<span class="k">do</span>
  <span class="c"># 一些安全性检查，如果如下文件存在则删除</span>
  <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$safe_mysql_unix_port&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    rm -f <span class="s2">&quot;$safe_mysql_unix_port&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$pid_file&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    rm -f <span class="s2">&quot;$pid_file&quot;</span>
  <span class="k">fi</span>
  <span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$pid_file.shutdown&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
     rm -f  <span class="s2">&quot;$pid_file.shutdown&quot;</span>
  <span class="k">fi</span>

  <span class="nv">start_time</span><span class="o">=</span><span class="sb">`</span>date +%M%S<span class="sb">`</span>

  <span class="c"># 传入$cmd参数的值，会使用eval命令启动mysqld</span>
  eval_log_error <span class="s2">&quot;$cmd&quot;</span>

  <span class="k">if</span> <span class="o">[</span> <span class="nv">$want_syslog</span> -eq <span class="m">0</span> -a ! -f <span class="s2">&quot;$err_log&quot;</span> -a ! -h <span class="s2">&quot;$err_log&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    touch <span class="s2">&quot;$err_log&quot;</span>                    <span class="c"># hypothetical: log was renamed but not</span>
    chown <span class="nv">$user</span> <span class="s2">&quot;$err_log&quot;</span>              <span class="c"># flushed yet. we&#39;d recreate it with</span>
    chmod <span class="s2">&quot;$fmode&quot;</span> <span class="s2">&quot;$err_log&quot;</span>           <span class="c"># wrong owner next time we log, so set</span>
  <span class="k">fi</span>                                    <span class="c"># it up correctly while we can!</span>

  <span class="nv">end_time</span><span class="o">=</span><span class="sb">`</span>date +%M%S<span class="sb">`</span>

  <span class="c"># 如果正常关闭，也就是检查PID文件被正常删除，则退出分支，不尝试重启进程</span>
  <span class="k">if</span> <span class="nb">test</span> ! -f <span class="s2">&quot;$pid_file&quot;</span>		<span class="c"># This is removed if normal shutdown</span>
  <span class="k">then</span>
    <span class="nb">break</span>
<span class="nb">  </span><span class="k">fi</span>

  <span class="c"># 在进程宕之后，如果不希望重启则直接退出mysqld_safe</span>
  <span class="k">if</span> <span class="nb">test</span> -f <span class="s2">&quot;$pid_file.shutdown&quot;</span>	<span class="c"># created to signal that it must stop</span>
  <span class="k">then</span>
    log_notice <span class="s2">&quot;$pid_file.shutdown present. The server will not restart.&quot;</span>
    <span class="nb">break</span>
<span class="nb">  </span><span class="k">fi</span>


  <span class="c"># sanity check if time reading is sane and there&#39;s sleep</span>
  <span class="k">if</span> <span class="nb">test</span> <span class="nv">$end_time</span> -gt <span class="m">0</span> -a <span class="nv">$have_sleep</span> -gt 0
  <span class="k">then</span>
    <span class="c"># 如果在一秒以内完成重启，则尝试睡眠1秒</span>
    <span class="k">if</span> <span class="nb">test</span> <span class="nv">$end_time</span> -eq <span class="nv">$start_time</span>
    <span class="k">then</span>
      <span class="nv">fast_restart</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$fast_restart</span> + 1<span class="sb">`</span>
      <span class="k">if</span> <span class="nb">test</span> <span class="nv">$fast_restart</span> -ge <span class="nv">$max_fast_restarts</span>
      <span class="k">then</span>
        log_notice <span class="s2">&quot;The server is respawning too fast. Sleeping for 1 second.&quot;</span>
        sleep 1
        <span class="nv">sleep_state</span><span class="o">=</span><span class="nv">$?</span>
        <span class="k">if</span> <span class="nb">test</span> <span class="nv">$sleep_state</span> -gt 0
        <span class="k">then</span>
          log_notice <span class="s2">&quot;The server is respawning too fast and no working sleep command. Turning off trottling.&quot;</span>
          <span class="nv">have_sleep</span><span class="o">=</span>0
        <span class="k">fi</span>

        <span class="nv">fast_restart</span><span class="o">=</span>0
      <span class="k">fi</span>
    <span class="k">else</span>
      <span class="nv">fast_restart</span><span class="o">=</span>0
    <span class="k">fi</span>
  <span class="k">fi</span>

  <span class="c"># mysqld_safe已经启动的处理方法，保证只有一个mysqld_safe程序启动</span>
  <span class="k">if</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="nb">test</span> <span class="nv">$KILL_MYSQLD</span> -eq 1
  <span class="k">then</span>
    <span class="c"># 统计启动的mysqld进程的数目:A)正常为0；B)进程hang，为1；C)有历史进程hang，为多个</span>
    <span class="nv">numofproces</span><span class="o">=</span><span class="sb">`</span>ps xaww <span class="p">|</span> grep -v <span class="s2">&quot;grep&quot;</span> <span class="p">|</span> grep <span class="s2">&quot;$ledir/$MYSQLD\&gt;&quot;</span> <span class="p">|</span> grep -c <span class="s2">&quot;pid-file=$pid_file&quot;</span><span class="sb">`</span>

    log_notice <span class="s2">&quot;Number of processes running now: $numofproces&quot;</span>
    <span class="nv">I</span><span class="o">=</span>1
    <span class="k">while</span> <span class="nb">test</span> <span class="s2">&quot;$I&quot;</span> -le <span class="s2">&quot;$numofproces&quot;</span>
    <span class="k">do</span>
      <span class="c"># 过滤启动的MySQL服务进程，通过sed -n &#39;$p&#39;每次只获取最后一行记录</span>
      <span class="nv">PROC</span><span class="o">=</span><span class="sb">`</span>ps xaww <span class="p">|</span> grep <span class="s2">&quot;$ledir/$MYSQLD\&gt;&quot;</span> <span class="p">|</span> grep -v <span class="s2">&quot;grep&quot;</span> <span class="p">|</span> grep <span class="s2">&quot;pid-file=$pid_file&quot;</span> <span class="p">|</span> sed -n <span class="s1">&#39;$p&#39;</span><span class="sb">`</span>

      <span class="c"># 上述过滤的第一列为进程ID，使用T变量来获取进程ID</span>
      <span class="k">for</span> T in <span class="nv">$PROC</span>
      <span class="k">do</span>
        <span class="nb">break</span>
<span class="nb">      </span><span class="k">done</span>

      <span class="c"># 因为已经hang了，直接kill -9强制删除</span>
      <span class="k">if</span> <span class="nb">kill</span> -9 <span class="nv">$T</span>
      <span class="k">then</span>
        log_error <span class="s2">&quot;$MYSQLD process hanging, pid $T - killed&quot;</span>
      <span class="k">else</span>
        <span class="nb">break</span>
<span class="nb">      </span><span class="k">fi</span>

      <span class="c"># 每干掉一个mysqld就把I加一，如果有N个mysqld进程，则执行N次kill -9命令</span>
      <span class="nv">I</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$I</span> + 1<span class="sb">`</span>
    <span class="k">done</span>
  <span class="k">fi</span>

  log_notice <span class="s2">&quot;mysqld restarted&quot;</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$pid_file.shutdown&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  rm -f <span class="s2">&quot;$pid_file.shutdown&quot;</span>
<span class="k">fi</span>

log_notice <span class="s2">&quot;mysqld from pid file $pid_file ended&quot;</span>

<span class="k">if</span> <span class="o">[</span> ! -h <span class="s2">&quot;$safe_pid&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  rm -f <span class="s2">&quot;$safe_pid&quot;</span>                       <span class="c"># Some Extra Safety. File is deleted</span>
<span class="k">fi</span>                                        <span class="c"># once the mysqld process ends.</span></code></pre></figure>

<p>简单来说，mysqld_safe 会执行如下命令，其中参数会转换为绝对路径。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ nohup mysqld ... &lt; /dev/null &gt;&gt; localhost.err 2&gt;&amp;1</code></pre></figure>


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/mysql-introduce.html" title="MySQL 简介">&larr; Older</a></li> 
         <li class="next"><a href="/post/mysql-basic.html" title="MySQL 基本介绍">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1428595200',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/mysql-mysqld-safe.html" data-title="MySQL 启动脚本" data-url="/post/mysql-mysqld-safe.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
