<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
  <meta name="baidu-site-verification" content="B786jeR0MV" />
  <meta name="msvalidate.01" content="29F791E7F785800340E37AD7C714D2A7" />
  <meta name="google-site-verification" content="p7jJ5d3kF9yxRhpIo5GgHXAZ1ATKVyZhV2kf6mEGOv0" />
  <title>MySQL Performance Schema|JinYang's Blog</title>
  <meta name="keywords" content="">
  <meta name="description" content="">

  <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
  <script type="text/javascript">
  !window.jQuery && document.write('<script src="/static/js/jquery.min.js"><\/script>');
  </script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
  <script type="text/javascript">
  !$('body').popover && document.write('<script src="/static/js/bootstrap.min.js"><\/script>');
  </script>
  <script type="text/javascript" src="/static/js/main.js"></script>
  <!-- <link rel="stylesheet prefetch" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/bootstrap.min.css">
  <!-- <link href="http://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/font-awesome.min.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/pygments.css">
  <link type="text/css" rel="stylesheet prefetch" href="/static/css/screen.css">
  <style type="text/css">
  
    .post-container > p {text-indent: 2em;}
  
  </style>
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-124556620-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-124556620-1');
</script>

</head>

<body>
<nav class="navbar navbar-default navbar-inverse navbar-fixed-top navbar-wrapper">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span>
      </button><a class="navbar-brand" href="/">Jin-Yang</a>
    </div>
    <div id="navbar" class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
        <li  ><a href="/"> Home </a></li>
        <li  ><a href="/archives.html"> Archive </a></li>
        <li  ><a href="/categories.html"> Categories </a></li>
        <li  ><a href="/projects.html"> Projects </a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"> Others <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li class="dropdown-header">常用网站</li>
            <li role="separator" class="divider"></li>
            <li><a href="https://www.rtems.org/">www.rtems.org</a></li>
            <li><a href="http://www.gnu.org/">www.gnu.org</a></li>
            <li><a href="https://www.kernel.org/">www.kernel.org</a></li>
            <li><a href="https://www.arduino.cc/">www.arduino.cc</a></li>
          </ul>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li  ><a href="/about.html"> About </a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</nav>

<div id="myCarousel" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
    <li data-target="#myCarousel" data-slide-to="1"></li>
    <li data-target="#myCarousel" data-slide-to="2"></li>
    <li data-target="#myCarousel" data-slide-to="3"></li>
    <li data-target="#myCarousel" data-slide-to="4"></li>
  </ol>
  <div class="carousel-inner" role="listbox">
    <div class="item active">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>KISS</h1>
          <h2>Keep It Simple and Stupid.</h2>
          <!--<a class="btn btn-lg btn-primary" href="#" role="button">Sign up today</a>-->
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Seize The Day</h1><h1>And Get Busy Living</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Stay hungry</h1><h1>Stay foolish</h1>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
	  <h2>Ever tried, ever failed</h2><h2>No matter, try again</h2><h2>Fail again, fail better</h2>
        </div>
      </div>
    </div>
    <div class="item">
      <img src="data:image/gif;base64,R0lGODlhAQABAIAAAGZmZgAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==" alt="Second slide">
      <div class="container">
        <div class="carousel-caption">
          <h1>Nothing is true</h1><h1>Every is permitted</h1>
        </div>
      </div>
    </div>
  </div>
  <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right"></span>
    <span class="sr-only">Next</span>
  </a>
</div><!-- /.carousel -->

<div class="container">
  <div class="row">
    <div class="col-lg-9 blog-main" style="min-width: 500px">
    
<div class="post-container">
  <div class="blog-header">
    <h1>MySQL Performance Schema</h1>
    <div class="post-description">
      <i class="fa fa-calendar"></i> 2015-07-18 Saturday &nbsp; &nbsp;
      <i class="fa fa-tags"></i>  mysql ,  database  
      
    </div>
  </div>
  <hr>
  <p>这一存储引擎应该是在 MySQL 5.5 引入的，主要用于收集数据库服务器性能参数，提供等待事件的详细信息，包括锁、互斥变量、文件信息等；其中的表是只读的，用户不能创建或者修改。</p>

<p>在此简单介绍下。</p>

<!-- more -->

<h2 id="简介">简介</h2>

<p>这一存储引擎应该是在 MySQL 5.5 引入的，主要用于收集数据库服务器性能参数，提供等待事件的详细信息，包括锁、互斥变量、文件信息等；其中的表是只读的，用户不能创建或者修改。</p>

<p>另外，需要注意的是，开启 PS 会有一定的性能损耗，不同的版本号，不同的分支可能略有不同，如果比较关注性能，应该以实测为准。</p>

<p>在该库中，数据表分为如下的几类：</p>

<ol>
  <li>setup table：设置表，配置监控选项；</li>
  <li>current events table：记录当前那些 thread 正在发生什么事情；</li>
  <li>history table  发生的各种事件的历史记录表；</li>
  <li>summary table  对各种事件的统计表；</li>
  <li>杂项表，乱七八糟表。</li>
</ol>

<!--
    Current events
    event histories
    summaries
    object instances
    setup (configuration)
-->

<p>很多资料也可以参考官方网站的介绍 <a href="http://dev.mysql.com/doc/refman/en/performance-schema.html">MySQL Performance Schema</a> 。</p>

<h3 id="开启">开启</h3>

<p>如果使用 Performance Schema，需要在编译时进行配置，可以通过如下命令查看是否支持。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">$ mysqld --verbose --help | grep performance_schema
  ... ...
  --performance-schema
                      Enable the performance schema.
  --performance-schema-accounts-size=#
                      Maximum number of instrumented user@host accounts. Use 0
                      to disable, -1 for automated sizing.
  ... ...</code></pre></figure>

<p>在 5.5.6 之前，默认是关闭的，之后默认是打开的，在配置文件中通过如下方式进行设置，注意，这个参数是静态参数，只能在 my.cnf 设置，不能动态修改。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[mysqld]
performance_schema=ON</code></pre></figure>

<p>设置完重启后，可以查看相应变量，判断是否已经启动；若返回值为 ON，则说明性能数据库正常开启状态；如果是 OFF 可以查看日志为什么启动失败。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SHOW VARIABLES LIKE &#39;performance_schema&#39;;</code></pre></figure>

<p>Performance Schema 通过存储引擎插件实现，也就意味着可以通过如下命令查看。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT * FROM INFORMATION_SCHEMA.ENGINES WHERE ENGINE=&#39;PERFORMANCE_SCHEMA&#39;\G
*************************** 1. row ***************************
      ENGINE: PERFORMANCE_SCHEMA
     SUPPORT: YES
     COMMENT: Performance Schema
TRANSACTIONS: NO
          XA: NO
  SAVEPOINTS: NO

mysql&gt; SHOW ENGINES\G
... ...
      Engine: PERFORMANCE_SCHEMA
     Support: YES
     Comment: Performance Schema
Transactions: NO
          XA: NO
  Savepoints: NO
... ...</code></pre></figure>

<p>对应的表存储在 performance_schema 库中，所包含的表可以通过如下两种方式查看，对应的表会随着新监控的添加慢慢增长。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = &#39;performance_schema&#39;;
mysql&gt; SHOW TABLES FROM performance_schema;</code></pre></figure>

<p>默认不是所有的 instrument 和 consumer 都会被 enable ，这也就意味着一开始不会收集所有的事件，可以通过执行如下 SQL 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; UPDATE setup_instruments SET ENABLED = &#39;YES&#39;, TIMED = &#39;YES&#39;;
Query OK, 338 rows affected (0.12 sec)
mysql&gt; UPDATE setup_consumers SET ENABLED = &#39;YES&#39;;
Query OK, 8 rows affected (0.00 sec)</code></pre></figure>

<p>如果想查看某个时刻的等待事件，可以查询 events_waits_current 表，它记录了每个 thread 最近的监控信息。</p>

<h2 id="setup-table">setup table</h2>

<p>通过如下方式可以查看所有的 setup 表。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT table_name FROM information_schema.tables WHERE \
       table_schema = &#39;performance_schema&#39; AND table_name LIKE &#39;setup%&#39;;
+-------------------+
| table_name        |
+-------------------+
| setup_actors      |       配置用户纬度的监控，默认监控所有用户
| setup_consumers   |       消费者类型，即收集的事件写入到哪些统计表中
| setup_instruments |       该数据库的表名以及是否开启监控
| setup_objects     |       监控对象
| setup_timers      |       监控选项已经采样频率的时间间隔
+-------------------+
5 rows in set (0.00 sec)</code></pre></figure>

<h3 id="setup_actors">setup_actors</h3>

<p>配置用户纬度的监控，默认监控所有用户。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT * FROM performance_schema.setup_actors;
+------+------+------+---------+---------+
| HOST | USER | ROLE | ENABLED | HISTORY |
+------+------+------+---------+---------+
| %    | %    | %    | YES     | YES     |
+------+------+------+---------+---------+
1 row in set (0.00 sec)</code></pre></figure>

<h3 id="setup_consumers">setup_consumers</h3>

<p>对于 setup_consumers 表，需要注意的是，如果要采集数据，需要确保其 ENABLED 列为 YES 才会收集，可以直接使用 UPDATE SQL 进行更新，更新完后立即生效。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT * FROM performance_schema.setup_consumers ;
+----------------------------------+---------+
| NAME                             | ENABLED |
+----------------------------------+---------+
| events_stages_current            | NO      |
| events_stages_history            | NO      |
| events_stages_history_long       | NO      |
| events_statements_current        | YES     |
| events_statements_history        | YES     |
| events_statements_history_long   | NO      |
| events_transactions_current      | NO      |
| events_transactions_history      | NO      |
| events_transactions_history_long | NO      |
| events_waits_current             | NO      |
| events_waits_history             | NO      |
| events_waits_history_long        | NO      |
| global_instrumentation           | YES     |
| thread_instrumentation           | YES     |
| statements_digest                | YES     |
+----------------------------------+---------+
15 rows in set (0.00 sec)</code></pre></figure>

<!--
这个表的各个记录还存在层级关系，只有当上级的配置启用时才会考虑下级的配置。
层级关系为：

global_instrumentation
|----thread_instrumentation
|         |----events_waits_current
|         |           |-events_waits_history
|         |           |-events_waits_history_long
|         |----events_stages_current
|         |           |-events_stages_history
|         |           |-events_stages_history_long
|         |----events_statements_current
|                     |-events_statements_history
|                     |-events_statements_history_long
|-----statements_digest
当global_instrumentation启用时，"thread_instrumentation"和"statements_digest"的配置才有可能生效。其他的配置类推。
只有当"setup_instruments"，"setup_objects",”setup_consumers“和"threads"都某一项测量指标都启用时才能收集到它的信息。
-->

<p>上述通过 UPDATE 配置后，服务器重启又会变回默认值，要永久生效需要在配置文件里添加。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">[mysqld]
performance_schema_consumer_events_waits_current      = ON
performance_schema_consumer_events_stages_current     = ON
performance_schema_consumer_events_statements_current = ON
performance_schema_consumer_events_waits_history      = ON
performance_schema_consumer_events_stages_history     = ON
performance_schema_consumer_events_statements_history = ON</code></pre></figure>

<p>也即在这些表的前面加上performance_schema_consumer_xxx。</p>

<p>其中 history 和 history_long 保存的是 current 表的历史记录条数，长度可以通过变量设置。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SHOW VARIABLES LIKE &#39;performance_schema%history%size&#39;;
+----------------------------------------------------------+-------+
| Variable_name                                            | Value |
+----------------------------------------------------------+-------+
| performance_schema_events_stages_history_long_size       | 1000  |
| performance_schema_events_stages_history_size            | 10    |
| performance_schema_events_statements_history_long_size   | 1000  |
| performance_schema_events_statements_history_size        | 10    |
| performance_schema_events_transactions_history_long_size | 1000  |
| performance_schema_events_transactions_history_size      | 10    |
| performance_schema_events_waits_history_long_size        | 1000  |
| performance_schema_events_waits_history_size             | 10    |
+----------------------------------------------------------+-------+
8 rows in set (0.00 sec)</code></pre></figure>

<h3 id="setup_instruments">setup_instruments</h3>

<p>配置具体的 instrument，主要包含如下的几大类：idle、stage/xxx、statement/xxx、wait/xxx、memory/xxx、transaction 。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT name, count(1) FROM performance_schema.setup_instruments GROUP BY left(name,5);
+-------------------------------------------+----------+
| name                                      | count(1) |
+-------------------------------------------+----------+
| idle                                      | 1        |
| memory/performance_schema/mutex_instances | 375      |
| stage/sql/After create                    | 129      |
| statement/sql/select                      | 193      |
| transaction                               | 1        |
| wait/synch/mutex/sql/TC_LOG_MMAP::LOCK_tc | 314      |
+-------------------------------------------+----------+
6 rows in set (0.01 sec)</code></pre></figure>

<p>idle 表示 socket 空闲的时间；stage 类表示语句的每个执行阶段的统计；statement 类统计语句维度的信息；wait 类统计各种等待事件，比如 IO、mutux、spin_lock、condition 等。</p>

<h3 id="setup_objects">setup_objects</h3>

<p>默认对 MySQL、performance_schema 和 information_schema 中的表都不监控，而其它 DB 的所有表都监控。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT * FROM performance_schema.setup_objects;
+-------------+--------------------+-------------+---------+-------+
| OBJECT_TYPE | OBJECT_SCHEMA      | OBJECT_NAME | ENABLED | TIMED |
+-------------+--------------------+-------------+---------+-------+
| EVENT       | mysql              | %           | NO      | NO    |
| EVENT       | performance_schema | %           | NO      | NO    |
| EVENT       | information_schema | %           | NO      | NO    |
| EVENT       | %                  | %           | YES     | YES   |
| FUNCTION    | mysql              | %           | NO      | NO    |
| FUNCTION    | performance_schema | %           | NO      | NO    |
| FUNCTION    | information_schema | %           | NO      | NO    |
| FUNCTION    | %                  | %           | YES     | YES   |
| PROCEDURE   | mysql              | %           | NO      | NO    |
| PROCEDURE   | performance_schema | %           | NO      | NO    |
| PROCEDURE   | information_schema | %           | NO      | NO    |
| PROCEDURE   | %                  | %           | YES     | YES   |
| TABLE       | mysql              | %           | NO      | NO    |
| TABLE       | performance_schema | %           | NO      | NO    |
| TABLE       | information_schema | %           | NO      | NO    |
| TABLE       | %                  | %           | YES     | YES   |
| TRIGGER     | mysql              | %           | NO      | NO    |
| TRIGGER     | performance_schema | %           | NO      | NO    |
| TRIGGER     | information_schema | %           | NO      | NO    |
| TRIGGER     | %                  | %           | YES     | YES   |
+-------------+--------------------+-------------+---------+-------+
20 rows in set (0.00 sec)</code></pre></figure>

<h3 id="setup_timers">setup_timers</h3>

<p>配置每种类型指令的统计时间单位。MICROSECOND表示统计单位是微妙，CYCLE表示统计单位是时钟周期，时间度量与CPU的主频有关，NANOSECOND表示统计单位是纳秒。但无论采用哪种度量单位，最终统计表中统计的时间都会装换到皮秒。（1秒＝1000000000000皮秒）</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT * FROM performance_schema.setup_timers;
+-------------+-------------+
| NAME        | TIMER_NAME  |
+-------------+-------------+
| idle        | MICROSECOND |
| wait        | CYCLE       |
| stage       | NANOSECOND  |
| statement   | NANOSECOND  |
| transaction | NANOSECOND  |
+-------------+-------------+
5 rows in set (0.00 sec)</code></pre></figure>

<h2 id="instance">instance</h2>

<h3 id="cond_instances">cond_instances</h3>

<p>条件等待对象实例，表中记录了系统中使用的条件变量的对象，OBJECT_INSTANCE_BEGIN 为对象的内存地址。</p>

<h3 id="file_instances">file_instances</h3>

<p>记录了系统中打开了文件的对象，包括 ibdata、redo、binlog、用户的表文件等，open_count 显示当前文件打开的数目，如果没有打开过，不会出现在表中。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; SELECT * FROM performance_schema.file_instances;
+-------------------------------------------+--------------------------------------+------------+
| FILE_NAME                                 | EVENT_NAME                           | OPEN_COUNT |
+-------------------------------------------+--------------------------------------+------------+
| /opt/mysql-5.7/share/english/errmsg.sys   | wait/io/file/sql/ERRMSG              | 0          |
| /opt/mysql-5.7/share/charsets/Index.xml   | wait/io/file/mysys/charset           | 0          |
| /tmp/mysql-master/ibdata1                 | wait/io/file/innodb/innodb_data_file | 3          |
| /tmp/mysql-master/ib_logfile0             | wait/io/file/innodb/innodb_log_file  | 2          |
| /tmp/mysql-master/ib_logfile1             | wait/io/file/innodb/innodb_log_file  | 2          |
| /tmp/mysql-master/mysql/engine_cost.ibd   | wait/io/file/innodb/innodb_data_file | 3          |
+-------------------------------------------+--------------------------------------+------------+
269 rows in set (0.01 sec)</code></pre></figure>

<!--
### mutex_instances

记录了系统中使用互斥量对象的所有记录，其中name为：wait/synch/mutex/*。LOCKED_BY_THREAD_ID显示哪个线程正持有mutex，若没有线程持有，则为NULL。

### rwlock_instances

： 读写锁同步对象实例

表中记录了系统中使用读写锁对象的所有记录，其中name为 wait/synch/rwlock/*。WRITE_LOCKED_BY_THREAD_ID为正在持有该对象的thread_id，若没有线程持有，则为NULL。READ_LOCKED_BY_COUNT为记录了同时有多少个读者持有读锁。（通过 events_waits_current 表可以知道，哪个线程在等待锁；通过rwlock_instances知道哪个线程持有锁。rwlock_instances的缺陷是，只能记录持有写锁的线程，对于读锁则无能为力）。
-->

<h3 id="socket_instances">socket_instances</h3>

<p>记录活跃会话对象实例，表中记录了 thread_id、socket_id、ip 和 port，其它表可以通过 thread_id 与 socket_instance 进行关联，获取 IP-PORT 信息，能够与应用对接起来。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysql&gt; select * from socket_instances;
+----------------------------------------+-----------+-----------+------------------+-------+--------+
| EVENT_NAME                             | THREAD_ID | SOCKET_ID | IP               | PORT  | STATE  |
+----------------------------------------+-----------+-----------+------------------+-------+--------+
| wait/io/socket/sql/server_tcpip_socket | 1         | 33        | ::               | 3307  | ACTIVE |
| wait/io/socket/sql/server_unix_socket  | 1         | 34        |                  | 0     | ACTIVE |
| wait/io/socket/sql/client_connection   | 31        | 41        | ::ffff:127.0.0.1 | 54834 | ACTIVE |
| wait/io/socket/sql/client_connection   | 32        | 45        |                  | 0     | ACTIVE |
+----------------------------------------+-----------+-----------+------------------+-------+--------+
4 rows in set (0.00 sec)</code></pre></figure>

<p>event_name 主要包含 3 类：</p>

<ul>
  <li>wait/io/socket/sql/server_unix_socket，服务端 unix 监听 socket；</li>
  <li>wait/io/socket/sql/server_tcpip_socket，服务端 tcp 监听 socket；</li>
  <li>wait/io/socket/sql/client_connection，客户端 socket 。</li>
</ul>

<!--
三：Wait表
1，events_waits_current：记录了当前线程等待的事件
2，events_waits_history：记录了每个线程最近等待的10个事件
3，events_waits_history_long：记录了最近所有线程产生的10000个事件

四：Stage 表
1，events_stages_current：记录了当前线程所处的执行阶段
2，events_stages_history：记录了当前线程所处的执行阶段10条历史记录
3，events_stages_history_long：记录了当前线程所处的执行阶段10000条历史记录

五：Statement 表
1，events_statements_current：通过 thread_id+event_id可以唯一确定一条记录。Statments表只记录最顶层的请求，SQL语句或是COMMAND，每条语句一行。event_name形式为statement/sql/*，或statement/com/*
2，events_statements_history
3，events_statements_history_long

六：Connection 表
1，users：记录用户连接数信息
2，hosts：记录了主机连接数信息
3，accounts：记录了用户主机连接数信息

七：Summary 表： Summary表聚集了各个维度的统计信息包括表维度，索引维度，会话维度，语句维度和锁维度的统计信息
-->

<h2 id="其它">其它</h2>

<h3 id="threads">threads</h3>

<p>监视服务端的当前运行的线程。</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">----- 哪个SQL执行最多
mysql&gt; SELECT schema_name,digest_text,count_star,sum_rows_sent,sum_rows_examined
          FROM events_statements_summary_by_digest ORDER BY count_star desc\G

----- 哪个SQL平均响应时间最多
mysql&gt; SELECT schema_name,digest_text,count_star,avg_timer_wait,sum_rows_sent,sum_rows_examined
          FROM events_statements_summary_by_digest ORDER BY AVG_TIMER_WAIT desc LIMIT 1\G</code></pre></figure>

<h2 id="源码解析">源码解析</h2>

<p>该引擎的源码保存在 storage/perfschema 目录下，</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">mysqld_main()
 |-pre_initialize_performance_schema()      最先调用的函数
 |-initialize_performance_schema()
 |-initialize_performance_schema_acl()
 |-check_performance_schema()</code></pre></figure>

<!--
status；
show status;
show engines;
show plugins;
show engine innodb status;
show master status;
show slave status;
show procedure status;
show table status;
show variables;

https://yq.aliyun.com/articles/59262
http://www.cnblogs.com/cchust/p/5061131.html
-->


  <hr>
  <nav>
    <ul class="pager">
         <li class="previous"><a href="/post/an-interesting-strategy-for-thieves.html" title="【转】一个银行劫匪的止损策略">&larr; Older</a></li> 
         <li class="next"><a href="/post/mysql-tools.html" title="MySQL 常用工具">Newer &rarr;</a></li> 
    </ul>
  </nav><br>
<!--
  <hr><div id="section-donate"><span>赏</span></div><br>
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p><br>
  <div class="row" style="text-align:center;" >
    <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
    <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
  </div><br><hr>
-->
  <p style="text-indent:0px;text-align:center;">如果喜欢这里的文章，而且又不差钱的话，欢迎打赏个早餐 ^_^</p>
  <div id="donate_module">
    <style type="text/css">
      .donate_bar a.btn_donate{
        display: inline-block;
        position:      relative;
        text-align:    center;
        width: 82px;
        height: 82px;
        background: url("/images/misc/btn_reward.gif") no-repeat;
        _background: url("/images/misc/btn_reward.gif") no-repeat;
        -webkit-transition: background 0s;
        -moz-transition: background 0s;
        -o-transition: background 0s;
        -ms-transition: background 0s;
        transition: background 0s;
      }
      .donate_bar a.btn_donate:hover{ background-position: 0px -82px;}
      .donate_bar .donate_txt {
        display: block;
        color: #9d9d9d;
        font: 14px/2 "Microsoft Yahei";
      }
    </style>
    <div id="donate_board" class="donate_bar row" style="text-align:center;" >
      <a id="btn_donate" class="btn_donate" target="_self" href="javascript:;" title="Donate 打赏"></a>
    </div>
    <div id="donate_guide" class="donate_bar center hidden">
      <div class="row" style="text-align:center;" >
        <div class="col-md-6"><img src="/images/system/barcode-pay-alipay.jpg" style="width:150px;height:150px;" title="支付宝捐赠" /><br>支付宝打赏</div>
        <div class="col-md-6"><img src="/images/system/barcode-pay-wechat.jpg" style="width:150px;height:150px;" title="微信捐赠" /><br>微信打赏</div>
      </div>
    </div>
    <script type="text/javascript">
      document.getElementById('btn_donate').onclick = function(){
        $('#donate_board').addClass('hidden');
        $('#donate_guide').removeClass('hidden');
      }
      function donate_on_web(){
        $('#donate').submit();
      }
    </script>
  </div>

  <hr>

  <div id="gitmentContainer"></div>
  <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
  <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
  <script>
  var gitment = new Gitment({
      id: '1437148800',
      owner: 'Jin-Yang',
      repo: 'jin-yang.github.com',
      oauth: {
          client_id: '6d89d48ce689192bf95d',
          client_secret: 'c9a720aafb8e3084e3feb46cadee80b03cdc792f',
      },
  });
  gitment.render('gitmentContainer');
  </script>

  <!-- 多说评论框 start -->
  <!--<div class="ds-thread" data-thread-key="请将此处替换成文章在你的站点中的ID" data-title="请替换成文章的标题" data-url="请替换成文章的网址"></div>-->
  <!--
  <div class="ds-thread" data-thread-key="/post/mysql-performance-schema_init.html" data-title="MySQL Performance Schema" data-url="/post/mysql-performance-schema_init.html"></div>
  -->
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <!--
  <script type="text/javascript">
      var duoshuoQuery = {short_name:"jinyangposts"};
      (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
           || document.getElementsByTagName('body')[0]).appendChild(ds);
      })();
  </script>
  -->
  <!-- 多说公共JS代码 end -->
</div>

    </div>
    <div class="col-lg-3 visible-lg blog-sidebar">
    <center><a href="/"><img src="/images/system/linux-liberty.png" width="200" /></a></center>
<h2>About This Blog</h2>
<div class="sidebar-module">
<p style="text-indent:0em;margin:0px;padding:0px;">This is a personal weblog ^_^ generated with Jekyll, if you like it or have some questions,
just feel free to contact me :)</p>
</div><!-- end of "node" "about" -->



<h2>Recent Posts</h2>
<div class="list-group">
  
    <a class="list-group-item" href="/post/linux-program-cpu-cache-introduce_init.html">CPU Cache</a>
  
    <a class="list-group-item" href="/post/artificial-intelligence-decision-tree-introduce.html">决策树</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-bcc-tools-introduce.html">BCC 工具使用</a>
  
    <a class="list-group-item" href="/post/linux-ebpf-basic-usage-introduce.html">eBPF 简介</a>
  
    <a class="list-group-item" href="/post/math-monte-carlo-sample-introduce.html">采样算法</a>
  
</div>

<h2>Categories</h2>
<ul class="list-group" style="margin:0px;">
  
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#bash"> bash</a>
    <span class="badge">2</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#database"> database</a>
    <span class="badge">86</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#golang"> golang</a>
    <span class="badge">28</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#linux"> linux</a>
    <span class="badge">301</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#misc"> misc</a>
    <span class="badge">244</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#mysql"> mysql</a>
    <span class="badge">79</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#network"> network</a>
    <span class="badge">49</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#postgresql"> postgresql</a>
    <span class="badge">4</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#program"> program</a>
    <span class="badge">138</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#python"> python</a>
    <span class="badge">25</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#react"> react</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#rtems"> rtems</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#sql"> sql</a>
    <span class="badge">10</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#tools"> tools</a>
    <span class="badge">1</span>
  </li>
  
    <li style="margin-left:0em" class="list-group-item"><a href="/categories.html#webserver"> webserver</a>
    <span class="badge">25</span>
  </li>
  
</ul><!-- end of "node" "categories" -->

<h2>Related Links</h2>
<ul class="list-group" style="margin:0px">
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.rtems.org" title="To RTEMS"><img class="img-thumbnail img-responsive" src="/images/system/rtems.png"  alt="RTEMS"/></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>RTEMS</strong><br>
        <div class="sidebar-description">Real-Time Executive for Multiprocessor System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
       <a href="http://www.gnu.org" title="To GNU">
       <img class="img-thumbnail img-responsive" src="/images/system/gnu.jpg" alt="GNU" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>GNU</strong><br>
        <div class="sidebar-description">A Unix-linux Operating System</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://www.kernel.org" title="To Linux Kernel">
    <img class="img-thumbnail img-responsive" src="/images/system/linux.png"  alt="LINUX" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Linux Kernel</strong><br>
        <div class="sidebar-description">Maintained by Linux Kernel Organization</div>
      </div>
    </div>
  </li>
  <li style="margin-left:0em" class="list-group-item">
    <div class="row">
      <div class="col-xs-4">
    <a href="http://arduino.cc" title="To Arduino">
    <img class="img-thumbnail img-responsive" src="/images/system/arduino.png"  alt="ARDUINO" /></a>
      </div>
      <div class="col-xs-8 center-block" style="padding:0px;">
        <strong>Arduino</strong><br>
        <div class="sidebar-description">Open-source Electronic Prototyping Platform</div>
      </div>
    </div>
  </li>
</ul>

<h2>Search</h2>
<div class="sidebar-module">
  <form class="search" method="GET" action="https://www.google.com.hk/search">
    <input type="text" name="q" class="search-query" placeholder=" Search on Google">
    <input type="hidden" name="ie" value="utf-8">
    <input type="submit" name="sa" value="Search" />
  </form><br>
  <input type="text" class="search-field" placeholder=" Search This Site">
  <div class="search-results"></div>
</div>



    </div>
  </div>
<hr><p class="text-center">This Site was built by Jin Yang, generated with Jekyll, and hosted on GitHub Pages<br/> &copy;2013-2019 &ndash; Jin Yang</p><div class="footer-logo"></div>

</div>
</body>
</html>
